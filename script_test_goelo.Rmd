---
title: "script_stage test ouverture données Goêlo"
author: "Hugo Gallier"
date: "2024-01-24"
output: html_document
editor_options: 
  chunk_output_type: console
---


# Library

Package à télécharger
```{r}
rm(list=ls())

library(dplyr)
library(tidyr)
library(ggplot2)
library(here)
library(stringr)
library(vegan)
library(scales)
library(car)

```

#################### Importation du data et chargement ###################

Identification des fichiers à charger
```{r}
setwd(here::here())



MPhoto=read.csv('Meta_photo.csv', sep=';')%>%
  # mutate(Micro=) %>%
  mutate(Micro=sub("\\_.*", "", Code_struct))
  
```

## Chargement data
Boucle de chargement des fichiers csv 
```{r}

setwd('D:/Hugo/Recif_Goelo/') # à modifier avec nom de ton DD



data_list=list.files(pattern =".csv", recursive=T)

L=list()
for( i in 1: length(data_list)){
  
  Nome_tot=data_list[i]
  
  str_split(Nome_tot,"/")
    Name_file=basename(data_list[i])
    
data=read.csv(data_list[i], sep=',', header=T, fileEncoding="latin1") %>%
  mutate(Name_file=rep(basename(data_list[i]), n()),
         recif=str_split(Nome_tot,"/")[[1]][4],
         recif=case_when(recif == 'Récif 01-12'~ 'recif1',
                         recif == 'Récif 13-24'~ 'recif2',
                         recif == 'Récif 25-36'~ 'recif3',
                         TRUE~NA)) 
  


L[[i]]<-data

}

# fileEncoding="latin1"
```

## Date d'immersion
Ajout des dates d'immersion des différents récifs
```{r}
Immer_site=data.frame(Site=c('Paim'), Date=c(as.Date('2023-10-01'),as.Date('2022-09-01'),as.Date('2023-07-01'))) %>%
       mutate( Date_imm_ok=format(as.POSIXlt(Date,  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT")) %>% select(Site, Date_imm_ok)
         
```

## Saison - date

Data frame d'identification des saisons
```{r}

Date_sais=data.frame(
           start=c(
             format(as.POSIXlt(as.Date('2021-03-20'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-06-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-09-22'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-12-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
      format(as.POSIXlt(as.Date('2022-03-20'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
      format(as.POSIXlt(as.Date('2022-06-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
       format(as.POSIXlt(as.Date('2022-09-22'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT")))
```


## Mise en forme des données

Mise en forme des fichiers chargés:

-Ajout de métadata à partir du nom du fichier: site, date , micro env., Num quadrat ...
- Transformation format Date
- Correction nom taxon érroné
- Changements de noms des micro env.
- Regroupement des micro env dans structure internes vs externes
```{r}
# data_PQ[grepl('rndpts.csv.rndpts',data_PQ$Name_file),]

## ajout de categories à partir du nom de fichier

# data_PQ=do.call(rbind,L) %>%
#   mutate(Site=substr(Name_file, start = 1, stop = 2)) %>%
#   # test2=substr(Name_file, start = 1, stop = 6))%>%
#   # test3=sub("^([^_]*_[^_]*).*", "\\2", Name_file),
#   separate(col = Name_file, into = c('Date','Micro','Quad','Recif'), sep = '_') %>%
#   mutate(Micro=stringr::str_replace_all(Micro, ".rndpts.csv", ""), 
#     Quad2=substr(Quad, start = 1, stop = 1),
#     
    
data_PQ=do.call(rbind,L) %>%
  mutate(Site=substr(Name_file, start = 1, stop = 2)) %>%
  # test2=substr(Name_file, start = 1, stop = 6))%>%
  # test3=sub("^([^_]*_[^_]*).*", "\\2", Name_file),
  separate(col = Name_file, into = c('Date','Micro','Quad'), sep = '_') %>%
  mutate(Micro=stringr::str_replace_all(Micro, ".rndpts.csv", ""),
    Quad2=substr(Quad, start = 1, stop = 1),
         
          Month_str=gsub("-.*", "", Date,perl=TRUE),
          YY=gsub(".*-", "", Date,perl=TRUE),
          Month=case_when( Month_str=='Avri'~'04',
                           Month_str=="Janv"~'01',
                           Month_str=='Juill'~'07',
                           Month_str=='Sept'~'09',
                           Month_str=='Oct'~'10',
                           Month_str=='Nov'~'11'),
          Date_ok=format(as.POSIXlt(paste0('01/',Month,'/',YY),  format = "%d/%m/%y"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
          Date_courte=format(as.POSIXlt(paste0('01/',Month,'/',YY),  format = "%d/%m/%y"), format="%Y-%m", tz="GMT"),
          Week=strftime(Date_ok, format = "%V")) %>%
  mutate(spp.Name= ifelse(spp.Name == 'Tubularia indivisa ',
                          'Tubularia indivisa',spp.Name),
         spp.Name=ifelse(spp.Name == 'Unidentified',
                          'NI',spp.Name))
  

# Version synthétique du df

data_PQ_light=data_PQ %>% dplyr::select(Image, spp.Name,spp.ID,N.pts.per.species,Cov..per.species,
               N.pts.ALL.species,Cov..ALL.species, Site,Date_ok,Micro,Quad2,
               Week,Date_courte,Month_str,recif )%>%
rename('spp'='spp.Name',
       'Count'='N.pts.per.species',
       'Cov'='Cov..per.species',
       'Count_all'='N.pts.ALL.species',
       'Cov_all'='Cov..ALL.species')%>%
  mutate(abb=abbreviate(spp))%>%
  left_join(MPhoto, by=c('Micro')) %>%
  mutate(Structure2=recode_factor(Structure,
   "Bandes"="Dome",
   "Bandes.C1"="Disc",
   "Faille"="Inner_slots",
   "Faille_coupole"="Upper_slots",
   "Pilier.C2"="Columns",
   "Trous"="Holes",
   "Pieds"="Pillars"))%>% 
  mutate(Strcut_groups=case_when(
  Structure2 %in% c('Dome','Upper_slots')~'Horizontal_section',
 Structure2 %in% c('Disc','Columns','Pillars')~'Vertical_section',
  Structure2 %in% c('Inner_slots','Holes')~'Inner_section',
 TRUE ~ 'NA')) %>%
  mutate(M_ensemble=ifelse(Micro %in% c("P1","P2","P3","T1","T2","T3","T4"),substr(Micro, start = 1, stop = 1),substr(Micro, start = 1, stop = 3)),
         M_ensemble2=ifelse(M_ensemble == 'DPF','DGF',M_ensemble))%>%
  left_join(Immer_site, by='Site') 


knitr::kable(data_PQ_light %>% select(spp,abb)%>% unique())
corresp=data_PQ_light %>% select(spp,abb)%>% unique()
```
# Modification des données 
```{r}
dataR1<-data_PQ_light
dataR<-dataR1[,-c(1,6:8,11,16:19,21:24)]
dataR<-na.omit(dataR)

dataR$spp<-as.factor(dataR$spp)
dataR$spp.ID<-as.factor(dataR$spp.ID)
dataR$recif<-as.factor(dataR$recif)
dataR$Micro<-as.factor(dataR$Micro)
dataR$Count<-as.numeric(dataR$Count)
dataR$Month_str<-as.factor(dataR$Month_str)
dataR$Month<-as.factor(dataR$Month)
dataR$Date_ok<-as.factor(dataR$Date_ok)
dataR$Date_courte<-as.factor(dataR$Date_courte)
dataR$Week<-as.factor(dataR$Week)
dataR$Structure2<-as.factor(dataR$Structure2)

dataR<-dataR[,-12]
colnames(dataR)[10]<-c("Site")
```


#Indice Gamma
```{r}
# Quel est la richesse taxonomique global (Indice Gamma) d'un site et de la zone d'étude en général

dataR<-dataR1[,-c(1,6:8,11,16:19,21:24)]
dataR<-na.omit(dataR)
seq1<-rep(0,times=1005)
dataR3<-cbind(dataR,seq1)
dataR<-dataR3

# Indice gamma par site 
dataR2=dataR %>% filter(!spp %in% c("NI","Unassigned")) %>% #enlève les NI et unassigned
  select(spp,Site) %>% 
  distinct() %>% 
  group_by(Site) %>% #filtre selon le site, date et structure
  summarize(S=n()) #créér une nouvelle colonne permettant de faire un summary des valeurs filtrées
dataR2

# Indice gamma selon date
dataR2=dataR %>% filter(!spp %in% c("NI","Unassigned")) %>% #enlève les NI et unassigned
  # filter (!Site %in% c("Bi","Bu","VB")) %>%
  select(spp,Site,Date_courte) %>% 
  distinct() %>% 
  group_by(Site,Date_courte) %>% #filtre selon le site, date et structure
  summarize(S=n()) #créér une nouvelle colonne permettant de faire un summary des valeurs filtrées
length(unique(dataR2$spp))



# Indice gamma global
dataR2=dataR %>% filter(!spp %in% c("NI","Unassigned")) %>% #enlève les NI et unassigned
  select(spp,seq1) %>% 
  distinct() %>% 
  group_by(seq1) %>% #filtre selon le site, date et structure
  summarize(S=n()) #créér une nouvelle colonne permettant de faire un summary des valeurs filtrées
print(dataR2)

```


# Comparaison intersite (microhabitats confondus) temporelle
```{r}

dataR
dataR2=dataR %>% filter(!spp %in% c("NI","Unassigned")) %>% #enlève les NI et unassigned
  filter(!Structure2 %in% c ("Holes","Inner_slots","Upper_slots"))%>% 
  select(spp,Site,Date_courte) %>% 
  distinct() %>% 
  group_by(Site,Date_courte) %>% #filtre selon le site, date et structure
  summarize(S=n()) #créér une nouvelle colonne permettant de faire un summary des valeurs filtrées


ggplot(dataR2, aes(Date_courte,S, col=Site))+
  xlab("Date")+
  ylab("Richesse taxonomique")+
  geom_point()+
  geom_line( aes(group=Site))+
  # facet_wrap(.~Site)+ # <- cette fonction permet de réaliser les geoms précedents mais pour différentes catégories (ici j'ai choisi les micro habitat, mais on aurait pu le faire pour les sites par exemples)
  theme_bw()+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) # <- rotation des dates pour qu'elles soient lisibles

```

#Comparaison intersite des Micro habitats
```{r}

dataR2=dataR %>% filter(!spp %in% c("NI","Unassigned")) %>% #enlève les NI et unassigned
  filter(!Structure2  %in% c("Holes","Dome","Inner_slots","Upper_slots"))%>% 
  select(Site,spp,Date_courte,Structure2)%>%
  distinct() %>% 
  group_by(Site,Date_courte,Structure2)%>%
  summarize(S=n()) #créér une nouvelle colonne permettant de faire un summary des valeurs filtrées


ggplot(dataR2, aes(Structure2,S, fill=Site))+ # Avec "fill" ou "col" du peut ajout une séparation de tes données par facteur (ici le site)
  xlab("Structure")+
  ylab("Richesse taxonomique")+
  geom_jitter(alpha=.3)+  # On ajoute les points (pas nécessaire mais utile pour savoir sur quoi se base les boxplots)
  geom_boxplot()+
  theme_bw()



dataR2=dataR %>% filter(!spp %in% c("NI","Unassigned")) %>% #enlève les NI et unassigned
  filter(!Structure2  %in% c("Holes","Dome","Inner_slots","Upper_slots"))%>% 
  select(Site,spp,Date_courte,Structure2)%>%
  distinct() %>% 
  group_by(Site,Date_courte,Structure2)%>%
  summarize(S=n()) #créér une nouvelle colonne permettant de faire un summary des valeurs filtrées

ggplot(dataR2, aes(Site,S, fill=Structure2))+ # Avec "fill" ou "col" du peut ajout une séparation de tes données par facteur (ici le site)
  xlab("Structure")+
  ylab("Richesse taxonomique")+
  geom_jitter(alpha=.3)+  # On ajoute les points (pas nécessaire mais utile pour savoir sur quoi se base les boxplots)
  geom_boxplot()+
  theme_bw()
```


###Test Shapiro/Levene/Anova
```{r}
library(rstatix)

model1<-lm(S~Structure2,data=dataR2021)
shapiro_test(residuals(model1))#si pvalue supérieure à 0,05 alors permet de dire que les résidus sont normalements distribuées

leveneTest(S~Structure2,data=dataR2)#Si p value supérieur à 0,05 alors variance entre les groupes est égale

test_anova<-aov(S~factor(Site)*factor(Date_courte),data=dataR2)#anova en prenant la date ainsi que les structures comme facteur
test_anova<-aov(S~factor(Site)*factor(Micro),data=dataR2)#anova en prenant la date ainsi que les micro comme facteur
test_anova<-aov(S~factor(Site),data=dataR2)#anova en prenant la date ainsi que les micro comme facteur
test_anova<-aov(S~factor(Micro),data=dataR2)#anova en prenant la date ainsi que les micro comme facteur

summary(test_anova)
```

# Linear mixed model
```{r}
library(lme4)
library(Matrix)
library(sjPlot)

dataR2=dataR %>% filter(!spp %in% c("NI","Unassigned")) %>% #enlève les NI et unassigned
  filter(!Structure2  %in% c("Holes","Dome","Inner_slots","Upper_slots"))%>% 
  filter(!Date_courte=="2021-01") %>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% #filtre selon le site, date et structure
  summarize(S=n()) #créér une nouvelle colonne permettant de faire un summary des valeurs filtrées

mixed.lmer <- lmer(S ~ Site + (1|Micro/Date_courte), data = dataR2) #compare les données de richesse taxo avec les variables aléatoires qui sont Micro et date courte
summary(mixed.lmer)
plot_model(mixed.lmer,show.values = T,show.p = T)#montre que par rapport à un site de réference (ici Bi), les autres sites sont différents. Ici Fetlar a plutot une diversité moindre que Bi mais est le plus proche. 
tab_model(mixed.lmer)


```



#radar plot
```{r}
dataR<-dataR1[,-c(1,6:7,15:18,20:23)]
dataR<-dataR[,-c(2,4,6,8:9,11)]
dataR<-na.omit(dataR)

library(ggradar)

##### Bottom disc #####
lcol<-c("blue","red","orange","black")

### C1 
# Se
resultat1<- na.omit(spread((dataR2=dataR %>% filter(!spp %in% c("NI","Unassigned")) %>%#enlève les NI
  filter(!Structure2 %in% c("Dome","Holes")) %>%
  filter(Site == ("Se"))%>%
  filter(Micro %in% c("C1B1","C1B2","C1B3","C1B4","C1B5","C1B6","C1B7","C1B8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% #filtre selon le site, date et structure
  summarize(S=n())),key=Micro,value=S)) #créér une nouvelle colonne permettant de faire un summary des valeurs filtrées
resultat1[is.na(resultat1)]<-0

ggradar(resultat1[,-2],grid.min = 1,grid.max =10,values.radar = c(0,5,10),group.colours = "blue",legend.title="Site",gridline.max.linetype = 1,gridline.max.colour = "black",background.circle.colour = "lightblue")

# Ju
resultat2<- na.omit(spread((dataR2=dataR %>% filter(!spp %in% c("NI","Unassigned")) %>%#enlève les NI
  filter(!Structure2 %in% c("Dome","Holes")) %>%
  filter(Site == ("Ju"))%>%
  filter(Micro %in% c("C1B1","C1B2","C1B3","C1B4","C1B5","C1B6","C1B7","C1B8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% #filtre selon le site, date et structure
  summarize(S=n())),key=Micro,value=S)) #créér une nouvelle colonne permettant de faire un summary des valeurs filtrées
resultat2[is.na(resultat2)]<-0

ggradar(resultat2[,-2],grid.min = 1,grid.max =10,values.radar = c(0,5,10),group.colours = "red",legend.title="Site",gridline.max.linetype = 1,gridline.max.colour = "black",background.circle.colour = "lightblue")

### C2
# Se
resultat3<- na.omit(spread((dataR2=dataR %>% filter(!spp %in% c("NI","Unassigned")) %>%#enlève les NI
  filter(!Structure2 %in% c("Dome","Holes")) %>%
  filter(Site == ("Se"))%>%
  filter(Micro %in% c("C2P1","C2P2","C2P3","C2P4","C2P5","C2P6","C2P7","C2P8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% #filtre selon le site, date et structure
  summarize(S=n())),key=Micro,value=S)) #créér une nouvelle colonne permettant de faire un summary des valeurs filtrées
resultat3[is.na(resultat3)]<-0

ggradar(resultat3[,-2],grid.min = 1,grid.max =10,values.radar = c(0,5,10),group.colours = "blue",legend.title="Site",gridline.max.linetype = 1,gridline.max.colour = "black",background.circle.colour = "lightblue")

# Ju
resultat4<- na.omit(spread((dataR2=dataR %>% filter(!spp %in% c("NI","Unassigned")) %>%#enlève les NI
  filter(!Structure2 %in% c("Dome","Holes")) %>%
  filter(Site == ("Ju"))%>%
  filter(Micro %in% c("C2P1","C2P2","C2P3","C2P4","C2P5","C2P6","C2P7","C2P8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% #filtre selon le site, date et structure
  summarize(S=n())),key=Micro,value=S)) #créér une nouvelle colonne permettant de faire un summary des valeurs filtrées
resultat4[is.na(resultat4)]<-0

ggradar(resultat4[,-2],grid.min = 1,grid.max =10,values.radar = c(0,5,10),group.colours = "red",legend.title="Site",gridline.max.linetype = 1,gridline.max.colour = "black",background.circle.colour = "lightblue")
```