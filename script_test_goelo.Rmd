---
title: "script_stage test ouverture données Goêlo"
author: "Hugo Gallier"
date: "2024-01-24"
output: html_document
editor_options: 
  chunk_output_type: console
---


# Library

Package à télécharger
```{r}
rm(list=ls())

library(dplyr)
library(tidyr)
library(ggplot2)
library(here)
library(vegan)
library(scales)
library(fmsb)
library(FactoMineR)
library(ecodist)
library(ade4)
library(lme4)
library(Matrix)
library(sjPlot)
library(RColorBrewer)
library(iNEXT)
library(rstatix)
library(ggradar)
library(pairwiseAdonis)
library(ecole)
library(tidyverse)
library(mgcv)
library(ggforce)
library(tidymv)
library(ggtern)
library(codyn)
library(adespatial)
library(ggdendro)
library(car)
library(adegraphics)

```

#################### Importation du data et chargement ###################

Identification des fichiers à charger
```{r}
setwd(here::here())

MPhoto=read.csv('Meta_photo.csv', sep=';')%>%
  # mutate(Micro=) %>%
  mutate(Micro=sub("\\_.*", "", Code_struct))
  
```

## Chargement data
Boucle de chargement des fichiers csv 
```{r}

setwd('D:/Hugo/Recif_Goelo/') # à modifier avec nom de ton DD



data_list=list.files(pattern =".csv", recursive=T)

L=list()
for( i in 1: length(data_list)){
  
  Nome_tot=data_list[i]
  
  str_split(Nome_tot,"/")
    Name_file=basename(data_list[i])
    
data=read.csv(data_list[i], sep=',', header=T, fileEncoding="latin1") %>%
  mutate(Name_file=rep(basename(data_list[i]), n()),
         recif=str_split(Nome_tot,"/")[[1]][4],
         recif=case_when(recif == 'Récif 01-12'~ 'recif1',
                         recif == 'Récif 13-24'~ 'recif2',
                         recif == 'Récif 25-36'~ 'recif3',
                         TRUE~NA)) 

L[[i]]<-data

}

# fileEncoding="latin1"
```

## Date d'immersion
Ajout des dates d'immersion des différents récifs
```{r}
Immer_site=data.frame(Site=c('recif2','recif1','recif3'), Date=c(as.Date('2022-06-22'),as.Date('2022-06-22'),as.Date('2022-06-22'))) %>%
       mutate( Date_imm_ok=format(as.POSIXlt(Date,  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT")) %>% select(Site, Date_imm_ok)
```

## Saison - date

Data frame d'identification des saisons
```{r}
Date_sais=data.frame(
           start=c(
             format(as.POSIXlt(as.Date('2021-03-20'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-06-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-09-22'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-12-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
      format(as.POSIXlt(as.Date('2022-03-20'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
      format(as.POSIXlt(as.Date('2022-06-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
       format(as.POSIXlt(as.Date('2022-09-22'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT")))
```


## Mise en forme des données

Mise en forme des fichiers chargés:

-Ajout de métadata à partir du nom du fichier: site, date , micro env., Num quadrat ...
- Transformation format Date
- Correction nom taxon érroné
- Changements de noms des micro env.
- Regroupement des micro env dans structure internes vs externes
```{r}
# data_PQ[grepl('rndpts.csv.rndpts',data_PQ$Name_file),]

## ajout de categories à partir du nom de fichier
    
data_PQ=do.call(rbind,L) %>%
  mutate(Site=substr(Name_file, start = 1, stop = 2)) %>%
  separate(col = Name_file, into = c('Date','Micro','Quad'), sep = '_') %>%
  mutate(Micro=stringr::str_replace_all(Micro, ".rndpts.csv", ""),
    Quad2=substr(Quad, start = 1, stop = 1),
         
          Month_str=gsub("-.*", "", Date,perl=TRUE),
          YY=gsub(".*-", "", Date,perl=TRUE),
          Month=case_when( Month_str=='Avri'~'04',
                           Month_str=="Janv"~'01',
                           Month_str=='Juill'~'07',
                           Month_str=='Sept'~'09',
                           Month_str=='Oct'~'10',
                           Month_str=='Nov'~'11'),
          Date_ok=format(as.POSIXlt(paste0('01/',Month,'/',YY),  format = "%d/%m/%y"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
          Date_courte=format(as.POSIXlt(paste0('01/',Month,'/',YY),  format = "%d/%m/%y"), format="%Y-%m", tz="GMT"),
          Week=strftime(Date_ok, format = "%V")) %>%
  mutate(spp.Name= ifelse(spp.Name == 'Tubularia indivisa ','Tubularia indivisa',spp.Name),
         spp.Name=ifelse(spp.Name == 'Unidentified','NI',spp.Name))
  

# Version synthétique du df

data_PQ_light=data_PQ %>% dplyr::select(Image, spp.Name,spp.ID,N.pts.per.species,Cov..per.species,
               N.pts.ALL.species,Cov..ALL.species,Date_ok,Micro,Quad2,
               Week,Date_courte,Month_str,recif)%>%
rename('spp'='spp.Name',
       'Count'='N.pts.per.species',
       'Cov'='Cov..per.species',
       'Count_all'='N.pts.ALL.species',
       'Cov_all'='Cov..ALL.species',
       'Site'='recif')%>%
  mutate(abb=abbreviate(spp))%>%
   group_by(spp,abb,Site,Micro,Date_courte,Date_ok) %>% 
  summarize(Mcov=mean(Cov)) %>% 
  left_join(MPhoto, by=c('Micro')) %>%
  mutate(Structure2=recode_factor(Structure,
   "Bandes"="Dome",
   "Bandes.C1"="Disc",
   "Faille"="Inner_slots",
   "Faille_coupole"="Upper_slots",
   "Pilier.C2"="Columns",
   "Trous"="Holes",
   "Pieds"="Pillars"))%>% 
  mutate(Strcut_groups=case_when(
  Structure2 %in% c('Dome','Upper_slots')~'Horizontal_section',
 Structure2 %in% c('Disc','Columns','Pillars')~'Vertical_section',
  Structure2 %in% c('Inner_slots','Holes')~'Inner_section',
 TRUE ~ 'NA')) %>%
  mutate(M_ensemble=ifelse(Micro %in% c("P1","P2","P3","T1","T2","T3","T4"),substr(Micro, start = 1, stop = 1),substr(Micro, start = 1, stop = 3)),
         M_ensemble2=ifelse(M_ensemble == 'DPF','DGF',M_ensemble))%>%
  left_join(Immer_site, by='Site') 


knitr::kable(data_PQ_light %>% select(spp,abb)%>% unique())
corresp=data_PQ_light %>% select(spp,abb)%>% unique()
```

# #######################


# ###### Partie Hugo ######
# Formatage du jeu de données 
```{r}

#Calcul du temps depuis l'immersion
data_PQ_light=data_PQ_light %>% 
   mutate(Day_delta=as.numeric(abs(difftime(Date_ok,Date_imm_ok,units='days'))))

dataR1<-data_PQ_light
dataR=dataR1 %>% filter(!spp %in% c("NI","Unassigned","ponte","Ponte",'NA','None')) %>%
    # filter(!Structure2 %in% c('Holes','Upper_slots','Inner_slots','Dome')) %>% 
    filter(!Structure2 %in% c('Holes','Upper_slots','Dome','Bandes.C2')) %>% 
  select (spp,abb,Site,Micro,Date_courte,Mcov,Structure2,Day_delta)

```

  
  
#Indice Gamma
```{r}
# Quel est la richesse taxonomique global (Indice Gamma) d'un site et de la zone d'étude en général

# Indice gamma par site 
dataR2=dataR %>% ungroup %>% 
  select(spp,Site) %>% 
  # filter(Site == 'recif3') %>% 
  distinct()%>% 
  group_by(spp) %>% 
  summarize(S=n()) %>%
  na.omit()
length(unique(dataR2$spp))


# Indice gamma Quad2# Indice gamma global
dataR2=dataR %>% 
  select(spp,seq1) %>% 
  distinct() %>% 
  group_by(seq1) %>% 
  summarize(S=n()) 


length(unique(dataR1$spp))#permet de savoir le nombre de variable différente dans la colonne spp (mais ne prend pas en compte la suppression des N)


```

# ### Indice Alpha 

# Comparaison intersite (microhabitats confondus) temporelle
```{r}

dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Date_courte) %>%
  distinct()%>%
  group_by(Site,Structure2,Micro,Date_courte) %>%
  summarize(S=n()) %>%
  na.omit()

dataR3=dataR2 %>%
  group_by(Site,Date_courte,Structure2) %>%
  summarize(S2 = mean(S))
  
dataR3$S2[which(dataR3$Structure2=='Pillars')]<-(dataR3$S2[which(dataR3$Structure2=='Pillars')]/2)

ggplot(dataR3, aes(Date_courte,S2, col=Site))+# Avec "fill" ou "col" tu peux ajouter une séparation de tes données par facteur
  xlab("Date")+
  ylab("Richesse taxonomique")+
  geom_point()+
  geom_line(aes(group=Site))+
  # facet_wrap(.~Site)+ # <- cette fonction permet de réaliser les geoms précedents mais pour différentes catégories (ici j'ai choisi les micro habitat, mais on aurait pu le faire pour les sites par exemples)
  theme_bw()+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) # <- rotation des dates pour qu'elles soient lisibles

```

#Comparaison intersite des Micro habitats
```{r}

dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Date_courte) %>%
  distinct()%>%
  group_by(Site,Structure2,Micro,Date_courte) %>%
  summarize(S=n()) %>%
  na.omit()

dataR3=dataR2 %>%
  group_by(Site,Date_courte,Structure2) %>%
  summarize(S2 = mean(S))

dataR3$S2[which(dataR3$Structure2=='Pillars')]<-(dataR3$S2[which(dataR3$Structure2=='Pillars')]/2)

ggplot(dataR3, aes(Structure2,S2, fill=Site))+ 
  xlab("Structure")+
  ylab("Richesse taxonomique")+
  geom_jitter(alpha=.3)+  # On ajoute les points (pas nécessaire mais utile pour savoir sur quoi se base les boxplots)
  geom_boxplot()+
  theme_bw()

```


###Test Shapiro/Levene/Anova
```{r}

dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Date_courte,saison) %>%
  distinct()%>%
  group_by(Site,Structure2,Micro,Date_courte,saison) %>%
  summarize(S=n()) %>%
  na.omit()

dataR3=dataR2 %>%
  group_by(Site,Structure2,Date_courte,saison) %>%
  summarize(S2 = mean(S))

# model1<-lm(S~Structure2,data=dataR2021)
# shapiro_test(residuals(model1))#si pvalue supérieure à 0,05 alors permet de dire que les résidus sont normalements distribuées

# leveneTest(S~Structure2,data=dataR2)#Si p value supérieur à 0,05 alors variance entre les groupes est égale

test_anova<-aov(S2~factor(Site)*factor(Date_courte),data=dataR3)#anova en prenant la date ainsi que les sites comme facteur
test_anova<-aov(S2~factor(Site)*factor(Micro),data=dataR3)
test_anova<-aov(S2~factor(Site),data=dataR3)
test_anova<-aov(S2~factor(Site)+Error(Date_courte),data=dataR3)
test_anova<-aov(S2~factor(Micro),data=dataR3)
test_anova<-aov(S2~factor(Structure2)+Error(Date_courte),data=dataR3)
test_anova<-aov(S2~factor(Structure2),data=dataR3)
                
summary(test_anova)

```

# Linear mixed model
```{r}
#ajoute une colonne de saison 
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2023-07"] <- "été"
dataR$saison[dataR$saison == "2022-09" | dataR$saison == "2023-09"] <- "automne"

dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Date_courte,saison) %>% 
  distinct()%>% 
  group_by(Site,Structure2,Micro,Date_courte,saison) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR3=dataR2 %>% 
  group_by(Site,Structure2,Date_courte,saison) %>% 
  summarize(S2 = mean(S))

mixed.lmer <- lmer(S2 ~ Site + (1|Structure2/saison), data = dataR3) #compare les données de richesse taxo avec les variables aléatoires qui sont Micro et date courte
summary(mixed.lmer)
plot_model(mixed.lmer,show.values = T,show.p = T)#montre que par rapport à un site de réference (ici Bi), les autres sites sont différents. Ici Fetlar a plutot une diversité moindre que Bi mais est le plus proche. 
tab_model(mixed.lmer)

```


# Generalized Additive Models
```{r}
#Permet de montrer la significativité des valeurs selon des variables aléatoires

#ajoute une colonne de saison 
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2023-07"] <- "été"
dataR$saison[dataR$saison == "2022-09" | dataR$saison == "2023-09"] <- "automne"

dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Day_delta,saison,Date_courte) %>% 
  distinct()%>% 
  mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
  group_by(Site,Structure2,Micro,Day_delta,saison,Years) %>% 
  summarize(S=n()) %>%
  na.omit()%>% 
  droplevels()

dataR3=dataR2 %>% 
  group_by(Site,Structure2,Day_delta,saison,Years) %>% 
  summarize(S2 = mean(S)) 


#Richesse taxo
dataR2$Site<-as.factor(dataR2$Site)
dataR2$S<-as.numeric(dataR2$S)
dataR2$saison<-as.factor(dataR2$saison)
dataR2$Micro<-as.factor(dataR2$Micro)
dataR2$Day_delta<-as.numeric(dataR2$Day_delta)

str(dataR3)
dataR3$Site<-as.factor(dataR3$Site)
dataR3$S2<-as.numeric(dataR3$S2)
dataR3$saison<-as.factor(dataR3$saison)
dataR3$Years<-as.factor(dataR3$Years)



#test comparaison tous les paramètres
model1<-gam(S2~s(Day_delta)+Site,data=dataR3)
model11<-gam(S2~s(Day_delta)+Years,data=dataR3)
model111<-gam(S2~s(Day_delta)+Structure2,data=dataR3)
model1111<-gam(S2~s(Day_delta)+saison,data=dataR3)
model11111<-gam(S2~s(Day_delta)+Site+saison,data=dataR3)
model111111<-gam(S2~s(Day_delta)+Structure2+saison,data=dataR3)
model1111111<-gam(S2~s(Day_delta)+Structure2+Site,data=dataR3)
model11111111<-gam(S2~s(Day_delta)+Structure2+Site+saison,data=dataR3)

gam.check(model1)#permet de voir si le nombre de fonction simple utilisé est suffisant (si pvalue trop petite alors utiliser plus)
summary(model1)

model2<-gam(S2~Site/Day_delta+Day_delta,data=dataR3)
model22<-gam(S2~Site/Day_delta+Day_delta+Structure2,data=dataR3)
model222<-gam(S2~Site/Day_delta+Day_delta+saison,data=dataR3)
model2222<-gam(S2~Site/Day_delta+Day_delta+Site,data=dataR3)
model22222<-gam(S2~Site/Day_delta+Day_delta+Years,data=dataR3)
model222222<-gam(S2~Site/Day_delta+Day_delta+saison+Years,data=dataR3)
model2222222<-gam(S2~Site/Day_delta+Day_delta+saison+Site,data=dataR3)
model22222222<-gam(S2~Site/Day_delta+Day_delta+saison+Structure2,data=dataR3)
model222222222<-gam(S2~Site/Day_delta+Day_delta+Years+Site,data=dataR3)
model2222222222<-gam(S2~Site/Day_delta+Day_delta+Years+Structure2,data=dataR3)
model22222222222<-gam(S2~Site/Day_delta+Day_delta+Structure2+Site,data=dataR3)
model222222222222<-gam(S2~Site/Day_delta+Day_delta+Structure2+Site+saison+Years,data=dataR3)

#comparaison des modèles
AICc(model1,model11,model111,model1111,model11111,model111111,model1111111,model11111111)
AICc(model2,model22,model222,model2222,model22222,model222222,model2222222,model22222222,model222222222,model2222222222,
     model22222222222,model222222222222)

library(MuMIn)
options(na.action = "na.fail")
fm1<-gam(S~s(Day_delta)+s(Structure2,bs="re") +s(Site,bs="re")  +s(saison,bs="re"),data=dataR2)
ms1<-dredge(fm1)


#plot des gams
plot(model1,shift=mean(dataR3$S2),residuals=T,cex=1,pch=16,col="blue",shade=T,shade.col='grey')
ggplot(data = dataR3, mapping = aes(x = Day_delta, y = S2,colour=Site)) +
  geom_point(size = 0.7, alpha = 0.7) +
  geom_smooth(method="gam", formula= y~s(x))+
  theme_bw()

plot_smooths(model=model1, series=Day_delta,comparison=Site)+theme_bw() #permet de mettre les gam selon les sites

```



# Radar plot
```{r}
dataR
# lcol2<-brewer.pal(8,"Reds")
lcol2<-c('#FB6A4A','#CB181D','#59040c')


##### Bottom disc #####
# Récif 1
resultat1ref1<- spread((dataR2=dataR %>% 
  filter(Site == ("recif1"))%>%
  filter(Micro %in% c("C1B1","C1B2","C1B3","C1B4","C1B5","C1B6","C1B7","C1B8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S) 
resultat1ref1[is.na(resultat1ref1)]<-0

ggradar(resultat1ref1[,-1],grid.min = 0,grid.mid=3,grid.max =5,values.radar = c(0,3,5),group.colours = lcol2,legend.title="Récif 1",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


# Récif 2
resultatref2<- spread((dataR2=dataR %>% 
  filter(Site == ("recif2"))%>%
  filter(Micro %in% c("C1B1","C1B2","C1B3","C1B4","C1B5","C1B6","C1B7","C1B8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S) 
resultatref2[is.na(resultatref2)]<-0

ggradar(resultatref2[,-1],grid.min = 0,grid.mid=3,grid.max =5,values.radar = c(0,3,5),group.colours = lcol2,legend.title="Récif 2",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


# Récif 3
resultatref3<-spread((dataR2=dataR %>% 
  filter(Site == ("recif3"))%>%
  filter(Micro %in% c("C1B1","C1B2","C1B3","C1B4","C1B5","C1B6","C1B7","C1B8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S) 
resultatref3[is.na(resultatref3)]<-0

ggradar(resultatref3[,-1],grid.min = 0,grid.mid=3,grid.max =6,values.radar = c(0,3,6),group.colours = lcol2,legend.title="Récif 3",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


##### Columns #####
# Récif 1
resultat2ref1<- spread((dataR2=dataR %>% 
  filter(Site == ("recif1"))%>%
  filter(Micro %in% c("C2P1","C2P2","C2P3","C2P4","C2P5","C2P6","C2P7","C2P8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S)
resultat2ref1[is.na(resultat2ref1)]<-0

ggradar(resultat2ref1[,-1],grid.min = 0,grid.mid=3,grid.max =5,values.radar = c(0,3,5),group.colours = lcol2,legend.title="récif 1",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


# Récif 2
resultat2ref2<- spread((dataR2=dataR %>% 
  filter(Site == ("recif2"))%>%
  filter(Micro %in% c("C2P1","C2P2","C2P3","C2P4","C2P5","C2P6","C2P7","C2P8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S)
resultat2ref2[is.na(resultat2ref2)]<-0

ggradar(resultat2ref2[,-1],grid.min = 0,grid.mid=3,grid.max =5,values.radar = c(0,3,5),group.colours = lcol2,legend.title="Récif 2",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


# Récif 3
resultat2ref3<- spread((dataR2=dataR %>% 
  filter(Site == ("recif3"))%>%
  filter(Micro %in% c("C2P1","C2P2","C2P3","C2P4","C2P5","C2P6","C2P7","C2P8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S) 
resultat2ref3[is.na(resultat2ref3)]<-0

ggradar(resultat2ref3[,-1],grid.min = 0,grid.mid=3,grid.max =5,values.radar = c(0,3,5),group.colours = lcol2,legend.title="Récif 3",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")

```

# Matrice de distance
```{r}
# Permet de calculer la distance entre le recouvrement de chaque espèce et le taux de recouvrement

levels(factor(dataR$Site))
# test=data_PQ_light %>% filter(Site=='DSC')


# data_comp2=data_PQ_light %>% ungroup %>% 
#   select(spp,Cov,Site,Micro,Date_courte,Structure2,Strcut_groups, Quad2) %>% 
#   filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte')) %>%
#   filter(!Structure2 %in% c('Dome','Holes','Upper_slots','Inner_slots')) %>% 
#   group_by(spp,Site,Micro,Date_courte,Structure2) %>% 
#   filter(!Structure2 %in% c('Dome','Upper_slots' )) %>% 
#     filter(!Site %in% c('Fe','DSC' )) %>% 
#   mutate(Sample=paste0(Site,'_',Date_courte,'_',
#                        Micro,'_',Quad2)) %>% 
#   group_by(Sample,Site,spp, Micro,Structure2,Strcut_groups, Date_courte) %>% 
#   dplyr::summarize(Mcov=mean(Cov)) %>% 
# 
#   group_by(Sample,Site,Micro,Date_courte,Structure2) %>% 
#   distinct() %>% drop_na() %>% 
#     spread(spp,Mcov) %>% ungroup() %>% 
#       mutate(across(everything(.), ~replace_na(., 0))) 

dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2023-07"] <- "été"
dataR$saison[dataR$saison == "2022-09" | dataR$saison == "2023-09"] <- "automne"

data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2,saison) %>% 
  group_by(spp,Site,Micro,Date_courte,Structure2,saison) %>% 
  distinct() %>% drop_na() %>% 
  spread(spp,Mcov) %>% ungroup() %>% 
  mutate(across(everything(.), ~replace_na(., 0))) 


# Comp_mat=data_comp2 %>% select(-c(Site,Sample,Micro,Structure2,Strcut_groups,Date_courte)) %>% as.matrix() 
# Meta_data=data_comp2 %>% select(Site,Sample,Micro,Structure2,Strcut_groups,Date_courte) #créer jeu de données avec les méta données
# distdataR<-vegdist(Comp_mat, method='bray') #library vegan - distance de Bray-Curtis, considéré face aux distances euclidiennes comme plus efficace pour les données écologiques

Comp_mat=data_comp2 %>% select(-c(Site,Micro,Structure2,Date_courte,saison)) %>% as.matrix() 
Meta_data=data_comp2 %>% select(Site,Micro,Structure2,Date_courte,saison) #créer jeu de données avec les méta données

distdataR<-vegdist(Comp_mat, method='bray') #library vegan - distance de Bray-Curtis, considéré face aux distances euclidiennes comme plus efficace pour les données écologiques


```

##  PCoA
```{r}
# Permet de représenter les données dans l'espace et voir les paramètres le plus la variance

pcoa_tot_SS<- cmdscale(d = as.matrix(distdataR),k=10, eig = T) 
x=pcoa_tot_SS$points[,1]
y=pcoa_tot_SS$points[,2]

plot(x,y) # <- ça fonctionne



# # Data frame pour rassembler les coordonnées de la PCOA + les metadata
# PCOA_df=data.frame(x=pcoa_tot_SS$points[,1],y=pcoa_tot_SS$points[,2],
#            Structure=Meta_data$Structure2,
#  Eig=pcoa_tot_SS$eig[1:2]/sum(pcoa_tot_SS$eig)
#

# ggplot(data=PCOA_df,aes(x,y, col=Struc_group))+ # <- Ici on explore avec col les variable qui explique le + l'explosion du nuage de points
#   # geom_point(aes(col=Site), size=1, alpha=.6)+
#   geom_point()+
#   geom_point(data=PCOA_df_mean,aes(Mx,My), size=5)+
#   geom_hline(yintercept=0)+
#   geom_vline(xintercept=0)+
#   theme_bw()

 
PCOA_df=data.frame(x=pcoa_tot_SS$points[,1],y=pcoa_tot_SS$points[,2],
                   Structure=Meta_data$Structure2,
                   Site=Meta_data$Site,
                   Date=Meta_data$Date_courte,
                   Saison=Meta_data$saison)

ggplot(data=PCOA_df,aes(x,y,colour=Site))+ # <- Ici on explore avec col les variable qui explique le + l'explosion du nuage de points
  # geom_point(aes(col=Site), size=1, alpha=.6)+
  geom_point()+
  labs(x="Axe 1 (29.6%)",y="Axe 2 (22.2%)")+
  geom_hline(yintercept=0)+
  geom_vline(xintercept=0)+
  theme_bw()

#PCoA avec les barycentres
s.class(PCOA_df[c(1:2)],as.factor(PCOA_df$Site),col=c("#f8766d","#619cff","#00ba38"),ellipseSize=0) # permet de faire le graph de l'PCoA avec des barycentres
s.class(PCOA_df[c(1:2)],droplevels(as.factor(PCOA_df$Structure)),col=c("#f8766d","#a4a304","#00b0f6","#e76bf3"),ellipseSize=0)
s.class(PCOA_df[c(1:2)],droplevels(as.factor(PCOA_df$Date)),col=c("#f8766d","#619cff","#00ba38"),ellipseSize=0)


# Apport de variance selon les axes
summaryPCOA<-data.frame(
  EIG= pcoa_tot_SS$eig,
  PCTVAR=100*pcoa_tot_SS$eig/sum(pcoa_tot_SS$eig),
  CUMPCTVAR = cumsum(100*pcoa_tot_SS$eig/sum(pcoa_tot_SS$eig)))

plot(summaryPCOA$PCTVAR[1:100],ylim=c(0,30),
        xlab="Composantes",ylab="Pourcentage d'inertie (explication de la variance)")


# Test importance des espèces dans l'explication de la variance 
vf <- envfit(pcoa_tot_SS, data_comp2, perm = 999)
spp.scrs <- as.data.frame(scores(vf, display = "vectors"))
spp.scrs2 <-(spp.scrs[which(vf$vectors$pvals<0.01),])
spp.scrs3 <- cbind(spp.scrs2, Abb = rownames(spp.scrs2))

```

## Permanova
```{r}
# Permet de voir s'il y a possibilité de regrouper les structures

data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2) %>% 
  group_by(spp,Site,Micro,Date_courte,Structure2) %>% 
  distinct() %>% drop_na() %>% 
  spread(spp,Mcov) %>% ungroup() %>% 
  mutate(across(everything(.), ~replace_na(., 0))) 

distdataR<-vegdist(Comp_mat, method='bray')

adonis2(distdataR~Structure2,data=data_comp2,permutations=999)

```


# Vitesse de colonisation
```{r}

dataR$nummois<-dataR$Date_courte
dataR$nummois[dataR$nummois == "2022-09"] <-71
dataR$nummois[dataR$nummois == "2023-07"] <-374 
dataR$nummois[dataR$nummois == "2023-09"] <-436 

# à utiliser avec les lignes de dataR$nummois d'avant
seq<-c(0,0)

dataR21=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,nummois) %>%
  filter(Site == "recif1") %>% 
  distinct()%>%
  group_by(Site,Structure2,Micro,nummois) %>%
  summarize(S=n()) %>%
  na.omit()

dataR31=dataR2 %>%
  group_by(Site,nummois) %>%
  summarize(S2 = mean(S))

dataR2recif1<-dataR31$Site[-1]
dataR31$nummois<-as.numeric(dataR31$nummois)
dataR31$S2<-as.numeric(dataR31$S2)
dataR31<-dataR31[,-1]
dataR211<-dataR31[order(dataR31$nummois),]
dataR3<-dataR211[-1,]-dataR211[-nrow(dataR211),]
dataR3$SparT<-dataR3$S/dataR3$nummois
dataR31<-rbind(seq,dataR3[,-2])



dataR22=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,nummois) %>%
  filter(Site == "recif2") %>% 
  distinct()%>%
  group_by(Site,Structure2,Micro,nummois) %>%
  summarize(S=n()) %>%
  na.omit()

dataR32=dataR22 %>%
  group_by(Site,nummois) %>%
  summarize(S2 = mean(S))

dataR2recif1<-dataR32$Site[-1]
dataR32$nummois<-as.numeric(dataR31$nummois)
dataR32$S2<-as.numeric(dataR32$S2)
dataR32<-dataR32[,-1]
dataR211<-dataR32[order(dataR32$nummois),]
dataR3<-dataR211[-1,]-dataR211[-nrow(dataR211),]
dataR3$SparT<-dataR3$S/dataR3$nummois
dataR32<-rbind(seq,dataR3[,-2])



dataR23=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,nummois) %>%
  filter(Site == "recif3") %>% 
  distinct()%>%
  group_by(Site,Structure2,Micro,nummois) %>%
  summarize(S=n()) %>%
  na.omit()

dataR33=dataR23 %>%
  group_by(Site,nummois) %>%
  summarize(S2 = mean(S))

dataR2recif1<-dataR33$Site[-1]
dataR33$nummois<-as.numeric(dataR31$nummois)
dataR33$S2<-as.numeric(dataR33$S2)
dataR33<-dataR33[,-1]
dataR211<-dataR33[order(dataR33$nummois),]
dataR3<-dataR211[-1,]-dataR211[-nrow(dataR211),]
dataR3$SparT<-dataR3$S/dataR3$nummois
dataR33<-rbind(seq,dataR3[,-2])


dataRjour<-dataR31$nummois
dataRjour1<-dataRjour[order(dataRjour)]


plot(dataR31$SparT~dataRjour1,col="red",xlim=c(0,310),ylim=c(-0.01,0.03),pch=19,xlab="Nombre de jours",ylab="Nombre d'espèces colonisant par jour")
par(new=T)
plot(dataR32$SparT~dataRjour1,col="blue",xlim=c(0,310),ylim=c(-0.01,0.03),pch=19,xlab="",ylab="")
par(new=T)
plot(dataR33$SparT~dataRjour1,col="green",xlim=c(0,310),ylim=c(-0.01,0.03),pch=19,xlab="",ylab="")
par(new=T)
lines(dataR31$SparT~dataRjour1,col="red",xlim=c(0,310),ylim=c(-0.01,0.03),pch=19,xlab="",ylab="")
lines(dataR32$SparT~dataRjour1,col="blue",xlim=c(0,310),ylim=c(-0.01,0.03),pch=19,xlab="",ylab="")
lines(dataR33$SparT~dataRjour1,col="green",xlim=c(0,310),ylim=c(-0.01,0.03),pch=19,xlab="",ylab="")
legend(x = "bottomright", legend = c("récif 1","récif 2","récif 3"),lty = 1, col = c("red","blue","green"),lwd = 2)

```




# Test comparaison site MARINEFF et GOELO

```{r}

dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Date_courte,Structure2) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Structure2) %>% #filtre selon le site, date et structure
  summarize(S=n())

dataR4=dataR3 %>% ungroup %>% 
  filter(!Date_courte=="2021-01") %>%
  select(spp,Site,Date_courte,Structure2) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Structure2) %>% #filtre selon le site, date et structure
  summarize(S=n())

dataR5<-rbind(dataR2,dataR4)


mixed.lmer <- lmer(S ~ Site + (1|Structure2/Date_courte), data = dataR5) 
summary(mixed.lmer)
plot_model(mixed.lmer,show.values = T,show.p = T)
```


# ### Indices Beta

## Indice de Shannon et Piélou
```{r}
# stabilité des communautés, 0 = 1 espèce prédominante sur sur le récif et 1 = équité de la répartion des espèces
#### indice de Shannon

#matrice présence/absence  par site par espèce
dataR2=dataR %>% ungroup %>%
  select(spp,Site,Day_delta) %>% 
  distinct()%>% 
  group_by(spp,Site,Day_delta) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR4<-spread((dataR3=dataR2 %>% 
  group_by(spp,Site,Day_delta) %>%
  summarize(S2 = mean(S))),key=spp,value=S2)
   # ),key=spp,value=S)
dataR4[is.na(dataR4)]<-0

shannonind<-diversity(dataR4[,-c(1:2)],index="shannon")
shannonind2<-cbind(dataR4[,c(1:2)],shannonind)
colnames(shannonind2)[3]<-"shannon"

#matrice couverture moyenne par site par espèce
dataR2=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Day_delta,Mcov) %>% 
  distinct()%>% 
  group_by(spp,Site,Structure2,Day_delta,Mcov)

dataR4<-spread((dataR3=dataR2 %>% 
  group_by(spp,Site,Day_delta) %>%
  summarize(Mcov2 = mean(Mcov))),key=spp,value=Mcov2) 
dataR4[is.na(dataR4)]<-0

# Calcul indice de Shannon
shannonind<-diversity(dataR4[,-c(1:2)],index="shannon")
shannonind2<-cbind(dataR4[,c(1:2)],shannonind)
colnames(shannonind2)[3]<-"shannon"

ggplot(shannonind2, aes(Day_delta,shannon, col=Site))+ # Avec "fill" ou "col" du peut ajout une séparation de tes données par facteur (ici le site)
  xlab("Jour depuis immersion")+
  ylab("Indice de Shannon")+
  # geom_jitter(alpha=.3)+  # On ajoute les points (pas nécessaire mais utile pour savoir sur quoi se base les boxplots)
  # geom_boxplot()+
  # geom_smooth()+
  geom_point()+
  geom_line(aes(group=Site))+
  theme_bw() 

#test calcul shannon max théorique
# propmax<-1/ncol(dataR4[,-1])
# shannonmax<- -sum(propmax*log(propmax))

#### indice de Piélou (indice de Shannon/Richesse spécifique)
Piélouind<-shannonind/log(27) #indice de shannon divisé par le nombre max de taxons sur un meme site
Piélouind2<-cbind(dataR4[,c(1:2)],Piélouind)
colnames(Piélouind2)[3]<-"Piélou"
ggplot(Piélouind2, aes(Day_delta,Piélou, col=Site))+ # Avec "fill" ou "col" du peut ajout une séparation de tes données par facteur (ici le site)
  xlab("Jour depuis immersion")+
  ylab("Indice de Piélou")+
  # geom_jitter(alpha=.3)+  # On ajoute les points (pas nécessaire mais utile pour savoir sur quoi se base les boxplots)
  # geom_boxplot()+
  geom_line(aes(group=Site))+
  geom_point()+
  theme_bw() 

```

## Calcul nestedness/replacement/richesse
```{r}

# été
# dataR2=dataR %>% ungroup %>%
#   filter(saison == 'été') %>% 
#   select(spp,Site,Day_delta) %>% 
#   distinct()%>% 
#   group_by(spp,Site,Day_delta) %>% 
#   summarize(S=n()) %>%
#   na.omit()
# 
# dataR4<-spread((dataR3=dataR2 %>% 
#   group_by(spp,Site,Day_delta) %>%
#   summarize(S2 = mean(S))),key=Site,value=S2) 
# dataR4[is.na(dataR4)]<-0


#### Mcov moyen
dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Micro,Date_courte,Structure2,Mcov) %>% 
  group_by(spp,Site,Micro,Date_courte,Structure2,Mcov) %>% 
  distinct() %>% drop_na() %>% 
    spread(spp,Mcov) %>% ungroup() %>% 
    mutate(across(everything(.), ~replace_na(., 0))) %>% 
    mutate(Name=paste(Site,Structure2,Date_courte,sep=",")) #prend les metas données de chaque ligne 

data_comp_mat=dataR2 %>% dplyr::select(-c(Site,Micro,Date_courte,Structure2,Name))

databetadiv2<-beta.div.comp(data_comp_mat,coef="S")





# Extraction des matrices
mat.D=as.matrix(databetadiv2$D)
mat.D[upper.tri(mat.D)]<-NA
diag(mat.D)<-NA
rownames(mat.D)<-dataR2$Name #change le nom des lignes avec les metadonnées
colnames(mat.D)<-dataR2$Name #change le nom des colonnes avec les metadonnées
 
mat.repl=as.matrix(databetadiv2$repl)
mat.repl[upper.tri(mat.repl)]<-NA
diag(mat.repl)<-NA
rownames(mat.repl)<-dataR2$Name #change le nom des lignes avec les metadonnées
colnames(mat.repl)<-dataR2$Name #change le nom des colonnes avec les metadonnées
 
mat.rich=as.matrix(databetadiv2$rich)
mat.rich[upper.tri(mat.rich)]<-NA
diag(mat.rich)<-NA
rownames(mat.rich)<-dataR2$Name #change le nom des lignes avec les metadonnées
colnames(mat.rich)<-dataR2$Name #change le nom des colonnes avec les metadonnées
 

# Transformation des matrices en df
test.mat.D=na.omit(reshape2::melt(mat.D)) %>% mutate(Type='D') 
test.mat.D2 <- test.mat.D %>%
  mutate(row_id = row_number()) %>%  # Créer une colonne pour identifier chaque ligne
  separate(Var1, into = paste0("Var1", 1:3), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 1 
  separate(Var2, into = paste0("Var2", 1:3), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 2
  select(-row_id)  # Supprimer la colonne d'identification
colnames(test.mat.D2)<-c("Site1","Structure1","Date1","Site2","Structure2","Date2","Dissimilarité","type")


test.mat.repl=na.omit(reshape2::melt(mat.repl)) %>% mutate(Type='repl')
test.mat.repl2 <- test.mat.repl %>%
  mutate(row_id = row_number()) %>%  # Créer une colonne pour identifier chaque ligne
  separate(Var1, into = paste0("Var1", 1:3), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 1 
  separate(Var2, into = paste0("Var2", 1:3), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 2
  select(-row_id)  # Supprimer la colonne d'identification
colnames(test.mat.repl2)<-c("Site1","Structure1","Date1","Site2","Structure2","Date2","Remplacement","type")


test.mat.rich=na.omit(reshape2::melt(mat.rich)) %>% mutate(Type='rich')
test.mat.rich2 <- test.mat.rich %>%
  mutate(row_id = row_number()) %>%  # Créer une colonne pour identifier chaque ligne
  separate(Var1, into = paste0("Var1", 1:3), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 1 
  separate(Var2, into = paste0("Var2", 1:3), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 2
  select(-row_id)  # Supprimer la colonne d'identification
colnames(test.mat.rich2)<-c("Site1","Structure1","Date1","Site2","Structure2","Date2","Richesse","type")


#Création jeu de données rassemblant les différentes données
datadissi<-test.mat.D2 %>% select(Site1,Structure1,Date1,Site2,Structure2,Date2,Dissimilarité) 
datarepl<-test.mat.repl2 %>% select(Site1,Structure1,Date1,Site2,Structure2,Date2,Remplacement) 
datarich<-test.mat.rich2 %>% select(Site1,Structure1,Date1,Site2,Structure2,Date2,Richesse)

datatern<-cbind(datadissi[,-c(5,7)],Similarité=(1-datadissi[,7])*100,Remplacement=100*datarepl[,7],Richesse=100*datarich[,7])
datatern<-cbind(datadissi[,-c(7)],Similarité=(1-datadissi[,7]),Remplacement=datarepl[,7],Richesse=datarich[,7])

```


### Ternary plot
```{r}

########## Test package gg plot ########## 
 #http://www.ggtern.com/d/2.2.0/

datatern2=datatern %>%
  # filter(Structure1 == 'Disc') %>% 
  # filter(Site1 == 'Bi') %>%
  filter(Site1 == Site2,
         # Structure1==Structure2
         ) %>%
     filter(Structure1!=Structure2) %>%
  # filter(Site2 == 'VB')
  # filter(Structure1 == "Di") %>% 
  filter(Date1 == '2022-09') %>%
  filter(Date2 == '2022-09') %>% 
  mutate(Comp_site=Site1,
         Comp_struct=Structure1) 
# %>% 
  # filter(Comp_struct =="Inner_slots")

datatern2=datatern2 %>% 
 mutate(Compasite<-paste(Site1,Site2,sep="/")) %>% 
  mutate(Compastruct<-paste(Structure1,Structure2,sep="/"))
colnames(datatern2)[12]<-"Compasite"
colnames(datatern2)[13]<-"Compastruct"


datamean<-datatern2 %>%  group_by(Comp_site,Comp_struct,Compastruct) %>%  #permet de faire la moyenne de chaque colonne par site/struct
  dplyr::summarize(Similarité=mean(Similarité),
            Remplacement=mean(Remplacement),
            Richesse=mean(Richesse))

# datamean<-as.data.frame(t(colMeans(datatern2[,c(6:8)]))) # faire la moyenne par rapport à une seule valeur


ggtern(data=datatern2, aes(x=Richesse,y=Similarité,z=Remplacement)) +
  geom_point(aes(colour=Compastruct), position=position_jitter_tern(x=0.1, y=0.1, z=0.1),alpha=.3) +
    # geom_point(aes(fill=Comp_struct), position=position_jitter_tern(x=0.1, y=0.1, z=0.1),alpha=.1) +
  # stat_density_tern( #ajout de la densité
           # geom="polygon",aes(fill=after_stat(level)),bins=10,color='grey')+
           # geom="polygon",aes(fill=(..level..)),bins=10,color='grey')+
           # geom="polygon",aes(fill=Structure1),bins=10,color='grey')+
           # geom="polygon",aes(fill=Compasite),bins=10,color='grey')+
  labs(title="")+
# theme_custom(  #https://rdrr.io/cran/ggtern/man/ggtern_themes.html
#   base_size = 10,
#   base_family = "",
#   tern.plot.background = NULL,
#   tern.panel.background = NULL,
#   col.T = "deepskyblue",
#   col.L = "green3",
#   col.R = "firebrick1",
#   col.grid.minor = "white"
# )+
  theme_hidetitles()+ #enlève le nom des axes
  theme_showarrows()+
  geom_crosshair_tern(data=datamean,aes(color=Compastruct))+
  facet_wrap(.~Comp_site)+
  labs(color = "Structures comparées")

```