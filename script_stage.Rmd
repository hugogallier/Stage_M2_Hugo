---
title: "script_analyse_test"
author: "Hugo Gallier"
date: "2024-01-23"
output: html_document
editor_options: 
  chunk_output_type: console
---


# Library

Package à télécharger
```{r}
rm(list=ls())

library(dplyr)
library(tidyr)
library(ggplot2)
library(here)


```

#################### Importation du data et chargement ###################

Identification des fichiers à charger
```{r}
setwd(here::here())



MPhoto=read.csv('Meta_photo.csv', sep=';')%>%
  # mutate(Micro=) %>%
  mutate(Micro=sub("\\_.*", "", Code_struct))
  
```

## Chargement data
Boucle de chargement des fichiers csv 
```{r}
setwd('D:/Hugo/suivi_scientifique') # à modifier avec nom de ton DD

data_list=list.files(pattern =".csv", recursive=T)

L=list()
for( i in 1: length(data_list)){
  
    Name_file=basename(data_list[i])

data=read.csv(data_list[i], sep=',', header=T, fileEncoding="latin1") %>%
  mutate(Name_file=rep(basename(data_list[i]), n()))

L[[i]]<-data

}

# fileEncoding="latin1"
```

## Date d'immersion
Ajout des dates d'immersion des différents récifs
```{r}
Immer_site=data.frame(Site=c('Bi','Bu','VB','Fe'), Date=c(as.Date('2020-10-30'),as.Date('2020-11-26'),as.Date('2020-11-27'),as.Date('2020-11-30'))) %>%
       mutate( Date_imm_ok=format(as.POSIXlt(Date,  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT")) %>% select(Site, Date_imm_ok)
         
```

## Saison - date

Data frame d'identification des saisons
```{r}

Date_sais=data.frame(
           start=c(
             format(as.POSIXlt(as.Date('2021-03-20'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-06-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-09-22'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-12-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
      format(as.POSIXlt(as.Date('2022-03-20'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
      format(as.POSIXlt(as.Date('2022-06-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
       format(as.POSIXlt(as.Date('2022-09-22'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT")))
```


## Mise en forme des données

Mise en forme des fichiers chargés:

-Ajout de métadata à partir du nom du fichier: site, date , micro env., Num quadrat ...
- Transformation format Date
- Correction nom taxon érroné
- Changements de noms des micro env.
- Regroupement des micro env dans structure internes vs externes
```{r}
# data_PQ[grepl('rndpts.csv.rndpts',data_PQ$Name_file),]

## ajout de categories à partir du nom de fichier

data_PQ=do.call(rbind,L) %>%
  mutate(Site=substr(Name_file, start = 1, stop = 2)) %>%
  # test2=substr(Name_file, start = 1, stop = 6))%>%
  # test3=sub("^([^_]*_[^_]*).*", "\\2", Name_file),
  separate(col = Name_file, into = c('Site','Date','Micro','truc','Quad'), sep = '_') %>%
  mutate( Site=ifelse(Site=='FR','Fe',Site),
          Quad=ifelse(is.na(Quad),truc,Quad),
          Quad2=substr(Quad, start = 1, stop = 2),
          Month_str=gsub("-.*", "", Date,perl=TRUE),
          YY=gsub(".*-", "", Date,perl=TRUE),
          Month=case_when( Month_str=='Avri'~'04',
                           Month_str=="Janv"~'01',
                           Month_str=='Juil'~'07',
                           Month_str=='Oct'~'10',
                           Month_str=='Nov'~'11'),
          Date_ok=format(as.POSIXlt(paste0('01/',Month,'/',YY),  format = "%d/%m/%y"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
          Date_courte=format(as.POSIXlt(paste0('01/',Month,'/',YY),  format = "%d/%m/%y"), format="%Y-%m", tz="GMT"),
          Week=strftime(Date_ok, format = "%V")) %>%
  mutate(spp.Name= ifelse(spp.Name == 'Tubularia indivisa ',
                          'Tubularia indivisa',spp.Name),
         spp.Name=ifelse(spp.Name == 'Unidentified',
                          'NI',spp.Name))
  

# Version synthétique du df

data_PQ_light=data_PQ %>% dplyr::select(Image, spp.Name,spp.ID,N.pts.per.species,Cov..per.species,
               N.pts.ALL.species,Cov..ALL.species, Site,Date_ok,Micro,Quad2,
               Week,Date_courte,Month_str )%>%
rename('spp'='spp.Name',
       'Count'='N.pts.per.species',
       'Cov'='Cov..per.species',
       'Count_all'='N.pts.ALL.species',
       'Cov_all'='Cov..ALL.species')%>%
  mutate(abb=abbreviate(spp))%>%
  left_join(MPhoto, by=c('Micro')) %>%
  mutate(Structure2=recode_factor(Structure,
   "Bandes"="Dome",
   "Bandes.C1"="Disc",
   "Faille"="Inner_slots",
   "Faille_coupole"="Upper_slots",
   "Pilier.C2"="Columns",
   "Trous"="Holes",
   "Pieds"="Pillars"))%>% 
  mutate(Strcut_groups=case_when(
  Structure2 %in% c('Dome','Upper_slots')~'Horizontal_section',
 Structure2 %in% c('Disc','Columns','Pillars')~'Vertical_section',
  Structure2 %in% c('Inner_slots','Holes')~'Inner_section',
 TRUE ~ 'NA')) %>%
  mutate(M_ensemble=ifelse(Micro %in% c("P1","P2","P3","T1","T2","T3","T4"),substr(Micro, start = 1, stop = 1),substr(Micro, start = 1, stop = 3)),
         M_ensemble2=ifelse(M_ensemble == 'DPF','DGF',M_ensemble))%>%
  left_join(Immer_site, by='Site') 


knitr::kable(data_PQ_light %>% select(spp,abb)%>% unique())
corresp=data_PQ_light %>% select(spp,abb)%>% unique()
```

Vérification que la colonne "strcut_groups" est correctement informée



#################### Réduction des colonnes et transformation des valeurs ####################
```{r}
dataR<-data_PQ_light
dataR<-dataR[,-c(1,6:7,15:23)]
dataR<-na.omit(dataR)#enlève les lignes ayant du NA (correspondant aux zones sans faune et flore béton)

dataR$spp<-as.factor(dataR$spp)
dataR$spp.ID<-as.factor(dataR$spp.ID)
dataR$Site<-as.factor(dataR$Site)
dataR$Micro<-as.factor(dataR$Micro)
dataR$Count<-as.numeric(dataR$Count)
dataR$Month_str<-as.factor(dataR$Month_str)
dataR$Month<-as.factor(dataR$Month)
dataR$Date_ok<-as.factor(dataR$Date_ok)
dataR$Date_courte<-as.factor(dataR$Date_courte)
dataR$Week<-as.factor(dataR$Week)
dataR$Quad2<-as.factor(dataR$Quad2)
str(dataR)
```


##### Indice de Simpson #####
```{r}
beta<-rep(0, times=106) #a utiliser en fonction des périodes/localisations,... souhaitées
for (i in 1:106){
  beta[i]<-simpson(dataR2$spp.ID==i)
}

```

##### Indice Alpha #####
```{r}
A<-table(dataR2$spp.ID) #a utiliser en fonction des périodes/localisations,... souhaitées
length(A)

##Test calcul selon micro habitat
# nrow(dataR2[dataR2$Micro=="C1B1" & dataR2$Month_str=="Juill",])

#Conditions
condition <- "C1B1"
# condition2 <- "C1B2"
# condition3 <- "C1B3"
# condition4 <- "C1B4"
# condition5 <- "C1B5"
# condition6 <- "C1B6"
# condition7 <- "C1B7"
# condition8 <- "C1B8"
# condition9 <- "C2B1"
# condition10<- "C2B2"
# condition11<- "C2B3"
# condition12<- "C2B4"
# condition13<- "C2B5"
# condition14<- "C2B6"
# condition15<- "C2B7"
# condition16<- "C2B8"

condition<-c("C1B1","C1B2","C1B3","C1B4","C1B5","C1B6","C1B7","C1B8","C2P1","C2P2","C2P3","C2P4","C2P5","C2P6","C2P7","C2P8","CGF1","CHG2","CGF3"
             ,"CGF4","CHB1","CHB2","CHB3","CHB4","CHB5","CHB6","CHB7","CHB8","CPF1","CPF2","CPF3","CPF4","DGF1","DGF2","DGF3","DGF4","DPF1","DPF2"
             ,"DPF3","DPF4","P1","P2","P3","T1","T2","T3","T4")
condition<-as.factor(condition)
conditiont <- c("2021-01","2021-04","2021-07","2021-10","2021-11","2022-01","2022-04","2022-07","2022-11")
conditiont<-as.factor(conditiont)
str(conditiont)
conditionr <- c("Bi","Bu","Fe","VB")
conditionr<-as.factor(conditionr)


#Filtrer les données selon les conditions
filtered_dataA <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont1, dataR$Site == conditionr1)
filtered_dataB <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont2, dataR$Site == conditionr1)
filtered_dataC <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont3, dataR$Site == conditionr1)

filtered_dataD <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont4, dataR$Site == conditionr2)
filtered_dataE <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont2, dataR$Site == conditionr2)
filtered_dataF <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont3, dataR$Site == conditionr2)

filtered_dataG <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont5, dataR$Site == conditionr3)
filtered_dataH <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont2, dataR$Site == conditionr3)
filtered_dataI <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont7, dataR$Site == conditionr3)

# Récupérer le nombre de variables différentes
A <- length(unique(unlist(filtered_dataA[,1])))#colonne où les variables doivent être différentes
B <- length(unique(unlist(filtered_dataB[,1])))#colonne où les variables doivent être différentes
C <- length(unique(unlist(filtered_dataC[,1])))#colonne où les variables doivent être différentes

D <- length(unique(unlist(filtered_dataD[,1])))
E <- length(unique(unlist(filtered_dataE[,1])))
F <- length(unique(unlist(filtered_dataF[,1])))

G <- length(unique(unlist(filtered_dataG[,1])))
H <- length(unique(unlist(filtered_dataH[,1])))
I <- length(unique(unlist(filtered_dataI[,1])))

C1B1table<-data.frame(Micro=rep(c(conditiont1,conditiont2,conditiont3),each=1),
                     alpha=rbind(A,B,C))
C1B1table2<-data.frame(Micro2=rep(c(conditiont4,conditiont2,conditiont3),each=1),
                     alpha2=rbind(D,E,F))
C1B1table3<-data.frame(Micro3=rep(c(conditiont4,conditiont2,conditiont3),each=1),
                     alpha3=rbind(G,H,I))

C1B1t<-cbind(C1B1table,C1B1table2,C1B1table3)

C1B1t[,1]<-as.factor(C1B1t[,1])
C1B1t[,2]<-as.numeric(C1B1t[,2])

plot(C1B1table$alpha~C1B1table$Micro,col="red")

ggplot(data=C1B1t)+
  geom_point(aes(x=Micro,y=alpha),col="red")+
  geom_point(aes(x=Micro2,y=alpha2),col="blue")+
  geom_point(aes(x=Micro3,y=alpha3),col="green")
```

```{r}
#association d'un microhabitat a un nombre
assigndata <- data.frame(
  variable_a_assigner = levels(dataR$Micro),
  valeur_associée = c(1:nlevels(dataR$Micro)))
# Utiliser la fonction factor pour obtenir les niveaux uniques
assigndata$variable_a_assigner <- as.integer(factor(assigndata$variable_a_assigner, levels = unique(assigndata$variable_a_assigner)))




Table<-rep(0,times=nlevels(dataR$Date_courte))

i<-1
j<-1
k<-1

for (i in 1:nlevels(dataR$Micro)){ #microhabitat
  for (j in 1:nlevels(dataR$Site)){ #récif
    for (k in 1:nlevels(dataR$Date_courte)){ #date

for (i in 1:nlevels(condition)){ #microhabitat
  for (j in 1:nlevels(conditionr)){ #récif
    for (k in 1:nlevels(conditiont)){ #date
      
filtered_dataA <- dataR %>% 
  filter(dataR$Micro == condition[i], dataR$Date_courte == conditiont[k], dataR$Site == conditionr[j])
# filtered_dataB <- dataR %>% 
#   filter(dataR$Micro == condition[i], dataR$Date_courte == conditiont[k], dataR$Site == conditionr[j])
# filtered_dataC <- dataR %>% 
#   filter(dataR$Micro == condition[i], dataR$Date_courte == conditiont[k], dataR$Site == conditionr[j])

A <- length(unique(unlist(filtered_dataA[,1])))#[,1]colonne où les variables doivent être différentes
# B <- length(unique(unlist(filtered_dataB[,1])))
# C <- length(unique(unlist(filtered_dataC[,1])))
}}}
Table[i]<-data.frame(Micro=rep(c(conditiont[k]),each=1),
                     alpha=rbind(Table,A))
}

      
Table[i]<-data.frame(Micro=rep(c(conditiont1),each=1),
                     alpha=rbind(A,B,C))
    }
  }
}
