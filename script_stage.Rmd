---
title: "script_analyse_test"
author: "Hugo Gallier"
date: "2024-01-23"
output: html_document
editor_options: 
  chunk_output_type: console
---


# Library

Package à télécharger
```{r}
rm(list=ls())

library(dplyr)
library(tidyr)
library(ggplot2)
library(here)
library(vegan)

```

#################### Importation du data et chargement ###################

Identification des fichiers à charger
```{r}
setwd(here::here())



MPhoto=read.csv('Meta_photo.csv', sep=';')%>%
  # mutate(Micro=) %>%
  mutate(Micro=sub("\\_.*", "", Code_struct))
  
```

## Chargement data
Boucle de chargement des fichiers csv 
```{r}
setwd('E:/Hugo/suivi_scientifique') # à modifier avec nom de ton DD
# setwd('E:/Marineff/suivi_scientifique')

data_list=list.files(pattern =".csv", recursive=T)

L=list()
for( i in 1: length(data_list)){
  
    Name_file=basename(data_list[i])

data=read.csv(data_list[i], sep=',', header=T, fileEncoding="latin1") %>%
  mutate(Name_file=rep(basename(data_list[i]), n()))

L[[i]]<-data

}

# fileEncoding="latin1"
```

## Date d'immersion
Ajout des dates d'immersion des différents récifs
```{r}
Immer_site=data.frame(Site=c('Bi','Bu','VB','Fe'), Date=c(as.Date('2020-10-30'),as.Date('2020-11-26'),as.Date('2020-11-27'),as.Date('2020-11-30'))) %>%
       mutate( Date_imm_ok=format(as.POSIXlt(Date,  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT")) %>% select(Site, Date_imm_ok)
         
```

## Saison - date

Data frame d'identification des saisons
```{r}

Date_sais=data.frame(
           start=c(
             format(as.POSIXlt(as.Date('2021-03-20'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-06-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-09-22'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-12-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
      format(as.POSIXlt(as.Date('2022-03-20'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
      format(as.POSIXlt(as.Date('2022-06-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
       format(as.POSIXlt(as.Date('2022-09-22'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT")))
```


## Mise en forme des données

Mise en forme des fichiers chargés:

-Ajout de métadata à partir du nom du fichier: site, date , micro env., Num quadrat ...
- Transformation format Date
- Correction nom taxon érroné
- Changements de noms des micro env.
- Regroupement des micro env dans structure internes vs externes
```{r}
# data_PQ[grepl('rndpts.csv.rndpts',data_PQ$Name_file),]

## ajout de categories à partir du nom de fichier

data_PQ=do.call(rbind,L) %>%
  mutate(Site=substr(Name_file, start = 1, stop = 2)) %>%
  # test2=substr(Name_file, start = 1, stop = 6))%>%
  # test3=sub("^([^_]*_[^_]*).*", "\\2", Name_file),
  separate(col = Name_file, into = c('Site','Date','Micro','truc','Quad'), sep = '_') %>%
  mutate( Site=ifelse(Site=='FR','Fe',Site),
          Quad=ifelse(is.na(Quad),truc,Quad),
          Quad2=substr(Quad, start = 1, stop = 2),
          Month_str=gsub("-.*", "", Date,perl=TRUE),
          YY=gsub(".*-", "", Date,perl=TRUE),
          Month=case_when( Month_str=='Avri'~'04',
                           Month_str=="Janv"~'01',
                           Month_str=='Juil'~'07',
                           Month_str=='Oct'~'10',
                           Month_str=='Nov'~'11'),
          Date_ok=format(as.POSIXlt(paste0('01/',Month,'/',YY),  format = "%d/%m/%y"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
          Date_courte=format(as.POSIXlt(paste0('01/',Month,'/',YY),  format = "%d/%m/%y"), format="%Y-%m", tz="GMT"),
          Week=strftime(Date_ok, format = "%V")) %>%
  mutate(spp.Name= ifelse(spp.Name == 'Tubularia indivisa ',
                          'Tubularia indivisa',spp.Name),
         spp.Name=ifelse(spp.Name == 'Unidentified',
                          'NI',spp.Name))
  

# Version synthétique du df

data_PQ_light=data_PQ %>% dplyr::select(Image, spp.Name,spp.ID,N.pts.per.species,Cov..per.species,
               N.pts.ALL.species,Cov..ALL.species, Site,Date_ok,Micro,Quad2,
               Week,Date_courte,Month_str )%>%
rename('spp'='spp.Name',
       'Count'='N.pts.per.species',
       'Cov'='Cov..per.species',
       'Count_all'='N.pts.ALL.species',
       'Cov_all'='Cov..ALL.species')%>%
  mutate(abb=abbreviate(spp))%>%
  left_join(MPhoto, by=c('Micro')) %>%
  mutate(Structure2=recode_factor(Structure,
   "Bandes"="Dome",
   "Bandes.C1"="Disc",
   "Faille"="Inner_slots",
   "Faille_coupole"="Upper_slots",
   "Pilier.C2"="Columns",
   "Trous"="Holes",
   "Pieds"="Pillars"))%>% 
  mutate(Strcut_groups=case_when(
  Structure2 %in% c('Dome','Upper_slots')~'Horizontal_section',
 Structure2 %in% c('Disc','Columns','Pillars')~'Vertical_section',
  Structure2 %in% c('Inner_slots','Holes')~'Inner_section',
 TRUE ~ 'NA')) %>%
  mutate(M_ensemble=ifelse(Micro %in% c("P1","P2","P3","T1","T2","T3","T4"),substr(Micro, start = 1, stop = 1),substr(Micro, start = 1, stop = 3)),
         M_ensemble2=ifelse(M_ensemble == 'DPF','DGF',M_ensemble))%>%
  left_join(Immer_site, by='Site') 


knitr::kable(data_PQ_light %>% select(spp,abb)%>% unique())
corresp=data_PQ_light %>% select(spp,abb)%>% unique()
```

Vérification que la colonne "strcut_groups" est correctement informée


# Partie Hugo
##Réduction des colonnes et transformation des valeurs
```{r}
dataR1<-data_PQ_light
dataR<-dataR1[,-c(1,6:7,15:23)]
dataR<-na.omit(dataR)#enlève les lignes ayant du NA (correspondant aux zones sans faune et flore béton)
# save(dataR,file="dataR.Rdata")

dataR$spp<-as.factor(dataR$spp)
dataR$spp.ID<-as.factor(dataR$spp.ID)
dataR$Site<-as.factor(dataR$Site)
dataR$Micro<-as.factor(dataR$Micro)
dataR$Count<-as.numeric(dataR$Count)
dataR$Month_str<-as.factor(dataR$Month_str)
dataR$Month<-as.factor(dataR$Month)
dataR$Date_ok<-as.factor(dataR$Date_ok)
dataR$Date_courte<-as.factor(dataR$Date_courte)
dataR$Week<-as.factor(dataR$Week)
dataR$Quad2<-as.factor(dataR$Quad2)
str(dataR)
```


# Indice de Simpson 
```{r}
beta<-rep(0, times=106) #a utiliser en fonction des périodes/localisations,... souhaitées
for (i in 1:106){
  beta[i]<-simpson(dataR2$spp.ID==i)
}

```

# Indice Alpha 
```{r}
A<-table(dataR2$spp.ID) #a utiliser en fonction des périodes/localisations,... souhaitées
length(A)

##Test calcul selon micro habitat
# nrow(dataR2[dataR2$Micro=="C1B1" & dataR2$Month_str=="Juill",])

#Conditions
condition <- "C1B1"
# condition2 <- "C1B2"
# condition3 <- "C1B3"
# condition4 <- "C1B4"
# condition5 <- "C1B5"
# condition6 <- "C1B6"
# condition7 <- "C1B7"
# condition8 <- "C1B8"
# condition9 <- "C2B1"
# condition10<- "C2B2"
# condition11<- "C2B3"
# condition12<- "C2B4"
# condition13<- "C2B5"
# condition14<- "C2B6"
# condition15<- "C2B7"
# condition16<- "C2B8"

condition<-c("C1B1","C1B2","C1B3","C1B4","C1B5","C1B6","C1B7","C1B8","C2P1","C2P2","C2P3","C2P4","C2P5","C2P6","C2P7","C2P8","CGF1","CHG2","CGF3"
             ,"CGF4","CHB1","CHB2","CHB3","CHB4","CHB5","CHB6","CHB7","CHB8","CPF1","CPF2","CPF3","CPF4","DGF1","DGF2","DGF3","DGF4","DPF1","DPF2"
             ,"DPF3","DPF4","P1","P2","P3","T1","T2","T3","T4")
condition<-as.factor(condition)
conditiont <- c("2021-01","2021-04","2021-07","2021-10","2021-11","2022-01","2022-04","2022-07","2022-11")
conditiont<-as.factor(conditiont)
str(conditiont)
conditionr <- c("Bi","Bu","Fe","VB")
conditionr<-as.factor(conditionr)


#Filtrer les données selon les conditions
filtered_dataA <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont1, dataR$Site == conditionr1)
filtered_dataB <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont2, dataR$Site == conditionr1)
filtered_dataC <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont3, dataR$Site == conditionr1)

filtered_dataD <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont4, dataR$Site == conditionr2)
filtered_dataE <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont2, dataR$Site == conditionr2)
filtered_dataF <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont3, dataR$Site == conditionr2)

filtered_dataG <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont5, dataR$Site == conditionr3)
filtered_dataH <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont2, dataR$Site == conditionr3)
filtered_dataI <- dataR %>% 
  filter(dataR$Micro == condition1, dataR$Date_courte == conditiont7, dataR$Site == conditionr3)

# Récupérer le nombre de variables différentes
A <- length(unique(unlist(filtered_dataA[,1])))#colonne où les variables doivent être différentes
B <- length(unique(unlist(filtered_dataB[,1])))#colonne où les variables doivent être différentes
C <- length(unique(unlist(filtered_dataC[,1])))#colonne où les variables doivent être différentes

D <- length(unique(unlist(filtered_dataD[,1])))
E <- length(unique(unlist(filtered_dataE[,1])))
F <- length(unique(unlist(filtered_dataF[,1])))

G <- length(unique(unlist(filtered_dataG[,1])))
H <- length(unique(unlist(filtered_dataH[,1])))
I <- length(unique(unlist(filtered_dataI[,1])))

C1B1table<-data.frame(Micro=rep(c(conditiont1,conditiont2,conditiont3),each=1),
                     alpha=rbind(A,B,C))
C1B1table2<-data.frame(Micro2=rep(c(conditiont4,conditiont2,conditiont3),each=1),
                     alpha2=rbind(D,E,F))
C1B1table3<-data.frame(Micro3=rep(c(conditiont4,conditiont2,conditiont3),each=1),
                     alpha3=rbind(G,H,I))

C1B1t<-cbind(C1B1table,C1B1table2,C1B1table3)

C1B1t[,1]<-as.factor(C1B1t[,1])
C1B1t[,2]<-as.numeric(C1B1t[,2])

plot(C1B1table$alpha~C1B1table$Micro,col="red")

ggplot(data=C1B1t)+
  geom_point(aes(x=Micro,y=alpha),col="red")+
  geom_point(aes(x=Micro2,y=alpha2),col="blue")+
  geom_point(aes(x=Micro3,y=alpha3),col="green")
```


# Comparaison intersite et intrasite
## Comparaison intersite 2021-2022 (pas de temporalité saisonalle)
```{r}
#Y'a t'il une différence de richesse taxonomique entre les différents micro habitats, et selon les différents sites ainsi que selon les années?
dataR<-dataR1[,-c(1,6:7,15:18,20:23)]
dataR<-na.omit(dataR)
dataR2=dataR %>% filter(!spp %in% c("NI","Unassigned")) %>% #enlèveles NI
  select(spp,Site,Date_courte,Structure2) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Structure2) %>% #filtre selon le site, date et structure
  summarize(S=n()) #créér une nouvelle colonne permettant de faire un summary des valeurs filtrées

#######################################
###################### Version Hugo ########
dataR2$Site<-as.factor(dataR2$Site)
dataR2$Date_courte<-as.factor(dataR2$Date_courte)
dataR2$S<-as.numeric(dataR2$S)

dataR2021<-dataR2[which(dataR2$Date_courte=="2021-01" | dataR2$Date_courte=="2021-04" | dataR2$Date_courte=="2021-07" 
                        | dataR2$Date_courte=="2021-10" | dataR2$Date_courte=="2021-11"),]

dataR2022<-dataR2[which(dataR2$Date_courte=="2022-01" | dataR2$Date_courte=="2022-04" | dataR2$Date_courte=="2022-07" 
                        | dataR2$Date_courte=="2022-11"),]

par(mfrow=c(1,1))
plot(dataR2021$S~dataR2021$Structure2,ylab="Richesse taxonomique",las=2,xlab="",ylim=c(0,22),main="Richesse taxonomique des récifs en 2021")#las permet de changer l'orientation des labels
plot(dataR2022$S~dataR2022$Structure2,ylab="Richesse taxonomique",las=2,xlab="",ylim=c(0,22),main="Richesse taxonomique des récifs en 2022")
```

#### Version Bruno

 On va simplement utiliser ggplot à partir du dataframe pour visualiser plusieurs choses rapidement

Pour comparer des "catégories" --> mieux utiliser les boxplot
Pour comparer des varations d'une variable dans le temps --> mieux vaut utiliser des courbes
```{r}

# Plot1: Visualition différences entre sites pour chaque micro habitat

ggplot(dataR2, aes(Structure2,S, fill=Site))+ # Avec "fill" ou "col" du peut ajout une séparation de tes données par facteur (ici le site)
  geom_jitter(alpha=.3)+  # On ajoute les points (pas nécessaire mais utile pour savoir sur quoi se base les boxplots)
  geom_boxplot()+
  theme_bw()  # Juste pour retirer le fond gris pas défaut (--> moche !)


# Plot 2 : Visualisation des différences de chaque micro habitat par Site

ggplot(dataR2, aes(Site,S, fill=Structure2))+ 
  geom_jitter(alpha=.3)+  
  geom_boxplot()+
  theme_bw() 


# Plot 3: Visualisation changement de S dans le temps, par Site et pour chaque micro habitat
ggplot(dataR2, aes(Date_courte,S, col=Site))+
  geom_point()+
  geom_line( aes(group=Site))+
  facet_wrap(.~Structure2)+ # <- cette fonction permet de réaliser les geoms précegents mais pour différentes catégories (ici j'ai choisi les micro habitat, mais on aurait pu le faire pour les sites par exemples)
  theme_bw()+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) # <- rotation des dates pour qu'elles soient lisibles
```


```{r}
#####Comparaison richesse taxo entre les 4 sites - 2021
par(mfrow=c(2,2))
plot(dataR2021$S[which(dataR2021$Site=="Bi")]~dataR2021$Structure2[which(dataR2021$Site=="Bi")],ylab="Richesse taxonomique",las=2,xlab="",main="2021 - Site Bi",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="Bu")]~dataR2021$Structure2[which(dataR2021$Site=="Bu")],ylab="Richesse taxonomique",las=2,xlab="",main="2021 - Site Bu",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="Fe")]~dataR2021$Structure2[which(dataR2021$Site=="Fe")],ylab="Richesse taxonomique",las=2,xlab="",main="2021 - Site Fe",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="VB")]~dataR2021$Structure2[which(dataR2021$Site=="VB")],ylab="Richesse taxonomique",las=2,xlab="",main="2021 - Site VB",ylim=c(0,20))#las permet de changer l'orientation des labels


#####Comparaison richesse taxo entre les 4 sites - 2022
par(mfrow=c(2,2))
plot(dataR2022$S[which(dataR2022$Site=="Bi")]~dataR2022$Structure2[which(dataR2022$Site=="Bi")],ylab="Richesse taxonomique",las=2,xlab="",main="2022 - Site Bi")#las permet de changer l'orientation des labels

plot(dataR2022$S[which(dataR2022$Site=="Bu")]~dataR2022$Structure2[which(dataR2022$Site=="Bu")],ylab="Richesse taxonomique",las=2,xlab="",main="2022 - Site Bu")#las permet de changer l'orientation des labels

plot(dataR2022$S[which(dataR2022$Site=="Fe")]~dataR2022$Structure2[which(dataR2022$Site=="Fe")],ylab="Richesse taxonomique",las=2,xlab="",main="2022 - Site Fe")#las permet de changer l'orientation des labels

plot(dataR2022$S[which(dataR2022$Site=="VB")]~dataR2022$Structure2[which(dataR2022$Site=="VB")],ylab="Richesse taxonomique",las=2,xlab="",main="2022 - Site VB")#las permet de changer l'orientation des labels

```


## Comparaison intrasite 2021-2022 (temporalité saisonnale)
```{r}
#Y'a t'il une différence de richesse taxonomique selon les microhabitats au sein d'un même récif au fil des inventaires?

dataR2021
dataR2022

####################
#      Site Bi     #
####################
########2021########
par(mfrow=c(3,2))
plot(dataR2021$S[which(dataR2021$Site=="Bi" | dataR2021$Date_courte=="2021-01")]~dataR2021$Structure2[which(dataR2021$Site=="Bi" | dataR2021$Date_courte=="2021-01")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bi - Janvier 2021",ylim=c(0,20))#las permet de changer l'orientation des labels
m<-mean(dataR2021$S[which(dataR2021$Site=="Bi" | dataR2021$Date_courte=="2021-01")])
sd<-sd(dataR2021$S[which(dataR2021$Site=="Bi" | dataR2021$Date_courte=="2021-01")])

plot(dataR2021$S[which(dataR2021$Site=="Bi" | dataR2021$Date_courte=="2021-04")]~dataR2021$Structure2[which(dataR2021$Site=="Bi" | dataR2021$Date_courte=="2021-04")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bi - Avril 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="Bi" | dataR2021$Date_courte=="2021-07")]~dataR2021$Structure2[which(dataR2021$Site=="Bi" | dataR2021$Date_courte=="2021-07")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bi - Juillet 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="Bi" | dataR2021$Date_courte=="2021-10")]~dataR2021$Structure2[which(dataR2021$Site=="Bi" | dataR2021$Date_courte=="2021-10")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bi - Octobre 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="Bi" | dataR2021$Date_courte=="2021-11")]~dataR2021$Structure2[which(dataR2021$Site=="Bi" | dataR2021$Date_courte=="2021-11")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bi - Novembre 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

########2022########
par(mfrow=c(2,2))
plot(dataR2022$S[which(dataR2022$Site=="Bi" | dataR2022$Date_courte=="2022-01")]~dataR2022$Structure2[which(dataR2022$Site=="Bi" | dataR2022$Date_courte=="2022-01")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bi - Janvier 2022",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2022$S[which(dataR2022$Site=="Bi" | dataR2022$Date_courte=="2022-04")]~dataR2022$Structure2[which(dataR2022$Site=="Bi" | dataR2022$Date_courte=="2022-04")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bi - Avril 2022",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2022$S[which(dataR2022$Site=="Bi" | dataR2022$Date_courte=="2022-07")]~dataR2022$Structure2[which(dataR2022$Site=="Bi" | dataR2022$Date_courte=="2022-07")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bi - Juillet 2022",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2022$S[which(dataR2022$Site=="Bi" | dataR2022$Date_courte=="2022-11")]~dataR2022$Structure2[which(dataR2022$Site=="Bi" | dataR2022$Date_courte=="2022-11")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bi - Novembre 2022",ylim=c(0,20))#las permet de changer l'orientation des labels


####################
#      Site Bu     #
####################
########2021########
par(mfrow=c(3,2))
plot(dataR2021$S[which(dataR2021$Site=="Bu" | dataR2021$Date_courte=="2021-01")]~dataR2021$Structure2[which(dataR2021$Site=="Bu" | dataR2021$Date_courte=="2021-01")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bu - Janvier 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="Bu" | dataR2021$Date_courte=="2021-04")]~dataR2021$Structure2[which(dataR2021$Site=="Bu" | dataR2021$Date_courte=="2021-04")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bu - Avril 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="Bu" | dataR2021$Date_courte=="2021-07")]~dataR2021$Structure2[which(dataR2021$Site=="Bu" | dataR2021$Date_courte=="2021-07")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bu - Juillet 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="Bu" | dataR2021$Date_courte=="2021-10")]~dataR2021$Structure2[which(dataR2021$Site=="Bu" | dataR2021$Date_courte=="2021-10")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bu - Octobre 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="Bu" | dataR2021$Date_courte=="2021-11")]~dataR2021$Structure2[which(dataR2021$Site=="Bu" | dataR2021$Date_courte=="2021-11")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bu - Novembre 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

########2022########
par(mfrow=c(2,2))
plot(dataR2022$S[which(dataR2022$Site=="Bu" | dataR2022$Date_courte=="2022-01")]~dataR2022$Structure2[which(dataR2022$Site=="Bu" | dataR2022$Date_courte=="2022-01")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bu - Janvier 2022",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2022$S[which(dataR2022$Site=="Bu" | dataR2022$Date_courte=="2022-04")]~dataR2022$Structure2[which(dataR2022$Site=="Bu" | dataR2022$Date_courte=="2022-04")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bu - Avril 2022",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2022$S[which(dataR2022$Site=="Bu" | dataR2022$Date_courte=="2022-07")]~dataR2022$Structure2[which(dataR2022$Site=="Bu" | dataR2022$Date_courte=="2022-07")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bu - Juillet 2022",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2022$S[which(dataR2022$Site=="Bu" | dataR2022$Date_courte=="2022-11")]~dataR2022$Structure2[which(dataR2022$Site=="Bu" | dataR2022$Date_courte=="2022-11")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Bu - Novembre 2022",ylim=c(0,20))#las permet de changer l'orientation des labels


####################
#      Site Fe     #
####################
########2021########
par(mfrow=c(3,2))
plot(dataR2021$S[which(dataR2021$Site=="Fe" | dataR2021$Date_courte=="2021-01")]~dataR2021$Structure2[which(dataR2021$Site=="Fe" | dataR2021$Date_courte=="2021-01")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Fe - Janvier 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="Fe" | dataR2021$Date_courte=="2021-04")]~dataR2021$Structure2[which(dataR2021$Site=="Fe" | dataR2021$Date_courte=="2021-04")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Fe - Avril 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="Fe" | dataR2021$Date_courte=="2021-07")]~dataR2021$Structure2[which(dataR2021$Site=="Fe" | dataR2021$Date_courte=="2021-07")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Fe - Juillet 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="Fe" | dataR2021$Date_courte=="2021-10")]~dataR2021$Structure2[which(dataR2021$Site=="Fe" | dataR2021$Date_courte=="2021-10")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Fe - Octobre 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="Fe" | dataR2021$Date_courte=="2021-11")]~dataR2021$Structure2[which(dataR2021$Site=="Fe" | dataR2021$Date_courte=="2021-11")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Fe - Novembre 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

########2022########
par(mfrow=c(2,2))
plot(dataR2022$S[which(dataR2022$Site=="Fe" | dataR2022$Date_courte=="2022-01")]~dataR2022$Structure2[which(dataR2022$Site=="Fe" | dataR2022$Date_courte=="2022-01")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Fe - Janvier 2022",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2022$S[which(dataR2022$Site=="Fe" | dataR2022$Date_courte=="2022-04")]~dataR2022$Structure2[which(dataR2022$Site=="Fe" | dataR2022$Date_courte=="2022-04")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Fe - Avril 2022",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2022$S[which(dataR2022$Site=="Fe" | dataR2022$Date_courte=="2022-07")]~dataR2022$Structure2[which(dataR2022$Site=="Fe" | dataR2022$Date_courte=="2022-07")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Fe - Juillet 2022",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2022$S[which(dataR2022$Site=="Fe" | dataR2022$Date_courte=="2022-11")]~dataR2022$Structure2[which(dataR2022$Site=="Fe" | dataR2022$Date_courte=="2022-11")],ylab="Richesse taxonomique",las=2,xlab="",main="Site Fe - Novembre 2022",ylim=c(0,20))#las permet de changer l'orientation des labels


####################
#      Site VB     #
####################
########2021########
par(mfrow=c(3,2))
plot(dataR2021$S[which(dataR2021$Site=="VB" | dataR2021$Date_courte=="2021-01")]~dataR2021$Structure2[which(dataR2021$Site=="VB" | dataR2021$Date_courte=="2021-01")],ylab="Richesse taxonomique",las=2,xlab="",main="Site VB - Janvier 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="VB" | dataR2021$Date_courte=="2021-04")]~dataR2021$Structure2[which(dataR2021$Site=="VB" | dataR2021$Date_courte=="2021-04")],ylab="Richesse taxonomique",las=2,xlab="",main="Site VB - Avril 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="VB" | dataR2021$Date_courte=="2021-07")]~dataR2021$Structure2[which(dataR2021$Site=="VB" | dataR2021$Date_courte=="2021-07")],ylab="Richesse taxonomique",las=2,xlab="",main="Site VB - Juillet 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="VB" | dataR2021$Date_courte=="2021-10")]~dataR2021$Structure2[which(dataR2021$Site=="VB" | dataR2021$Date_courte=="2021-10")],ylab="Richesse taxonomique",las=2,xlab="",main="Site VB - Octobre 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2021$S[which(dataR2021$Site=="VB" | dataR2021$Date_courte=="2021-11")]~dataR2021$Structure2[which(dataR2021$Site=="VB" | dataR2021$Date_courte=="2021-11")],ylab="Richesse taxonomique",las=2,xlab="",main="Site VB - Novembre 2021",ylim=c(0,20))#las permet de changer l'orientation des labels

########2022########
par(mfrow=c(2,2))
plot(dataR2022$S[which(dataR2022$Site=="VB" | dataR2022$Date_courte=="2022-01")]~dataR2022$Structure2[which(dataR2022$Site=="VB" | dataR2022$Date_courte=="2022-01")],ylab="Richesse taxonomique",las=2,xlab="",main="Site VB - Janvier 2022",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2022$S[which(dataR2022$Site=="VB" | dataR2022$Date_courte=="2022-04")]~dataR2022$Structure2[which(dataR2022$Site=="VB" | dataR2022$Date_courte=="2022-04")],ylab="Richesse taxonomique",las=2,xlab="",main="Site VB - Avril 2022",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2022$S[which(dataR2022$Site=="VB" | dataR2022$Date_courte=="2022-07")]~dataR2022$Structure2[which(dataR2022$Site=="VB" | dataR2022$Date_courte=="2022-07")],ylab="Richesse taxonomique",las=2,xlab="",main="Site VB - Juillet 2022",ylim=c(0,20))#las permet de changer l'orientation des labels

plot(dataR2022$S[which(dataR2022$Site=="VB" | dataR2022$Date_courte=="2022-11")]~dataR2022$Structure2[which(dataR2022$Site=="VB" | dataR2022$Date_courte=="2022-11")],ylab="Richesse taxonomique",las=2,xlab="",main="Site VB - Novembre 2022",ylim=c(0,20))#las permet de changer l'orientation des labels

```



###Test Shapiro/Levene/Anova
```{r}
library(rstatix)
dataR2021<-dataR2[which(dataR2$Date_courte=="2021-01" | dataR2$Date_courte=="2021-04" | dataR2$Date_courte=="2021-07" 
                        | dataR2$Date_courte=="2021-10" | dataR2$Date_courte=="2021-11"),]
dataR2021<-dataR2021[which(dataR2021$Site=="Bi"),]

# test_levene<-levene_test(S~Structure2)
model1<-lm(S~Structure2,data=dataR2021)
shapiro_test(residuals(model1))#si pvalue supérieure à 0,05 alors permet de dire que les résidus sont normalements distribuées

leveneTest(S~Structure2,data=dataR2021)#Si p value supérieur à 0,05 alors variance entre les groupes est égale

test_anova<-aov(S~factor(Site)*factor(Date_courte),data=dataR2022)#anova en prenant la date ainsi que les structures comme facteur
summary(test_anova)



```

# Comparaison intersite et temporelle
```{r}
load(file="dataR.Rdata")
dataR%>%filter(!spp=="NI")
dataRBi<-dataR[which(dataR$Site=="Bi"),]
dataRBu<-dataR[which(dataR$Site=="Bu"),]
dataRVb<-dataR[which(dataR$Site=="VB"),]
dataRFe<-dataR[which(dataR$Site=="Fe"),]


##### 01-2021 #####
dataR2021_01<-dataR[which(dataR$Date_courte=="2021-01"),]

filtered_dataI <- dataR2021_01 %>% 
  filter(dataR2021_01$Site == "Bi")
filtered_dataJ <- dataR2021_01 %>% 
  filter(dataR2021_01$Site == "Bu")
filtered_dataK <- dataR2021_01 %>% 
  filter(dataR2021_01$Site == "VB")
filtered_dataL <- dataR2021_01 %>% 
  filter(dataR2021_01$Site == "Fe")

I <- length(unique(unlist(filtered_dataI[,1])))#colonne où les variables doivent être différentes
J <- length(unique(unlist(filtered_dataJ[,1])))#colonne où les variables doivent être différentes
K <- length(unique(unlist(filtered_dataK[,1])))#colonne où les variables doivent être différentes
L <- length(unique(unlist(filtered_dataL[,1])))#colonne où les variables doivent être différentes


Table2021_01<-data.frame(Micro=rep(c("Bi","Bu","VB","Fe"),each=1),
                     Jan2021=rbind(I,J,K,L))

##### 04-2021 #####
dataR2021_04<-dataR[which(dataR$Date_courte=="2021-04"),]

filtered_dataM <- dataR2021_04 %>% 
  filter(dataR2021_04$Site == "Bi")
filtered_dataN <- dataR2021_04 %>% 
  filter(dataR2021_04$Site == "Bu")
filtered_dataO <- dataR2021_04 %>% 
  filter(dataR2021_04$Site == "VB")
filtered_dataP <- dataR2021_04 %>% 
  filter(dataR2021_04$Site == "Fe")

M <- length(unique(unlist(filtered_dataM[,1])))#colonne où les variables doivent être différentes
N <- length(unique(unlist(filtered_dataN[,1])))#colonne où les variables doivent être différentes
O <- length(unique(unlist(filtered_dataO[,1])))#colonne où les variables doivent être différentes
P <- length(unique(unlist(filtered_dataP[,1])))#colonne où les variables doivent être différentes


Table2021_04<-data.frame(Micro=rep(c("Bi","Bu","VB","Fe"),each=1),
                     Jan2021=rbind(M,N,O,P))

##### 07-2021 #####
dataR2021_07<-dataR[which(dataR$Date_courte=="2021-07"),]

filtered_dataQ <- dataR2021_07 %>% 
  filter(dataR2021_07$Site == "Bi")
filtered_dataR <- dataR2021_07 %>% 
  filter(dataR2021_07$Site == "Bu")
filtered_dataS <- dataR2021_07 %>% 
  filter(dataR2021_07$Site == "VB")
filtered_dataT <- dataR2021_07 %>% 
  filter(dataR2021_07$Site == "Fe")

Q <- length(unique(unlist(filtered_dataQ[,1])))#colonne où les variables doivent être différentes
R <- length(unique(unlist(filtered_dataR[,1])))#colonne où les variables doivent être différentes
S <- length(unique(unlist(filtered_dataS[,1])))#colonne où les variables doivent être différentes
T <- length(unique(unlist(filtered_dataT[,1])))#colonne où les variables doivent être différentes

Table2021_07<-data.frame(Micro=rep(c("Bi","Bu","VB","Fe"),each=1),
                     Jan2021=rbind(Q,R,S,T))

##### 10-2021 #####
dataR2021_10<-dataR[which(dataR$Date_courte=="2021-10"),]

filtered_dataU <- dataR2021_10 %>% 
  filter(dataR2021_10$Site == "Bi")
filtered_dataV <- dataR2021_10 %>% 
  filter(dataR2021_10$Site == "Bu")
filtered_dataW <- dataR2021_10 %>% 
  filter(dataR2021_10$Site == "VB")
filtered_dataX <- dataR2021_10 %>% 
  filter(dataR2021_10$Site == "Fe")

U <- length(unique(unlist(filtered_dataU[,1])))#colonne où les variables doivent être différentes
V <- length(unique(unlist(filtered_dataV[,1])))#colonne où les variables doivent être différentes
W <- length(unique(unlist(filtered_dataW[,1])))#colonne où les variables doivent être différentes
X <- length(unique(unlist(filtered_dataX[,1])))#colonne où les variables doivent être différentes

Table2021_10<-data.frame(Micro=rep(c("Bi","Bu","VB","Fe"),each=1),
                     Jan2021=rbind(U,V,W,X))

##### 11-2021 #####
dataR2021_11<-dataR[which(dataR$Date_courte=="2021-11"),]

filtered_dataA <- dataR2021_11 %>% 
  filter(dataR2021_11$Site == "Bi")
filtered_dataB <- dataR2021_11 %>% 
  filter(dataR2021_11$Site == "Bu")
filtered_dataC <- dataR2021_11 %>% 
  filter(dataR2021_11$Site == "VB")
filtered_dataC <- dataR2021_11 %>% 
  filter(dataR2021_11$Site == "Fe")

A <- length(unique(unlist(filtered_dataA[,1])))#colonne où les variables doivent être différentes
B <- length(unique(unlist(filtered_dataB[,1])))#colonne où les variables doivent être différentes
C <- length(unique(unlist(filtered_dataC[,1])))#colonne où les variables doivent être différentes
D <- length(unique(unlist(filtered_dataD[,1])))#colonne où les variables doivent être différentes

Table2021_11<-data.frame(Micro=rep(c("Bi","Bu","VB","Fe"),each=1),
                     Nov2021=rbind(A,B,C,D))

##### 01-2022 #####
dataR2022_01<-dataR[which(dataR$Date_courte=="2022-01"),]

filtered_dataAA <- dataR2022_01 %>% 
  filter(dataR2022_01$Site == "Bi")
filtered_dataBB <- dataR2022_01 %>% 
  filter(dataR2022_01$Site == "Bu")
filtered_dataCC <- dataR2022_01 %>% 
  filter(dataR2022_01$Site == "VB")
filtered_dataDD <- dataR2022_01 %>% 
  filter(dataR2022_01$Site == "Fe")

AA <- length(unique(unlist(filtered_dataAA[,1])))#colonne où les variables doivent être différentes
BB <- length(unique(unlist(filtered_dataBB[,1])))#colonne où les variables doivent être différentes
CC <- length(unique(unlist(filtered_dataCC[,1])))#colonne où les variables doivent être différentes
DD <- length(unique(unlist(filtered_dataDD[,1])))#colonne où les variables doivent être différentes

dataR2022_01<-data.frame(Micro=rep(c("Bi","Bu","VB","Fe"),each=1),
                     Jan2021=rbind(AA,BB,CC,DD))

##### 04-2022 #####
dataR2022_04<-dataR[which(dataR$Date_courte=="2022-04"),]

filtered_dataEE <- dataR2022_04 %>% 
  filter(dataR2022_04$Site == "Bi")
filtered_dataFF <- dataR2022_04 %>% 
  filter(dataR2022_04$Site == "Bu")
filtered_dataGG <- dataR2022_04 %>% 
  filter(dataR2022_04$Site == "VB")
filtered_dataHH <- dataR2022_04 %>% 
  filter(dataR2022_04$Site == "Fe")

EE <- length(unique(unlist(filtered_dataEE[,1])))#colonne où les variables doivent être différentes
FF <- length(unique(unlist(filtered_dataFF[,1])))#colonne où les variables doivent être différentes
GG <- length(unique(unlist(filtered_dataGG[,1])))#colonne où les variables doivent être différentes
HH <- length(unique(unlist(filtered_dataHH[,1])))#colonne où les variables doivent être différentes

dataR2022_04<-data.frame(Micro=rep(c("Bi","Bu","VB","Fe"),each=1),
                     Jan2021=rbind(EE,FF,GG,HH))

##### 07-2022 #####
dataR2022_07<-dataR[which(dataR$Date_courte=="2022-07"),]

filtered_dataII <- dataR2022_07 %>% 
  filter(dataR2022_07$Site == "Bi")
filtered_dataJJ <- dataR2022_07 %>% 
  filter(dataR2022_07$Site == "Bu")
filtered_dataKK <- dataR2022_07 %>% 
  filter(dataR2022_07$Site == "VB")
filtered_dataLL <- dataR2022_07 %>% 
  filter(dataR2022_07$Site == "Fe")

II <- length(unique(unlist(filtered_dataII[,1])))#colonne où les variables doivent être différentes
JJ <- length(unique(unlist(filtered_dataJJ[,1])))#colonne où les variables doivent être différentes
KK <- length(unique(unlist(filtered_dataKK[,1])))#colonne où les variables doivent être différentes
LL <- length(unique(unlist(filtered_dataLL[,1])))#colonne où les variables doivent être différentes

dataR2022_07<-data.frame(Micro=rep(c("Bi","Bu","VB","Fe"),each=1),
                     Jan2021=rbind(II,JJ,KK,LL))

##### 11-2022 #####
dataR2022_11<-dataR[which(dataR$Date_courte=="2022-11"),]

filtered_dataE <- dataR2022_11 %>% 
  filter(dataR2022_11$Site == "Bi")
filtered_dataF <- dataR2022_11 %>% 
  filter(dataR2022_11$Site == "Bu")
filtered_dataG <- dataR2022_11 %>% 
  filter(dataR2022_11$Site == "VB")
filtered_dataH <- dataR2022_11 %>% 
  filter(dataR2022_11$Site == "Fe")

E <- length(unique(unlist(filtered_dataE[,1])))#colonne où les variables doivent être différentes
F <- length(unique(unlist(filtered_dataF[,1])))#colonne où les variables doivent être différentes
G <- length(unique(unlist(filtered_dataG[,1])))#colonne où les variables doivent être différentes
H <- length(unique(unlist(filtered_dataH[,1])))#colonne où les variables doivent être différentes

Table2022_11<-data.frame(Micro=rep(c("Bi","Bu","VB","Fe"),each=1),
                     Nov2022=rbind(E,F,G,H))



########## Graphique ##########
TableCompRec<-cbind(Table2021_01,Table2021_04[,-1],Table2021_07[,-1],Table2021_10[,-1],Table2021_11[,-1],dataR2022_01[,-1],dataR2022_04[,-1]
                    ,dataR2022_07[,-1],Table2022_11[,-1])
TableCompRec[TableCompRec==0]<-NA
colnames(TableCompRec)<-c("Site","Jan_2021","Avr_2021","Juil_2021","Oct_2021","Nov_2021","Jan_2022","Avr_2022","Juil_2022","Nov_2022")
ggplot(data=TableCompRec)+
  geom_point(aes(x=Site,y=Jan_2021),col="red",size=3)+
  geom_point(aes(x=Site,y=Avr_2021),col="blue",size=3)+
  geom_point(aes(x=Site,y=Juil_2021),col="green",size=3)+
  geom_point(aes(x=Site,y=Oct_2021),col="black",size=3)+
  geom_point(aes(x=Site,y=Nov_2021),col="pink",size=3)+
  geom_point(aes(x=Site,y=Jan_2022),col="purple",size=3)+
  geom_point(aes(x=Site,y=Avr_2022),col="yellow",size=3)+
  geom_point(aes(x=Site,y=Juil_2022),col="orange",size=3)+
  geom_point(aes(x=Site,y=Nov_2022),col="darkgreen",size=3)+
  theme_classic()+ ylab("Diversité taxonomique")


```

#Test radar plot
```{r}
# devtools::install_github("ricardo-bion/ggradar")
library(ggradar)
dataR2=dataR %>% filter(!spp %in% c("NI","Unassigned")) %>%#enlève les NI
  filter(!Structure2 %in% c("Dome","Upper_slots")) %>%
  select(spp,Site,Date_courte,Structure2) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Structure2) %>% #filtre selon le site, date et structure
  summarize(S=n()) #créér une nouvelle colonne permettant de faire un summary des valeurs filtrées

dataR2021a<-dataR2[which(dataR2$Date_courte=="2021-01" & dataR2$Site=="Bi"),] 
dataR2021b<-dataR2[which(dataR2$Date_courte=="2021-04" & dataR2$Site=="Bi"),] 
dataR2021c<-dataR2[which(dataR2$Date_courte=="2021-07" & dataR2$Site=="Bi"),] 
# dataR2021d<-dataR2[which(dataR2$Date_courte=="2021-10" & dataR2$Site=="Bi"),] 
dataR2021e<-dataR2[which(dataR2$Date_courte=="2021-11" & dataR2$Site=="Bi"),] 
dataR2021f<-cbind(dataR2021a[,-c(1,2)],dataR2021b[,-c(1,2)],dataR2021c[,-c(1,2)],dataR2021e[,-c(1,2)])
dataR2021f<-dataR2021f[,-c(3,5,7)]
colnames(dataR2021f)<-c("Micro","Janvier","Avril","Juillet","Novembre")
dataR2021f$Janvier<-as.numeric(dataR2021f$Janvier)
dataR2021f$Avril<-as.numeric(dataR2021f$Avril)
dataR2021f$Juillet<-as.numeric(dataR2021f$Juillet)
dataR2021f$Novembre<-as.numeric(dataR2021f$Novembre)

ggradar(dataR2021f,grid.min = 0,grid.max =22)
```