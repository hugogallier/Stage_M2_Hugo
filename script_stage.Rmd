---
title: "script_analyse_test"
author: "Hugo Gallier"
date: "2024-01-23"
output: html_document
editor_options: 
  chunk_output_type: console
---


# Library

Package à télécharger
```{r}
rm(list=ls())

library(dplyr)
library(tidyr)
library(ggplot2)
library(here)
library(vegan)
library(scales)
library(fmsb)
library(FactoMineR)
library(ecodist)
library(ade4)
library(lme4)
library(Matrix)
library(sjPlot)
library(RColorBrewer)
library(iNEXT)
library(rstatix)
library(ggradar)
library(pairwiseAdonis)
library(ecole)
library(tidyverse)
library(mgcv)
library(ggforce)
library(tidymv)
library(ggtern)
library(codyn)
library(adespatial)
library(ggdendro)
library(car)
library(adegraphics)
library(gratia)
library(ggpubr)
library(paletteer)
library(indicspecies)

```


#################### Importation du data et chargement ###################

```{r}
#Chargement des photos associées à chaque cadrats

setwd(here::here())

MPhoto=read.csv('Meta_photo.csv', sep=';')%>%
  # mutate(Micro=) %>%
  mutate(Micro=sub("\\_.*", "", Code_struct))
  
```

## Chargement data

```{r}
#Chargement des jeux de données

setwd('D:/Hugo/suivi_scientifique') # à modifier avec nom de ton DD
# setwd('E:/Marineff/suivi_scientifique')

data_list=list.files(pattern =".csv", recursive=T)

L=list()
for( i in 1: length(data_list)){
  
    Name_file=basename(data_list[i])

data=read.csv(data_list[i], sep=',', header=T, fileEncoding="latin1") %>%
  mutate(Name_file=rep(basename(data_list[i]), n()))

L[[i]]<-data
}


test_data_list=data_list[grepl('DSC',data_list)]


# fileEncoding="latin1"
```

## Date d'immersion

```{r}
# Ajout des dates d'immersion des différents récifs

Immer_site=data.frame(Site=c('Bi','Bu','VB','Fe'), Date=c(as.Date('2020-10-30'),as.Date('2020-11-26'),as.Date('2020-11-27'),as.Date('2020-11-30'))) %>%
       mutate(Date_imm_ok=format(as.POSIXlt(Date,  format = "%Y-%m-%d"), format="%Y-%m-%d", tz="GMT")) %>% select(Site, Date_imm_ok)
     
# Date=c(as.Date('2020-10-30'),as.Date('2020-11-26'),as.Date('2020-11-27'),as.Date('2020-11-30'))) %>%
       # mutate(Date_imm_ok=format(as.POSIXlt(Date,  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT")) %>% select(Site, Date_imm_ok)    
```


## Saison - date

```{r}
# Ajout de dates correspondant aux différentes saisons
Date_sais=data.frame(
           start=c(
             format(as.POSIXlt(as.Date('2021-03-20'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-06-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-09-22'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-12-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2022-03-20'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2022-06-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2022-09-22'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT")))
```



## Mise en forme des données

```{r}
# Ajout de méta données à partir du nom de fichier (site,data,micro,n° de quadrat)
# Correction et abbréviation des noms de taxons
# Changements des noms des microhabitats
# Changements du format des dates


# test_dataPQ=data_PQ[grepl('DSC',data_PQ$Name_file),]

data_PQ=do.call(rbind,L) %>%
  mutate(Site=substr(Name_file, start = 1, stop = 2)) %>%
  separate(col = Name_file, into = c('Site','Date','Micro','truc','Quad'), sep = '_') %>%
  mutate( Site=ifelse(Site=='FR','Fe',Site),
          Quad=ifelse(is.na(Quad),truc,Quad),
          Quad2=substr(Quad, start = 1, stop = 2),
          Month_str=gsub("-.*", "", Date,perl=TRUE),
          YY=gsub(".*-", "", Date,perl=TRUE),
          Month=case_when( Month_str=='Avri'~'04',
                           Month_str=='avri'~'04',
                           Month_str=="Janv"~'01',
                           Month_str=='Juil'~'07',
                           Month_str=='Oct'~'10',
                           Month_str=='Nov'~'11'),
          Date_ok=format(as.POSIXlt(paste0('01/',Month,'/',YY),  format = "%d/%m/%y"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
          Date_courte=format(as.POSIXlt(paste0('01/',Month,'/',YY),  format = "%d/%m/%y"), format="%Y-%m", tz="GMT"),
          Week=strftime(Date_ok, format = "%V")) %>%
  mutate(spp.Name= ifelse(spp.Name == 'Tubularia indivisa ', 'Tubularia indivisa',spp.Name),
         spp.Name=ifelse(spp.Name == 'Unidentified','NI',spp.Name))
  



# Version synthétique du df

data_PQ_light=data_PQ %>% dplyr::select(Image, spp.Name,spp.ID,N.pts.per.species,Cov..per.species,
               N.pts.ALL.species,Cov..ALL.species, Site,Date_ok,Micro,Quad2,
               Week,Date_courte,Month_str )%>%
rename('spp'='spp.Name',
       'Count'='N.pts.per.species',
       'Cov'='Cov..per.species',
       'Count_all'='N.pts.ALL.species',
       'Cov_all'='Cov..ALL.species')%>%
  mutate(abb=abbreviate(spp))%>%
   group_by(spp,abb,Site,Micro,Date_courte,Date_ok,Quad2) %>%
  summarize(Mcov=mean(Cov)) %>%
  # summarize(MCount=mean(Count)) %>%
  left_join(MPhoto, by=c('Micro')) %>%
  mutate(Structure2=recode_factor(Structure,
   "Bandes"="Dome",
   "Bandes.C1"="Disc",
   "Faille"="Inner_slots",
   "Faille_coupole"="Upper_slots",
   "Pilier.C2"="Columns",
   "Trous"="Holes",
   "Pieds"="Pillars"))%>% 
  mutate(Strcut_groups=case_when(
  Structure2 %in% c('Dome','Upper_slots')~'Horizontal_section',
 Structure2 %in% c('Disc','Columns','Pillars')~'Vertical_section',
  Structure2 %in% c('Inner_slots','Holes')~'Inner_section', TRUE ~ 'NA')) %>%
  mutate(M_ensemble=ifelse(Micro %in% c("P1","P2","P3","T1","T2","T3","T4"),substr(Micro, start = 1, stop = 1),substr(Micro, start = 1, stop = 3)),
         M_ensemble2=ifelse(M_ensemble == 'DPF','DGF',M_ensemble))%>%
  left_join(Immer_site, by='Site') %>% 
    mutate(spp=replace_na(spp,"None"))
 

knitr::kable(data_PQ_light %>% select(spp,abb)%>% unique())
corresp=data_PQ_light %>% select(spp,abb)%>% unique()
```

<!-- export le jeu de données en csv -->
<!-- write.csv(data_PQ_light,"data_semibrute.csv") -->
<!-- write.csv(dataR,"data_utilise.csv") -->
<!-- write.csv(dataR4,"matrice_de_presence.csv") -->

# #######################

# ###### Partie Hugo ######
# Formatage du jeu de données 
```{r}
#Calcul du temps depuis l'immersion
data_PQ_light=data_PQ_light %>% 
   mutate(Day_delta=as.numeric(difftime(Date_ok,Date_imm_ok,units='days')))

dataR1<-data_PQ_light
dataR=dataR1 %>% filter(!spp %in% c("NI","Unassigned","ponte","Ponte",'None','NA')) %>%
  filter(!Micro %in% c('C2P3.rndpts.csv','C2P4.rndpts.csv','C2P6.rndpts.csv')) %>% 
  filter(!Site == ("DSC"))%>%
  filter(!Structure2 %in% c('Holes','Upper_slots','Dome')) %>% 
  # filter(!Date_courte == '2021-01') %>%
  select (spp,abb,Site,Structure2,Micro,Date_courte,Mcov,Day_delta,Quad2)
  # select (spp,abb,Site,Micro,Date_courte,Structure2,MCount)

# save(dataR,file="dataR.Rdata")



#####permet de faire la moyenne du nombre de taxon dans chaque micro
# dataR2=dataR %>% ungroup %>% 
#   select(spp,Site,Structure2,Micro,Date_courte) %>% 
#   distinct()%>% 
#   group_by(Site,Structure2,Micro,Date_courte) %>% 
#   summarize(S=n()) %>%
#   na.omit()
# 
# dataR3=dataR2 %>% 
#   group_by(Site,Structure2,Date_courte) %>% 
#   summarize(mean__count = mean(S))
# 
# 
#####permet de faire la moyenne du nombre de taxon dans chaque structure 
# dataR2=dataR %>% ungroup %>% 
#   select(spp,Site,Structure2,Date_courte) %>% 
#   distinct()%>% 
#   group_by(Site,Structure2,Date_courte) %>% 
#   summarize(S=n()) %>%
#   na.omit()
# 
# dataR3=dataR2 %>% 
#   group_by(Site,Date_courte) %>% 
#   summarize(mean__count = mean(S))

```


# ### Indice Gamma
```{r}
# Quel est la richesse taxonomique global (Indice Gamma) d'un site et de la zone d'étude en général

# Indice gamma par site 
dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Date_courte) %>% 
  filter(Date_courte  %in% c('2021-04','2021-07','2021-10','2021-11')) %>%
  filter(Site == "Fe") %>%
  distinct()%>% 
  group_by(spp,Date_courte,Site) %>% 
  summarize(S=n()) %>%
  na.omit()
length(unique(dataR2$spp))


seq<-rep(0,times=nrow(dataR))
dataR
dataR2=dataR %>% 
  select(spp,Site) %>% 
  distinct() %>% 
  group_by(spp,Site) %>% 
  summarize(S=n()) 
length(unique(dataR2$spp))


# Indice gamma Quad2# Indice gamma global
dataR2=dataR %>% 
  select(spp,seq1) %>% 
  distinct() %>% 
  group_by(seq1) %>% 
  summarize(S=n()) 


length(unique(dataR1$spp))#permet de savoir le nombre de variable différente dans la colonne spp (mais ne prend pas en compte la suppression des N)

```


# ### Indice Alpha 


# Comparaison intersite et intrasite
## Comparaison intersite 2021-2022 (pas de temporalité saisonalle)
```{r}
#Y'a t'il une différence de richesse taxonomique entre les différents micro habitats, et selon les différents sites ainsi que selon les années?

#permet de faire la moyenne du nombre de taxon dans chaque micro
dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Date_courte) %>% 
  distinct()%>% 
  group_by(Site,Structure2,Micro,Date_courte) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR3=dataR2 %>% 
  group_by(Site,Structure2,Date_courte) %>% 
  summarize(S2 = mean(S))
# dataR3$S2[which(dataR3$Structure2=='Pillars')]<-(dataR3$S2[which(dataR3$Structure2=='Pillars')]/2)

ggplot(dataR3, aes(Structure2,S2, fill=Site))+ # Avec "fill" ou "col" du peut ajout une séparation de tes données par facteur (ici le site)
  xlab("Structure")+
  ylab("Richesse taxonomique moyenne")+
  geom_jitter(alpha=.3)+  # On ajoute les points (pas nécessaire mais utile pour savoir sur quoi se base les boxplots)
  geom_boxplot()+
  theme_bw()+  # Juste pour retirer le fond gris pas défaut
stat_summary(fun.y = mean,
        geom = "point",
        size = 2,
        color = "black",
        position = position_dodge(width = .75))

```

###Test Shapiro/Levene/Anova
```{r}
# Y'a t-il des différences statistiques concerannt les sites/structurse/microhabitats,... ?

dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"

dataR2=dataR %>% ungroup %>% 
  filter(!Date_courte %in% c("2021-04","2021-07","2021-10","2021-11")) %>%
  select(spp,Site,Structure2,Micro,Day_delta,saison) %>% 
  distinct()%>% 
  group_by(Site,Structure2,Micro,Day_delta,saison) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR3=dataR2 %>% 
  group_by(Site,Structure2,Day_delta,saison) %>% 
  summarize(S2 = mean(S))

dataR3$Site<-as.factor(dataR3$Site)
dataR3$saison<-as.factor(dataR3$saison)


#Anova
test_anova<-aov(S2~Site+Structure2+saison,data=dataR3)# anova en prenant la date ainsi que les structures comme facteur
test_anova<-aov(S2~Site+Error(Day_delta),data=dataR3)# en prenant en variable aléatoire day delta
test_anova<-aov(S2~Site+Error(Structure2),data=dataR3)
test_anova<-aov(S2~Site,data=dataR3)
summary(test_anova)


#normalité des données
shapiro_test(residuals(test_anova))#si pvalue supérieure à 0,05 alors permet de dire que les résidus sont normalements distribuées
# qqnorm(test_anova$residuals)
# qqline(test_anova$residuals)


#Homoscédasticité
leveneTest(test_anova$residuals,dataR3)#Si p value supérieur à 0,05 alors variance entre les groupes est égale
test_levene<-levene_test(dataR3$S2~dataR3$Site+Structure2+dataR3$saison)
plot(test_anova$residuals~test_anova$fitted.values)

```

## Comparaison intersite (microhabitats confondus) temporelle
```{r}
# Comment évolue la richesse taxonomique des sites dans le temps?

#permet de faire la moyenne du nombre de taxon dans chaque micro
dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Date_courte) %>% 
  distinct()%>% 
  group_by(Site,Structure2,Date_courte) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR3=dataR2 %>% 
  group_by(Site,Date_courte) %>% 
  summarize(S2 = mean(S))


ggplot(dataR3, aes(Date_courte,S2, col=Site))+
  xlab("Date")+
  ylab("Richesse taxonomique")+
  geom_point()+
  geom_line(aes(group=Site))+
  # facet_wrap(.~Site)+ # <- cette fonction permet de réaliser les geoms précedents mais pour différentes catégories (ici j'ai choisi les micro habitat, mais on aurait pu le faire pour les sites par exemples)
  theme_bw()+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) # <- rotation des dates pour qu'elles soient lisibles

```

## Comparaison intersite des microhabitats - temporelle
```{r}
# Y'a t'il une différence temporelle dans l'évolution de la richesse taxnomique des microhabitats?

dataR2=dataR %>% ungroup %>% 
  filter(!Date_courte=="2021-01") %>%
  select(spp,Site,Date_courte,Structure2) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Structure2) %>% 
  summarize(S=n()) %>% 
  na.omit()


ggplot(dataR2 %>%  
  filter(!Date_courte=="2021-01"), 
  aes(Date_courte,S, col=Site))+
  xlab("Date")+
  ylab("Richesse taxonomique")+
  geom_point()+
  geom_line(aes(group=Site))+
  facet_wrap(.~Structure2)+ 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

```

# # Radar plot
```{r}
#Y a t'il une colonisation prédominante sur les différentes parties des récifs?

# https://r-charts.com/ranking/ggradar/
# devtools::install_github("ricardo-bion/ggradar")


##### Bottom disc #####
lcol2<-brewer.pal(8,"Reds")
lcol2<-c('#FEE0D2','#FCBBA1','#FC9272','#FB6A4A','#EF3B2C','#CB181D','#99000D','#59040c')

# Bi
resultat4Bi<- na.omit(spread((dataR2=dataR %>% 
  filter(!Date_courte == ("2021-01"))%>%
  filter(Site == ("Bi"))%>%
  filter(Micro %in% c("C1B1","C1B2","C1B3","C1B4","C1B5","C1B6","C1B7","C1B8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S)) 
resultat4Bi[is.na(resultat4Bi)]<-0

ggradar(resultat4Bi[,-1],grid.min = 0,grid.mid=7,grid.max =15,values.radar = c(0,7,15),group.colours = lcol2[c(1,2,4:8)],legend.title="Site Bi",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


# Bu
resultat4Bu<- na.omit(spread((dataR2=dataR %>% 
  filter(!Date_courte == ("2021-01"))%>%
  filter(Site == ("Bu"))%>%
  filter(Micro %in% c("C1B1","C1B2","C1B3","C1B4","C1B5","C1B6","C1B7","C1B8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S)) 
resultat4Bu[is.na(resultat4Bu)]<-0

ggradar(resultat4Bu[,-1],grid.min = 0,grid.mid=7, grid.max =15,values.radar = c(0,7,15),group.colours = lcol2[c(2,4,6,8)],legend.title="Site Bu",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")

# Fe
resultat4Fe<- na.omit(spread((dataR2=dataR %>%
  filter(!Date_courte == ("2021-01"))%>%
  filter(Site == ("Fe"))%>%
  filter(Micro %in% c("C1B1","C1B2","C1B3","C1B4","C1B5","C1B6","C1B7","C1B8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S)) 
resultat4Fe[is.na(resultat4Fe)]<-0

ggradar(resultat4Fe[,-1],grid.min = 0,grid.mid=7,grid.max =15,values.radar = c(0,7,15),group.colours = lcol2[c(1,4,5,6,7)], legend.title="Site Fe",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


# VB
resultat4VB<- na.omit(spread((dataR2=dataR %>%
  filter(!Date_courte == ("2021-01"))%>%
  filter(Site == ("VB"))%>%
  filter(Micro %in% c("C1B1","C1B2","C1B3","C1B4","C1B5","C1B6","C1B7","C1B8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S))
resultat4VB[is.na(resultat4VB)]<-0

ggradar(resultat4VB[,-1],grid.min = 0,grid.mid= 7,grid.max =15,values.radar = c(0,7,15),group.colours =lcol2[c(1:5,7:8)], legend.title="Site VB",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")

##### Columns #####
par(mfrow=c(2,2))
#Bi
resultat3Bi<- na.omit(spread((dataR2=dataR %>% 
  filter(!Date_courte == ("2021-01"))%>%
  filter(Site == ("Bi"))%>%
  filter(Micro %in% c("C2P1","C2P2","C2P3","C2P4","C2P5","C2P6","C2P7","C2P8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S)) 
resultat3Bi[is.na(resultat3Bi)]<-0

ggradar(resultat3Bi[,-1],grid.min = 0,grid.max =10,grid.mid=5,values.radar = c(0,5,10),group.colours =lcol2[c(1,4,5,6,8)],legend.title="Site Bi",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


#Bu
resultat3Bu<- na.omit(spread((dataR2=dataR %>%
  filter(Site == ("Bu"))%>%
  filter(Micro %in% c("C2P1","C2P2","C2P3","C2P4","C2P5","C2P6","C2P7","C2P8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S))
resultat3Bu[is.na(resultat3Bu)]<-0

ggradar(resultat3Bu[,-1],grid.min = 0,grid.max =10,grid.mid=5,values.radar = c(0,5,10),group.colours =lcol2[c(1,2,4,5,8)],legend.title="Site Bu",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


#Fe
resultat3Fe<- na.omit(spread((dataR2=dataR %>% 
  filter(!Date_courte == ("2021-01"))%>%
  filter(Site == ("Fe"))%>%
  filter(Micro %in% c("C2P1","C2P2","C2P3","C2P4","C2P5","C2P6","C2P7","C2P8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S))
resultat3Fe[is.na(resultat3Fe)]<-0

ggradar(resultat3Fe[,-1],grid.min = 0,grid.max =10,grid.mid=5,values.radar = c(0,5,10),group.colours =lcol2[c(1,5,7)] ,legend.title="Site Fe",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


#VB
resultat3VB<- na.omit(spread((dataR2=dataR %>%
  filter(!Date_courte == ("2021-01"))%>%
  filter(Site == ("VB"))%>%
  filter(Micro %in% c("C2P1","C2P2","C2P3","C2P4","C2P5","C2P6","C2P7","C2P8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S))
resultat3VB[is.na(resultat3VB)]<-0

ggradar(resultat3VB[,-1],grid.min = 0,grid.max =10,grid.mid=5,values.radar = c(0,5,10),group.colours =lcol2[c(1:3,5,6,8)] ,legend.title="Site VB",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


```


# # Utilisation des modèles
## Linear mixed model
```{r}
#Permet de montrer la significativité des valeurs selon des variables aléatoires

#permet de faire la moyenne du nombre de taxon dans chaque micro

dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"

dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Date_courte,saison) %>% 
  distinct()%>% 
  group_by(Site,Structure2,Micro,Date_courte,saison) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR3=dataR2 %>% 
  group_by(Site,Structure2,Date_courte,saison) %>% 
  summarize(S2 = mean(S))


plot(lm(S2~Site,data=dataR3))
mixed.lmer <- lmer(S2 ~ Site + (1|saison/Structure2), data = dataR3) #compare les données de richesse taxo avec les variables aléatoires qui sont Micro et date courte

mixed.lmer <- lmer(S2 ~ Site + (1|saison/Structure2), data = dataR3)

summary(mixed.lmer)
plot_model(mixed.lmer,show.values = T,show.p = T)#montre que par rapport à un site de réference (ici Bi), les autres sites sont différents. Ici Fetlar a plutot une diversité moindre que Bi mais est le plus proche. 
tab_model(mixed.lmer)

shapiro_test(lmer(S2 ~ Site + (1|saison/Structure2), data = dataR3))
leveneTest(S2~Site ,data=dataR3)
```

## Generalized linear model
```{r}
#Permet de montrer la significativité des valeurs selon des variables aléatoires

#ajoute une colonne de saison 
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"

dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Day_delta,saison) %>% 
  distinct()%>% 
  group_by(Site,Structure2,Micro,Day_delta,saison) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR3=dataR2 %>% 
  group_by(Site,Structure2,Day_delta,saison) %>% 
  summarize(S2 = mean(S))
 
glm1<-glm(S2~as.numeric(Day_delta)+ Site,data=dataR3)
plot(glm1)
summary(glm1)
```

## Generalized Additive Models
```{r}
#Permet de montrer la significativité des valeurs selon des variables aléatoires

#ajoute une colonne de saison 
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"

#avec Richesse taxo
dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Day_delta,saison,Date_courte) %>% 
  # filter(Date_courte %in% c("2021-11")) %>%
  # filter(Structure2 == "Columns") %>%
  distinct()%>% 
  # mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
  group_by(Site,Structure2,Micro,Day_delta,saison) %>% 
  summarize(S=n()) %>%
  na.omit()%>% 
  droplevels()

dataR3=dataR2 %>%
  group_by(Site,Structure2,Day_delta,saison) %>%
  summarize(S2 = mean(S))


# dataR3=dataR2 %>% #grouper les données selon les sites et les jours afin de pouvoir avoir les memes données que shannon
#   group_by(Site,Structure2,Day_delta,saison) %>%
#   as.data.frame() %>%
#   summarize(S2 = mean(S),.by=c(Site,Day_delta,saison))


#Richesse taxo
dataR2$Site<-as.factor(dataR2$Site)
dataR2$S<-as.numeric(dataR2$S)
# dataR3$S<-as.numeric(dataR3$S)
dataR2$saison<-as.factor(dataR2$saison)
dataR2$Micro<-as.factor(dataR2$Micro)
dataR2$Day_delta<-as.numeric(dataR2$Day_delta)
# dataR3$Years<-as.factor(dataR3$Years)


dataR3$Site<-as.factor(dataR3$Site)
dataR3$S2<-as.numeric(dataR3$S2)
# dataR3$S<-as.numeric(dataR3$S)
dataR3$saison<-as.factor(dataR3$saison)
# dataR3$Micro<-as.factor(dataR3$Micro)
dataR3$Day_delta<-as.numeric(dataR3$Day_delta)
# dataR3$Years<-as.factor(dataR3$Years)
str(dataR3)


#ajout de l'indice de shannon dans le df pour la gam
# dataR4<-cbind(dataR3,shannonind2[,-c(1:2)])


# calcul correlation day_delta et years
# cor(dataR3$Day_delta,as.numeric(dataR3$Years))


#### MCOV avec quadrat moyenné ####
# dataR2=dataR %>% ungroup %>%
#   select(spp,Site,Structure2,Micro,Day_delta,saison,Date_courte,Mcov,Quad2) %>%
#   distinct()%>%
#   mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
#   group_by(Site,Structure2,Day_delta,saison,Years,Mcov,Micro,Quad2) %>%
#   # summarize(S=n()) %>%
#   na.omit()%>%
#   droplevels() 
# 
# #fait la moyenne des quadrats
# dataR3=dataR2 %>%
#   group_by(spp,Site,Structure2,Day_delta,saison,Micro) %>%
#   summarize(Mcov2 = mean(Mcov,.by=c(Micro,Day_delta,Quad2)))   #moyenne du recouvrement des 2 quadrats/espèce/micro
# 
# #fait la moyenne du recouvrement toutes espèces par micro
# dataR4=dataR3 %>%
#         group_by(Site,Structure2,Day_delta,saison) %>%
#     # group_by(Site,Structure2,Day_delta,saison,Micro) %>%
# summarize(Mcov3 = sum(Mcov2,.by=Structure2))
#     # dataR3$Mcov2= 100*dataR3$Mcov2/max(dataR3$Mcov2)
#   # summarize(Mcov3 = sum(Mcov2,.by=c(as.factor(Micro),as.factor(Site),Day_delta,as.factor(Structure2))))
#   # summarize(Mcov3 = sum(Mcov2,.by=c(Structure2,Day_delta))) %>% 
#       # group_by(Site,Structure2,Day_delta,saison) 
#   # summarize(Mcov3 = sum(Mcov2,.by=as.factor(Micro)))
# 
# 
# #Mcov
# dataR3$Site<-as.factor(dataR3$Site)
# dataR3$Mcov2<-as.numeric(dataR3$Mcov2)
# dataR3$saison<-as.factor(dataR3$saison)
# dataR3$Micro<-as.factor(dataR3$Micro)
# 
# dataR4$Site<-as.factor(dataR4$Site)
# dataR4$Mcov3<-as.numeric(dataR4$Mcov3)
# dataR4$saison<-as.factor(dataR4$saison)
# dataR4$Micro<-as.factor(dataR4$Micro)
# dataR4$Day_delta<-as.factor(dataR4$Day_delta)
# 
# str(dataR4)


#test comparaison tous les paramètres
model1<-gam(S2~s(Day_delta)+Site,data=dataR3)
model11<-gam(S2~s(Day_delta)+Structure2,data=dataR3)
model111<-gam(S2~s(Day_delta)+saison,data=dataR3)
model1111<-gam(S2~s(Day_delta)+Site,data=dataR3)
model11111<-gam(S2~s(Day_delta)+Structure2+Site,data=dataR3)
model111111<-gam(S2~s(Day_delta)+s(Structure2,bs="re")+s(Site,bs="re")+s(saison,bs="re")+s(Structure2,by=Site,bs='re'),data=dataR3) # avec les structures dépendantes des sites
model111111<-gam(S2~s(Day_delta)+s(Structure2,bs="re")+s(Site,bs="re")+s(saison,bs="re")+s(Structure2,by=Site,bs='re')+Structure2*Day_delta,data=dataR3) 
model111111<-gam(S2~s(Day_delta)+s(Structure2,bs="re")+s(Site,bs="re")+s(saison,bs="re")+s(Structure2,by=Site,bs='re')+Site*Day_delta,data=dataR3) 
model111111<-gam(S2~s(Day_delta)+s(Structure2,bs="re")+s(Site,bs="re")+s(saison,bs="re")+s(Structure2,by=Site,bs='re')+Site*Day_delta+Structure2*Day_delta,data=dataR3) 

model111111<-gam(S2~s(Day_delta)+Day_delta*Structure2,data=dataR3)
model111111<-gam(S2~s(Day_delta)+Site*Day_delta,data=dataR3)

# model111111<-gam(S2~s(Day_delta)+s(Site,bs="re")+s(saison,bs="re")+s(shannon,bs='re'),data=dataR4) #Avec shannon
# model111111<-gam(S2~s(Day_delta,k=20)+s(Site,bs="re")+s(saison,bs="re"),data=dataR3)
# model1111111<-gam(Mcov~s(Day_delta)+s(Structure2,bs='re')+s(Site,bs="re")+s(saison,bs="re"),data=dataR2)
# model11111111<-gam(Mcov2~s(Day_delta)+s(Structure2,bs='re')+s(Site,bs="re")+s(saison,bs="re"),data=dataR3)
# model111111111<-gam(Mcov3~s(Day_delta,k=27)+s(Structure2,bs='re')+s(Site,bs="re")+s(saison,bs="re"),data=dataR4)


summary(model111111)

# model2<-gam(S2~Site/Day_delta+s(Day_delta,bs="re"),data=dataR3)
# model22<-gam(S2~Site/Day_delta+s(Day_delta,bs="re")+s(Structure2,bs='re'),data=dataR3)
# model222<-gam(S2~Site/Day_delta+s(Day_delta,bs="re")+s(saison,bs="re"),data=dataR3)
# model2222<-gam(S2~Site/Day_delta+s(Day_delta,bs="re")+s(Site,bs="re"),data=dataR3)
# model22222<-gam(S2~Site/Day_delta+s(Day_delta,bs="re")+s(saison,bs="re")+s(Site,bs="re"),data=dataR3)
# model222222<-gam(S2~Site/Day_delta+s(Day_delta,bs="re")+s(saison,bs="re")+s(Structure2,bs='re'),data=dataR3)
# model2222222<-gam(S2~Site/Day_delta+s(Day_delta,bs="re")+s(Structure2,bs='re')+s(Site,bs="re")+s(saison,bs="re"),data=dataR3)

AIC(model1,model11,model111,model1111,model11111,model111111)
AIC(model2,model22,model222,model2222,model22222,model222222,model2222222)

plot_smooths(model=model111111, series=Day_delta,comparison=Structure2)+theme_bw()


#test comparaison tous les paramètres
library(MuMIn)
options(na.action = "na.fail")
fm1<-gam(S2~s(Day_delta)+s(Structure2,bs="re")+s(Site,bs="re")+s(saison,bs="re")+s(Structure2,by=Site,bs='re'),data=dataR3)
ms1<-dredge(fm1)


#plot de la gam
plot(model111111,shift=mean(dataR3$S2),residuals=T,cex=0.7,pch=16,col="blue",shade=T,shade.col='grey')
ggplot(data = dataR3, mapping = aes(x = Day_delta, y = S2)) +
  geom_point(size = 0.7, alpha = 0.7) +
  geom_smooth(method="gam", formula= y~s(x))+
  theme_bw()

plot_smooths(model=model111111, series=Day_delta,comparison=Site)+theme_bw()+ #permet de mettre les gam selon les sites
  (scale_y_continuous(limits=c(0,10)))+
      (scale_x_continuous(limits=c(110,750)))+
   # (scale_x_continuous(minor_breaks=seq(0,27,by=2)))+
     # (scale_x_continuous(breaks=seq(0,25,by=2)))+
  geom_vline(xintercept = 206,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 299,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 389,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 478,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 571,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 664,colour='#666666',alpha=.5)+
#   annotate("rect",xmin=112,xmax=205.9,ymin=0,ymax=10,alpha=.1,fill="green")+
#   annotate("rect",xmin=206,xmax=298.9,ymin=0,ymax=10,alpha=.1,fill="orange")+
#   annotate("rect",xmin=299,xmax=388.9,ymin=0,ymax=10,alpha=.1,fill="brown")+
#   annotate("rect",xmin=389,xmax=477.9,ymin=0,ymax=10,alpha=.1,fill="blue")+
# annotate("rect",xmin=478,xmax=570.9,ymin=0,ymax=10,alpha=.1,fill="green")+
#   annotate("rect",xmin=571,xmax=663.9,ymin=0,ymax=10,alpha=.1,fill="orange")+
#   annotate("rect",xmin=664,xmax=750,ymin=0,ymax=10,alpha=.1,fill="brown")+
annotate("text",x = c(159,252,344,433,524,617,708),y=0.3,
           label=c("Printemps","Eté","Automne","Hiver","Printemps","Eté","Automne"),
           colour=c("#666666","#666666","#666666","#666666","#666666","#666666","#666666"))+
   xlab("Nombre de jours d'immersion")+
  ylab("Richesse taxonomique moyenne")


#### Conditions d'applications
par(mfrow = c(2, 2))
gam.check(model111111)



```


#### Plot diagnostic 

le qqplot + plot fitted versus deviance plot
```{r}

qq_plot=qq_plot(model111111, method = "simulate")+
  labs(subtitle = NULL, title=NULL)+
  theme_bw()
qq_plot


df_mod<- data.frame(log_fitted = fitted(model111111),
                 residuals  = resid(model111111, type = "deviance"))


dev_mod <- ggplot(df_mod, aes(x = log_fitted, y = residuals))+
    geom_point() +
  geom_hline(yintercept=0, linetype=2)+
    labs(x = "Linear predictor", y = "Deviance residual")+
  theme_bw()


dig_plot_tot=ggarrange(qq_plot, dev_mod, ncol=2)


```


#### Plot réponse

Exemple de plot de reponse 
```{r}

# on reconstruit un data frame en faisant varier que la variable d'interet (fonction "evenly")

Parametre1_df <- data_slice(model111111,
                    param=evenly(model111111$model$Site))#param à changer selon la variable à faire varier

# On génére des predictions avec le nouveau df

fv_ds_distancesea <- fitted_values(model111111, data = Parametre1_df) 


# On plot le data frame
# - si variable quantitative : geom_ribbon
# - si variable qualitative: geom_range ou geom_bar
# - geom_rug pour ajouter des ticks pour identifier le nombre de valeur sur un gradient quantitatif


p=ggplot() +
  # geom_boxplot()
  geom_ribbon() +
  geom_range()+
  geom_line()+


  theme_bw()+
 ylab('')+
  xlab('')+
    theme(axis.text=element_text(size=12),
          text = element_text(size = 15))+
 geom_rug(position='jitter', inherit.aes = T)

```


# # Vitesse de colonisation 
```{r}
# Quelle est la vitesse de colonisation de chaque site et comment évoluent-t-elles ?

# à utiliser avec les les lignes de dataR$nummois d'avant
seq<-c(0,0)
seq2<-c(0,0,0)

###Bizeux
dataR21=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Day_delta) %>%
  filter(Site == "Bi") %>% 
  distinct()%>%
  group_by(Site,Structure2,Micro,Day_delta) %>%
  summarize(S=n()) %>%
  na.omit()

dataR310=dataR21 %>%
  group_by(Site,Day_delta) %>%
  summarize(S2 = mean(S))

dataR31<-dataR310

dataR3Bi<-dataR31$Site[-1]
dataR31$Day_delta<-as.numeric(dataR31$Day_delta)
dataR31$S2<-as.numeric(dataR31$S2)
dataR31<-dataR31[,-1]
dataR31<-rbind(seq,dataR31)
dataR311<-dataR31[order(dataR31$Day_delta),]
dataR3<-dataR311[-1,]-dataR311[-nrow(dataR311),]
# dataR3$SparT<-dataR3$S/dataR3$Day_delta
dataR3$SparT<-30.5*(dataR3$S/dataR3$Day_delta)
dataR31<-rbind(seq,dataR3[,-2])


### Buharats
dataR22=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Day_delta) %>%
  filter(Site == "Bu") %>% 
  distinct()%>%
  group_by(Site,Structure2,Micro,Day_delta) %>%
  summarize(S=n()) %>%
  na.omit()

dataR320=dataR22 %>%
  group_by(Site,Day_delta) %>%
  summarize(S2 = mean(S))

dataR32<-dataR320

dataR3Bu<-dataR32$Site[-1]
dataR32$Day_delta<-as.numeric(dataR32$Day_delta)
dataR32$S2<-as.numeric(dataR32$S2)
dataR32<-dataR32[,-1]
dataR32<-rbind(seq,dataR32)
dataR311<-dataR32[order(dataR32$Day_delta),]
dataR3<-dataR311[-1,]-dataR311[-nrow(dataR311),]
# dataR3$SparT<-dataR3$S/dataR3$Day_delta
dataR3$SparT<-30.5*(dataR3$S/dataR3$Day_delta)
dataR32<-rbind(seq,dataR3[,-2])

### Fetlar
dataR23=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Day_delta) %>%
  filter(Site == "Fe") %>% 
  distinct()%>%
  group_by(Site,Structure2,Micro,Day_delta) %>%
  summarize(S=n()) %>%
  na.omit()

dataR330=dataR23 %>%
  group_by(Site,Day_delta) %>%
  summarize(S2 = mean(S))

dataR33<-dataR330

dataR3Fe<-dataR33$Site[-1]
dataR33$Day_delta<-as.numeric(dataR33$Day_delta)
dataR33$S2<-as.numeric(dataR33$S2)
dataR33<-dataR33[,-1]
dataR33<-rbind(seq,dataR33)
dataR311<-dataR33[order(dataR33$Day_delta),]
dataR3<-dataR311[-1,]-dataR311[-nrow(dataR311),]
# dataR3$SparT<-dataR3$S/dataR3$Day_delta
dataR3$SparT<-30.5*(dataR3$S/dataR3$Day_delta)
dataR33<-rbind(seq,dataR3[,-2])

### Vieux Bancs
dataR24=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Day_delta) %>%
  filter(Site == "VB") %>% 
  distinct()%>%
  group_by(Site,Structure2,Micro,Day_delta) %>%
  summarize(S=n()) %>%
  na.omit()

dataR340=dataR24 %>%
  group_by(Site,Day_delta) %>%
  summarize(S2 = mean(S))

dataR34<-dataR340

dataR3VB<-dataR34$Site[-1]
dataR34$Day_delta<-as.numeric(dataR34$Day_delta)
dataR34$S2<-as.numeric(dataR34$S2)
dataR34<-dataR34[,-1]
dataR34<-rbind(seq,dataR34)
dataR311<-dataR34[order(dataR34$Day_delta),]
dataR3<-dataR311[-1,]-dataR311[-nrow(dataR311),]
# dataR3$SparT<-dataR3$S/dataR3$Day_delta
dataR3$SparT<-30.5*(dataR3$S/dataR3$Day_delta)
dataR34<-rbind(seq,dataR3[,-2])


dataRjour1<-c(0,dataR310$Day_delta/30.5)
dataRjour2<-c(0,dataR320$Day_delta/30.5)
dataRjour3<-c(0,dataR330$Day_delta/30.5)
dataRjour4<-c(0,dataR340$Day_delta/30.5)


# dataR2total<-rbind(dataR3Bi,dataR3Bu,dataR3Fe,dataR3VB)
# dataR7<-cbind(dataR2$Site,dataR3$SparT,dataR4$SparT,dataR5$SparT,dataR6$SparT)

plot(dataR31$SparT~dataRjour1,col="red",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="Nombre de jours",ylab="Nombre moyen d'espèces  colonisant par jour")
par(new=T)
plot(dataR32$SparT~dataRjour2,col="blue",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="",ylab="")
par(new=T)
plot(dataR33$SparT~dataRjour3,col="green",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="",ylab="")
par(new=T)
plot(dataR34$SparT~dataRjour4,col="black",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="",ylab="")
lines(dataR31$SparT~dataRjour1,col="red",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="",ylab="")
lines(dataR32$SparT~dataRjour2,col="blue",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="",ylab="")
lines(dataR33$SparT~dataRjour3,col="green",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="",ylab="")
lines(dataR34$SparT~dataRjour4,col="black",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="",ylab="")
legend(x = "bottomright", legend = c("Bi","Bu","Fe","VB"),lty = 1, col = c("red","blue","green","black"),lwd = 2)


plot(dataR31$SparT~dataRjour1,col="red",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="Nombre de mois d'immersion",ylab="Nombre moyen d'espèces  colonisant par mois")
par(new=T)
plot(dataR32$SparT~dataRjour2,col="blue",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="",ylab="")
par(new=T)
plot(dataR33$SparT~dataRjour3,col="green",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="",ylab="")
par(new=T)
plot(dataR34$SparT~dataRjour4,col="black",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="",ylab="")
lines(dataR31$SparT~dataRjour1,col="red",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="",ylab="")
lines(dataR32$SparT~dataRjour2,col="blue",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="",ylab="")
lines(dataR33$SparT~dataRjour3,col="green",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="",ylab="")
lines(dataR34$SparT~dataRjour4,col="black",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="",ylab="")
legend(x = "bottomright", legend = c("Bi","Bu","Fe","VB"),lty = 1, col = c("red","blue","green","black"),lwd = 2)


ggplot(dataR31, aes(x=dataRjour1,SparT))+
  xlab("Nombre de mois d'immersion")+
  ylab("Nombre moyen d'espèces  colonisant par mois")+
 geom_point(colour="#f8766d")+
  geom_line(colour="#f8766d")+
 geom_point(aes(x=dataRjour2,y=SparT),dataR32,colour="#7cae00")+
  geom_line(aes(x=dataRjour2,y=SparT),dataR32,colour="#7cae00")+
 geom_point(aes(x=dataRjour3,y=SparT),dataR33,colour="#00bfc4")+
  geom_line(aes(x=dataRjour3,y=SparT),dataR33,colour="#00bfc4")+
 geom_point(aes(x=dataRjour4,y=SparT),dataR34,colour="#c77cff")+
  geom_line(aes(x=dataRjour4,y=SparT),dataR34,colour="#c77cff")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
annotate("rect",xmin=0,xmax=33.9/30.5,ymin=-2,ymax = 1.5,alpha=.2,fill="brown")+
    (scale_y_continuous(limits=c(-2,1.5)))+
      (scale_x_continuous(limits=c(0,25)))+
   # (scale_x_continuous(minor_breaks=seq(0,27,by=2)))+
     (scale_x_continuous(breaks=seq(0,25,by=2)))+
  annotate("rect",xmin=34/30.5,xmax=111.9/30.5,ymin=-2,ymax=1.5,alpha=.2,fill="blue")+
  annotate("rect",xmin=112/30.5,xmax=205.9/30.5,ymin=-2,ymax=1.5,alpha=.2,fill="green")+
  annotate("rect",xmin=206/30.5,xmax=298.9/30.5,ymin=-2,ymax=1.5,alpha=.2,fill="orange")+
  annotate("rect",xmin=299/30.5,xmax=388.9/30.5,ymin=-2,ymax = 1.5,alpha=.2,fill="brown")+
  annotate("rect",xmin=389/30.5,xmax=477.9/30.5,ymin=-2,ymax = 1.5,alpha=.2,fill="blue")+
annotate("rect",xmin=478/30.5,xmax=570.9/30.5,ymin=-2,ymax = 1.5,alpha=.2,fill="green")+
  annotate("rect",xmin=571/30.5,xmax=663.9/30.5,ymin=-2,ymax = 1.5,alpha=.2,fill="orange")+
  annotate("rect",xmin=664/30.5,xmax=752.9/30.5,ymin=-2,ymax = 1.5,alpha=.2,fill="brown")+
annotate("text",x = c(2.4,5.2,8.2,11.2,14.2,17.1,20.2,23.2),y=-1.9,
           label=c("Hiver","Printemps","Eté","Automne","Hiver","Printemps","Eté","Automne"),
           colour=c("blue","green","orange","brown","blue","green","orange","brown"))

```

# # Représentation spatial
## Matrice de distance
```{r}
# Permet de calculer la distance entre le recouvrement de chaque espèce et le taux de recouvrement

# data_comp2=data_PQ_light %>% ungroup %>% 
#   select(spp,Cov,Site,Micro,Date_courte,Structure2,Strcut_groups, Quad2) %>% 
#   filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte')) %>%
#   filter(!Structure2 %in% c('Dome','Holes','Upper_slots','Inner_slots')) %>% 
#   group_by(spp,Site,Micro,Date_courte,Structure2) %>% 

#   filter(!Structure2 %in% c('Dome','Upper_slots' )) %>% 
#     filter(!Site %in% c('Fe','DSC' )) %>% 
#   mutate(Sample=paste0(Site,'_',Date_courte,'_',
#                        Micro,'_',Quad2)) %>% 
#   group_by(Sample,Site,spp, Micro,Structure2,Strcut_groups, Date_courte) %>% 
#   dplyr::summarize(Mcov=mean(Cov)) %>% 
# 
#   group_by(Sample,Site,Micro,Date_courte,Structure2) %>% 
#   distinct() %>% drop_na() %>% 
#     spread(spp,Mcov) %>% ungroup() %>% 
#       mutate(across(everything(.), ~replace_na(., 0))) 

#ajoute une colonne de saison 
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"
dataR$saison[dataR$saison == "2021-01" |dataR$saison == "2022-01"] <- "hiver"

dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"336"
dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"339"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"2021-11"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"2021-11"


data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2,saison,Quad2,Day_delta) %>% 
  mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
  group_by(spp,Site,Micro,Date_courte,Structure2,saison,Years,Day_delta) %>% 
  # filter(!Site == 'Fe') %>% 
  distinct() %>% drop_na() %>% 
  summarize(Mcov2 = mean(Mcov,.by=c(spp,Micro,Day_delta,Quad2))) %>%
  spread(spp,Mcov2) %>% ungroup() %>% 
  mutate(across(everything(.), ~replace_na(., 0))) %>% 
  mutate(Compsite_date=paste(Site,Date_courte,sep=","))

# data_comp2$nouvelle<-ifelse(data_comp2$Structure2 == "Pillars" | data_comp2$Structure2 == "Columns", "Pillars", "Autres")
# data_comp2$nouvelle<-ifelse(data_comp2$Structure2 == "Pillars", "Pillars", "Autres")

data_comp2$Site<-as.factor(data_comp2$Site)
data_comp2$Micro<-as.factor(data_comp2$Micro)
data_comp2$Date_courte<-as.factor(data_comp2$Date_courte)
data_comp2$Day_delta<-as.factor(data_comp2$Day_delta)
# data_comp2$nouvelle<-as.factor(data_comp2$nouvelle)
data_comp2$Years<-as.factor(data_comp2$Years)
data_comp2$Compsite_date<-as.factor(data_comp2$Compsite_date)


# test=data_comp2 %>% filter(Site == 'VB',
                          # Date_courte=='2021-07' )
# data_comp2=data_comp2[rowSums(data_comp2)>0,]

# Comp_mat=data_comp2 %>% select(-c(Site,Sample,Micro,Structure2,Strcut_groups,Date_courte)) %>% as.matrix() 
# Meta_data=data_comp2 %>% select(Site,Sample,Micro,Structure2,Strcut_groups,Date_courte)

Comp_mat=data_comp2 %>% select(-c(Site,Micro,Structure2,Date_courte,saison,Years,Day_delta,Compsite_date)) %>% as.matrix() #sans meta données
Meta_data=data_comp2 %>% select(Site,Micro,Structure2,Date_courte,saison,Years,Day_delta,Compsite_date) #meta données

# Comp_mat=data_comp2 %>% select(-c(Site,Micro,Structure2,Date_courte,nouvelle,saison)) %>% as.matrix() #sans meta données
# Meta_data=data_comp2 %>% select(Site,Micro,Structure2,Date_courte,nouvelle,saison) #meta données


distdataR<-vegdist(Comp_mat, method='bray') #library vegan - distance de Bray-Curtis, considéré face aux distances euclidiennes comme plus efficace pour les données écologiques


```

##  PCoA
```{r}
# Permet de représenter les données dans l'espace et voir les paramètres expliquant le plus la variance

pcoa_tot_SS<- cmdscale(d = as.matrix(distdataR), k=10, eig = T) 
x=pcoa_tot_SS$points[,1]
y=pcoa_tot_SS$points[,2]

PCOA_df=data.frame(x=pcoa_tot_SS$points[,1],y=pcoa_tot_SS$points[,2],
                   Structure=Meta_data$Structure2,
                   Site=Meta_data$Site,
                   Date=Meta_data$Date_courte,
                   Saison=Meta_data$saison,
                   Years=Meta_data$Years,
                   Compsite_date=Meta_data$Compsite_date
                   # Structure3=Meta_data$nouvelle
                   )
# save(PCOA_df,file="PCOA_df")

# PCOA_df=PCOA_df %>% filter(Date %in% c("2021-04","2021-07","2021-11"))
# PCOA_df=PCOA_df %>% filter(!Date %in% c("2021-04","2021-07","2021-11"))
# PCOA_df=PCOA_df %>% filter(Site == "VB")

ggplot(data=PCOA_df,aes(x,y, col=Years))+ # <- Ici on explore avec col les variable qui explique le + l'explosion du nuage de points
  # geom_point(aes(col=Site), size=1, alpha=.6)+
  geom_point()+
  labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")+
  geom_hline(yintercept=0)+
  geom_vline(xintercept=0)+
  theme_bw()
  # geom_mark_ellipse(aes(fill=Structure,group=Structure))


#PCoA avec les barycentres
# s.class(PCOA_df[c(1:2)],as.factor(PCOA_df$Site),col=c("#fb746b","#7cab04","#00bfc4","#c77cff"),ellipseSize=0) # permet de faire le graph de la PCoA avec des barycentres
# s.class(PCOA_df[c(1:2)],droplevels(as.factor(PCOA_df$Structure)),col=c("#fb746b","#7cab04","#00bfc4","#c77cff"),ellipseSize=0)
# s.class(PCOA_df[c(1:2)],droplevels(as.factor(PCOA_df$Date)),col=c("#000099","#0000FF","#6666FF","#99CCFF","#006600","#33CC33","#99FF00"),ellipseSize=0)
# 
# s.class(PCOA_df[c(1:2)],droplevels(as.factor(PCOA_df$Compsite_date)),ellipseSize=0,col=c("#000099","#0000FF","#6666FF","#99CCFF","#006600","#33CC33","#99FF00","#CCFF33"))


#### Barycentre avec ggplot
  ######## trajectoires sites ##########
load("PCOA_df")

## PCoA Sites ##
barycenters <- aggregate(cbind(x,y) ~ Site, PCOA_df, mean)
# paste(Site,Date,sep="_")
ggplot(PCOA_df, aes(x = x, y = y,colour =Site )) +
  geom_point(alpha=.2) +
  # Ajouter les barycentres
  # geom_point(data = barycenters, aes(x = x, y = y, colour = paste(Site,Date,sep="_")), size = 3, shape = 17) +
  # Ajout lignes entre les barycentres et les points
  geom_segment(data = merge(PCOA_df, barycenters, by ="Site", suffixes = c("",".bary")),
               aes(x = x, y = y, xend = x.bary, yend = y.bary, color = Site),alpha=.3)+
  theme_bw()+theme(legend.position = "none")+labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")+
  geom_label(
    label="Bizeux", x=barycenters$x[which(barycenters$Site=="Bi")], y=barycenters$y[which(barycenters$Site=="Bi")],
    label.padding = unit(0.25, "lines"), # Rectangle size around label
    label.size = 0.35,color = "orange",fill="white")+
  geom_label(
    label="Buharats", x=barycenters$x[which(barycenters$Site=="Bu")], y=barycenters$y[which(barycenters$Site=="Bu")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "#66CC00",fill="white")+
  geom_label(
    label="Fetlar", x=barycenters$x[which(barycenters$Site=="Fe")], y=barycenters$y[which(barycenters$Site=="Fe")],
    label.padding = unit(0.25, "lines"),
    label.size = 0.35,color = "#00CCCC",fill="white")+
  geom_label(
    label="Vieux-Bancs", x=barycenters$x[which(barycenters$Site=="VB")], y=barycenters$y[which(barycenters$Site=="VB")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "purple",fill="white")
  

  

## PCoA Structures ##
load("PCOA_df")
barycenters <- aggregate(cbind(x,y) ~ Structure, PCOA_df, mean)
# paste(Site,Date,sep="_")
ggplot(PCOA_df, aes(x = x, y = y,colour =Structure )) +
  geom_point(alpha=.2) +
  # Ajouter les barycentres
  # geom_point(data = barycenters, aes(x = x, y = y, colour = paste(Site,Date,sep="_")), size = 3, shape = 17) +
  # Ajout lignes entre les barycentres et les points
  geom_segment(data = merge(PCOA_df, barycenters, by ="Structure", suffixes = c("",".bary")),
               aes(x = x, y = y, xend = x.bary, yend = y.bary, color = Structure),alpha=.3)+
  theme_bw()+theme(legend.position = "none")+
  geom_label(
    label="Disc", x=barycenters$x[which(barycenters$Structure=="Disc")], y=barycenters$y[which(barycenters$Structure=="Disc")],
    label.padding = unit(0.25, "lines"), # Rectangle size around label
    label.size = 0.35,color = "orange",fill="white")+
  geom_label(
    label="Columns", x=barycenters$x[which(barycenters$Structure=="Columns")], y=barycenters$y[which(barycenters$Structure=="Columns")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "#66CC00",fill="white")+
  geom_label(
    label="Pillars", x=barycenters$x[which(barycenters$Structure=="Pillars")], y=barycenters$y[which(barycenters$Structure=="Pillars")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "#00CCCC",fill="white")+
  geom_label(
    label="Inner_slots", x=barycenters$x[which(barycenters$Structure=="Inner_slots")], y=barycenters$y[which(barycenters$Structure=="Inner_slots")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "purple",fill="white")+
  labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")


## PCoA Dates ##
load("PCOA_df")
barycenters <- aggregate(cbind(x,y) ~ Date, PCOA_df, mean)
# paste(Site,Date,sep="_")
ggplot(PCOA_df, aes(x = x, y = y,colour =Date )) +
  geom_point(alpha=.2) +
  # Ajouter les barycentres
  # geom_point(data = barycenters, aes(x = x, y = y, colour = paste(Site,Date,sep="_")), size = 3, shape = 17) +
  # Ajout lignes entre les barycentres et les points
  geom_segment(data = merge(PCOA_df, barycenters, by ="Date", suffixes = c("",".bary")),
               aes(x = x, y = y, xend = x.bary, yend = y.bary, color = Date),alpha=.3)+
  theme_bw()+theme(legend.position = "none")+
  geom_label(
    label="2021-04", x=barycenters$x[which(barycenters$Date=="2021-04")], y=barycenters$y[which(barycenters$Date=="2021-04")],
    label.padding = unit(0.25, "lines"), # Rectangle size around label
    label.size = 0.35,color = "red",fill="white")+
  geom_label(
    label="2021-07", x=barycenters$x[which(barycenters$Date=="2021-07")], y=barycenters$y[which(barycenters$Date=="2021-07")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "orange",fill="white")+
  geom_label(
    label="2021-11", x=barycenters$x[which(barycenters$Date=="2021-11")], y=barycenters$y[which(barycenters$Date=="2021-11")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "#66CC00",fill="white")+
  geom_label(
    label="2022-01", x=barycenters$x[which(barycenters$Date=="2022-01")], y=barycenters$y[which(barycenters$Date=="2022-01")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "#009966",fill="white")+
geom_label(
    label="2022-04", x=barycenters$x[which(barycenters$Date=="2022-04")], y=barycenters$y[which(barycenters$Date=="2022-04")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "#00CCCC",fill="white")+
  geom_label(
    label="2022-07", x=barycenters$x[which(barycenters$Date=="2022-07")], y=barycenters$y[which(barycenters$Date=="2022-07")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "purple",fill="white")+
  geom_label(
    label="2022-11", x=barycenters$x[which(barycenters$Date=="2022-11")], y=barycenters$y[which(barycenters$Date=="2022-11")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "pink",fill="white")+
  labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")


######## trajectoires sites-dates 2021 et 2022 ##########
load("PCOA_df")

barycenters <- aggregate(cbind(x,y) ~ Site+Date, PCOA_df, mean)
ggplot(PCOA_df, aes(x = x, y = y,colour = paste(Site,Date,sep="_"))) +
  geom_point(alpha=.2) +
     # Ajouter les barycentres
  geom_point(data = barycenters, aes(x = x, y = y, colour = paste(Site,Date,sep="_")), size = 3, shape = 17) +

  
     # Ajout lignes entre les barycentres et les points
  geom_segment(data = barycenters[which(barycenters$Site=="Bi"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="blue",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="blue",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="blue",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="blue",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="blue",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB"),],aes(x=x[7],y=y[7],xend=x[8],yend=y[8]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  labs(color="Sites et dates")+ labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")+theme_bw() 
  

  ######## trajectoires sites-dates-structures 2021 et 2022 ##########
##### Disc
load("PCOA_df")
PCOA_df=PCOA_df %>% filter(Structure == "Disc")

barycenters <- aggregate(cbind(x,y) ~ Site+Date+Structure, PCOA_df, mean)


ggplot(PCOA_df, aes(x = x, y = y,colour = paste(Site,Date,Structure,sep="_"))) +
  geom_point(alpha=.2) +
    # Ajout les barycentres
  geom_point(data = barycenters, aes(x = x, y = y, colour = paste(Site,Date,Structure,sep="_")), size = 3, shape = 17) +
    # Ajout lignes entre les barycentres et les points
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Disc"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Disc"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Disc"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Disc"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Disc"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Disc"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Disc"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Disc"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Disc"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Disc"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Disc"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Disc"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Disc"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Disc"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Disc"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Disc"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Disc"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Disc"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="purple")+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Disc"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Disc"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Disc"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Disc"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Disc"),],aes(x=x[7],y=y[7],xend=x[8],yend=y[8]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  labs(color="Sites et dates")+ labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")+ theme_bw() 



##### Colonnes
load("PCOA_df")
PCOA_df=PCOA_df %>% filter(Structure == "Columns")

barycenters <- aggregate(cbind(x,y) ~ Site+Date+Structure, PCOA_df, mean)

ggplot(PCOA_df, aes(x = x, y = y,colour = paste(Site,Date,Structure,sep="_"))) +
  geom_point(alpha=.2) +
    # Ajout les barycentres
  geom_point(data = barycenters, aes(x = x, y = y, colour = paste(Site,Date,Structure,sep="_")), size = 3, shape = 17) +
    # Ajout lignes entre les barycentres et les points
   geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Columns"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Columns"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Columns"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Columns"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Columns"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Columns"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Columns"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Columns"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Columns"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Columns"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Columns"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Columns"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Columns"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Columns"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Columns"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Columns"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Columns"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Columns"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="purple")+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Columns"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Columns"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Columns"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Columns"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Columns"),],aes(x=x[7],y=y[7],xend=x[8],yend=y[8]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  labs(color="Sites et dates")+ labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")+ theme_bw() 



##### Piliers
load("PCOA_df")
PCOA_df=PCOA_df %>% filter(Structure == "Pillars")

barycenters <- aggregate(cbind(x,y) ~ Site+Date+Structure, PCOA_df, mean)


ggplot(PCOA_df, aes(x = x, y = y,colour = paste(Site,Date,Structure,sep="_"))) +
  geom_point(alpha=.2) +
    # Ajout les barycentres
  geom_point(data = barycenters, aes(x = x, y = y, colour = paste(Site,Date,Structure,sep="_")), size = 3, shape = 17) +
    # Ajout lignes entre les barycentres et les points
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Pillars"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Pillars"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Pillars"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Pillars"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Pillars"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Pillars"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Pillars"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Pillars"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Pillars"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Pillars"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Pillars"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Pillars"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Pillars"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Pillars"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Pillars"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Pillars"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Pillars"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Pillars"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="purple")+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Pillars"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Pillars"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Pillars"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Pillars"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Pillars"),],aes(x=x[7],y=y[7],xend=x[8],yend=y[8]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  labs(color="Sites et dates")+ labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")+ theme_bw()  


##### Inner_slots
load("PCOA_df")
PCOA_df=PCOA_df %>% filter(Structure == "Inner_slots")

barycenters <- aggregate(cbind(x,y) ~ Site+Date+Structure, PCOA_df, mean)


ggplot(PCOA_df, aes(x = x, y = y,colour = paste(Site,Date,Structure,sep="_"))) +
  geom_point(alpha=.2) +
    # Ajout les barycentres
  geom_point(data = barycenters, aes(x = x, y = y, colour = paste(Site,Date,Structure,sep="_")), size = 3, shape = 17) +
    # Ajout lignes entre les barycentres et les points
   geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Inner_slots"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Inner_slots"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Inner_slots"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Inner_slots"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Inner_slots"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Inner_slots"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="orange",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Inner_slots"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Inner_slots"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Inner_slots"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Inner_slots"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Inner_slots"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="darkgreen",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Inner_slots"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Inner_slots"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Inner_slots"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Inner_slots"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Inner_slots"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="pink",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Inner_slots"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Inner_slots"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="purple")+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Inner_slots"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Inner_slots"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Inner_slots"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Inner_slots"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Inner_slots"),],aes(x=x[7],y=y[7],xend=x[8],yend=y[8]),color="purple",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  labs(color="Sites et dates")+ labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")+ theme_bw()  

# geom_path(data=barycenters[which(barycenters$Site == "Bi"),],group=1,aes(color=Site),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
# geom_path(data=barycenters[which(barycenters$Site == "Bu"),],group=1,aes(color=Site),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
# geom_path(data=barycenters[which(barycenters$Site == "Fe"),],group=1,aes(color=Site),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
# geom_path(data=barycenters[which(barycenters$Site == "VB"),],group=1,aes(color=Site),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))





### apport de la variabilité selon le nombre d'axe
summaryPCOA<-data.frame(
  EIG= pcoa_tot_SS$eig,
  PCTVAR=100*pcoa_tot_SS$eig/sum(pcoa_tot_SS$eig),
  CUMPCTVAR = cumsum(100*pcoa_tot_SS$eig/sum(pcoa_tot_SS$eig)))
plot(summaryPCOA$PCTVAR[1:30],ylim=c(0,30),xlab="Composantes",ylab="Pourcentage d'inertie (explication de la variance)")


### Explication de la variance par les variables
#test avec factominer (fonctionne mais les axes n'expliquent pas la même variance que l'ACoP plus haut)
res.pca<-PCOA_df[,c(1:2)]
res.pca<-PCA(Comp_mat,ncp=6)
res.pca<-PCA(as.matrix(distdataR),ncp=6)

# Test importance des espèces dans l'explication de la variance 
vf <- envfit(pcoa_tot_SS, data_comp2, perm = 999)
spp.scrs <- as.data.frame(scores(vf, display = "vectors"))
spp.scrs2 <-(spp.scrs[which(vf$vectors$pvals<0.01),])
spp.scrs3 <- cbind(spp.scrs2, Abb = rownames(spp.scrs2))


ggplot(PCOA_df, aes(x = x, y = y)) +
  geom_point(colour="black",alpha=.2)+
  geom_point(spp.scrs3,mapping=aes(x=Dim1,y=Dim2,colour=Abb),size=2)+
    labs(color="Taxons significatifs")+ labs(x="Axe 1 (22,1%)",y="Axe 2 (12,1%)")+
  theme_bw() + 
  geom_label(data=spp.scrs3,aes(x=Dim1,y=Dim2,label=Abb), nudge_x = 0.0, nudge_y = 0.05, check_overlap = T,label.size=0.07,size=3)+ # ajout des labels au niveau de chaque point
  scale_x_continuous(limits=c(-0.83,0.7))+
  theme(legend.position="none") #enlève la légende

geom_label(
    label="2022-11", x=barycenters$x[which(barycenters$Date=="2022-11")], y=barycenters$y[which(barycenters$Date=="2022-11")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "pink",fill="white")+
  labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")

```

## Permanova
```{r}
# Permet de voir s'il y a possibilité de regrouper les structures

data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Day_delta,Structure2) %>% 
  group_by(spp,Site,Micro,Day_delta,Structure2) %>% 
  distinct() %>% drop_na() %>% 
  spread(spp,Mcov) %>% ungroup() %>% 
  mutate(across(everything(.), ~replace_na(., 0))) 

Comp_mat=data_comp2 %>% select(-c(Site,Structure2,Date_courte,Micro)) %>% as.matrix() #sans meta données

distdataR<-vegdist(Comp_mat, method='bray')


groupe<-data_comp2$Structure2
groupe<-data_comp2$Site
groupe<-data_comp2$Day_delta
groupe<-data_comp2$Micro

adonis2(distdataR~groupe,data=data_comp2,permutations=999)


# Permet de voir si les microhabitats possèdent une richesse taxo équivalente et donc qu'ils peuvent etre regroupés

data_comp2=dataR %>% ungroup %>% 
  filter(Site == 'VB') %>%
  filter(Structure2 == 'Inner_slots') %>%
  select(spp,Mcov,Site,Micro,Day_delta,Structure2) %>% 
  group_by(spp,Site,Micro,Day_delta,Structure2) %>% 
  distinct() %>% drop_na() %>% 
  spread(spp,Mcov) %>% ungroup() %>% 
  mutate(across(everything(.), ~replace_na(., 0))) 

Comp_mat=data_comp2 %>% select(-c(Site,Structure2,Day_delta,Micro)) #sans meta données

distdataR<-vegdist(Comp_mat, method='bray')

adonis2(distdataR~Micro,data=data_comp2,permutations=999)



# Pair wise permanova 
groupe<-data_comp2$Structure2
groupe<-data_comp2$Site
groupe<-data_comp2$Day_delta
groupe<-data_comp2$Micro

pairwise.adonis(distdataR,groupe,perm=999,sim.method = 'bray',p.adjust.m='bonferroni')
adonis3<-permanova_pairwise(distdataR,groupe,permutations=999,method='bray',padj="bonferroni")

pv<-adonis3$p.adj
pv<-c(0,)
Site<-adonis3$pairs
Site<-c("Colonnes","Disques","Dome","Pillars")
table(pv,Site)
Sitepv<-cbind(site,pv)

heatmap(as.matrix(as.numeric(adonis3$p.adj)))
site<-c("Disques","Colonnes","Dome","Pilliers")

Sitepv<-cbind(site,pv)

```

## ANOSIM
```{r}
#Similaire à une ANOVA mais utilise une matrice de dissimilarité en entrée de data

data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Structure2,Date_courte) %>% 
  filter(Site == "Bu") %>% 
  filter(Date_courte %in% c("2021-11","2022-11")) %>% 
  group_by(spp,Site,Micro,Structure2) %>% 
  distinct() %>% drop_na() %>% 
  spread(spp,Mcov) %>% ungroup() %>% 
  mutate(across(everything(.), ~replace_na(., 0))) 

datano=data_comp2[,-c(1:4)] %>% as.matrix()

ano=anosim(datano,droplevels(data_comp2$Structure2),distance="bray",permutations=999)
ano 
plot(ano,xlab="Structures",ylab="Rang de distance entre les échantillons")
```


## Classification hiérarchique
```{r}
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"

data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2,saison) %>% 
  group_by(spp,Site,Micro,Date_courte,Structure2,saison) %>% 
  distinct() %>% drop_na() %>% 
  spread(spp,Mcov) %>% ungroup() %>% 
  mutate(across(everything(.), ~replace_na(., 0))) 

data_comp2$Site<-as.factor(data_comp2$Site)
data_comp2$Micro<-as.factor(data_comp2$Micro)
data_comp2$Date_courte<-as.factor(data_comp2$Date_courte)

Comp_mat=data_comp2 %>% select(-c(Site,Micro,Structure2,Date_courte,saison)) %>% as.matrix() #sans meta données
Meta_data=data_comp2 %>% select(Site,Micro,Structure2,Date_courte,saison) #meta données

distdataR<-vegdist(Comp_mat, method='bray')

arbre <- hclust(distdataR, method = "ward.D2")
plot(arbre, labels = FALSE, main = "Dendrogramme")
ggdendrogram(arbre,labels=FALSE)

```

# # Courbe d'accumulation
## Méthode 1 (intrapolation)
```{r}
#Permet de savoir le nombre de taxon retrouvé selon l'effort d'inventaire
# Courbe d'accumulation package vegan (seulement intrapolation)

data_comp2=data_PQ_light %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2) %>% 
  filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte'),) %>%
  filter(Structure2 == "Pillars") %>% 
  filter(Site == "Bi")%>%
    filter(Date_courte %in% c("2022-07")) %>% 

  # filter(Date_courte %in% c("2022-07","2022-04","2022-11","2022-01"))%>%
  group_by(spp,Site,Micro,Date_courte,Structure2) %>% 
  distinct() %>% drop_na() %>% 
    spread(spp,Mcov) %>% ungroup() %>% 
      mutate(across(everything(.), ~replace_na(., 0))) 

Comp_mat2=data_comp2 %>% ungroup() %>%  select(-c(Site,Micro,Structure2,Date_courte)) %>% as.matrix() 

data_comp3=data_PQ_light %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2) %>% 
  filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte')) %>%
  filter(Structure2 == "Pillars") %>% 
  filter(Site == "Bu")%>%
  # filter(Date_courte %in% c("2022-07","2022-04","2022-11","2022-01"))%>%
  group_by(spp,Site,Micro,Date_courte,Structure2) %>% 
  distinct() %>% drop_na() %>% 
    spread(spp,Mcov) %>% ungroup() %>% 
      mutate(across(everything(.), ~replace_na(., 0))) 

Comp_mat3=data_comp3 %>% select(-c(Site,Micro,Structure2,Date_courte)) %>% as.matrix() 


data_comp4=data_PQ_light %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2) %>% 
  filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte')) %>%
  filter(Structure2 == "Pillars") %>% 
  filter(Site == "VB")%>%
  filter(Date_courte %in% c("2022-07","2022-04","2022-11","2022-01"))%>%
  group_by(spp,Site,Micro,Date_courte,Structure2) %>% 
  distinct() %>% drop_na() %>% 
    spread(spp,Mcov) %>% ungroup() %>% 
      mutate(across(everything(.), ~replace_na(., 0))) 

Comp_mat4=data_comp4 %>% select(-c(Site,Micro,Structure2,Date_courte)) %>% as.matrix() 


data_comp5=data_PQ_light %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2) %>% 
  filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte')) %>%
  filter(Structure2 == "Pillars") %>% 
  filter(Site == "Fe")%>%
  filter(Date_courte %in% c("2022-07","2022-04","2022-11","2022-01"))%>%
  group_by(spp,Site,Micro,Date_courte,Structure2) %>% 
  distinct() %>% drop_na() %>% 
    spread(spp,Mcov) %>% ungroup() %>% 
      mutate(across(everything(.), ~replace_na(., 0))) 

Comp_mat5=data_comp5 %>% select(-c(Site,Micro,Structure2,Date_courte)) %>% as.matrix() 


spBi<-specaccum(Comp_mat2)
spBu<-specaccum(Comp_mat3)
spVB<-specaccum(Comp_mat4)
spFe<-specaccum(Comp_mat5)


plot(spBi,col="blue",ci.type="poly",ci.lty=0,ci.col="lightblue",ylim=c(0,30),xlim=c(0,12),ylab="Nombre d'espèces",xlab="Nombre de mesures",main="Courbe accumulative taxons 2022 pilliers/Site")
par(new=T)
plot(spBi2,col="darkgreen",ci.type="poly",ci.lty=0,ci.col="lightgreen",ylim=c(0,30),xlim=c(0,12),ylab="",xlab="")
par(new=T)
plot(spBi3,col="orange",ci.type="poly",ci.lty=0,ci.col="lightyellow",ylim=c(0,30),xlim=c(0,12),ylab="",xlab="")
par(new=T)
plot(spBi4,col="red",ci.type="poly",ci.lty=0,ci.col="#FCBBA1",ylim=c(0,30),xlim=c(0,12),ylab="",xlab="")
par(new=T)
plot(spBi5,col="black",ci.type="poly",ci.lty=0,ci.col="grey",ylim=c(0,30),xlim=c(0,12),ylab="",xlab="")

legend(x = "bottomright", legend = c("Bi","VB","Fe","Bu"),lty = 1, col = c("blue","darkgreen","orange","red"),lwd = 2)

#permet de voir les indices tels que chao/ bootstrap,....
spBi<-specaccum(Comp_mat2)
pool<-specpool(Comp_mat5)
poolaccum(Comp_mat5,permutation=100)
plot(poolaccum(Comp_mat3,permutation=100))

estimateR(as.integer(Comp_mat2))
estimateR(as.integer(Comp_mat3))
estimateR(as.integer(Comp_mat4))
estimateR(as.integer(Comp_mat5))

```

## Méthode 2 (intra et extrapolation)

```{r}
#Création d'une matrice d'incidence

# On réorganise le df de base
# Ajout d'une variable qui combine la date et la structure

### Disques
data_comp1=data_PQ_light %>% ungroup %>% 
  select(spp,Date_courte,Site,Structure2, Code_struct) %>% 
   filter(!spp %in% c('NA','NI','Unassigned','ponte','Ponte','None')) %>%
  mutate(date_st=paste0(Date_courte,'_',Code_struct)) %>%  # 
  filter(Structure2 == ("Disc")) %>%
  mutate(P=1) %>% 
    select(-c(Date_courte,Code_struct)) %>% 
  distinct() %>% group_by(Site) %>% 
  group_split()

# On créait une fonction pour nettoyer l'intérieur de la liste
fun_clean=function(x){
  x %>% spread(date_st,P) %>% 
    select(-c(spp,Site,Structure2)) %>% 
      mutate(across(everything(.), ~replace_na(., 0))) %>% 
  as.data.frame()}

# Convertion de split df en list
comp_list=as.list(data_comp1)

# Application de la fonction + names
comp_list_clean=lapply(comp_list, fun_clean)
names(comp_list_clean)<-c('Bi','Bu','Fe','Vb')

# Fonction
out.raw <- iNEXT(comp_list_clean,q=0,
                 datatype="incidence_raw",
                 endpoint=80)
plot(out.raw)
# ggiNEXT(out.raw)

ChaoRichness(comp_list_clean,datatype = 'incidence_raw')

# Ici tu les données concernant l'estimation de la rich. totale
Rar_disc_df=as.data.frame(out.raw$AsyEst)

poolaccum(comp_list_clean)



### Colonnes
data_comp1=data_PQ_light %>% ungroup %>% 
  select(spp,Date_courte,Site,Structure2, Code_struct) %>% 
   filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte','None')) %>%
  mutate(date_st=paste0(Date_courte,'_',Code_struct)) %>%  # 
  filter(Structure2 == ("Columns")) %>% 
  mutate(P=1) %>% 
    select(-c(Date_courte,Code_struct)) %>% 
  distinct() %>% group_by(Site) %>% 
  group_split()

# On créait une fonction pour nettoyer l'intérieur de la liste
fun_clean=function(x){
  x %>% spread(date_st,P) %>% 
    select(-c(spp,Site,Structure2)) %>% 
      mutate(across(everything(.), ~replace_na(., 0))) %>% 
  as.data.frame()}

# Convertion de split df en list
comp_list=as.list(data_comp1)

# Application de la fonction + names
comp_list_clean=lapply(comp_list, fun_clean)
names(comp_list_clean)<-c('Bi','Bu','Fe','Vb')

# Fonction
out.raw <- iNEXT(comp_list_clean,q=0,
                 datatype="incidence_raw",
                 endpoint=80)
plot(out.raw)
# Ici tu les données concernant l'estimation de la rich. totale
Rar_disc_df=as.data.frame(out.raw$AsyEst)





### Piliers
data_comp1=data_PQ_light %>% ungroup %>% 
  select(spp,Date_courte,Site,Structure2, Code_struct) %>% 
   filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte','None')) %>%
  mutate(date_st=paste0(Date_courte,'_',Code_struct)) %>%  # 
  filter(Structure2 == ("Pillars")) %>% 
  mutate(P=1) %>% 
    select(-c(Date_courte,Code_struct)) %>% 
  distinct() %>% group_by(Site) %>% 
  group_split()

# On créait une fonction pour nettoyer l'intérieur de la liste
fun_clean=function(x){
  x %>% spread(date_st,P) %>% 
    select(-c(spp,Site,Structure2)) %>% 
      mutate(across(everything(.), ~replace_na(., 0))) %>% 
  as.data.frame()}

# Convertion de split df en list
comp_list=as.list(data_comp1)

# Application de la fonction + names
comp_list_clean=lapply(comp_list, fun_clean)
names(comp_list_clean)<-c('Bi','Bu','Fe','Vb')

# Fonction
out.raw <- iNEXT(comp_list_clean,q=0,
                 datatype="incidence_raw",
                 endpoint=80)
plot(out.raw)

# Ici tu les données concernant l'estimation de la rich. totale
Rar_disc_df=as.data.frame(out.raw$AsyEst)


### Colonnes
data_comp1=data_PQ_light %>% ungroup %>% 
  select(spp,Date_courte,Site,Structure2, Code_struct) %>% 
   filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte','None')) %>%
  mutate(date_st=paste0(Date_courte,'_',Code_struct)) %>%  # 
  filter(Structure2 == ("Inner_slots")) %>% 
  mutate(P=1) %>% 
    select(-c(Date_courte,Code_struct)) %>% 
  distinct() %>% group_by(Site) %>% 
  group_split()

# On créait une fonction pour nettoyer l'intérieur de la liste
fun_clean=function(x){
  x %>% spread(date_st,P) %>% 
    select(-c(spp,Site,Structure2)) %>% 
      mutate(across(everything(.), ~replace_na(., 0))) %>% 
  as.data.frame()}

# Convertion de split df en list
comp_list=as.list(data_comp1)

# Application de la fonction + names
comp_list_clean=lapply(comp_list, fun_clean)
names(comp_list_clean)<-c('Bi','Bu','Fe','Vb')

# Fonction
out.raw <- iNEXT(comp_list_clean,q=0,
                 datatype="incidence_raw",
                 endpoint=80)
plot(out.raw)
# Ici tu les données concernant l'estimation de la rich. totale
Rar_disc_df=as.data.frame(out.raw$AsyEst)





### Toutes les structures 
data_comp1=data_PQ_light %>% ungroup %>% 
  select(spp,Date_courte,Site,Structure2, Code_struct) %>% 
   filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte','None')) %>%
  mutate(date_st=paste0(Date_courte,'_',Code_struct)) %>%  
   filter(Structure2 %in% c("Disc","Pillars","Columns","Inner_slots")) %>% 
  mutate(P=1) %>% 
    select(-c(Date_courte,Code_struct)) %>% 
  distinct() %>% group_by(Site) %>% 
  group_split()


# On créait une fonction pour nettoyer l'intérieur de la liste
fun_clean=function(x){
  x%>% spread(date_st,P) %>% 
    distinct(spp,.keep_all = TRUE) %>% #ajout de cette fonction permettant de ne pas additionner les taxons en fonction des structures
    select(-c(spp,Site,Structure2)) %>% 
      mutate(across(everything(.), ~replace_na(., 0))) %>% 
  as.data.frame()}

# Convertion de split df en list
comp_list=as.list(data_comp1)

# Application de la fonction + names
comp_list_clean=lapply(comp_list, fun_clean)
names(comp_list_clean)<-c('Bi','Bu','Fe','Vb')

# Fonction
out.raw <- iNEXT(comp_list_clean,q=0,
                 datatype="incidence_raw",
                 endpoint=250)
plot(out.raw)


# Ici tu les données concernant l'estimation de la rich. totale
Rar_disc_df=as.data.frame(out.raw$AsyEst)

specpool(as.numeric(comp_list_clean$Bi))




### test  
data_comp1=data_PQ_light %>% ungroup %>% 
  select(spp,Date_courte,Site,Structure2, Code_struct) %>% 
   filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte','None')) %>%
   filter(Date_courte %in% c("2022-07","2021-07")) %>% 
  filter(Site == "Bi") %>% 
  mutate(date_st=paste0(Date_courte,'_',Code_struct)) %>%  
   filter(Structure2 %in% c("Disc","Pillars","Columns","Inner_slots")) %>% 
  mutate(P=1) %>% 
    select(-c(Date_courte,Code_struct)) %>% 
  distinct() %>% group_by(Structure2) %>% 
  group_split()


# On créait une fonction pour nettoyer l'intérieur de la liste
fun_clean=function(x){
  x%>% spread(date_st,P) %>% 
    distinct(spp,.keep_all = TRUE) %>% #ajout de cette fonction permettant de ne pas additionner les taxons en fonction des        structures
    select(-c(spp,Site,Structure2)) %>% 
      mutate(across(everything(.), ~replace_na(., 0))) %>% 
  as.data.frame()}

# Convertion de split df en list
comp_list=as.list(data_comp1)

# Application de la fonction + names
comp_list_clean=lapply(comp_list, fun_clean)
names(comp_list_clean)<-c('Bi','Bu','Fe','Vb')

# Fonction
out.raw <- iNEXT(comp_list_clean,q=0,
                 datatype="incidence_raw",
                 endpoint=250)
plot(out.raw)

```



# ### Indices Beta

## Indice de Shannon et Piélou
```{r}
# stabilité des communautés, 0 = 1 espèce prédominante sur sur le récif et 1 = équité de la répartion des espèces
##### indice de Shannon

#### Richesse taxo
#matrice présence/absence  par site par espèce
dataR2=dataR %>% ungroup %>%
  select(spp,Site,Day_delta) %>% 
  distinct()%>% 
  group_by(spp,Site,Day_delta) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR4<-spread((dataR3=dataR2 %>% 
  group_by(spp,Site,Day_delta) %>%
  summarize(S2 = mean(S))),key=spp,value=S2)

dataR4[is.na(dataR4)]<-0

shannonind<-diversity(dataR4[,-c(1:2)],index="shannon")
shannonind2<-cbind(dataR4[,c(1:2)],shannonind)
colnames(shannonind2)[3]<-"shannon"


#### Recouvrement
#matrice couverture moyenne par site par espèce
dataR2=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Day_delta,Mcov) %>% 
  distinct()%>% 
  group_by(spp,Site,Structure2,Day_delta,Mcov)

dataR4<-spread((dataR3=dataR2 %>% 
  group_by(spp,Site,Day_delta) %>%
  summarize(Mcov2 = mean(Mcov))),key=spp,value=Mcov2) 
dataR4[is.na(dataR4)]<-0

# Calcul indice de Shannon
shannonind<-diversity(dataR4[,-c(1:2)],index="shannon")
shannonind2<-cbind(dataR4[,c(1:2)],shannonind)
colnames(shannonind2)[3]<-"shannon"


#plot shannon
ggplot(shannonind2, aes(Day_delta,shannon, col=Site))+ # Avec "fill" ou "col" du peut ajout une séparation de tes données par facteur (ici le site)
  xlab("Jour depuis immersion")+
  ylab("Indice de Shannon")+
  # geom_jitter(alpha=.3)+  # On ajoute les points (pas nécessaire mais utile pour savoir sur quoi se base les boxplots)
  # geom_boxplot()+
  # geom_smooth()+
  geom_point()+
  geom_line(aes(group=Site))+
  theme_bw() 

#test calcul shannon max théorique
# propmax<-1/ncol(dataR4[,-1])
# shannonmax<- -sum(propmax*log(propmax))

#### indice de Piélou (indice de Shannon/Richesse spécifique)
Piélouind<-shannonind/log(45) #indice de shannon divisé par le nombre max de taxons sur un meme site
Piélouind2<-cbind(dataR4[,c(1:2)],Piélouind)
colnames(Piélouind2)[3]<-"Piélou"

#plot Piélou
ggplot(Piélouind2, aes(Day_delta,Piélou, col=Site))+ # Avec "fill" ou "col" du peut ajout une séparation de tes données par facteur (ici le site)
  xlab("Nombre de jours d'immersion")+
  ylab("Indice de Piélou")+
  # geom_jitter(alpha=.3)+  # On ajoute les points (pas nécessaire mais utile pour savoir sur quoi se base les boxplots)
  # geom_boxplot()+
  geom_line(aes(group=Site))+
  geom_point()+
  theme_bw() +
    (scale_y_continuous(limits=c(0.4,0.9)))+
      (scale_x_continuous(limits=c(110,750)))+
   # (scale_x_continuous(minor_breaks=seq(0,27,by=2)))+
     # (scale_x_continuous(breaks=seq(0,25,by=2)))+
  annotate("rect",xmin=112,xmax=205.9,ymin=0.4,ymax=0.9,alpha=.1,fill="green")+
  annotate("rect",xmin=206,xmax=298.9,ymin=0.4,ymax=0.9,alpha=.1,fill="orange")+
  annotate("rect",xmin=299,xmax=388.9,ymin=0.4,ymax = 0.9,alpha=.1,fill="brown")+
  annotate("rect",xmin=389,xmax=477.9,ymin=0.4,ymax = 0.9,alpha=.1,fill="blue")+
annotate("rect",xmin=478,xmax=570.9,ymin=0.4,ymax = 0.9,alpha=.1,fill="green")+
  annotate("rect",xmin=571,xmax=663.9,ymin=0.4,ymax = 0.9,alpha=.1,fill="orange")+
  annotate("rect",xmin=664,xmax=750,ymin=0.4,ymax = 0.9,alpha=.1,fill="brown")+
annotate("text",x = c(159,252,344,433,524,617,708),y=0.45,
           label=c("Printemps","Eté","Automne","Hiver","Printemps","Eté","Automne"),
           colour=c("green","orange","brown","blue","green","orange","brown"))

```



## Calcul nestedness/replacement/richesse
```{r}

dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"

### Mcov moyen
dataR3=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Date_courte,Mcov,Quad2,saison) %>%
  distinct()%>%
  group_by(Site,Structure2,Mcov,Micro,Quad2,Date_courte,saison) %>%
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by=c(spp,Site,Structure2,Micro,Date_courte,saison)) %>%
  na.omit()%>%
  droplevels() %>% 
  spread(spp,Mcov2) %>% 
  mutate(across(everything(.), ~replace_na(., 0))) %>% 
  mutate(Name=paste(Site,Structure2,Date_courte,saison,sep=","))
 

#Calcul de la nestedness, diversité et turnover
databetadiv2<-beta.div.comp(dataR3[,-c(1:5,66)],coef="S") 
databetadiv2$rich


# Extraction des matrices
mat.D=as.matrix(databetadiv2$D)
mat.D[upper.tri(mat.D)]<-NA
diag(mat.D)<-NA
rownames(mat.D)<-dataR3$Name #change le nom des lignes avec les metadonnées
colnames(mat.D)<-dataR3$Name #change le nom des colonnes avec les metadonnées
 
mat.repl=as.matrix(databetadiv2$repl)
mat.repl[upper.tri(mat.repl)]<-NA
diag(mat.repl)<-NA
rownames(mat.repl)<-dataR3$Name #change le nom des lignes avec les metadonnées
colnames(mat.repl)<-dataR3$Name #change le nom des colonnes avec les metadonnées
 
mat.rich=as.matrix(databetadiv2$rich)
mat.rich[upper.tri(mat.rich)]<-NA
diag(mat.rich)<-NA
rownames(mat.rich)<-dataR3$Name #change le nom des lignes avec les metadonnées
colnames(mat.rich)<-dataR3$Name #change le nom des colonnes avec les metadonnées
 

# Transformation des matrices en df
test.mat.D=na.omit(reshape2::melt(mat.D)) %>% mutate(Type='D') 
test.mat.D2 <- test.mat.D %>%
  mutate(row_id = row_number()) %>%  # Créer une colonne pour identifier chaque ligne
  separate(Var1, into = paste0("Var1", 1:4), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 1 
  separate(Var2, into = paste0("Var2", 1:4), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 2
  select(-row_id)  # Supprimer la colonne d'identification
colnames(test.mat.D2)<-c("Site1","Structure1","Date1","Saison1","Site2","Structure2","Date2","Saison2","Dissimilarité","type")

test.mat.repl=na.omit(reshape2::melt(mat.repl)) %>% mutate(Type='repl')
test.mat.repl2 <- test.mat.repl %>%
  mutate(row_id = row_number()) %>%  # Créer une colonne pour identifier chaque ligne
  separate(Var1, into = paste0("Var1", 1:4), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 1 
  separate(Var2, into = paste0("Var2", 1:4), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 2
  select(-row_id)  # Supprimer la colonne d'identification
colnames(test.mat.repl2)<-c("Site1","Structure1","Date1","Saison1","Site2","Structure2","Date2","Saison2","Dissimilarité","type")

test.mat.rich=na.omit(reshape2::melt(mat.rich)) %>% mutate(Type='rich')
test.mat.rich2 <- test.mat.rich %>%
  mutate(row_id = row_number()) %>%  # Créer une colonne pour identifier chaque ligne
  separate(Var1, into = paste0("Var1", 1:4), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 1 
  separate(Var2, into = paste0("Var2", 1:4), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 2
  select(-row_id)  # Supprimer la colonne d'identification
colnames(test.mat.rich2)<-c("Site1","Structure1","Date1","Saison1","Site2","Structure2","Date2","Saison2","Dissimilarité","type")


#Création jeu de données rassemblant les différentes données
datadissi<-test.mat.D2 %>% select(Site1,Structure1,Date1,Saison1,Site2,Structure2,Date2,Saison2,Dissimilarité) 
datarepl<-test.mat.repl2 %>% select(Site1,Structure1,Date1,Saison1,Site2,Structure2,Date2,Saison2,Dissimilarité) 
datarich<-test.mat.rich2 %>% select(Site1,Structure1,Date1,Saison1,Site2,Structure2,Date2,Saison2,Dissimilarité)

datatern<-cbind(datadissi[,-c(5,7)],Similarité=(1-datadissi[,9])*100,Remplacement=100*datarepl[,9],Richesse=100*datarich[,9])
datatern<-cbind(datadissi[,-c(9)],Similarité=(1-datadissi[,9]),Remplacement=datarepl[,9],Richesse=datarich[,9])

```



### Ternary plot
```{r}

########## Test package gg plot ########## #http://www.ggtern.com/d/2.2.0/
datatern2=datatern %>%
  # filter(Structure1 == 'Disc') %>%
  # filter(Site1 == 'VB') %>%
    # filter(Site2 == 'Fe') %>%
    filter(Site1!=Site2) %>% 
  # filter(Site1 == Site2,
         # Saison1 == Saison2
         # ) %>%
  # filter(Structure1!=Structure2) %>%
  filter(Structure1 == Structure2) %>%
  # filter(Date1!=Date2) %>%
  filter(Date1==Date2) %>%
  # filter(Date1 == '2022-01') %>%
  # filter(Date2 == '2022-01') %>%
  # filter(!Date1 %in% c("2021-04","2021-07",'2021-10','2021-11')) %>%
  # filter(!Date2 %in% c("2021-04","2021-07",'2021-10','2021-11')) %>%
  mutate(Comp_site=Site1,
         Comp_struct=Structure1) 
# %>% 
  # filter(Comp_struct =="Inner_slots")

datatern2=datatern2 %>% 
 mutate(Compasite<-paste(Site1,Site2,sep="/")) %>% 
  mutate(Compastruct<-paste(Structure1,Structure2,sep="/")) %>% 
  mutate(Compadate<-paste(Date1,Date2,sep="/")) %>% 
  mutate(Compasaison<-paste(Saison1,Saison2,sep="/")) %>% 
  mutate(Compasite_date<-paste(Site1,Date1,sep="/")) 
colnames(datatern2)[14]<-"Compasite"
colnames(datatern2)[15]<-"Compastruct"
colnames(datatern2)[16]<-"Compadate"
colnames(datatern2)[17]<-"Compasaison"
colnames(datatern2)[18]<-"Compasitedate"

#pour pouvoir mettre mettre les données de structure et date ensemble
# datatern2=datatern2 %>% mutate(Compasitedate=paste(Comp_struct,Compadate))
datatern2=datatern2 %>% mutate(Compasite_struct=paste(Compasite,Structure1))
datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
datatern2=datatern2 %>% mutate(Site_Years=paste(Compasite,Years))
datatern2=datatern2 %>% mutate(Compastruct_date=paste(Compadate,Compastruct))
datatern2=datatern2 %>% mutate(Compastruct_site_date=paste(Compasitedate,Compastruct))
datatern2=datatern2 %>% mutate(Compasite_date=paste(Compasite,Date1))

datamean<-datatern2 %>%  group_by(Compasite,Compasite_date,Comp_struct,Compadate) %>%  #permet de faire la moyenne de chaque colonne par site/struct
  #  Compastruct,,Comp_site,Compadate,Compadate,Compadate,Compastruct,Compastruct,Site_Years <-à utiliser dans la ligne d'avant afin de faire les comparaisons voulues
  dplyr::summarize(Similarité=mean(Similarité),
            Remplacement=mean(Remplacement),
            Richesse=mean(Richesse))

ggtern(data=datatern2, aes(x=Richesse,y=Similarité,z=Remplacement,group=Compasite_date)) +
  # geom_point(aes(colour=Compasite), position=position_jitter_tern(x=0.1, y=0.1, z=0.1),alpha=.3) +
    # geom_point(aes(colour=Compastruct), position=position_jitter_tern(x=0.1, y=0.1, z=0.1),alpha=.3) +
      # geom_point(aes(colour=Compasitedate), position=position_jitter_tern(x=0.1, y=0.1, z=0.1),alpha=.2) +
  geom_point(aes(color=Compasite_date),position=position_jitter_tern(x=0.1, y=0.1, z=0.1),alpha=.1)+
        geom_point(data=datamean,aes(color=Compasite_date)) +
  # stat_density_tern( #ajout de la densité
            # geom="polygon",aes(fill=after_stat(level)),bins=10,color='grey')+
            # geom="polygon",aes(fill=Structure1),bins=10,color='grey')+
            # geom="polygon",aes(fill=Compasite),bins=10,color='grey')+
  theme_hidetitles()+ #enlève le nom des axes
  theme_showarrows()+ #montre les fléches
  # geom_crosshair_tern(data=datamean,aes(color=Compastruct_date))+
  # geom_crosshair_tern(data=datamean,aes(color=Compadate))+
  # geom_crosshair_tern(data=datamean,aes(color=Compastruct_date))+
  # geom_crosshair_tern(data=datamean,aes(color=Compasitedate))+
  # facet_wrap(.~Comp_site)+
  # facet_wrap(.~Compasite)+
    facet_wrap(.~Comp_struct)+
  labs(title="")+
  # scale_color_paletteer_d("dichromat::SteppedSequential_5")
  # labs(color = "Structures comparées")+
  
#### trajectoire avec flèches pour comparer les structures semblables

  # geom_path(data=datamean[which(datamean$Comp_site == "Bi" & datamean$Comp_struct=="Disc"),],group=1,aes(color=Compasitedate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Bu" & datamean$Comp_struct=="Disc"),],group=1,aes(color=Compasitedate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Fe" & datamean$Comp_struct=="Disc"),],group=1,aes(color=Compasitedate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "VB" & datamean$Comp_struct=="Disc"),],group=1,aes(color=Compasitedate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))
  # geom_path(data=datamean[which(datamean$Comp_site == "Bi" & datamean$Comp_struct=="Columns"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Bu" & datamean$Comp_struct=="Columns"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Fe" & datamean$Comp_struct=="Columns"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "VB" & datamean$Comp_struct=="Columns"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  # geom_path(data=datamean[which(datamean$Comp_site == "Bi" & datamean$Comp_struct=="Pillars"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Bu" & datamean$Comp_struct=="Pillars"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Fe" & datamean$Comp_struct=="Pillars"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "VB" & datamean$Comp_struct=="Pillars"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  # geom_path(data=datamean[which(datamean$Comp_site == "Bi" & datamean$Comp_struct=="Inner_slots"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Bu" & datamean$Comp_struct=="Inner_slots"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Fe" & datamean$Comp_struct=="Inner_slots"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "VB" & datamean$Comp_struct=="Inner_slots"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))



#### Trajectoire pour comparer les structures différentes
 # geom_path(data=datamean[which(datamean$Compastruct=="Columns/Disc"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Columns/Inner_slots"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Columns/Pillars"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Inner_slots/Disc"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Inner_slots/Columns"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Inner_slots/Pillars"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Pillars/Columns"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Pillars/Disc"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Pillars/Inner_slots"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Disc/Columns"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Disc/Inner_slots"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Disc/Pillars"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))


#### Trajectoire pour comparer les récifs différents selon les structures
geom_path(data=datamean[which(datamean$Compasite=="Bu/Bi"),],group=1,aes(color=Compasite_date),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
geom_path(data=datamean[which(datamean$Compasite=="Fe/Bi"),],group=1,aes(color=Compasite_date),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+ 
geom_path(data=datamean[which(datamean$Compasite=="Fe/Bu"),],group=1,aes(color=Compasite_date),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
geom_path(data=datamean[which(datamean$Compasite=="VB/Bi"),],group=1,aes(color=Compasite_date),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
geom_path(data=datamean[which(datamean$Compasite=="VB/Bu"),],group=1,aes(color=Compasite_date),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
geom_path(data=datamean[which(datamean$Compasite=="VB/Fe"),],group=1,aes(color=Compasite_date),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))


#### personnalisation du plot
# theme_custom( #https://rdrr.io/cran/ggtern/man/ggtern_themes.html
#   base_size = 10,
#   base_family = "",
#   tern.plot.background = NULL,
#   tern.panel.background = NULL,
#   col.T = "deepskyblue",
#   col.L = "green3",
#   col.R = "firebrick1",
#   col.grid.minor = "white"
# )
  
   
```

# # Significativité des taxons indicateurs du site (fonction multipatt)
```{r}

#test sans moyenne par structure et donc avec micro
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"

### Mcov moyen
dataR3=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Date_courte,Mcov,Quad2,saison) %>%
  distinct()%>%
  group_by(Site,Structure2,Mcov,Micro,Quad2,Date_courte,saison) %>%
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by=c(spp,Site,Structure2,Micro,Date_courte,saison)) %>%
  na.omit()%>%
  droplevels() %>% 
  spread(spp,Mcov2) %>% 
  mutate(across(everything(.), ~replace_na(., 0))) %>% 
  mutate(Name=paste(Site,Structure2,Date_courte,saison,sep=","))
 
dataR3
test1<-multipatt(dataR3[-c(1:5,66)],dataR3$Site)
summary(test1)

# test avec moyenne par structure
dataR4=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Date_courte,Mcov,Quad2,saison) %>%
  distinct()%>%
  group_by(Site,Structure2,Mcov,Micro,Quad2,Date_courte,saison) %>%
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by=c(spp,Site,Structure2,Micro,Date_courte,saison)) %>%
  na.omit()%>%
  droplevels() 
  
dataR5=dataR4 %>% ungroup %>% 
    group_by(Site,saison,Date_courte,Structure2) %>% 
  as.data.frame() %>% summarize(Mcov3=mean(Mcov2),.by=c(spp,Site,Structure2,Date_courte,saison)) %>%
  spread(spp,Mcov3) %>% 
  mutate(across(everything(.), ~replace_na(., 0)))  
  # mutate(Name=paste(Site,Structure2,Date_courte,saison,sep=","))

test1<-multipatt(dataR5[-c(1:4)],dataR5$Site)
summary(test1)


```

# # Recouvrement par la roche nue

```{r}
# Quelle est l'évolution de la colonisation de la roche nue au fil du temps?
# Est ce que la diminution de la richesse taxonomique en hiver est démontrée par un nombre d'espèces plus faibles? Par une diminution de la colonisation du récif (augmentation du taux de roche nue(mortalité de la flore/faune sessile))?

dataR2=data_PQ_light %>% ungroup %>%
  filter(spp == "NI") %>%
  filter(!Micro %in% c('C2P3.rndpts.csv','C2P4.rndpts.csv','C2P6.rndpts.csv')) %>% 
  filter(!Site == ("DSC"))%>%
  filter(!Structure2 %in% c('Holes','Upper_slots','Dome')) %>% 
  filter(!Date_courte == '2021-01') %>% 
  select(Site,Day_delta,Structure2,Micro,Quad2,Mcov) %>% 
  group_by(Site,Day_delta,Structure2,Micro,Quad2,Mcov) %>% 
  na.omit() %>% 
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by = c(Day_delta,Site,Structure2,Micro)) 

dataR3=dataR2 %>% as.data.frame() %>% 
  summarize(Mcov3=mean(Mcov2),.by = c(Day_delta,Site,Structure2)) 

dataR3=dataR2 %>% as.data.frame() %>% 
  summarize(Mcov3=mean(Mcov2),.by = c(Day_delta,Site)) 


ggplot(dataR3, aes(Structure2,Mcov3, fill=Site))+
  xlab("Structure")+
  ylab("Taux de roche nue")+
  geom_jitter(alpha=.3)+  
  geom_boxplot()+
  theme_bw()  

#Evolution temporelle
ggplot(dataR3, aes(Day_delta,Mcov3, col=Site))+
  xlab("Nombre de jours d'immersion")+
  ylab("Pourcentage de non-recouvrement du récif (%)")+
  geom_point()+
  geom_line(aes(group=Site))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
annotate("rect",xmin=112,xmax=205,ymin=-1,ymax = 32,alpha=.1,fill="green")+
  annotate("rect",xmin=206,xmax=298,ymin=-1,ymax = 32,alpha=.1,fill="orange")+
  annotate("rect",xmin=299,xmax=388,ymin=-1,ymax = 32,alpha=.1,fill="brown")+
  annotate("rect",xmin=389,xmax=477,ymin=-1,ymax = 32,alpha=.1,fill="blue")+
annotate("rect",xmin=478,xmax=570,ymin=-1,ymax = 32,alpha=.1,fill="green")+
  annotate("rect",xmin=571,xmax=663,ymin=-1,ymax = 32,alpha=.1,fill="orange")+
  annotate("rect",xmin=664,xmax=752,ymin=-1,ymax = 32,alpha=.1,fill="brown")+
  annotate("rect",xmin=753,xmax=800,ymin=-1,ymax = 32,alpha=.1,fill="blue")+
annotate("text",x = c(158,252,343,433,524,617,708),y=0,
           label=c("Printemps","Eté","Automne","Hiver","Printemps","Eté","Automne"),
           colour=c("green","orange","brown","blue","green","orange","brown"))



#### Test Gam recouvrement roche nue
dataR<-data_PQ_light
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"

dataR2=dataR %>% ungroup %>%
  filter(spp == "NI") %>%
  filter(!Micro %in% c('C2P3.rndpts.csv','C2P4.rndpts.csv','C2P6.rndpts.csv')) %>% 
  filter(!Site == ("DSC"))%>%
  filter(!Structure2 %in% c('Holes','Upper_slots','Dome')) %>% 
  filter(!Date_courte == '2021-01') %>% 
  select(Site,Day_delta,Structure2,Micro,Quad2,Mcov,saison) %>% 
  group_by(Site,Day_delta,Structure2,Micro,Quad2,Mcov,saison) %>% 
  na.omit() %>% 
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by = c(Day_delta,Site,Structure2,Micro,saison)) 

dataR3=dataR2 %>% as.data.frame() %>% 
  summarize(Mcov3=mean(Mcov2),.by = c(Day_delta,Site,Structure2,saison)) 

# dataR3=dataR2 %>% as.data.frame() %>% 
#   summarize(Mcov3=mean(Mcov2),.by = c(Day_delta,Site)) 
dataR3$Site<-as.factor(dataR3$Site)
dataR3$saison<-as.factor(dataR3$saison)

model111111<-gam(Mcov3~s(Day_delta)+s(Structure2,bs="re")+s(Site,bs="re")+s(saison,bs="re")+s(Structure2,by=Site,bs='re'),data=dataR3) 
summary(model111111)

plot_smooths(model=model111111, series=Day_delta,comparison=Site)+theme_bw()+ #permet de mettre les gam selon les sites
  # (scale_y_continuous(limits=c(0,60)))+
      (scale_x_continuous(limits=c(110,750)))+
   # (scale_x_continuous(minor_breaks=seq(0,27,by=2)))+
     # (scale_x_continuous(breaks=seq(0,25,by=2)))+
  geom_vline(xintercept = 206,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 299,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 389,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 478,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 571,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 664,colour='#666666',alpha=.5)+
#   annotate("rect",xmin=112,xmax=205.9,ymin=0,ymax=10,alpha=.1,fill="green")+
#   annotate("rect",xmin=206,xmax=298.9,ymin=0,ymax=10,alpha=.1,fill="orange")+
#   annotate("rect",xmin=299,xmax=388.9,ymin=0,ymax=10,alpha=.1,fill="brown")+
#   annotate("rect",xmin=389,xmax=477.9,ymin=0,ymax=10,alpha=.1,fill="blue")+
# annotate("rect",xmin=478,xmax=570.9,ymin=0,ymax=10,alpha=.1,fill="green")+
#   annotate("rect",xmin=571,xmax=663.9,ymin=0,ymax=10,alpha=.1,fill="orange")+
#   annotate("rect",xmin=664,xmax=750,ymin=0,ymax=10,alpha=.1,fill="brown")+
annotate("text",x = c(159,252,344,433,524,617,708),y=60,
           label=c("Printemps","Eté","Automne","Hiver","Printemps","Eté","Automne"),
           colour=c("#666666","#666666","#666666","#666666","#666666","#666666","#666666"))+
   xlab("Nombre de jours d'immersion")+
  ylab("Pourcentage de roche nue sur le récif")

```

# # Recouvrement par les espèces
```{r}

data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2,saison,Quad2,Day_delta) %>% 
  mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
  group_by(spp,Site,Micro,Date_courte,Structure2,saison,Years,Day_delta) %>% 
  filter(Site == "VB") %>% 
  # filter(Structure2 == "Disc") %>% 
  # filter(Date_courte == "2021-11") %>%
  distinct() %>% drop_na() %>% 
  summarize(Mcov2 = mean(Mcov,.by=c(spp,Micro,Day_delta,Quad2)))



  # spread(spp,Mcov2) %>% ungroup() %>%
  # mutate(across(everything(.), ~replace_na(., 0)))

  
data_comp3=data_comp2 %>% ungroup %>% 
  select(spp,Site,Structure2,Day_delta,Mcov2) %>% 
      group_by(spp,Site,Structure2,Day_delta) %>%  
  summarize(Mcov3 = mean(Mcov2,.by=c(spp,Structure2))) 

# ggplot(data_comp2,aes(x=Structure2,y=Mcov2,col=spp))+
#   geom_col()
# 
# ggplot(data_comp3,aes(x=Structure2,y=Mcov3,col=spp))+
#   geom_col()

data_comp4=data_comp3 %>% ungroup %>% 
  select(spp,Site,Structure2,Day_delta,Mcov3) %>% 
      group_by(spp,Site,Structure2) %>%  
  summarize(Mcov4 = mean(Mcov3,.by=c(spp,Day_delta)))

 data_comp4=data_comp4 %>% 
   mutate(sd=sqrt(Mcov4))

data_comp5 <- data_comp4[order(data_comp4$Mcov4, decreasing = TRUE), ]#mettre dans l'ordre décroissant

# ggplot(data_comp4,aes(x=spp,y=Mcov3,fill=Structure2))+
#   geom_bar(stat="identity")+
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

# ggplot(data_comp5,aes(x=spp,y=Mcov4,fill=Structure2))+
#   geom_bar(stat="identity")+
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

ggplot(data_comp5,aes(x=reorder(spp,-Mcov4, function(x){sum(x)}),y=Mcov4,fill=Structure2))+
  geom_bar(stat="identity",position=position_dodge())+
  geom_errorbar(aes(ymin=Mcov4-sd, ymax=Mcov4+sd), width=.2, #ajout des barres d'erreur
                 position=position_dodge(.9))+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```


# # Test calcul divers
##### Test calcul turnover
```{r}

#proportion relative d'espèces gagnée ou perdue face au nombre total d'espèces observé sur la période 
# 
# dataR2=dataR %>% ungroup %>% 
#    filter(Site == 'Bi') %>%
#   select(spp,Site,Structure2,Day_delta) %>% 
#   distinct()%>% 
#   group_by(spp,Site,Day_delta) %>% 
#   summarize(S=n()) %>%
#   na.omit()
# 
# dataR3=dataR2 %>% 
#   group_by(spp,Site,Day_delta) %>% 
#   summarize(S2 = mean(S))
# 
# 
# turn<-turnover(dataR3,
#                time.var="Day_delta",
#                species.var="spp",
#                abundance.var="S2",
#                metric="total")
# 
# 
# #Dissimilarité de Jaccard
# dataR2<- spread((dataR2=dataR %>% 
#   select(spp,Site,Date_courte,Structure2) %>% 
#   # filter(Date_courte %in% c("2022-04","2022-07"))%>%
#   # filter(Structure2 == ("Disc")) %>%
#   filter(Site == "Bi") %>% 
#   distinct() %>% 
#   group_by(spp,Site,Date_courte) %>% 
#   summarize(S=n())),key=Site,value=S)
# dataR2[is.na(dataR2)]<-0
# 
# similarité_jaccard <- vegdist(dataR2[,3], method = "jaccard")
# 
# similarité_bray <- vegdist(dataR2[,3], method = "bray")
# 
# # library(betapart)
# # dissimilarité_raup_crick<-beta.pair(dataR2,method="raup_crick")
# 
# dissimilarité_raup_crick<-raupcrick(dataR2)
# library(pheatmap)
# pheatmap(1-as.matrix(similarité_jaccard), display_numbers = 1-as.matrix(similarité_jaccard))

```

##### Indice de Jaccard

```{r}
#les sites sont-ils similaires entre eux? 
#Indice de Jaccard entre 0 (pas de similarité) et 1 (sites identiques)
#correspond aux nombres d'observations dans les deux sites / par le nombre dans chaque site


#pour faire avec les données spp
# library(stringdist)
# library(bayesbio)
# stringdist(dataR3[,1],dataR2[,1],method='jaccard')#converti les caractères en données utitilisable
# jaccardSets(dataR2[,1],dataR3[,1])
# 
# #pour faire avec les données spp.ID
# dataR2$spp.ID<-as.numeric(dataR2$spp.ID)
# dataR3$spp.ID<-as.numeric(dataR3$spp.ID)
# jaccard <- function(a, b) {
#     intersection = length(intersect(a, b))
#     union = length(a) + length(b) - intersection
#     return (intersection/union)
# }
# 
# jaccard(dataR2[,-c(2:3)],dataR3[,-c(2:3)])

dataR2=dataR %>% ungroup %>%
  filter(saison == 'été') %>% 
  select(spp,Site) %>% 
  distinct()%>% 
  group_by(spp,Site) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR4<-spread((dataR3=dataR2 %>% 
  group_by(spp,Site) %>%
  summarize(S2 = mean(S))),key=spp,value=S2) 
dataR4[is.na(dataR4)]<-0

jaccardind<-vegdist(dataR4[,-1],index="jaccard")

```

##### Indice de Sorensen
```{r}
#les sites sont-ils similaires entre eux? 
#Indice de Sorensen entre 0 (pas de similarité) et 1 (sites identiques)

dataR2=dataR %>%
  filter(!Date_courte=="2021-01") %>%
  filter(Site=="Bu") %>%
  select(spp.ID,Site) %>% 
  distinct() %>% 
  group_by(spp.ID,Site) %>%
  summarize(S=n())


dataR3=dataR %>% 
  filter(!Date_courte=="2021-01") %>%
  filter(Site=="Fe") %>%
  select(spp.ID,Site) %>% 
  distinct() %>% 
  group_by(spp.ID,Site) %>% 
  summarize(S=n()) 


#pour faire avec les données spp.ID
dataR2$spp.ID<-as.numeric(dataR2$spp.ID)
dataR3$spp.ID<-as.numeric(dataR3$spp.ID)
sorensen <- function(a, b) {
    intersection = 2*length(intersect(a, b))
    union = length(a) + length(b)
    return (intersection/union)
}

sorensen(dataR2[,2],dataR3[,2])

```

##### Indice de Simpson
```{r}
# Montre la diversité taxonomique, 0 étant la présence d'une espèce et 1 une diversité importante
dataR2=dataR %>% ungroup %>%
  filter(saison == 'été') %>% 
  select(spp,Site) %>% 
  distinct()%>% 
  group_by(spp,Site) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR4<-spread((dataR3=dataR2 %>% 
  group_by(spp,Site) %>%
  summarize(S2 = mean(S))),key=spp,value=S2) 
dataR4[is.na(dataR4)]<-0

simpsonind<-diversity(dataR4[,-1],index="simpson")

```

##### Test différence échantillonage
```{r}

dataR2=dataR %>% ungroup %>%
  select(Site,Day_delta,Structure2) %>% 
  distinct()%>% 
  group_by(Site,Day_delta,Structure2) %>% 
  summarize(S3=sum(n(Site)),.by=Structure2) %>%
  na.omit()


seqdate<-c('153','244','367','428','518','609','732')
Bid<-as.numeric(rep(8,times=7))
Bic<-c(8,7,8,8,8,7,8)
Bip<-rep(3,times=7)
Bis<-c(8,8,8,7,8,8,8)
Birep<-rep("Bi",times=7)
Bidata<-as.data.frame(cbind(Birep,seqdate,Bid,Bic,Bip,Bis))
colnames(Bidata)<-c("Site","Nbjourimmer","Disques","Colonnes","Pilliers","Slots")
Bidata$Nbjourimmer<-as.factor(Bidata$Nbjourimmer)
Bidata$Disques<-as.numeric(Bidata$Disques)
Bidata$Colonnes<-as.numeric(Bidata$Colonnes)
Bidata$Pilliers<-as.numeric(Bidata$Pilliers)
Bidata$Slots<-as.numeric(Bidata$Slots)
Bidata2<-spread(Bidata,key=Birep,value=Bid)
ggplot(Bidata,aes(fill=))

Bud<-c(7,8,8,5,8,"",8)
Buc<-c(8,7,8,8,4,"",8)
Bup<-c(3,3,3,3,3,"",3)
Bus<-c(7,8,8,7,8,"",7)
Burep<-rep("Bu",times=7)
Budata<-cbind(Burep,seqdate,Bud,Buc,Bup,Bus)

Fed<-c(8,"",8,8,8,8,"")
Fec<-c(8,"",5,8,6,8,"")
Fep<-c(3,"",3,3,0,8,"")
Fes<-c(8,"",8,8,8,8,"")
Ferep<-rep("Bu",times=7)
Fedata<-cbind(Ferep,seqdate,Fed,Fec,Fep,Fes)

VBd<-c(8,8,8,8,7,8,8)
VBc<-c(8,8,"",8,7,8,8)
VBp<-c(3,3,"",3,3,3,3)
VBs<-c(6,7,7,8,7,8,8)
VBrep<-rep("VB",times=7)
VBdata<-cbind(VBrep,seqdate,VBd,VBc,VBp,VBs)

datanumber<-as.data.frame(rbind(Bidata,Budata,Fedata,VBdata))
datanumber2<-as.data.frame(cbind(Bidata,Budata,Fedata,VBdata))

colnames(datanumber)<-c("Site","Date","Disques","Colonnes","Pilliers","Slots")
datanumber$Date<-as.factor(datanumber$Date)
datanumber$Site<-as.factor(datanumber$Site)
datanumber$Disques<-as.numeric(datanumber$Disques)
datanumber$Colonnes<-as.numeric(datanumber$Colonnes)
datanumber$Pilliers<-as.numeric(datanumber$Pilliers)
datanumber$Slots<-as.numeric(datanumber$Slots)

plot(datanumber$Date,datanumber$Disques)

ggplot(datanumber, aes(Date,Colonnes, fill=Site))+ # Avec "fill" ou "col" du peut ajout une séparation de tes données par facteur (ici le site)
  xlab("Structure")+
  ylab("Richesse taxonomique")+
  # geom_jitter(alpha=.3)+  # On ajoute les points (pas nécessaire mais utile pour savoir sur quoi se base les boxplots)
  geom_boxplot()+
  theme_bw() 

```

#### Données envoyées à Frédéric
dataR2=dataR %>% ungroup %>%
  select(spp,Site,Day_delta,saison,Structure2) %>% 
  distinct()%>% 
  group_by(spp,Site,Day_delta,saison,Structure2) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR4<-spread((dataR3=dataR2 %>% 
  group_by(spp,Site,Day_delta,saison,Structure2) %>%
  summarize(S2 = mean(S))),key=spp,value=S2)
   # ),key=spp,value=S)
dataR4[is.na(dataR4)]<-0


