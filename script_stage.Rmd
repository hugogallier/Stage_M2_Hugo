---
title: "script_analyse_test"
author: "Hugo Gallier"
date: "2024-01-23"
output: html_document
editor_options: 
  chunk_output_type: console
---


# Library

Package à télécharger
```{r}
rm(list=ls())

library(dplyr)
library(tidyr)
library(ggplot2)
library(here)
library(vegan)
library(scales)
library(fmsb)
library(FactoMineR)
library(ecodist)
library(ade4)
library(lme4)
library(Matrix)
library(sjPlot)
library(RColorBrewer)
library(iNEXT)
library(rstatix)
library(ggradar)
library(pairwiseAdonis)
library(ecole)
library(tidyverse)
library(mgcv)
library(ggforce)
library(tidymv)
library(ggtern)
library(codyn)
library(adespatial)
library(ggdendro)
library(car)
library(adegraphics)
library(gratia)
library(ggpubr)
library(paletteer)
library(indicspecies)
library(ggrepel)
library(ecotraj)
library(iml)
library(randomForest)
library(partykit)
library(glmnet)

```


#################### Importation du data et chargement ###################

```{r}
#Chargement des photos associées à chaque cadrats

setwd(here::here())

MPhoto=read.csv('Meta_photo.csv', sep=';')%>%
  # mutate(Micro=) %>%
  mutate(Micro=sub("\\_.*", "", Code_struct))
  
```

## Chargement data

```{r}
#Chargement des jeux de données

setwd('D:/Hugo/suivi_scientifique') # à modifier avec nom de ton DD
# setwd('E:/Marineff/suivi_scientifique')

data_list=list.files(pattern =".csv", recursive=T)

L=list()
for( i in 1: length(data_list)){
  
    Name_file=basename(data_list[i])

data=read.csv(data_list[i], sep=',', header=T, fileEncoding="latin1") %>%
  mutate(Name_file=rep(basename(data_list[i]), n()))

L[[i]]<-data
}


test_data_list=data_list[grepl('DSC',data_list)]


# fileEncoding="latin1"
```

## Date d'immersion

```{r}
# Ajout des dates d'immersion des différents récifs

Immer_site=data.frame(Site=c('Bi','Bu','VB','Fe'), Date=c(as.Date('2020-10-30'),as.Date('2020-11-26'),as.Date('2020-11-27'),as.Date('2020-11-30'))) %>%
       mutate(Date_imm_ok=format(as.POSIXlt(Date,  format = "%Y-%m-%d"), format="%Y-%m-%d", tz="GMT"))%>% select(Site,Date_imm_ok)
  
```


## Saison - date

```{r}
# Ajout de dates correspondant aux différentes saisons
Date_sais=data.frame(
           start=c(
             format(as.POSIXlt(as.Date('2021-03-20'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-06-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-09-22'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2021-12-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2022-03-20'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2022-06-21'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
             format(as.POSIXlt(as.Date('2022-09-22'),  format = "%Y-%m-%d"), format="%Y-%m-%d %%H:%M:%S", tz="GMT")))
```



## Mise en forme des données

```{r}
# Ajout de méta données à partir du nom de fichier (site,data,micro,n° de quadrat)
# Correction et abbréviation des noms de taxons
# Changements des noms des microhabitats
# Changements du format des dates


# test_dataPQ=data_PQ[grepl('DSC',data_PQ$Name_file),]

data_PQ=do.call(rbind,L) %>%
  mutate(Site=substr(Name_file, start = 1, stop = 2)) %>%
  separate(col = Name_file, into = c('Site','Date','Micro','truc','Quad'), sep = '_') %>%
  mutate( Site=ifelse(Site=='FR','Fe',Site),
          Quad=ifelse(is.na(Quad),truc,Quad),
          Quad2=substr(Quad, start = 1, stop = 2),
          Month_str=gsub("-.*", "", Date,perl=TRUE),
          YY=gsub(".*-", "", Date,perl=TRUE),
          Month=case_when( Month_str=='Avri'~'04',
                           Month_str=='avri'~'04',
                           Month_str=="Janv"~'01',
                           Month_str=='Juil'~'07',
                           Month_str=='Oct'~'10',
                           Month_str=='Nov'~'11'),
          Date_ok=format(as.POSIXlt(paste0('01/',Month,'/',YY),  format = "%d/%m/%y"), format="%Y-%m-%d %%H:%M:%S", tz="GMT"),
          Date_courte=format(as.POSIXlt(paste0('01/',Month,'/',YY),  format = "%d/%m/%y"), format="%Y-%m", tz="GMT"),
          Week=strftime(Date_ok, format = "%V")) %>%
  mutate(spp.Name= ifelse(spp.Name == 'Tubularia indivisa ', 'Tubularia indivisa',spp.Name),
         spp.Name=ifelse(spp.Name == 'Unidentified','NI',spp.Name))
  



# Version synthétique du df

data_PQ_light=data_PQ %>% dplyr::select(Image, spp.Name,spp.ID,N.pts.per.species,Cov..per.species,
               N.pts.ALL.species,Cov..ALL.species, Site,Date_ok,Micro,Quad2,
               Week,Date_courte,Month_str )%>%
rename('spp'='spp.Name',
       'Count'='N.pts.per.species',
       'Cov'='Cov..per.species',
       'Count_all'='N.pts.ALL.species',
       'Cov_all'='Cov..ALL.species')%>%
  mutate(abb=abbreviate(spp))%>%
   group_by(spp,abb,Site,Micro,Date_courte,Date_ok,Quad2) %>%
  summarize(Mcov=mean(Cov)) %>%
  # summarize(MCount=mean(Count)) %>%
  left_join(MPhoto, by=c('Micro')) %>%
  mutate(Structure2=recode_factor(Structure,
   "Bandes"="Dome",
   "Bandes.C1"="Disc",
   "Faille"="Inner_slots",
   "Faille_coupole"="Upper_slots",
   "Pilier.C2"="Columns",
   "Trous"="Holes",
   "Pieds"="Pillars"))%>% 
  mutate(Strcut_groups=case_when(
  Structure2 %in% c('Dome','Upper_slots')~'Horizontal_section',
 Structure2 %in% c('Disc','Columns','Pillars')~'Vertical_section',
  Structure2 %in% c('Inner_slots','Holes')~'Inner_section', TRUE ~ 'NA')) %>%
  mutate(M_ensemble=ifelse(Micro %in% c("P1","P2","P3","T1","T2","T3","T4"),substr(Micro, start = 1, stop = 1),substr(Micro, start = 1, stop = 3)),
         M_ensemble2=ifelse(M_ensemble == 'DPF','DGF',M_ensemble))%>%
  left_join(Immer_site, by='Site') %>% 
    mutate(spp=replace_na(spp,"None"))
 

knitr::kable(data_PQ_light %>% select(spp,abb)%>% unique())
corresp=data_PQ_light %>% select(spp,abb)%>% unique()
```

<!-- export le jeu de données en csv -->
<!-- write.csv(data_PQ_light,"data_semibrute.csv") -->
<!-- write.csv(dataR,"data_utilise.csv") -->
<!-- write.csv(dataR4,"matrice_de_presence.csv") -->

# #######################

# ###### Partie Hugo ######
# Formatage du jeu de données 
```{r}
#Calcul du temps depuis l'immersion
data_PQ_light=data_PQ_light %>% 
   mutate(Day_delta=as.numeric(difftime(Date_ok,Date_imm_ok,units='days')))

dataR1<-data_PQ_light
dataR=dataR1 %>% filter(!spp %in% c("NI","Unassigned","ponte","Ponte",'None','NA')) %>%
  filter(!Micro %in% c('C2P3.rndpts.csv','C2P4.rndpts.csv','C2P6.rndpts.csv')) %>% 
  filter(!Site == ("DSC"))%>%
  filter(!Structure2 %in% c('Holes','Upper_slots','Dome')) %>% 
  # filter(!Date_courte == '2021-01') %>%
  select (spp,abb,Site,Structure2,Micro,Date_courte,Mcov,Day_delta,Quad2)
  # select (spp,abb,Site,Micro,Date_courte,Structure2,MCount)

# save(dataR,file="dataR.Rdata")



#####permet de faire la moyenne du nombre de taxon dans chaque micro
# dataR2=dataR %>% ungroup %>%
#   select(spp,Site,Structure2,Micro,Date_courte) %>%
#   distinct()%>%
#   group_by(Site,Structure2,Micro,Date_courte) %>%
#   summarize(S=n()) %>%
#   na.omit()
# 
# dataR3=dataR2 %>%
#   group_by(Site,Structure2,Date_courte) %>%
#   summarize(mean__count = mean(S))

# 
#####permet de faire la moyenne du nombre de taxon dans chaque structure 
# dataR2=dataR %>% ungroup %>% 
#   select(spp,Site,Structure2,Date_courte) %>% 
#   distinct()%>% 
#   group_by(Site,Structure2,Date_courte) %>% 
#   summarize(S=n()) %>%
#   na.omit()
# 
# dataR3=dataR2 %>% 
#   group_by(Site,Date_courte) %>% 
#   summarize(mean__count = mean(S))


#####pour voir le nombre de quadrat par site/par date/ par structure
# dataR2=dataR %>% ungroup %>%
#   select(Site,Structure2,Micro,Date_courte) %>%
#   distinct()%>%
#   group_by(Site,Structure2,Date_courte) %>%
#     summarize(S=n()) %>%
#   na.omit()
# 
# dataR3=dataR2 %>%
#   group_by(Site,Structure2,Date_courte) %>%
#   summarize(mean__count = mean(S))


```


# ### Indice Gamma
```{r}
# Quel est la richesse taxonomique global (Indice Gamma) d'un site et de la zone d'étude en général

# Indice gamma par site 
dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Date_courte) %>% 
  filter(Date_courte  %in% c('2021-04','2021-07','2021-10','2021-11')) %>%
  filter(Site == "Fe") %>%
  distinct()%>% 
  group_by(spp,Date_courte,Site) %>% 
  summarize(S=n()) %>%
  na.omit()
length(unique(dataR2$spp))


seq<-rep(0,times=nrow(dataR))
dataR
dataR2=dataR %>% 
  select(spp,Site) %>% 
  distinct() %>% 
  group_by(spp,Site) %>% 
  summarize(S=n()) 
length(unique(dataR2$spp))


# Indice gamma Quad2# Indice gamma global
dataR2=dataR %>% 
  select(spp,seq1) %>% 
  distinct() %>% 
  group_by(seq1) %>% 
  summarize(S=n()) 


length(unique(dataR1$spp)) #permet de savoir le nombre de variable différente dans la colonne spp (mais ne prend pas en compte la suppression des N)

```


# ### Indice Alpha 


# Comparaison intersite et intrasite
## Comparaison intersite 2021-2022 (pas de temporalité saisonalle)
```{r}
#Y'a t'il une différence de richesse taxonomique entre les différents micro habitats, et selon les différents sites ainsi que selon les années?

#permet de faire la moyenne du nombre de taxon dans chaque micro
dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Date_courte) %>% 
  distinct()%>% 
  group_by(Site,Structure2,Micro,Date_courte) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR3=dataR2 %>% 
  group_by(Site,Structure2,Date_courte) %>% 
  summarize(S2 = mean(S))
# dataR3$S2[which(dataR3$Structure2=='Pillars')]<-(dataR3$S2[which(dataR3$Structure2=='Pillars')]/2)

ggplot(dataR3, aes(Structure2,S2, fill=Site))+ # Avec "fill" ou "col" du peut ajout une séparation de tes données par facteur (ici le site)
  xlab("Structure")+
  ylab("Richesse taxonomique moyenne")+
  geom_jitter(alpha=.3)+  # On ajoute les points (pas nécessaire mais utile pour savoir sur quoi se base les boxplots)
  geom_boxplot()+
  theme_bw()+  # Juste pour retirer le fond gris pas défaut
    theme(axis.text.y = element_text(size=9,color="black"))+
stat_summary(fun.y = mean,
        geom = "point",
        size = 2,
        color = "black",
        position = position_dodge(width = .75))


###########


#permet de faire la moyenne du nombre de taxon dans chaque micro
dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Date_courte) %>% 
  filter(!Date_courte == "2021-01") %>%
  distinct()%>% 
  group_by(Site,Structure2,Micro,Date_courte) %>% 
  summarize(S=n()) %>%
  na.omit()

#structure
dataR3=dataR2 %>% 
  group_by(Structure2,Date_courte) %>% 
  summarize(S2 = mean(S)) %>% 
  mutate(sd=sqrt(S2))

#site
dataR3=dataR2 %>% 
  group_by(Site,Date_courte) %>% 
  summarize(S2 = mean(S)) %>% 
  mutate(sd=sqrt(S2))

ggplot(dataR3, aes(Structure2,S2,fill=Structure2))+ #Structure
  # ggplot(dataR3, aes(Site,S2,fill=Site))+ #Site
  geom_bar(stat="identity",alpha=.7)+
  geom_errorbar(aes(ymin=S2, ymax=S2+sd), width=.2, position=position_dodge(.9))+ #ajout des barres d'erreur
  theme_bw()+  # Juste pour retirer le fond gris pas défaut
  xlab("")+ylab("Richesse taxonomique moyenne")+
  theme(axis.text.x = element_blank(), axis.ticks = element_blank())+
  facet_wrap(.~Date_courte)+
   # theme(axis.text.x = element_text(size=16,colour="black"))+
   theme(axis.text.y = element_text(size=15,colour="black"))+
   # theme(axis.title.x = element_text(size=16,colour="black",vjust=0))+
  theme(axis.title.y = element_text(size=16,colour="black",vjust=2))+
   theme(strip.text.x = element_text(size = 16))
ggsave("RTM selon site par date.png",width=9,height=8,dpi=350)
ggsave("RTM selon structure par date.png",width=9,height=8,dpi=350)


 


dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Date_courte)%>% 
  filter(Date_courte %in%  c("2023-07"))

dataR3=dataR2%>%select(spp,Site) %>% 
  distinct()%>% ungroup() %>% 
  group_by(Site) %>% 
  summarize(S=n()) %>%
  na.omit()


dataR2=dataR %>% ungroup %>%
  select(spp,Site) %>% 
  distinct()%>% ungroup() %>% 
  group_by(spp) %>% 
  summarize(S=n()) %>%
  na.omit()

```

###Test Shapiro/Levene/Anova
```{r}
# Y'a t-il des différences statistiques concerannt les sites/structurse/microhabitats,... ?

dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"

dataR2=dataR %>% ungroup %>% 
  filter(!Date_courte %in% c("2021-04","2021-07","2021-10","2021-11")) %>%
  select(spp,Site,Structure2,Micro,Day_delta,saison) %>% 
  distinct()%>% 
  group_by(Site,Structure2,Micro,Day_delta,saison) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR3=dataR2 %>% 
  group_by(Site,Structure2,Day_delta,saison) %>% 
  summarize(S2 = mean(S))

dataR3$Site<-as.factor(dataR3$Site)
dataR3$saison<-as.factor(dataR3$saison)


#Anova
test_anova<-aov(S2~Site+Structure2+saison,data=dataR3)# anova en prenant la date ainsi que les structures comme facteur
test_anova<-aov(S2~Site+Error(Day_delta),data=dataR3)# en prenant en variable aléatoire day delta
test_anova<-aov(S2~Site+Error(Structure2),data=dataR3)
test_anova<-aov(S2~Site,data=dataR3)
summary(test_anova)


#normalité des données
shapiro_test(residuals(test_anova))#si pvalue supérieure à 0,05 alors permet de dire que les résidus sont normalements distribuées
# qqnorm(test_anova$residuals)
# qqline(test_anova$residuals)


#Homoscédasticité
leveneTest(test_anova$residuals,dataR3)#Si p value supérieur à 0,05 alors variance entre les groupes est égale
test_levene<-levene_test(dataR3$S2~dataR3$Site+Structure2+dataR3$saison)
plot(test_anova$residuals~test_anova$fitted.values)

```

## Comparaison intersite (microhabitats confondus) temporelle
```{r}
# Comment évolue la richesse taxonomique des sites dans le temps?

#permet de faire la moyenne du nombre de taxon dans chaque micro
dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Date_courte) %>% 
  distinct()%>% 
  group_by(Site,Structure2,Date_courte) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR3=dataR2 %>% 
  group_by(Site,Date_courte) %>% 
  summarize(S2 = mean(S))


ggplot(dataR3, aes(Date_courte,S2, col=Site))+
  xlab("Date")+
  ylab("Richesse taxonomique")+
  geom_point()+
  geom_line(aes(group=Site))+
  # facet_wrap(.~Site)+ # <- cette fonction permet de réaliser les geoms précedents mais pour différentes catégories (ici j'ai choisi les micro habitat, mais on aurait pu le faire pour les sites par exemples)
  theme_bw()+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) # <- rotation des dates pour qu'elles soient lisibles

```

## Comparaison intersite des microhabitats - temporelle
```{r}
# Y'a t'il une différence temporelle dans l'évolution de la richesse taxnomique des microhabitats?

dataR2=dataR %>% ungroup %>% 
  filter(!Date_courte=="2021-01") %>%
  select(spp,Site,Date_courte,Structure2) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Structure2) %>% 
  summarize(S=n()) %>% 
  na.omit()


ggplot(dataR2 %>%  
  filter(!Date_courte=="2021-01"), 
  aes(Date_courte,S, col=Site))+
  xlab("Date")+
  ylab("Richesse taxonomique")+
  geom_point()+
  geom_line(aes(group=Site))+
  facet_wrap(.~Structure2)+ 
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

```

# # Radar plot
```{r}
#Y a t'il une colonisation prédominante sur les différentes parties des récifs?

# https://r-charts.com/ranking/ggradar/
# devtools::install_github("ricardo-bion/ggradar")


##### Bottom disc #####
lcol2<-brewer.pal(8,"Reds")
lcol2<-c('#FEE0D2','#FCBBA1','#FC9272','#FB6A4A','#EF3B2C','#CB181D','#99000D','#59040c')

# Bi
resultat4Bi<- na.omit(spread((dataR2=dataR %>% 
  filter(!Date_courte == ("2021-01"))%>%
  filter(Site == ("Bi"))%>%
  filter(Micro %in% c("C1B1","C1B2","C1B3","C1B4","C1B5","C1B6","C1B7","C1B8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S)) 
resultat4Bi[is.na(resultat4Bi)]<-0

ggradar(resultat4Bi[,-1],grid.min = 0,grid.mid=7,grid.max =15,values.radar = c(0,7,15),group.colours = lcol2[c(1,2,4:8)],legend.title="Site Bi",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


# Bu
resultat4Bu<- na.omit(spread((dataR2=dataR %>% 
  filter(!Date_courte == ("2021-01"))%>%
  filter(Site == ("Bu"))%>%
  filter(Micro %in% c("C1B1","C1B2","C1B3","C1B4","C1B5","C1B6","C1B7","C1B8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S)) 
resultat4Bu[is.na(resultat4Bu)]<-0

ggradar(resultat4Bu[,-1],grid.min = 0,grid.mid=7, grid.max =15,values.radar = c(0,7,15),group.colours = lcol2[c(2,4,6,8)],legend.title="Site Bu",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")

# Fe
resultat4Fe<- na.omit(spread((dataR2=dataR %>%
  filter(!Date_courte == ("2021-01"))%>%
  filter(Site == ("Fe"))%>%
  filter(Micro %in% c("C1B1","C1B2","C1B3","C1B4","C1B5","C1B6","C1B7","C1B8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S)) 
resultat4Fe[is.na(resultat4Fe)]<-0

ggradar(resultat4Fe[,-1],grid.min = 0,grid.mid=7,grid.max =15,values.radar = c(0,7,15),group.colours = lcol2[c(1,4,5,6,7)], legend.title="Site Fe",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


# VB
resultat4VB<- na.omit(spread((dataR2=dataR %>%
  filter(!Date_courte == ("2021-01"))%>%
  filter(Site == ("VB"))%>%
  filter(Micro %in% c("C1B1","C1B2","C1B3","C1B4","C1B5","C1B6","C1B7","C1B8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S))
resultat4VB[is.na(resultat4VB)]<-0

ggradar(resultat4VB[,-1],grid.min = 0,grid.mid= 7,grid.max =15,values.radar = c(0,7,15),group.colours =lcol2[c(1:5,7:8)], legend.title="Site VB",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")

##### Columns #####
par(mfrow=c(2,2))
#Bi
resultat3Bi<- na.omit(spread((dataR2=dataR %>% 
  filter(!Date_courte == ("2021-01"))%>%
  filter(Site == ("Bi"))%>%
  filter(Micro %in% c("C2P1","C2P2","C2P3","C2P4","C2P5","C2P6","C2P7","C2P8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S)) 
resultat3Bi[is.na(resultat3Bi)]<-0

ggradar(resultat3Bi[,-1],grid.min = 0,grid.max =10,grid.mid=5,values.radar = c(0,5,10),group.colours =lcol2[c(1,4,5,6,8)],legend.title="Site Bi",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


#Bu
resultat3Bu<- na.omit(spread((dataR2=dataR %>%
  filter(Site == ("Bu"))%>%
  filter(Micro %in% c("C2P1","C2P2","C2P3","C2P4","C2P5","C2P6","C2P7","C2P8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S))
resultat3Bu[is.na(resultat3Bu)]<-0

ggradar(resultat3Bu[,-1],grid.min = 0,grid.max =10,grid.mid=5,values.radar = c(0,5,10),group.colours =lcol2[c(1,2,4,5,8)],legend.title="Site Bu",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


#Fe
resultat3Fe<- na.omit(spread((dataR2=dataR %>% 
  filter(!Date_courte == ("2021-01"))%>%
  filter(Site == ("Fe"))%>%
  filter(Micro %in% c("C2P1","C2P2","C2P3","C2P4","C2P5","C2P6","C2P7","C2P8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S))
resultat3Fe[is.na(resultat3Fe)]<-0

ggradar(resultat3Fe[,-1],grid.min = 0,grid.max =10,grid.mid=5,values.radar = c(0,5,10),group.colours =lcol2[c(1,5,7)] ,legend.title="Site Fe",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


#VB
resultat3VB<- na.omit(spread((dataR2=dataR %>%
  filter(!Date_courte == ("2021-01"))%>%
  filter(Site == ("VB"))%>%
  filter(Micro %in% c("C2P1","C2P2","C2P3","C2P4","C2P5","C2P6","C2P7","C2P8"))%>%
  select(spp,Site,Date_courte,Micro) %>% 
  distinct() %>% 
  group_by(Site,Date_courte,Micro) %>% 
  summarize(S=n())),key=Micro,value=S))
resultat3VB[is.na(resultat3VB)]<-0

ggradar(resultat3VB[,-1],grid.min = 0,grid.max =10,grid.mid=5,values.radar = c(0,5,10),group.colours =lcol2[c(1:3,5,6,8)] ,legend.title="Site VB",gridline.max.linetype = 1,gridline.max.colour = "black",gridline.min.linetype = 1,gridline.min.colour="black",gridline.mid.linetype = 1,gridline.mid.colour="black",background.circle.colour = "lightblue")


```


# # Utilisation des modèles
## Linear mixed model
```{r}
#Permet de montrer la significativité des valeurs selon des variables aléatoires

#permet de faire la moyenne du nombre de taxon dans chaque micro

dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"

dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Date_courte,saison) %>% 
  distinct()%>% 
  group_by(Site,Structure2,Micro,Date_courte,saison) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR3=dataR2 %>% 
  group_by(Site,Structure2,Date_courte,saison) %>% 
  summarize(S2 = mean(S))


plot(lm(S2~Site,data=dataR3))
mixed.lmer <- lmer(S2 ~ Site + (1|saison/Structure2), data = dataR3) #compare les données de richesse taxo avec les variables aléatoires qui sont Micro et date courte

mixed.lmer <- lmer(S2 ~ Site + (1|saison/Structure2), data = dataR3)

summary(mixed.lmer)
plot_model(mixed.lmer,show.values = T,show.p = T)#montre que par rapport à un site de réference (ici Bi), les autres sites sont différents. Ici Fetlar a plutot une diversité moindre que Bi mais est le plus proche. 
tab_model(mixed.lmer)

shapiro_test(lmer(S2 ~ Site + (1|saison/Structure2), data = dataR3))
leveneTest(S2~Site ,data=dataR3)
```

## Generalized linear model
```{r}
#Permet de montrer la significativité des valeurs selon des variables aléatoires

#ajoute une colonne de saison 
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"

dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Day_delta,saison) %>% 
  distinct()%>% 
  group_by(Site,Structure2,Micro,Day_delta,saison) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR3=dataR2 %>% 
  group_by(Site,Structure2,Day_delta,saison) %>% 
  summarize(S2 = mean(S))
 
glm1<-glm(S2~as.numeric(Day_delta)+ Site,data=dataR3)
plot(glm1)
summary(glm1)
```

## Generalized Additive Models
```{r}
#Permet de montrer la significativité des valeurs selon des variables aléatoires

#ajoute une colonne de saison 
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2021-01" |dataR$saison == "2022-01"] <- "hiver"

#avec Richesse taxo
dataR2=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Day_delta,saison,Date_courte) %>% 
  filter(!Date_courte %in% c("2021-01")) %>%
  # filter(Structure2 == "Columns") %>%
  distinct()%>% 
  # mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
  group_by(Site,Structure2,Micro,Day_delta,saison) %>% 
  summarize(S=n()) %>%
  na.omit()%>% 
  droplevels()


dataR3=dataR2 %>%
  group_by(Site,Structure2,Day_delta,saison) %>%
  summarize(S2 = mean(S))


# dataR3=dataR2 %>% #grouper les données selon les sites et les jours afin de pouvoir avoir les memes données que shannon
#   group_by(Site,Structure2,Day_delta,saison) %>%
#   as.data.frame() %>%
#   summarize(S2 = mean(S),.by=c(Site,Day_delta,saison))


#Richesse taxo
dataR2$Site<-as.factor(dataR2$Site)
dataR2$S<-as.numeric(dataR2$S)
dataR2$saison<-as.factor(dataR2$saison)
dataR2$Micro<-as.factor(dataR2$Micro)
dataR2$Day_delta<-as.numeric(dataR2$Day_delta)
# dataR3$Years<-as.factor(dataR3$Years)


dataR3$Site<-as.factor(dataR3$Site)
dataR3$S2<-as.numeric(dataR3$S2)
dataR3$saison<-as.factor(dataR3$saison)
dataR3$Day_delta<-as.numeric(dataR3$Day_delta)
# dataR3$Years<-as.factor(dataR3$Years)
str(dataR3)


#ajout de l'indice de shannon dans le df pour la gam
# dataR4<-cbind(dataR3,shannonind2[,-c(1:2)])


# calcul correlation day_delta et years
# cor(dataR3$Day_delta,as.numeric(dataR3$Years))


#### MCOV avec quadrat moyenné ####
# dataR2=dataR %>% ungroup %>%
#   select(spp,Site,Structure2,Micro,Day_delta,saison,Date_courte,Mcov,Quad2) %>%
#   distinct()%>%
#   mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
#   group_by(Site,Structure2,Day_delta,saison,Years,Mcov,Micro,Quad2) %>%
#   # summarize(S=n()) %>%
#   na.omit()%>%
#   droplevels() 
# 
# #fait la moyenne des quadrats
# dataR3=dataR2 %>%
#   group_by(spp,Site,Structure2,Day_delta,saison,Micro) %>%
#   summarize(Mcov2 = mean(Mcov,.by=c(Micro,Day_delta,Quad2)))   #moyenne du recouvrement des 2 quadrats/espèce/micro
# 
# #fait la moyenne du recouvrement toutes espèces par micro
# dataR4=dataR3 %>%
#         group_by(Site,Structure2,Day_delta,saison) %>%
#     # group_by(Site,Structure2,Day_delta,saison,Micro) %>%
# summarize(Mcov3 = sum(Mcov2,.by=Structure2))
#     # dataR3$Mcov2= 100*dataR3$Mcov2/max(dataR3$Mcov2)
#   # summarize(Mcov3 = sum(Mcov2,.by=c(as.factor(Micro),as.factor(Site),Day_delta,as.factor(Structure2))))
#   # summarize(Mcov3 = sum(Mcov2,.by=c(Structure2,Day_delta))) %>% 
#       # group_by(Site,Structure2,Day_delta,saison) 
#   # summarize(Mcov3 = sum(Mcov2,.by=as.factor(Micro)))
# 
# 
# #Mcov
# dataR3$Site<-as.factor(dataR3$Site)
# dataR3$Mcov2<-as.numeric(dataR3$Mcov2)
# dataR3$saison<-as.factor(dataR3$saison)
# dataR3$Micro<-as.factor(dataR3$Micro)
# 
# dataR4$Site<-as.factor(dataR4$Site)
# dataR4$Mcov3<-as.numeric(dataR4$Mcov3)
# dataR4$saison<-as.factor(dataR4$saison)
# dataR4$Micro<-as.factor(dataR4$Micro)
# dataR4$Day_delta<-as.factor(dataR4$Day_delta)
# 
# str(dataR4)


#test comparaison tous les paramètres
model1<-gam(S2~s(Day_delta)+Site,data=dataR3)
model11<-gam(S2~s(Day_delta)+Structure2,data=dataR3)
model111<-gam(S2~s(Day_delta)+saison,data=dataR3)
model1111<-gam(S2~s(Day_delta)+Site,data=dataR3)
model11111<-gam(S2~s(Day_delta)+Structure2+Site,data=dataR3)
model111111<-gam(S2~s(Day_delta)+s(Structure2,bs="re")+s(Site,bs="re")+s(saison,bs="re")+s(Structure2,by=Site,bs='re'),data=dataR3) # avec les structures dépendantes des sites
model111111<-gam(S2~s(Day_delta)+s(Structure2,bs="re")+s(Site,bs="re")+s(saison,bs="re")+s(Structure2,by=Site,bs='re')+Structure2*Day_delta,data=dataR3) 
model111111<-gam(S2~s(Day_delta)+s(Structure2,bs="re")+s(Site,bs="re")+s(saison,bs="re")+s(Structure2,by=Site,bs='re')+Site*Day_delta,data=dataR3) 
model111111<-gam(S2~s(Day_delta)+s(Structure2,bs="re")+s(Site,bs="re")+s(saison,bs="re")+s(Structure2,by=Site,bs='re')+Site*Day_delta+Structure2*Day_delta,data=dataR3) 

model111111<-gam(S2~s(Day_delta)+Day_delta*Structure2,data=dataR3)
model111111<-gam(S2~s(Day_delta)+Site*Day_delta,data=dataR3)

# model111111<-gam(S2~s(Day_delta)+s(Site,bs="re")+s(saison,bs="re")+s(shannon,bs='re'),data=dataR4) #Avec shannon
# model111111<-gam(S2~s(Day_delta,k=20)+s(Site,bs="re")+s(saison,bs="re"),data=dataR3)
# model1111111<-gam(Mcov~s(Day_delta)+s(Structure2,bs='re')+s(Site,bs="re")+s(saison,bs="re"),data=dataR2)
# model11111111<-gam(Mcov2~s(Day_delta)+s(Structure2,bs='re')+s(Site,bs="re")+s(saison,bs="re"),data=dataR3)
# model111111111<-gam(Mcov3~s(Day_delta,k=27)+s(Structure2,bs='re')+s(Site,bs="re")+s(saison,bs="re"),data=dataR4)


summary(model111111)

# model2<-gam(S2~Site/Day_delta+s(Day_delta,bs="re"),data=dataR3)
# model22<-gam(S2~Site/Day_delta+s(Day_delta,bs="re")+s(Structure2,bs='re'),data=dataR3)
# model222<-gam(S2~Site/Day_delta+s(Day_delta,bs="re")+s(saison,bs="re"),data=dataR3)
# model2222<-gam(S2~Site/Day_delta+s(Day_delta,bs="re")+s(Site,bs="re"),data=dataR3)
# model22222<-gam(S2~Site/Day_delta+s(Day_delta,bs="re")+s(saison,bs="re")+s(Site,bs="re"),data=dataR3)
# model222222<-gam(S2~Site/Day_delta+s(Day_delta,bs="re")+s(saison,bs="re")+s(Structure2,bs='re'),data=dataR3)
# model2222222<-gam(S2~Site/Day_delta+s(Day_delta,bs="re")+s(Structure2,bs='re')+s(Site,bs="re")+s(saison,bs="re"),data=dataR3)

AIC(model1,model11,model111,model1111,model11111,model111111)
AIC(model2,model22,model222,model2222,model22222,model222222,model2222222)

plot_smooths(model=model111111, series=Day_delta,comparison=Site)+theme_bw()+
  theme(axis.text.x = element_text(size=16,color="black"))+
  theme(axis.text.y = element_text(size=16,color="black"))
ggsave("gam_influencesite.png",width=9,height=8,dpi=350)

#test comparaison tous les paramètres
library(MuMIn)
options(na.action = "na.fail")
fm1<-gam(S2~s(Day_delta)+s(Structure2,bs="re")+s(Site,bs="re")+s(saison,bs="re")+s(Structure2,by=Site,bs='re'),data=dataR3)
ms1<-dredge(fm1)


#plot de la gam
plot(model111111,shift=mean(dataR3$S2),residuals=T,cex=0.7,pch=16,col="blue",shade=T,shade.col='grey')
ggplot(data = dataR3, mapping = aes(x = Day_delta, y = S2)) +
  geom_point(size = 0.7, alpha = 0.7) +
  geom_smooth(method="gam", formula= y~s(x))+
  theme_bw()

plot_smooths(model=model111111, series=Day_delta,comparison=Site)+theme_bw()+ #permet de mettre les gam selon les sites
  (scale_y_continuous(limits=c(0,10)))+
      (scale_x_continuous(limits=c(110,750)))+
   # (scale_x_continuous(minor_breaks=seq(0,27,by=2)))+
     # (scale_x_continuous(breaks=seq(0,25,by=2)))+
  geom_vline(xintercept = 206,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 299,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 389,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 478,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 571,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 664,colour='#666666',alpha=.5)+
#   annotate("rect",xmin=112,xmax=205.9,ymin=0,ymax=10,alpha=.1,fill="green")+
#   annotate("rect",xmin=206,xmax=298.9,ymin=0,ymax=10,alpha=.1,fill="orange")+
#   annotate("rect",xmin=299,xmax=388.9,ymin=0,ymax=10,alpha=.1,fill="brown")+
#   annotate("rect",xmin=389,xmax=477.9,ymin=0,ymax=10,alpha=.1,fill="blue")+
# annotate("rect",xmin=478,xmax=570.9,ymin=0,ymax=10,alpha=.1,fill="green")+
#   annotate("rect",xmin=571,xmax=663.9,ymin=0,ymax=10,alpha=.1,fill="orange")+
#   annotate("rect",xmin=664,xmax=750,ymin=0,ymax=10,alpha=.1,fill="brown")+
annotate("text",x = c(159,252,344,433,524,617,708),y=0.3,
           label=c("Printemps","Eté","Automne","Hiver","Printemps","Eté","Automne"),
           colour=c("#666666","#666666","#666666","#666666","#666666","#666666","#666666"))+
   xlab("Nombre de jours d'immersion")+
  ylab("Richesse taxonomique moyenne")


#### Conditions d'applications
par(mfrow = c(2, 2))
gam.check(model111111)



```


#### Plot diagnostic 

le qqplot + plot fitted versus deviance plot
```{r}

qq_plot=qq_plot(model111111, method = "simulate")+
  labs(subtitle = NULL, title=NULL)+
  theme_bw()
qq_plot


df_mod<- data.frame(log_fitted = fitted(model111111),
                 residuals  = resid(model111111, type = "deviance"))


dev_mod <- ggplot(df_mod, aes(x = log_fitted, y = residuals))+
    geom_point() +
  geom_hline(yintercept=0, linetype=2)+
    labs(x = "Linear predictor", y = "Deviance residual")+
  theme_bw()


dig_plot_tot=ggarrange(qq_plot, dev_mod, ncol=2)+theme(axis.text.x = element_text(size=20,color="red"))+
  theme(axis.text.y = element_text(size=20,color="black"))+
  theme(axis.title.x = element_text(size = 14))+
 theme(axis.title.y = element_text(size = 14))

dig_plot_tot
ggsave("conditionsapplications.png",width=11,height=8,dpi=350)

```


#### Plot réponse

Exemple de plot de reponse 
```{r}

# on reconstruit un data frame en faisant varier que la variable d'interet (fonction "evenly")

dd<-levels(as.factor(model111111$model$Day_delta))

Parametre1_df <- data_slice(model111111,
                    Site=evenly(model111111$model$Site),
                    Day_delta=evenly(dd))#param à changer selon la variable à faire varier

# On génére des predictions avec le nouveau df

fv_ds_distancesea <- fitted_values(model111111, data = Parametre1_df) 


# On plot le data frame
# - si variable quantitative : geom_ribbon
# - si variable qualitative: geom_range ou geom_bar
# - geom_rug pour ajouter des ticks pour identifier le nombre de valeur sur un gradient quantitatif


p=ggplot(fv_ds_distancesea,aes(x=Day_delta,y=fitted)) +
  # geom_boxplot()
  # geom_ribbon() +
  # geom_range()+
  geom_bar()+
  geom_line()+


  theme_bw()+
 ylab('')+
  xlab('')+
    theme(axis.text=element_text(size=12),
          text = element_text(size = 15))+
 geom_rug(position='jitter', inherit.aes = T)

```


# # Vitesse de colonisation 
```{r}
# Quelle est la vitesse de colonisation de chaque site et comment évoluent-t-elles ?

# à utiliser avec les les lignes de dataR$nummois d'avant
seq<-c(0,0)
seq2<-c(0,0,0)

###Bizeux
dataR21=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Day_delta) %>%
  filter(Site == "Bi") %>% 
  distinct()%>%
  group_by(Site,Structure2,Micro,Day_delta) %>%
  summarize(S=n()) %>%
  na.omit()

dataR310=dataR21 %>%
  group_by(Site,Day_delta) %>%
  summarize(S2 = mean(S))

dataR31<-dataR310

dataR3Bi<-dataR31$Site[-1]
dataR31$Day_delta<-as.numeric(dataR31$Day_delta)
dataR31$S2<-as.numeric(dataR31$S2)
dataR31<-dataR31[,-1]
dataR31<-rbind(seq,dataR31)
dataR311<-dataR31[order(dataR31$Day_delta),]
dataR3<-dataR311[-1,]-dataR311[-nrow(dataR311),]
# dataR3$SparT<-dataR3$S/dataR3$Day_delta
dataR3$SparT<-30.5*(dataR3$S/dataR3$Day_delta)
dataR31<-rbind(seq,dataR3[,-2])


### Buharats
dataR22=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Day_delta) %>%
  filter(Site == "Bu") %>% 
  distinct()%>%
  group_by(Site,Structure2,Micro,Day_delta) %>%
  summarize(S=n()) %>%
  na.omit()

dataR320=dataR22 %>%
  group_by(Site,Day_delta) %>%
  summarize(S2 = mean(S))

dataR32<-dataR320

dataR3Bu<-dataR32$Site[-1]
dataR32$Day_delta<-as.numeric(dataR32$Day_delta)
dataR32$S2<-as.numeric(dataR32$S2)
dataR32<-dataR32[,-1]
dataR32<-rbind(seq,dataR32)
dataR311<-dataR32[order(dataR32$Day_delta),]
dataR3<-dataR311[-1,]-dataR311[-nrow(dataR311),]
# dataR3$SparT<-dataR3$S/dataR3$Day_delta
dataR3$SparT<-30.5*(dataR3$S/dataR3$Day_delta)
dataR32<-rbind(seq,dataR3[,-2])

### Fetlar
dataR23=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Day_delta) %>%
  filter(Site == "Fe") %>% 
  distinct()%>%
  group_by(Site,Structure2,Micro,Day_delta) %>%
  summarize(S=n()) %>%
  na.omit()

dataR330=dataR23 %>%
  group_by(Site,Day_delta) %>%
  summarize(S2 = mean(S))

dataR33<-dataR330

dataR3Fe<-dataR33$Site[-1]
dataR33$Day_delta<-as.numeric(dataR33$Day_delta)
dataR33$S2<-as.numeric(dataR33$S2)
dataR33<-dataR33[,-1]
dataR33<-rbind(seq,dataR33)
dataR311<-dataR33[order(dataR33$Day_delta),]
dataR3<-dataR311[-1,]-dataR311[-nrow(dataR311),]
# dataR3$SparT<-dataR3$S/dataR3$Day_delta
dataR3$SparT<-30.5*(dataR3$S/dataR3$Day_delta)
dataR33<-rbind(seq,dataR3[,-2])

### Vieux Bancs
dataR24=dataR %>% ungroup %>% 
  select(spp,Site,Structure2,Micro,Day_delta) %>%
  filter(Site == "VB") %>% 
  distinct()%>%
  group_by(Site,Structure2,Micro,Day_delta) %>%
  summarize(S=n()) %>%
  na.omit()

dataR340=dataR24 %>%
  group_by(Site,Day_delta) %>%
  summarize(S2 = mean(S))

dataR34<-dataR340

dataR3VB<-dataR34$Site[-1]
dataR34$Day_delta<-as.numeric(dataR34$Day_delta)
dataR34$S2<-as.numeric(dataR34$S2)
dataR34<-dataR34[,-1]
dataR34<-rbind(seq,dataR34)
dataR311<-dataR34[order(dataR34$Day_delta),]
dataR3<-dataR311[-1,]-dataR311[-nrow(dataR311),]
# dataR3$SparT<-dataR3$S/dataR3$Day_delta
dataR3$SparT<-30.5*(dataR3$S/dataR3$Day_delta)
dataR34<-rbind(seq,dataR3[,-2])


dataRjour1<-c(0,dataR310$Day_delta/30.5)
dataRjour2<-c(0,dataR320$Day_delta/30.5)
dataRjour3<-c(0,dataR330$Day_delta/30.5)
dataRjour4<-c(0,dataR340$Day_delta/30.5)


# dataR2total<-rbind(dataR3Bi,dataR3Bu,dataR3Fe,dataR3VB)
# dataR7<-cbind(dataR2$Site,dataR3$SparT,dataR4$SparT,dataR5$SparT,dataR6$SparT)

plot(dataR31$SparT~dataRjour1,col="red",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="Nombre de jours",ylab="Nombre moyen d'espèces  colonisant par jour")
par(new=T)
plot(dataR32$SparT~dataRjour2,col="blue",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="",ylab="")
par(new=T)
plot(dataR33$SparT~dataRjour3,col="green",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="",ylab="")
par(new=T)
plot(dataR34$SparT~dataRjour4,col="black",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="",ylab="")
lines(dataR31$SparT~dataRjour1,col="red",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="",ylab="")
lines(dataR32$SparT~dataRjour2,col="blue",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="",ylab="")
lines(dataR33$SparT~dataRjour3,col="green",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="",ylab="")
lines(dataR34$SparT~dataRjour4,col="black",xlim=c(0,800),ylim=c(-0.07,0.05),pch=19,xlab="",ylab="")
legend(x = "bottomright", legend = c("Bi","Bu","Fe","VB"),lty = 1, col = c("red","blue","green","black"),lwd = 2)


plot(dataR31$SparT~dataRjour1,col="red",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="Nombre de mois d'immersion",ylab="Nombre moyen d'espèces  colonisant par mois")
par(new=T)
plot(dataR32$SparT~dataRjour2,col="blue",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="",ylab="")
par(new=T)
plot(dataR33$SparT~dataRjour3,col="green",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="",ylab="")
par(new=T)
plot(dataR34$SparT~dataRjour4,col="black",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="",ylab="")
lines(dataR31$SparT~dataRjour1,col="red",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="",ylab="")
lines(dataR32$SparT~dataRjour2,col="blue",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="",ylab="")
lines(dataR33$SparT~dataRjour3,col="green",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="",ylab="")
lines(dataR34$SparT~dataRjour4,col="black",xlim=c(0,25),ylim=c(-2,2),pch=19,xlab="",ylab="")
legend(x = "bottomright", legend = c("Bi","Bu","Fe","VB"),lty = 1, col = c("red","blue","green","black"),lwd = 2)


ggplot(dataR31, aes(x=dataRjour1,SparT))+
  xlab("Nombre de mois d'immersion")+
  ylab("Nombre moyen d'espèces  colonisant par mois")+
 geom_point(colour="#f8766d")+
  geom_line(colour="#f8766d")+
 geom_point(aes(x=dataRjour2,y=SparT),dataR32,colour="#7cae00")+
  geom_line(aes(x=dataRjour2,y=SparT),dataR32,colour="#7cae00")+
 geom_point(aes(x=dataRjour3,y=SparT),dataR33,colour="#00bfc4")+
  geom_line(aes(x=dataRjour3,y=SparT),dataR33,colour="#00bfc4")+
 geom_point(aes(x=dataRjour4,y=SparT),dataR34,colour="#c77cff")+
  geom_line(aes(x=dataRjour4,y=SparT),dataR34,colour="#c77cff")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
annotate("rect",xmin=0,xmax=33.9/30.5,ymin=-2,ymax = 1.5,alpha=.2,fill="brown")+
    (scale_y_continuous(limits=c(-2,1.5)))+
      (scale_x_continuous(limits=c(0,25)))+
   # (scale_x_continuous(minor_breaks=seq(0,27,by=2)))+
     (scale_x_continuous(breaks=seq(0,25,by=2)))+
  annotate("rect",xmin=34/30.5,xmax=111.9/30.5,ymin=-2,ymax=1.5,alpha=.2,fill="blue")+
  annotate("rect",xmin=112/30.5,xmax=205.9/30.5,ymin=-2,ymax=1.5,alpha=.2,fill="green")+
  annotate("rect",xmin=206/30.5,xmax=298.9/30.5,ymin=-2,ymax=1.5,alpha=.2,fill="orange")+
  annotate("rect",xmin=299/30.5,xmax=388.9/30.5,ymin=-2,ymax = 1.5,alpha=.2,fill="brown")+
  annotate("rect",xmin=389/30.5,xmax=477.9/30.5,ymin=-2,ymax = 1.5,alpha=.2,fill="blue")+
annotate("rect",xmin=478/30.5,xmax=570.9/30.5,ymin=-2,ymax = 1.5,alpha=.2,fill="green")+
  annotate("rect",xmin=571/30.5,xmax=663.9/30.5,ymin=-2,ymax = 1.5,alpha=.2,fill="orange")+
  annotate("rect",xmin=664/30.5,xmax=752.9/30.5,ymin=-2,ymax = 1.5,alpha=.2,fill="brown")+
annotate("text",x = c(2.4,5.2,8.2,11.2,14.2,17.1,20.2,23.2),y=-1.9,
           label=c("Hiver","Printemps","Eté","Automne","Hiver","Printemps","Eté","Automne"),
           colour=c("blue","green","orange","brown","blue","green","orange","brown"))

```

# # Représentation spatial
## Matrice de distance
```{r}
# Permet de calculer la distance entre le recouvrement de chaque espèce et le taux de recouvrement

# data_comp2=data_PQ_light %>% ungroup %>% 
#   select(spp,Cov,Site,Micro,Date_courte,Structure2,Strcut_groups, Quad2) %>% 
#   filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte')) %>%
#   filter(!Structure2 %in% c('Dome','Holes','Upper_slots','Inner_slots')) %>% 
#   group_by(spp,Site,Micro,Date_courte,Structure2) %>% 

#   filter(!Structure2 %in% c('Dome','Upper_slots' )) %>% 
#     filter(!Site %in% c('Fe','DSC' )) %>% 
#   mutate(Sample=paste0(Site,'_',Date_courte,'_',
#                        Micro,'_',Quad2)) %>% 
#   group_by(Sample,Site,spp, Micro,Structure2,Strcut_groups, Date_courte) %>% 
#   dplyr::summarize(Mcov=mean(Cov)) %>% 
# 
#   group_by(Sample,Site,Micro,Date_courte,Structure2) %>% 
#   distinct() %>% drop_na() %>% 
#     spread(spp,Mcov) %>% ungroup() %>% 
#       mutate(across(everything(.), ~replace_na(., 0))) 

#ajoute une colonne de saison 
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"
dataR$saison[dataR$saison == "2021-01" |dataR$saison == "2022-01"] <- "hiver"

dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"336"
dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"339"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"2021-11"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"2021-11"


data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2,saison,Quad2,Day_delta) %>% 
  mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
  group_by(spp,Site,Micro,Date_courte,Structure2,saison,Years,Day_delta) %>% 
  filter(Date_courte %in% c("2021-04","2021-07","2021-11","2022-01","2022-04","2022-11")) %>% # a utiliser pour les trajectoires
  # filter(!Date_courte %in% c("2021-01")) %>% # à utiliser pour l'influence des variables
  # filter(!Site == "Fe") %>%
  distinct() %>% drop_na() %>% 
  summarize(Mcov2 = mean(Mcov,.by=c(spp,Micro,Day_delta,Quad2))) %>%
  spread(spp,Mcov2) %>% ungroup() %>% 
  mutate(across(everything(.), ~replace_na(., 0))) %>% 
  mutate(Compsite_date=paste(Site,Date_courte,sep=","))

# data_comp2$nouvelle<-ifelse(data_comp2$Structure2 == "Pillars" | data_comp2$Structure2 == "Columns", "Pillars", "Autres")
# data_comp2$nouvelle<-ifelse(data_comp2$Structure2 == "Pillars", "Pillars", "Autres")

data_comp2$Site<-as.factor(data_comp2$Site)
data_comp2$Micro<-as.factor(data_comp2$Micro)
data_comp2$Date_courte<-as.factor(data_comp2$Date_courte)
data_comp2$Day_delta<-as.factor(data_comp2$Day_delta)
# data_comp2$nouvelle<-as.factor(data_comp2$nouvelle)
data_comp2$Years<-as.factor(data_comp2$Years)
data_comp2$Compsite_date<-as.factor(data_comp2$Compsite_date)


# test=data_comp2 %>% filter(Site == 'VB',
                          # Date_courte=='2021-07' )
# data_comp2=data_comp2[rowSums(data_comp2)>0,]

# Comp_mat=data_comp2 %>% select(-c(Site,Sample,Micro,Structure2,Strcut_groups,Date_courte)) %>% as.matrix() 
# Meta_data=data_comp2 %>% select(Site,Sample,Micro,Structure2,Strcut_groups,Date_courte)

Comp_mat=data_comp2 %>% select(-c(Site,Micro,Structure2,Date_courte,saison,Years,Day_delta,Compsite_date)) %>% as.matrix() #sans meta données
Meta_data=data_comp2 %>% select(Site,Micro,Structure2,Date_courte,saison,Years,Day_delta,Compsite_date) #meta données

# Comp_mat=data_comp2 %>% select(-c(Site,Micro,Structure2,Date_courte,nouvelle,saison)) %>% as.matrix() #sans meta données
# Meta_data=data_comp2 %>% select(Site,Micro,Structure2,Date_courte,nouvelle,saison) #meta données


distdataR<-vegdist(Comp_mat, method='bray') #library vegan - distance de Bray-Curtis, considéré face aux distances euclidiennes comme plus efficace pour les données écologiques


```

##  PCoA
### Variables
```{r}
# Permet de représenter les données dans l'espace et voir les paramètres expliquant le plus la variance

pcoa_tot_SS<- cmdscale(d = as.matrix(distdataR), k=10, eig = T) 
x=pcoa_tot_SS$points[,1]
y=pcoa_tot_SS$points[,2]

PCOA_df=data.frame(x=pcoa_tot_SS$points[,1],y=pcoa_tot_SS$points[,2],
                   Structure=Meta_data$Structure2,
                   Site=Meta_data$Site,
                   Date=Meta_data$Date_courte,
                   Saison=Meta_data$saison,
                   Years=Meta_data$Years,
                   Compsite_date=Meta_data$Compsite_date)

# save(PCOA_df,file="PCOA_df")

# PCOA_df=PCOA_df %>% filter(Date %in% c("2021-04","2021-07","2021-11"))
# PCOA_df=PCOA_df %>% filter(!Date %in% c("2021-04","2021-07","2021-11"))
# PCOA_df=PCOA_df %>% filter(Site == "VB")

ggplot(data=PCOA_df,aes(x,y, col=Years))+ # <- Ici on explore avec col les variable qui explique le + l'explosion du nuage de points
  # geom_point(aes(col=Site), size=1, alpha=.6)+
  geom_point()+
  labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")+
  geom_hline(yintercept=0)+
  geom_vline(xintercept=0)+
  theme_bw()
  # geom_mark_ellipse(aes(fill=Structure,group=Structure))


#PCoA avec les barycentres
# s.class(PCOA_df[c(1:2)],as.factor(PCOA_df$Site),col=c("#fb746b","#7cab04","#00bfc4","#c77cff"),ellipseSize=0) # permet de faire le graph de la PCoA avec des barycentres
# s.class(PCOA_df[c(1:2)],droplevels(as.factor(PCOA_df$Structure)),col=c("#fb746b","#7cab04","#00bfc4","#c77cff"),ellipseSize=0)
# s.class(PCOA_df[c(1:2)],droplevels(as.factor(PCOA_df$Date)),col=c("#000099","#0000FF","#6666FF","#99CCFF","#006600","#33CC33","#99FF00"),ellipseSize=0)
# 
# s.class(PCOA_df[c(1:2)],droplevels(as.factor(PCOA_df$Compsite_date)),ellipseSize=0,col=c("#000099","#0000FF","#6666FF","#99CCFF","#006600","#33CC33","#99FF00","#CCFF33"))


#### Barycentre avec ggplot
  ######## trajectoires sites ##########
load("PCOA_df")

## PCoA Sites ##
barycenters <- aggregate(cbind(x,y) ~ Site, PCOA_df, mean)
# paste(Site,Date,sep="_")
ggplot(PCOA_df, aes(x = x, y = y,colour =Site )) +
  geom_point(alpha=.2,aes(colour=Site)) +
    # scale_color_manual(values = c("#56B4E9", "#E69F00", "#999999","#009E73"))+
  # Ajouter les barycentres
  # geom_point(data = barycenters, aes(x = x, y = y, colour = paste(Site,Date,sep="_")), size = 3, shape = 17) +
  # Ajout lignes entre les barycentres et les points
  geom_segment(data = merge(PCOA_df, barycenters, by ="Site", suffixes = c("",".bary")),
               aes(x = x, y = y, xend = x.bary, yend = y.bary, color = Site),alpha=.3)+
  theme_bw()+labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")+
  # theme(legend.position = "none")+
  theme(axis.text.x = element_text(size=16,colour="black"))+
   theme(axis.text.y = element_text(size=16,colour="black"))+
   theme(axis.title.x = element_text(size=16,colour="black",vjust=0))+
  theme(axis.title.y = element_text(size=16,colour="black",vjust=2))+
  geom_label(
    label="Bizeux", x=barycenters$x[which(barycenters$Site=="Bi")], y=barycenters$y[which(barycenters$Site=="Bi")],
    label.padding = unit(0.25, "lines"), # Rectangle size around label
    label.size = 0.35,color = "#fb746b",fill="white")+
  geom_label(
    label="Buharats", x=barycenters$x[which(barycenters$Site=="Bu")], y=barycenters$y[which(barycenters$Site=="Bu")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "#7cab04",fill="white")+
  geom_label(
    label="Fetlar", x=barycenters$x[which(barycenters$Site=="Fe")], y=barycenters$y[which(barycenters$Site=="Fe")],
    label.padding = unit(0.25, "lines"),
    label.size = 0.35,color = "#00bfc4",fill="white")+
  geom_label(
    label="Vieux-Bancs", x=barycenters$x[which(barycenters$Site=="VB")], y=barycenters$y[which(barycenters$Site=="VB")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "#c77cff",fill="white")
ggsave("pcoainfluencesite.png",width=9,height=8,dpi=350)




## PCoA Structures ##
load("PCOA_df")
barycenters <- aggregate(cbind(x,y) ~ Structure, PCOA_df, mean)
# paste(Site,Date,sep="_")
ggplot(PCOA_df, aes(x = x, y = y,colour =Structure )) +
  geom_point(alpha=.2,aes(colour=Structure)) +
    # scale_color_manual(values = c("#56B4E9", "#E69F00", "#009E73","#999999"))+
  # Ajouter les barycentres
  # geom_point(data = barycenters, aes(x = x, y = y, colour = paste(Site,Date,sep="_")), size = 3, shape = 17) +
  # Ajout lignes entre les barycentres et les points
  geom_segment(data = merge(PCOA_df, barycenters, by ="Structure", suffixes = c("",".bary")),
               aes(x = x, y = y, xend = x.bary, yend = y.bary, color = Structure),alpha=.3)+
  theme_bw()+
  # theme(legend.position = "none")+
  theme(axis.text.x = element_text(size=16,colour="black"))+
   theme(axis.text.y = element_text(size=16,colour="black"))+
   theme(axis.title.x = element_text(size=16,colour="black",vjust=0))+
  theme(axis.title.y = element_text(size=16,colour="black",vjust=2))+
  geom_label(
    label="Disc", x=barycenters$x[which(barycenters$Structure=="Disc")], y=barycenters$y[which(barycenters$Structure=="Disc")],
    label.padding = unit(0.25, "lines"), # Rectangle size around label
    label.size = 0.35,color = "#fb746b",fill="white")+
  geom_label(
    label="Columns", x=barycenters$x[which(barycenters$Structure=="Columns")], y=barycenters$y[which(barycenters$Structure=="Columns")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "#7cab04",fill="white")+
  geom_label(
    label="Pillars", x=barycenters$x[which(barycenters$Structure=="Pillars")], y=barycenters$y[which(barycenters$Structure=="Pillars")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "#00bfc4",fill="white")+
  geom_label(
    label="Inner_slots", x=barycenters$x[which(barycenters$Structure=="Inner_slots")], y=barycenters$y[which(barycenters$Structure=="Inner_slots")],
    label.padding = unit(0.25, "lines"), 
    label.size = 0.35,color = "#c77cff",fill="white")+
  labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")
ggsave("pcoainfluencestructure.png",width=9,height=8,dpi=350)


## PCoA Dates ##
load("PCOA_df")
barycenters <- aggregate(cbind(x,y) ~ Date, PCOA_df, mean)
# paste(Site,Date,sep="_")
ggplot(PCOA_df, aes(x = x, y = y,colour =Date )) +
  geom_point(alpha=.2,aes(color=Date)) +
      # scale_color_manual(values = c("#999999", "#E69F00","#56B4E9", "#009E73","#F0E442", "#0072B2", "#D55E00"))+
  # Ajouter les barycentres
  # geom_point(data = barycenters, aes(x = x, y = y, colour = paste(Site,Date,sep="_")), size = 3, shape = 17) +
  # Ajout lignes entre les barycentres et les points
  geom_segment(data = merge(PCOA_df, barycenters, by ="Date", suffixes = c("",".bary")),
               aes(x = x, y = y, xend = x.bary, yend = y.bary, color = Date),alpha=.3)+
  theme_bw()+
 theme(axis.text.x = element_text(size=16,colour="black"))+
   theme(axis.text.y = element_text(size=16,colour="black"))+
   theme(axis.title.x = element_text(size=16,colour="black",vjust=0))+
  theme(axis.title.y = element_text(size=16,colour="black",vjust=2))+
  # theme(legend.position = "none")+
    # scale_color_paletteer_d("awtools::ppalette")+
      # scale_color_paletteer_d("ggthemes::colorblind")+
  geom_label(
  label="2021-04", x=barycenters$x[which(barycenters$Date=="2021-04")], y=barycenters$y[which(barycenters$Date=="2021-04")],
    label.padding = unit(0.25, "lines"), # Rectangle size around label
    label.size = 0.35,color = "#fb746b",fill="white")+
  geom_label(
    label="2021-07", x=barycenters$x[which(barycenters$Date=="2021-07")], y=barycenters$y[which(barycenters$Date=="2021-07")],
    label.padding = unit(0.25, "lines"), 
      label.size = 0.35,color = "#E69F00",fill="white")+
  geom_label(
    label="2021-11", x=barycenters$x[which(barycenters$Date=="2021-11")], y=barycenters$y[which(barycenters$Date=="2021-11")],
    label.padding = unit(0.25, "lines"), 
      label.size = 0.35,color = "#7cab04",fill="white")+
  geom_label(
    label="2022-01", x=barycenters$x[which(barycenters$Date=="2022-01")], y=barycenters$y[which(barycenters$Date=="2022-01")],
    label.padding = unit(0.25, "lines"), 
      label.size = 0.35,color = "#009E73",fill="white")+
  geom_label(
    label="2022-04", x=barycenters$x[which(barycenters$Date=="2022-04")], y=barycenters$y[which(barycenters$Date=="2022-04")],
    label.padding = unit(0.25, "lines"), 
      label.size = 0.35,color = "#00bfc4",fill="white")+
  geom_label(
    label="2022-07", x=barycenters$x[which(barycenters$Date=="2022-07")], y=barycenters$y[which(barycenters$Date=="2022-07")],
    label.padding = unit(0.25, "lines"), 
      label.size = 0.35,color = "#c77cff",fill="white")+
  geom_label(
    label="2022-11", x=barycenters$x[which(barycenters$Date=="2022-11")], y=barycenters$y[which(barycenters$Date=="2022-11")],
    label.padding = unit(0.25, "lines"), 
        label.size = 0.35,color = "pink",fill="white")+
  # geom_label(
  #   label="2021-01", x=barycenters$x[which(barycenters$Date=="2021-01")], y=barycenters$y[which(barycenters$Date=="2021-01")],
  #   label.padding = unit(0.25, "lines"), # Rectangle size around label
  #   label.size = 0.35,color = "#CC79A7",fill="white")+
  labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")
ggsave("pcoainfluencedate.png",width=9,height=8,dpi=350)`

```




### Trajectoire
```{r}
######## trajectoires sites-dates 2021 et 2022 ##########
load("PCOA_df")

barycenters <- aggregate(cbind(x,y) ~ Site+Date, PCOA_df, mean)

# paste(Site,Date,sep="_") # à mettre dans "colour" si on veut un dégradé par date

ggplot(PCOA_df, aes(x = x, y = y,colour =Site )) +
  geom_point(alpha=.6,color="grey") +
     # Ajouter les barycentres
  geom_point(data = barycenters, aes(x = x, y = y, fill = Site, shape=Date), size = 3) + #shape= forme selon la variable
  scale_shape_manual(values = c(15,16,17,18,3,7)) +
  # scale_color_manual(values = c("gray70", "gray58", "gray33","gray0"))+
     # Ajout lignes entre les barycentres et les points
  geom_segment(data = barycenters[which(barycenters$Site=="Bi"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB"),],aes(x=x[7],y=y[7],xend=x[8],yend=y[8]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  labs(color="Sites et dates")+ labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")+theme_bw()+
  theme(axis.text.x = element_text(size=16,colour="black"))+
   theme(axis.text.y = element_text(size=16,colour="black"))+
   theme(axis.title.x = element_text(size=16,colour="black",vjust=0))+
  theme(axis.title.y = element_text(size=16,colour="black",vjust=2))
ggsave("pcoatrajectoire20212022.png",width=9,height=8,dpi=350)


  ######## trajectoires sites-dates-structures 2021 et 2022 ##########
##### Disc
load("PCOA_df")
PCOA_df=PCOA_df %>% filter(Structure == "Disc")

barycenters <- aggregate(cbind(x,y) ~ Site+Date+Structure, PCOA_df, mean)
# paste(Site,Date,Structure,sep="_") #si on veut mettre un dégradé de couleur selon les dates et les sites

ggplot(PCOA_df, aes(x = x, y = y,colour = Site)) +
    geom_point(alpha=.6,color="grey") +
    # Ajout des barycentres
  geom_point(data = barycenters, aes(x = x, y = y, fill = Site, shape=Date), size = 3) + #shape= forme selon la variable
  scale_shape_manual(values = c(15,16,17,18,3,7)) +
  # scale_color_manual(values = c("gray70", "gray58", "gray33","gray0"))+
    # Ajout lignes entre les barycentres et les points
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Disc"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Disc"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Disc"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Disc"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Disc"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Disc"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Disc"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Disc"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Disc"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Disc"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Disc"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Disc"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Disc"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Disc"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Disc"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Disc"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Disc"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Disc"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#c77cff")+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Disc"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Disc"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Disc"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Disc"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Disc"),],aes(x=x[7],y=y[7],xend=x[8],yend=y[8]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  labs(color="Sites et dates")+ labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")+ theme_bw() +
  theme(axis.text.x = element_text(size=16,colour="black"))+
   theme(axis.text.y = element_text(size=16,colour="black"))+
   theme(axis.title.x = element_text(size=16,colour="black",vjust=0))+
  theme(axis.title.y = element_text(size=16,colour="black",vjust=2))
ggsave("pcoatrajectoiredisques.png",width=9,height=8,dpi=350)



##### Colonnes
load("PCOA_df")
PCOA_df=PCOA_df %>% filter(Structure == "Columns")

barycenters <- aggregate(cbind(x,y) ~ Site+Date+Structure, PCOA_df, mean)

ggplot(PCOA_df, aes(x = x, y = y,colour = Site)) +
 geom_point(alpha=.6,color="grey") +
    # Ajout des barycentres
  geom_point(data = barycenters, aes(x = x, y = y, fill = Site, shape=Date), size = 3) + #shape= forme selon la variable
  scale_shape_manual(values = c(15,16,17,18,3,7)) +
  # scale_color_manual(values = c("gray70", "gray58", "gray33","gray0"))+
    # Ajout lignes entre les barycentres et les points
   geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Columns"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Columns"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Columns"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Columns"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Columns"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Columns"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Columns"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Columns"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Columns"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Columns"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Columns"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Columns"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Columns"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Columns"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Columns"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Columns"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Columns"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Columns"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#c77cff")+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Columns"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Columns"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Columns"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Columns"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Columns"),],aes(x=x[7],y=y[7],xend=x[8],yend=y[8]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  labs(color="Sites et dates")+ labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")+ theme_bw() +
  theme(axis.text.x = element_text(size=16,colour="black"))+
   theme(axis.text.y = element_text(size=16,colour="black"))+
   theme(axis.title.x = element_text(size=16,colour="black",vjust=0))+
  theme(axis.title.y = element_text(size=16,colour="black",vjust=2))
ggsave("pcoatrajectoirecolonnes.png",width=9,height=8,dpi=350)



##### Piliers
load("PCOA_df")
PCOA_df=PCOA_df %>% filter(Structure == "Pillars")

barycenters <- aggregate(cbind(x,y) ~ Site+Date+Structure, PCOA_df, mean)


ggplot(PCOA_df, aes(x = x, y = y,colour = Site)) +
  geom_point(alpha=.6,color="grey") +
    # Ajout des barycentres
  geom_point(data = barycenters, aes(x = x, y = y, fill = Site, shape=Date), size = 3) + #shape= forme selon la variable
  scale_shape_manual(values = c(15,16,17,18,3,7)) +
  # scale_color_manual(values = c("gray70", "gray58", "gray33","gray0"))+
    # Ajout lignes entre les barycentres et les points
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Pillars"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Pillars"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Pillars"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Pillars"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Pillars"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Pillars"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Pillars"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Pillars"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Pillars"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Pillars"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Pillars"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Pillars"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Pillars"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Pillars"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Pillars"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Pillars"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Pillars"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Pillars"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#c77cff")+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Pillars"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Pillars"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Pillars"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Pillars"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Pillars"),],aes(x=x[7],y=y[7],xend=x[8],yend=y[8]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  labs(color="Sites et dates")+ labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")+ theme_bw()+  
 theme(axis.text.x = element_text(size=16,colour="black"))+
   theme(axis.text.y = element_text(size=16,colour="black"))+
   theme(axis.title.x = element_text(size=16,colour="black",vjust=0))+
  theme(axis.title.y = element_text(size=16,colour="black",vjust=2))
ggsave("pcoatrajectoirePiliers.png",width=9,height=8,dpi=350)



##### Inner_slots
load("PCOA_df")
PCOA_df=PCOA_df %>% filter(Structure == "Inner_slots")

barycenters <- aggregate(cbind(x,y) ~ Site+Date+Structure, PCOA_df, mean)


ggplot(PCOA_df, aes(x = x, y = y,colour = Site)) +
 geom_point(alpha=.6,color="grey") +
    # Ajout des barycentres
  geom_point(data = barycenters, aes(x = x, y = y, fill = Site, shape=Date), size = 3) + #shape= forme selon la variable
  scale_shape_manual(values = c(15,16,17,18,3,7)) +
  # scale_color_manual(values = c("gray70", "gray58", "gray33","gray0"))+
    # Ajout lignes entre les barycentres et les points
   geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Inner_slots"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Inner_slots"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Inner_slots"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Inner_slots"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Inner_slots"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bi" & barycenters$Structure=="Inner_slots"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="#fb746b",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Inner_slots"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Inner_slots"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Inner_slots"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Inner_slots"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Bu" & barycenters$Structure=="Inner_slots"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#7cab04",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Inner_slots"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Inner_slots"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Inner_slots"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Inner_slots"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="Fe" & barycenters$Structure=="Inner_slots"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#00bfc4",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Inner_slots"),],aes(x=x[1],y=y[1],xend=x[2],yend=y[2]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Inner_slots"),],aes(x=x[2],y=y[2],xend=x[3],yend=y[3]),color="#c77cff")+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Inner_slots"),],aes(x=x[3],y=y[3],xend=x[4],yend=y[4]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Inner_slots"),],aes(x=x[4],y=y[4],xend=x[5],yend=y[5]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Inner_slots"),],aes(x=x[5],y=y[5],xend=x[6],yend=y[6]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Inner_slots"),],aes(x=x[6],y=y[6],xend=x[7],yend=y[7]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  geom_segment(data = barycenters[which(barycenters$Site=="VB" & barycenters$Structure=="Inner_slots"),],aes(x=x[7],y=y[7],xend=x[8],yend=y[8]),color="#c77cff",arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  labs(color="Sites et dates")+ labs(x="Axe 1 (22,1%)",y="Axe 2 (12,2%)")+ theme_bw()+
   theme(axis.text.x = element_text(size=16,colour="black"))+
   theme(axis.text.y = element_text(size=16,colour="black"))+
   theme(axis.title.x = element_text(size=16,colour="black",vjust=0))+
  theme(axis.title.y = element_text(size=16,colour="black",vjust=2))
ggsave("pcoatrajectoirefailles.png",width=9,height=8,dpi=350)


# geom_path(data=barycenters[which(barycenters$Site == "Bi"),],group=1,aes(color=Site),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
# geom_path(data=barycenters[which(barycenters$Site == "Bu"),],group=1,aes(color=Site),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
# geom_path(data=barycenters[which(barycenters$Site == "Fe"),],group=1,aes(color=Site),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
# geom_path(data=barycenters[which(barycenters$Site == "VB"),],group=1,aes(color=Site),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))





### apport de la variabilité selon le nombre d'axe
summaryPCOA<-data.frame(
  EIG= pcoa_tot_SS$eig,
  PCTVAR=100*pcoa_tot_SS$eig/sum(pcoa_tot_SS$eig),
  CUMPCTVAR = cumsum(100*pcoa_tot_SS$eig/sum(pcoa_tot_SS$eig)))
plot(summaryPCOA$PCTVAR[1:30],ylim=c(0,30),xlab="Composantes",ylab="Pourcentage d'inertie (explication de la variance)")


### Explication de la variance par les variables
#test avec factominer (fonctionne mais les axes n'expliquent pas la même variance que l'ACoP plus haut)
res.pca<-PCOA_df[,c(1:2)]
res.pca<-PCA(Comp_mat,ncp=6)
res.pca<-PCA(as.matrix(distdataR),ncp=6)

# Test importance des espèces dans l'explication de la variance 
vf <- envfit(pcoa_tot_SS, data_comp2, perm = 999)
spp.scrs <- as.data.frame(scores(vf, display = "vectors"))
spp.scrs2 <-(spp.scrs[which(vf$vectors$pvals<0.01),])
spp.scrs3 <- cbind(spp.scrs2, Abb = rownames(spp.scrs2))


ggplot(PCOA_df, aes(x = x, y = y)) +
  geom_point(colour="black",alpha=.2)+
  geom_point(spp.scrs3,mapping=aes(x=Dim1,y=Dim2,colour=Abb),size=2)+
    labs(color="Taxons significatifs") + labs(x="Axe 1 (22,1%)",y="Axe 2 (12,1%)")+
  theme_bw() + 
  geom_label_repel(data=spp.scrs3,aes(x=Dim1,y=Dim2,label=Abb), nudge_x = 0.0, nudge_y = 0.05, check_overlap = T,label.size=0.07,size=3,force=10)+ # ajout des labels au niveau de chaque point
  scale_x_continuous(limits=c(-0.83,0.7))+
  theme(legend.position="none") #enlève la légende


ggplot(PCOA_df, aes(x = x, y = y)) +
  geom_point(colour="black",alpha=.2)+
  geom_point(spp.scrs3,mapping=aes(x=Dim1,y=Dim2),size=2)+
    labs(color="Taxons significatifs")+ labs(x="Axe 1 (22,1%)",y="Axe 2 (12,1%)")+
  theme_bw() + 
  geom_label_repel(data=spp.scrs3,aes(x=Dim1,y=Dim2,label=Abb), nudge_x = 0.0, nudge_y = 0.05, check_overlap = T,label.size=0.07,size=4,force=50)+ # ajout des labels au niveau de chaque point
  scale_x_continuous(limits=c(-0.83,0.7))+
  theme(axis.text.x = element_text(size=16,colour="black"))+
   theme(axis.text.y = element_text(size=16,colour="black"))+
  theme(axis.title.x = element_text(size=16,colour="black",vjust=0))+
  theme(axis.title.y = element_text(size=16,colour="black",vjust=2))+
  theme(legend.position="none") #enlève la légende
ggsave("pcoainfluencetaxon.png",width=8,height=8,dpi=350)

# options(ggrepel.max.overlaps = Inf) #si erreur avec overlaps alors exécuter ca

```


####  Analyse des trajectoires PCoA
```{r}
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"
dataR$saison[dataR$saison == "2021-01" |dataR$saison == "2022-01"] <- "hiver"

dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"336"
dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"339"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"2021-11"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"2021-11"

##marche
data_comp2=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Date_courte,Day_delta,Mcov,Quad2,saison) %>%
  # filter(Date_courte %in% c("2021-04","2021-07","2021-11","2022-01","2022-04","2022-11")) %>% 
  distinct()%>%
  group_by(Site,Structure2,Mcov,Micro,Quad2,Date_courte,saison) %>%
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by=c(spp,Site,Structure2,Micro,Date_courte,Day_delta,saison)) %>%
  na.omit()%>%
  droplevels() %>% 
  spread(spp,Mcov2) %>% 
  mutate(across(everything(.), ~replace_na(., 0))) %>% 
  mutate(Name=paste(Site,Structure2,Date_courte,saison,Day_delta,sep=","))


## Sans microhabitats
data_comp2=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Date_courte,Day_delta,Mcov,Quad2,saison) %>%
  # filter(Date_courte %in% c("2021-04","2021-07","2021-11","2022-01","2022-04","2022-11")) %>% 
  distinct()%>%
  group_by(Site,Structure2,Mcov,Micro,Quad2,Date_courte,saison) %>%
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by=c(spp,Site,Structure2,Date_courte,Day_delta,saison)) %>%
  na.omit()%>%
  droplevels() %>% 
  mutate(num=seq(1:1021)) %>% 
  spread(spp,Mcov2) %>% 
  mutate(across(everything(.), ~replace_na(., 0))) 






data_comp2$Site<-as.factor(data_comp2$Site)
data_comp2$Date_courte<-as.factor(data_comp2$Date_courte)
data_comp2$Day_delta<-as.factor(data_comp2$Day_delta)
data_comp2$Structure2<-as.factor(data_comp2$Structure2)
data_comp2$saison<-as.factor(data_comp2$saison)


Comp_mat=data_comp2 %>% select(-c(Site,Structure2,Date_courte,saison,Day_delta,num)) %>% as.matrix() #sans meta données
Meta_data=data_comp2 %>% select(Site,Structure2,Date_courte,saison,Day_delta,num) #meta données

Comp_mat=data_comp2 %>% select(-c(Site,Structure2,Date_courte,saison,Day_delta)) %>% as.matrix()
Meta_data=data_comp2 %>% select(Site,Structure2,Date_courte,saison,Day_delta)

distdataR<-vegdist(Comp_mat, method='bray') 

 
# sD<-trajectoryDistances(distdataR,data_comp2$Day_delta,surveys=NULL)
# sD<-trajectoryLengths(distdataR,data_comp2$Site,surveys=NULL) #longueur totale des vecteurs
# 
# summary(sD)
# sD1<-as.data.frame(sD)
```


###Distance
```{r}
##### Distance totale Structure par structure
data_comp2=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Date_courte,Day_delta,Mcov,Quad2,saison) %>%
  filter(Structure2 == "Inner_slots") %>% 
  filter(Date_courte %in% c("2021-04","2021-07","2021-11","2022-01","2022-04","2022-11")) %>%
  distinct()%>%
  group_by(Site,Structure2,Mcov,Micro,Quad2,Date_courte,saison) %>%
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by=c(spp,Site,Date_courte,Day_delta,saison)) %>%
  na.omit()%>%
  droplevels() %>% 
  spread(spp,Mcov2) %>% 
  mutate(across(everything(.), ~replace_na(., 0))) 


data_comp2$Site<-as.factor(data_comp2$Site)
data_comp2$Date_courte<-as.factor(data_comp2$Date_courte)
data_comp2$Day_delta<-as.factor(data_comp2$Day_delta)
data_comp2$saison<-as.factor(data_comp2$saison)


Comp_mat=data_comp2 %>% select(-c(Site,Date_courte,saison,Day_delta)) %>% as.matrix() #sans meta données
Meta_data=data_comp2 %>% select(Site,Date_courte,saison,Day_delta) #meta données


distdataR<-vegdist(Comp_mat, method='bray') 

sDL<-trajectoryLengths(distdataR,data_comp2$Site,surveys=NULL) #longueur totale des vecteurs


sDLCo=sDL
sDLDi=sDL
sDLPi=sDL
sDLF=sDL
sDlength<-rbind(sDLCo,sDLDi,sDLPi,sDLF)
sDlength$Structure<-rep(c("Colonnes","Disques","Piliers","Failles"),each=4)
sDlength$Site<-c("Bi","Bu","Fe","VB")
sDlength$sd<-sqrt(sDlength$Trajectory)
colnames(sDlength)[1:5]<-c("premier","deuxieme","troisieme","quatrieme","cinquieme")
# save(sDlength, file="sDlength.Rdata")
load("sDlength")


##### Trajectoire Totale #####
ggplot(sDlength, aes(Structure,Trajectory,fill=Structure))+ 
  geom_bar(stat="identity",alpha=.7)+
  # geom_boxplot()+
  # geom_errorbar(aes(ymin=Trajectory-sd, ymax=Trajectory+sd), width=.2, position=position_dodge(.9))+ #ajout des barres d'erreur
  theme_bw()+ 
  xlab("")+ylab("Distance totale de la trajectoire")+
  facet_wrap(~Site)



##### Trajectoire entre inventaires #####

sDlengthpre = sDlength %>% select("premier","Structure","Site") %>% mutate(Numinv="1 Avr-Juil")
sDlengthpre$Numinv[sDlengthpre$Site=="Fe" | sDlengthpre$Site=="Fe1" | sDlengthpre$Site=="Fe2" | sDlengthpre$Site=="Fe3"]<- "1.5 Avr-Nov"
colnames(sDlengthpre)[1]<-"value"

sDlengthdeu = sDlength %>% select("deuxieme","Structure","Site") %>% mutate(Numinv="2 Juil-Nov")
sDlengthdeu$Numinv[sDlengthdeu$Site=="Fe" | sDlengthdeu$Site=="Fe1" | sDlengthdeu$Site=="Fe2" | sDlengthdeu$Site=="Fe3"]<- "3 Nov-Jan"
colnames(sDlengthdeu)[1]<-"value"

sDlengthtro = sDlength %>% select("troisieme","Structure","Site") %>% mutate(Numinv="3 Nov-Jan")
sDlengthtro$Numinv[sDlengthtro$Site=="Fe" | sDlengthtro$Site=="Fe1" | sDlengthtro$Site=="Fe2" | sDlengthtro$Site=="Fe3"]<- "4 Jan-Avr"
colnames(sDlengthtro)[1]<-"value"

sDlengthqua = sDlength %>% select("quatrieme","Structure","Site") %>% mutate(Numinv="4 Jan-Avr")
colnames(sDlengthqua)[1]<-"value"

sDlengthcin = sDlength %>% select("cinquieme","Structure","Site") %>% mutate(Numinv="5 Avr-Nov")
colnames(sDlengthcin)[1]<-"value"

sDlengthtot<-rbind(sDlengthpre,sDlengthdeu,sDlengthtro,sDlengthqua,sDlengthcin)

sDlengthtot$Structure<-as.factor(sDlengthtot$Structure)
sDlengthtot$Site<-as.factor(sDlengthtot$Site)
sDlengthtot$Numinv<-as.factor(sDlengthtot$Numinv)
sDlengthtot=sDlengthtot %>% mutate(Structure_site=paste(Structure,Site))


ggplot(sDlengthtot, aes(Numinv,value,colour=Structure))+ 
  geom_point(stat="identity",alpha=.7,size=2)+
  # scale_shape_manual(values = c(15,16,17,18)) +
  # scale_color_manual(values = c("gray77", "gray63", "gray40","gray8"))+
  geom_line(aes(group=c(Structure_site)))+
  theme_bw()+ 
  theme(axis.text.x = element_text(angle = -70, vjust = -0.3,colour="black"))+
  theme(axis.text.y = element_text(size=16,colour="black"))+
  xlab("Comparaison entre les mois")+ylab("Angles des vecteurs entre deux dates")+ # pas sûr des dates parce que possible que les structures n'ont pas été échantillonnées tout le temps
facet_wrap(~Site)
ggsave("Distance vecteurs entre les dates.png",width=9,height=8,dpi=350)


# test significativité
sDlength=sDlength %>% filter(!Site=="Fe")
aov1<-aov(Trajectory~Structure+Site+Structure*Site,data=sDlength)
aov1<-aov(value~Structure*Site+Numinv,data=sDlengthtot)
summary(aov1)

adonis2(sDlength$Trajectory~Site+Structure,data=sDlength,permutations=999)

groupe<-sDlength$Site
groupe<-sDlength$Structure

adonis3<-permanova_pairwise(sDlength[,-c(2:4)],groupe,permutations=999,method='bray',padj="bonferroni")


## box plot longueur 
ggplot(sDlengthtot,aes(x= Site, y=value, fill=Structure))+
  geom_point(aes(x= Site, y=value, color=Structure),position=position_dodge(0.75),alpha=.5)+
  geom_boxplot(outlier.shape=NA)+
    # scale_color_manual(values = c("gray77", "gray63", "gray40","gray8"))+
    # scale_fill_manual(values = c("gray77", "gray63", "gray40","gray8"))+
  stat_summary(fun= mean, geom = "point",size = 2, color = "black", position = position_dodge(width = .75))+
  ylab("Distance entre les segments de la trajectoire")+
  theme_bw()+
  theme(axis.text.x = element_text(size=16,colour="black"))+
  theme(axis.text.y = element_text(size=16,colour="black"))
ggsave("longueur entre les segments.png",width=9,height=8,dpi=350)


```


###Angles
```{r}
##### Angles moyens Structure par structure
data_comp2=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Date_courte,Day_delta,Mcov,Quad2,saison) %>%
  filter(Structure2 == "Disc") %>%
  filter(Date_courte %in% c("2021-04","2021-07","2021-11","2022-01","2022-04","2022-11")) %>%
  distinct()%>%
  group_by(Site,Structure2,Mcov,Micro,Quad2,Date_courte,saison) %>%
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by=c(spp,Site,Date_courte,Day_delta,saison)) %>%
  na.omit()%>%
  droplevels() %>% 
  spread(spp,Mcov2) %>% 
  mutate(across(everything(.), ~replace_na(., 0))) 


data_comp2$Site<-as.factor(data_comp2$Site)
data_comp2$Date_courte<-as.factor(data_comp2$Date_courte)
data_comp2$Day_delta<-as.factor(data_comp2$Day_delta)
data_comp2$saison<-as.factor(data_comp2$saison)


Comp_mat=data_comp2 %>% select(-c(Site,Date_courte,saison,Day_delta)) %>% as.matrix() #sans meta données
Meta_data=data_comp2 %>% select(Site,Date_courte,saison,Day_delta) #meta données


distdataR<-vegdist(Comp_mat, method='bray') 

sDA<-trajectoryAngles(distdataR,data_comp2$Site,surveys=NULL) #angle des vecteurs

sDACo=sDA%>%  select(-rho)
# %>% mutate("S5-S6"=="0") 
# # colnames(sDACo)[7]<-"S5-S6"
# sDACo<-sDACo[,-7]
# sDACo<-sDACo[,c(1:4,7,5:6)] 
sDADi=sDA %>%  select(-rho)
sDAPi=sDA %>%  select(-rho)
# %>% mutate("S5-S6"=="0") 
# colnames(sDAPi)[7]<-"S5-S6"
# sDAPi<-sDAPi[,-7]
# sDAPi<-sDAPi[,c(1:4,7,5:6)]
sDAF=sDA  %>%  select(-rho)

sDAngle<-rbind(sDACo,sDADi,sDAPi,sDAF)
sDAngle$Structure<-rep(c("Colonnes","Disques","Piliers","Failles"),each=4)
sDAngle$Site<-c("Bi","Bu","Fe","VB")
sDAngle$sd<-sqrt(sDAngle$mean)

colnames(sDAngle)[c(1:5)]<-c("premier","deuxieme","troisieme","quatrieme","mean")
# save(sDAngle, file="data.RData")
load("sDAngle")


##### Angle entre inventaires #####
sDAnglepre = sDAngle %>% select("premier","Structure","Site") %>% mutate(Numinv='1 Avr-Juil-Nov')
sDAnglepre$Numinv[sDAnglepre$Site=="Fe" | sDAnglepre$Site=="Fe1" | sDAnglepre$Site=="Fe2" | sDAnglepre$Site=="Fe3"]<- "1.5 Avr-Nov-Jan"
colnames(sDAnglepre)[1]<-"value"

sDAngledeu = sDAngle %>% select("deuxieme","Structure","Site") %>% mutate(Numinv='2 Juil-Nov-Jan')
sDAngledeu$Numinv[sDAngledeu$Site=="Fe" | sDAngledeu$Site=="Fe1" | sDAngledeu$Site=="Fe2" | sDAngledeu$Site=="Fe3"]<- "3 Nov-Jan-Avr"
colnames(sDAngledeu)[1]<-"value"

sDAngletro = sDAngle %>% select("troisieme","Structure","Site") %>% mutate(Numinv='3 Nov-Jan-Avr')
colnames(sDAngletro)[1]<-"value"

sDAnglequa = sDAngle %>% select("quatrieme","Structure","Site") %>% mutate(Numinv='4 Jan-Avr-Nov')
colnames(sDAnglequa)[1]<-"value"

sDAngletot<-rbind(sDAnglepre,sDAngledeu,sDAngletro,sDAnglequa)
sDAngletot=sDAngletot %>% mutate(Structure_site=paste(Structure,Site))

ggplot(sDAngletot, aes(Numinv,value,colour=Structure))+ 
  geom_point(stat="identity",alpha=.7,size=2)+
  # scale_shape_manual(values = c(15,16,17,18)) +
  # scale_color_manual(values = c("gray77", "gray63", "gray40","gray8"))+
  geom_line(aes(group=c(Structure_site)))+
  theme_bw()+
    theme(axis.text.x = element_text(angle = -70, vjust = -0.4,colour="black"))+
   theme(axis.text.y = element_text(size=16,colour="black"))+
  xlab("Comparaison d'inventaire")+ylab("Angles des vecteurs entre deux dates")+ # pas sûr des dates parce que possible que les structures n'ont pas été échantillonnées tout le temps
facet_wrap(~Site)
ggsave("Angles vecteurs entre les dates.png",width=9,height=8,dpi=350)




##### Angle avec la moyenne totale #####
ggplot(sDAngle, aes(Structure,mean,fill=Structure))+ 
  geom_bar(stat="identity",alpha=.7)+
  # geom_boxplot()+
  # geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2, position=position_dodge(.9))+ #ajout des barres d'erreur
  theme_bw()+ 
  xlab("")+ylab("Angles moyens des vecteurs")+
  facet_wrap(~Site)



#test significativité
aov1<-aov(mean~Structure+Site,data=sDAngle)
aov1<-aov(value~Structure*Site+Numinv,data=sDAngletot)
summary(aov1)

groupe<-sDAngle$Site
groupe<-sDAngle$Structure
adonis3<-permanova_pairwise(sDAngle$mean,groupe,permutations=999,method='bray',padj="bonferroni")


## box plot angles 
ggplot(sDAngletot,aes(x= Site, y=value, fill=Structure))+
  geom_point(aes(x= Site, y=value, color=Structure),position=position_dodge(0.75),alpha=.5)+
  geom_boxplot(outlier.shape=NA)+
    # scale_color_manual(values = c("gray77", "gray63", "gray40","gray8"))+
    # scale_fill_manual(values = c("gray77", "gray63", "gray40","gray8"))+
    stat_summary(fun= mean, geom = "point",size = 2, color = "black", position = position_dodge(width = .75))+
  ylab("Angles entre les segments de la trajectoire")+
  theme_bw()+
  theme(axis.text.x = element_text(size=16,colour="black"))+
  theme(axis.text.y = element_text(size=16,colour="black"))
ggsave("angle entre les segments.png",width=9,height=8,dpi=350)


```

### Direction
```{r}

data_comp2=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Date_courte,Day_delta,Mcov,Quad2,saison) %>%
  filter(Structure2 == "Disc") %>% 
  filter(Date_courte %in% c("2021-04","2021-07","2021-11","2022-01","2022-04","2022-11")) %>%
  distinct()%>%
  group_by(Site,Structure2,Mcov,Micro,Quad2,Date_courte,saison) %>%
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by=c(spp,Site,Date_courte,Day_delta,saison)) %>%
  na.omit()%>%
  droplevels() %>% 
  spread(spp,Mcov2) %>% 
  mutate(across(everything(.), ~replace_na(., 0))) 



data_comp2$Site<-as.factor(data_comp2$Site)
data_comp2$Date_courte<-as.factor(data_comp2$Date_courte)
data_comp2$Day_delta<-as.factor(data_comp2$Day_delta)
data_comp2$saison<-as.factor(data_comp2$saison)


Comp_mat=data_comp2 %>% select(-c(Site,Date_courte,saison,Day_delta)) %>% as.matrix() #sans meta données
Meta_data=data_comp2 %>% select(Site,Date_courte,saison,Day_delta) #meta données


distdataR<-vegdist(Comp_mat, method='bray') 

sDD<-trajectoryDirectionality(distdataR,data_comp2$Site,surveys=NULL) #angle des vecteurs

library(reshape2)
sDDCo=sDD %>%  melt()
sDDDi=sDD %>%  melt()
sDDPi=sDD %>%  melt()
sDDF=sDD %>% melt()
sDDirection<-rbind(sDDCo,sDDDi,sDDPi,sDDF)
sDDirection$Structure<-rep(c("Colonnes","Disques","Piliers","Faille"),each=4)
sDDirection$Site<-c("Bi","Bu","Fe","VB")
sDDirection$sd<-sqrt(sDDirection$value)

ggplot(sDDirection, aes(Structure,value,fill=Structure))+ 
  geom_bar(stat="identity",alpha=.7)+
  theme_bw()+ 
  xlab("")+ylab("Direction moyenne des trajectoires")+
  facet_wrap(~Site)


# test significativité
aov1<-aov(value~Structure+Site,data=sDDirection)
summary(aov1)

groupe<-sDDirection$Site
groupe<-sDDirection$Structure

adonis3<-permanova_pairwise(sDDirection$value,groupe,permutations=999,method='bray',padj="bonferroni")

```

### Convergence
```{r}
data_comp2=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Date_courte,Day_delta,Mcov,Quad2,saison) %>%
  # filter(Structure2 == "Inner_slots") %>%
  # filter(!Site == "VB") %>%
  filter(Date_courte %in% c("2021-04","2021-07","2021-11","2022-01","2022-04","2022-11")) %>%
  distinct()%>%
  group_by(Site,Structure2,Mcov,Micro,Quad2,Date_courte,saison) %>%
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by=c(spp,Site,Date_courte,Day_delta,saison)) %>%
  na.omit()%>%
  droplevels() %>% 
  spread(spp,Mcov2) %>% 
  mutate(across(everything(.), ~replace_na(., 0))) 

data_comp2$Site<-as.factor(data_comp2$Site)
data_comp2$Date_courte<-as.factor(data_comp2$Date_courte)
data_comp2$Day_delta<-as.factor(data_comp2$Day_delta)
data_comp2$saison<-as.factor(data_comp2$saison)


Comp_mat=data_comp2 %>% select(-c(Site,Date_courte,saison,Day_delta)) %>% as.matrix() #sans meta données
Meta_data=data_comp2 %>% select(Site,Date_courte,saison,Day_delta) #meta données

distdataR<-vegdist(Comp_mat, method='bray') 


sDD<-trajectoryConvergence(distdataR,data_comp2$Site,surveys=NULL) #convergence des vecteurs
sDD

```


## Permanova
```{r}
# Permet de voir s'il y a possibilité de regrouper les structures

data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Day_delta,Structure2) %>% 
  group_by(spp,Site,Micro,Day_delta,Structure2) %>% 
  distinct() %>% drop_na() %>% 
  spread(spp,Mcov) %>% ungroup() %>% 
  mutate(across(everything(.), ~replace_na(., 0))) 

Comp_mat=data_comp2 %>% select(-c(Site,Structure2,Date_courte,Micro)) %>% as.matrix() #sans meta données

distdataR<-vegdist(Comp_mat, method='bray')


groupe<-data_comp2$Structure2
groupe<-data_comp2$Site
groupe<-data_comp2$Day_delta
groupe<-data_comp2$Micro

adonis2(distdataR~groupe,data=data_comp2,permutations=999)


# Permet de voir si les microhabitats possèdent une richesse taxo équivalente et donc qu'ils peuvent etre regroupés

dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"
dataR$saison[dataR$saison == "2021-01" |dataR$saison == "2022-01"] <- "hiver"

dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"336"
dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"339"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"2021-11"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"2021-11"


data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2,saison,Quad2,Day_delta) %>% 
  mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
  group_by(spp,Site,Micro,Date_courte,Structure2,saison,Years,Day_delta) %>% 
  # filter(Date_courte %in% c("2021-04","2021-07","2021-11","2022-01","2022-04","2022-11")) %>% #selection des dates ou il y a 4 dates (ou 3 sans fetlar)
  # filter(!Date_courte %in% c("2021-01","2021-04")) %>% 
  # filter(!Site == "Fe") %>%
  distinct() %>% drop_na() %>% 
  summarize(Mcov2 = mean(Mcov,.by=c(spp,Micro,Day_delta,Quad2))) %>%
  spread(spp,Mcov2) %>% ungroup() %>% 
  mutate(across(everything(.), ~replace_na(., 0))) %>% 
  mutate(Compsite_date=paste(Site,Date_courte,sep=","))

Comp_mat=data_comp2 %>% select(-c(Date_courte,Site,Structure2,Day_delta,Micro,Compsite_date,saison,Years)) #sans meta données

distdataR<-vegdist(Comp_mat, method='bray')

adonis2(distdataR~Site+Date_courte+Structure2,data=data_comp2,permutations=999)



# Pair wise permanova 
groupe<-data_comp2$Structure2
groupe<-data_comp2$Site
groupe<-data_comp2$Day_delta
groupe<-data_comp2$Micro

pairwise.adonis(distdataR,groupe,perm=999,sim.method = 'bray',p.adjust.m='bonferroni')
adonis3<-permanova_pairwise(distdataR,groupe,permutations=999,method='bray',padj="bonferroni")

pv<-adonis3$p.adj
pv<-c(0,)
Site<-adonis3$pairs
Site<-c("Colonnes","Disques","Dome","Pillars")
table(pv,Site)
Sitepv<-cbind(site,pv)

heatmap(as.matrix(as.numeric(adonis3$p.adj)))
site<-c("Disques","Colonnes","Dome","Pilliers")

Sitepv<-cbind(site,pv)

```

## ANOSIM
```{r}
#Similaire à une ANOVA mais utilise une matrice de dissimilarité en entrée de data

data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Structure2,Date_courte) %>% 
  filter(Site == "Bu") %>% 
  filter(Date_courte %in% c("2021-11","2022-11")) %>% 
  group_by(spp,Site,Micro,Structure2) %>% 
  distinct() %>% drop_na() %>% 
  spread(spp,Mcov) %>% ungroup() %>% 
  mutate(across(everything(.), ~replace_na(., 0))) 

datano=data_comp2[,-c(1:4)] %>% as.matrix()

ano=anosim(datano,droplevels(data_comp2$Structure2),distance="bray",permutations=999)
ano 
plot(ano,xlab="Structures",ylab="Rang de distance entre les échantillons")
```


## Classification hiérarchique
```{r}
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"

data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2,saison) %>% 
  group_by(spp,Site,Micro,Date_courte,Structure2,saison) %>% 
  distinct() %>% drop_na() %>% 
  spread(spp,Mcov) %>% ungroup() %>% 
  mutate(across(everything(.), ~replace_na(., 0))) 

data_comp2$Site<-as.factor(data_comp2$Site)
data_comp2$Micro<-as.factor(data_comp2$Micro)
data_comp2$Date_courte<-as.factor(data_comp2$Date_courte)

Comp_mat=data_comp2 %>% select(-c(Site,Micro,Structure2,Date_courte,saison)) %>% as.matrix() #sans meta données
Meta_data=data_comp2 %>% select(Site,Micro,Structure2,Date_courte,saison) #meta données

distdataR<-vegdist(Comp_mat, method='bray')

arbre <- hclust(distdataR, method = "ward.D2")
plot(arbre, labels = FALSE, main = "Dendrogramme")
ggdendrogram(arbre,labels=FALSE)

```

# # Courbe d'accumulation
## Méthode 1 (intrapolation)
```{r}
#Permet de savoir le nombre de taxon retrouvé selon l'effort d'inventaire
# Courbe d'accumulation package vegan (seulement intrapolation)

data_comp2=data_PQ_light %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2) %>% 
  filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte'),) %>%
  filter(Structure2 == "Pillars") %>% 
  filter(Site == "Bi")%>%
    filter(Date_courte %in% c("2022-07")) %>% 

  # filter(Date_courte %in% c("2022-07","2022-04","2022-11","2022-01"))%>%
  group_by(spp,Site,Micro,Date_courte,Structure2) %>% 
  distinct() %>% drop_na() %>% 
    spread(spp,Mcov) %>% ungroup() %>% 
      mutate(across(everything(.), ~replace_na(., 0))) 

Comp_mat2=data_comp2 %>% ungroup() %>%  select(-c(Site,Micro,Structure2,Date_courte)) %>% as.matrix() 

data_comp3=data_PQ_light %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2) %>% 
  filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte')) %>%
  filter(Structure2 == "Pillars") %>% 
  filter(Site == "Bu")%>%
  # filter(Date_courte %in% c("2022-07","2022-04","2022-11","2022-01"))%>%
  group_by(spp,Site,Micro,Date_courte,Structure2) %>% 
  distinct() %>% drop_na() %>% 
    spread(spp,Mcov) %>% ungroup() %>% 
      mutate(across(everything(.), ~replace_na(., 0))) 

Comp_mat3=data_comp3 %>% select(-c(Site,Micro,Structure2,Date_courte)) %>% as.matrix() 


data_comp4=data_PQ_light %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2) %>% 
  filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte')) %>%
  filter(Structure2 == "Pillars") %>% 
  filter(Site == "VB")%>%
  filter(Date_courte %in% c("2022-07","2022-04","2022-11","2022-01"))%>%
  group_by(spp,Site,Micro,Date_courte,Structure2) %>% 
  distinct() %>% drop_na() %>% 
    spread(spp,Mcov) %>% ungroup() %>% 
      mutate(across(everything(.), ~replace_na(., 0))) 

Comp_mat4=data_comp4 %>% select(-c(Site,Micro,Structure2,Date_courte)) %>% as.matrix() 


data_comp5=data_PQ_light %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2) %>% 
  filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte')) %>%
  filter(Structure2 == "Pillars") %>% 
  filter(Site == "Fe")%>%
  filter(Date_courte %in% c("2022-07","2022-04","2022-11","2022-01"))%>%
  group_by(spp,Site,Micro,Date_courte,Structure2) %>% 
  distinct() %>% drop_na() %>% 
    spread(spp,Mcov) %>% ungroup() %>% 
      mutate(across(everything(.), ~replace_na(., 0))) 

Comp_mat5=data_comp5 %>% select(-c(Site,Micro,Structure2,Date_courte)) %>% as.matrix() 


spBi<-specaccum(Comp_mat2)
spBu<-specaccum(Comp_mat3)
spVB<-specaccum(Comp_mat4)
spFe<-specaccum(Comp_mat5)


plot(spBi,col="blue",ci.type="poly",ci.lty=0,ci.col="lightblue",ylim=c(0,30),xlim=c(0,12),ylab="Nombre d'espèces",xlab="Nombre de mesures",main="Courbe accumulative taxons 2022 pilliers/Site")
par(new=T)
plot(spBi2,col="darkgreen",ci.type="poly",ci.lty=0,ci.col="lightgreen",ylim=c(0,30),xlim=c(0,12),ylab="",xlab="")
par(new=T)
plot(spBi3,col="orange",ci.type="poly",ci.lty=0,ci.col="lightyellow",ylim=c(0,30),xlim=c(0,12),ylab="",xlab="")
par(new=T)
plot(spBi4,col="red",ci.type="poly",ci.lty=0,ci.col="#FCBBA1",ylim=c(0,30),xlim=c(0,12),ylab="",xlab="")
par(new=T)
plot(spBi5,col="black",ci.type="poly",ci.lty=0,ci.col="grey",ylim=c(0,30),xlim=c(0,12),ylab="",xlab="")

legend(x = "bottomright", legend = c("Bi","VB","Fe","Bu"),lty = 1, col = c("blue","darkgreen","orange","red"),lwd = 2)

#permet de voir les indices tels que chao/ bootstrap,....
spBi<-specaccum(Comp_mat2)
pool<-specpool(Comp_mat5)
poolaccum(Comp_mat5,permutation=100)
plot(poolaccum(Comp_mat3,permutation=100))

estimateR(as.integer(Comp_mat2))
estimateR(as.integer(Comp_mat3))
estimateR(as.integer(Comp_mat4))
estimateR(as.integer(Comp_mat5))

```

## Méthode 2 (intra et extrapolation)

```{r}
#Création d'une matrice d'incidence

# On réorganise le df de base
# Ajout d'une variable qui combine la date et la structure

### Disques
data_comp1=data_PQ_light %>% ungroup %>% 
  select(spp,Date_courte,Site,Structure2, Code_struct) %>% 
   filter(!spp %in% c('NA','NI','Unassigned','ponte','Ponte','None')) %>%
  mutate(date_st=paste0(Date_courte,'_',Code_struct)) %>%  # 
  filter(Structure2 == ("Disc")) %>%
  mutate(P=1) %>% 
    select(-c(Date_courte,Code_struct)) %>% 
  distinct() %>% group_by(Site) %>% 
  group_split()

# On créait une fonction pour nettoyer l'intérieur de la liste
fun_clean=function(x){
  x %>% spread(date_st,P) %>% 
    select(-c(spp,Site,Structure2)) %>% 
      mutate(across(everything(.), ~replace_na(., 0))) %>% 
  as.data.frame()}

# Convertion de split df en list
comp_list=as.list(data_comp1)

# Application de la fonction + names
comp_list_clean=lapply(comp_list, fun_clean)
names(comp_list_clean)<-c('Bi','Bu','Fe','Vb')

# Fonction
out.raw <- iNEXT(comp_list_clean,q=0,
                 datatype="incidence_raw",
                 endpoint=80)
plot(out.raw)
# ggiNEXT(out.raw)

ChaoRichness(comp_list_clean,datatype = 'incidence_raw')

# Ici tu les données concernant l'estimation de la rich. totale
Rar_disc_df=as.data.frame(out.raw$AsyEst)

poolaccum(comp_list_clean)



### Colonnes
data_comp1=data_PQ_light %>% ungroup %>% 
  select(spp,Date_courte,Site,Structure2, Code_struct) %>% 
   filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte','None')) %>%
  mutate(date_st=paste0(Date_courte,'_',Code_struct)) %>%  # 
  filter(Structure2 == ("Columns")) %>% 
  mutate(P=1) %>% 
    select(-c(Date_courte,Code_struct)) %>% 
  distinct() %>% group_by(Site) %>% 
  group_split()

# On créait une fonction pour nettoyer l'intérieur de la liste
fun_clean=function(x){
  x %>% spread(date_st,P) %>% 
    select(-c(spp,Site,Structure2)) %>% 
      mutate(across(everything(.), ~replace_na(., 0))) %>% 
  as.data.frame()}

# Convertion de split df en list
comp_list=as.list(data_comp1)

# Application de la fonction + names
comp_list_clean=lapply(comp_list, fun_clean)
names(comp_list_clean)<-c('Bi','Bu','Fe','Vb')

# Fonction
out.raw <- iNEXT(comp_list_clean,q=0,
                 datatype="incidence_raw",
                 endpoint=80)
plot(out.raw)
# Ici tu les données concernant l'estimation de la rich. totale
Rar_disc_df=as.data.frame(out.raw$AsyEst)





### Piliers
data_comp1=data_PQ_light %>% ungroup %>% 
  select(spp,Date_courte,Site,Structure2, Code_struct) %>% 
   filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte','None')) %>%
  mutate(date_st=paste0(Date_courte,'_',Code_struct)) %>%  # 
  filter(Structure2 == ("Pillars")) %>% 
  mutate(P=1) %>% 
    select(-c(Date_courte,Code_struct)) %>% 
  distinct() %>% group_by(Site) %>% 
  group_split()

# On créait une fonction pour nettoyer l'intérieur de la liste
fun_clean=function(x){
  x %>% spread(date_st,P) %>% 
    select(-c(spp,Site,Structure2)) %>% 
      mutate(across(everything(.), ~replace_na(., 0))) %>% 
  as.data.frame()}

# Convertion de split df en list
comp_list=as.list(data_comp1)

# Application de la fonction + names
comp_list_clean=lapply(comp_list, fun_clean)
names(comp_list_clean)<-c('Bi','Bu','Fe','Vb')

# Fonction
out.raw <- iNEXT(comp_list_clean,q=0,
                 datatype="incidence_raw",
                 endpoint=80)
plot(out.raw)

# Ici tu les données concernant l'estimation de la rich. totale
Rar_disc_df=as.data.frame(out.raw$AsyEst)


### Colonnes
data_comp1=data_PQ_light %>% ungroup %>% 
  select(spp,Date_courte,Site,Structure2, Code_struct) %>% 
   filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte','None')) %>%
  mutate(date_st=paste0(Date_courte,'_',Code_struct)) %>%  # 
  filter(Structure2 == ("Inner_slots")) %>% 
  mutate(P=1) %>% 
    select(-c(Date_courte,Code_struct)) %>% 
  distinct() %>% group_by(Site) %>% 
  group_split()

# On créait une fonction pour nettoyer l'intérieur de la liste
fun_clean=function(x){
  x %>% spread(date_st,P) %>% 
    select(-c(spp,Site,Structure2)) %>% 
      mutate(across(everything(.), ~replace_na(., 0))) %>% 
  as.data.frame()}

# Convertion de split df en list
comp_list=as.list(data_comp1)

# Application de la fonction + names
comp_list_clean=lapply(comp_list, fun_clean)
names(comp_list_clean)<-c('Bi','Bu','Fe','Vb')

# Fonction
out.raw <- iNEXT(comp_list_clean,q=0,
                 datatype="incidence_raw",
                 endpoint=80)
plot(out.raw)
# Ici tu les données concernant l'estimation de la rich. totale
Rar_disc_df=as.data.frame(out.raw$AsyEst)





### Toutes les structures 
data_comp1=data_PQ_light %>% ungroup %>% 
  select(spp,Date_courte,Site,Structure2, Code_struct) %>% 
   filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte','None')) %>%
  mutate(date_st=paste0(Date_courte,'_',Code_struct)) %>%  
   filter(Structure2 %in% c("Disc","Pillars","Columns","Inner_slots")) %>% 
  mutate(P=1) %>% 
    select(-c(Date_courte,Code_struct)) %>% 
  distinct() %>% group_by(Site) %>% 
  group_split()


# On créait une fonction pour nettoyer l'intérieur de la liste
fun_clean=function(x){
  x%>% spread(date_st,P) %>% 
    distinct(spp,.keep_all = TRUE) %>% #ajout de cette fonction permettant de ne pas additionner les taxons en fonction des structures
    select(-c(spp,Site,Structure2)) %>% 
      mutate(across(everything(.), ~replace_na(., 0))) %>% 
  as.data.frame()}

# Convertion de split df en list
comp_list=as.list(data_comp1)

# Application de la fonction + names
comp_list_clean=lapply(comp_list, fun_clean)
names(comp_list_clean)<-c('Bi','Bu','Fe','Vb')

# Fonction
out.raw <- iNEXT(comp_list_clean,q=0,
                 datatype="incidence_raw",
                 endpoint=500)

p1<-plot(out.raw,xlim=c(0,500))





# Ici tu les données concernant l'estimation de la rich. totale
Rar_disc_df=as.data.frame(out.raw$AsyEst)

specpool(as.numeric(comp_list_clean$Bi))




### test  
data_comp1=data_PQ_light %>% ungroup %>% 
  select(spp,Date_courte,Site,Structure2, Code_struct) %>% 
   filter(!spp %in% c('NA','NI', 'Unassigned','ponte','Ponte','None')) %>%
   filter(Date_courte %in% c("2022-07","2021-07")) %>% 
  filter(Site == "Bi") %>% 
  mutate(date_st=paste0(Date_courte,'_',Code_struct)) %>%  
   filter(Structure2 %in% c("Disc","Pillars","Columns","Inner_slots")) %>% 
  mutate(P=1) %>% 
    select(-c(Date_courte,Code_struct)) %>% 
  distinct() %>% group_by(Structure2) %>% 
  group_split()


# On créait une fonction pour nettoyer l'intérieur de la liste
fun_clean=function(x){
  x%>% spread(date_st,P) %>% 
    distinct(spp,.keep_all = TRUE) %>% #ajout de cette fonction permettant de ne pas additionner les taxons en fonction des        structures
    select(-c(spp,Site,Structure2)) %>% 
      mutate(across(everything(.), ~replace_na(., 0))) %>% 
  as.data.frame()}

# Convertion de split df en list
comp_list=as.list(data_comp1)

# Application de la fonction + names
comp_list_clean=lapply(comp_list, fun_clean)
names(comp_list_clean)<-c('Bi','Bu','Fe','Vb')

# Fonction
out.raw <- iNEXT(comp_list_clean,q=0,
                 datatype="incidence_raw",
                 endpoint=250)
plot(out.raw)

```



# ### Indices Beta

## Indice de Shannon et Piélou
```{r}
# stabilité des communautés, 0 = 1 espèce prédominante sur sur le récif et 1 = équité de la répartion des espèces
##### indice de Shannon

#### Richesse taxo
#matrice présence/absence  par site par espèce
dataR2=dataR %>% ungroup %>%
  select(spp,Site,Day_delta) %>% 
  distinct()%>% 
  group_by(spp,Site,Day_delta) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR4<-spread((dataR3=dataR2 %>% 
  group_by(spp,Site,Day_delta) %>%
  summarize(S2 = mean(S))),key=spp,value=S2)

dataR4[is.na(dataR4)]<-0

shannonind<-diversity(dataR4[,-c(1:2)],index="shannon")
shannonind2<-cbind(dataR4[,c(1:2)],shannonind)
colnames(shannonind2)[3]<-"shannon"


#### Recouvrement
#matrice couverture moyenne par site par espèce
dataR2=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Day_delta,Mcov) %>% 
  distinct()%>% 
  group_by(spp,Site,Structure2,Day_delta,Mcov)

dataR4<-spread((dataR3=dataR2 %>% 
  group_by(spp,Site,Day_delta) %>%
  summarize(Mcov2 = mean(Mcov))),key=spp,value=Mcov2) 
dataR4[is.na(dataR4)]<-0

# Calcul indice de Shannon
shannonind<-diversity(dataR4[,-c(1:2)],index="shannon")
shannonind2<-cbind(dataR4[,c(1:2)],shannonind)
colnames(shannonind2)[3]<-"shannon"


#plot shannon
ggplot(shannonind2, aes(Day_delta,shannon, col=Site))+ # Avec "fill" ou "col" du peut ajout une séparation de tes données par facteur (ici le site)
  xlab("Jour depuis immersion")+
  ylab("Indice de Shannon")+
  # geom_jitter(alpha=.3)+  # On ajoute les points (pas nécessaire mais utile pour savoir sur quoi se base les boxplots)
  # geom_boxplot()+
  # geom_smooth()+
  geom_point()+
  geom_line(aes(group=Site))+
  theme_bw() 

#test calcul shannon max théorique
# propmax<-1/ncol(dataR4[,-1])
# shannonmax<- -sum(propmax*log(propmax))

#### indice de Piélou (indice de Shannon/Richesse spécifique)
Piélouind<-shannonind/log(45) #indice de shannon divisé par le nombre max de taxons sur un meme site
Piélouind2<-cbind(dataR4[,c(1:2)],Piélouind)
colnames(Piélouind2)[3]<-"Piélou"

#plot Piélou
ggplot(Piélouind2, aes(Day_delta,Piélou, col=Site))+ # Avec "fill" ou "col" du peut ajout une séparation de tes données par facteur (ici le site)
  xlab("Nombre de jours d'immersion")+
  ylab("Indice de Piélou")+
  # geom_jitter(alpha=.3)+  # On ajoute les points (pas nécessaire mais utile pour savoir sur quoi se base les boxplots)
  # geom_boxplot()+
  annotate("rect",xmin=112,xmax=205.9,ymin=0.45,ymax=0.9,alpha=.3,fill="grey")+
  annotate("rect",xmin=206,xmax=298.9,ymin=0.45,ymax=0.9,alpha=.3,fill="#666666")+
  annotate("rect",xmin=299,xmax=388.9,ymin=0.45,ymax = 0.9,alpha=.3,fill="grey")+
  annotate("rect",xmin=389,xmax=477.9,ymin=0.45,ymax = 0.9,alpha=.3,fill="#666666")+
annotate("rect",xmin=478,xmax=570.9,ymin=0.45,ymax = 0.9,alpha=.3,fill="grey")+
  annotate("rect",xmin=571,xmax=663.9,ymin=0.45,ymax = 0.9,alpha=.3,fill="#666666")+
  annotate("rect",xmin=664,xmax=750,ymin=0.45,ymax = 0.9,alpha=.3,fill="grey")+
  geom_line(aes(group=Site))+
  geom_point()+
  theme_bw() +
    (scale_y_continuous(limits=c(0.45,0.9)))+
      (scale_x_continuous(limits=c(110,750)))+
  theme(axis.text.x = element_text(size=16,colour="black"))+
   theme(axis.text.y = element_text(size=16,colour="black"))+
  theme(axis.title.x = element_text(size=16,colour="black",vjust=0))+
  theme(axis.title.y = element_text(size=16,colour="black",vjust=2))+
   # (scale_x_continuous(minor_breaks=seq(0,27,by=2)))+
     # (scale_x_continuous(breaks=seq(0,25,by=2)))+
#   annotate("rect",xmin=112,xmax=205.9,ymin=0.45,ymax=0.9,alpha=.1,fill="#33CC00")+
#   annotate("rect",xmin=206,xmax=298.9,ymin=0.45,ymax=0.9,alpha=.1,fill="orange")+
#   annotate("rect",xmin=299,xmax=388.9,ymin=0.45,ymax = 0.9,alpha=.1,fill="brown")+
#   annotate("rect",xmin=389,xmax=477.9,ymin=0.45,ymax = 0.9,alpha=.1,fill="blue")+
# annotate("rect",xmin=478,xmax=570.9,ymin=0.45,ymax = 0.9,alpha=.1,fill="#33CC00")+
#   annotate("rect",xmin=571,xmax=663.9,ymin=0.45,ymax = 0.9,alpha=.1,fill="orange")+
#   annotate("rect",xmin=664,xmax=750,ymin=0.45,ymax = 0.9,alpha=.1,fill="brown")+
# annotate("text",x = c(159,252,344,433,524,617,708),y=0.85,
#            label=c("Printemps","Eté","Automne","Hiver","Printemps","Eté","Automne"),
#            colour=c("#33CC00","orange","brown","blue","#33CC00","orange","brown"),angle=35)

# geom_vline(xintercept = 111,colour='#666666',alpha=.5)+
#   geom_vline(xintercept = 206,colour='#666666',alpha=.5)+
#   geom_vline(xintercept = 299,colour='#666666',alpha=.5)+
#   geom_vline(xintercept = 389,colour='#666666',alpha=.5)+
#   geom_vline(xintercept = 478,colour='#666666',alpha=.5)+
#   geom_vline(xintercept = 571,colour='#666666',alpha=.5)+
#   geom_vline(xintercept = 664,colour='#666666',alpha=.5)+
# theme(legend.position = "bottom")+
theme(legend.background = element_rect(fill="#ececec"))+
  theme(legend.key = element_rect(fill="#ececec"))+
  annotate("text",x = c(65,159,252,344,433,524,617,710),y=0.85,
           label=c("Hiver","Printemps","Eté","Automne","Hiver","Printemps","Eté","Automne"),
           colour=c("#666666","#666666","#666666","#666666","#666666","#666666","#666666","#666666"),size=6,angle=45)
ggsave("Indicedepiélou.png",width=9,height=8,dpi=350)

```


# Calcul des indices de beta diversité
```{r}

dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2021-01" | dataR$saison == "2022-01"] <- "hiver"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"2021-11"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"2021-11"

### Mcov moyen
dataR3=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Date_courte,Day_delta,Mcov,Quad2,saison) %>%
  # filter(Date_courte %in% c("2021-04","2021-07","2021-11","2022-01","2022-04","2022-11")) %>% 
  distinct()%>%
  group_by(Site,Structure2,Mcov,Micro,Quad2,Date_courte,saison) %>%
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by=c(spp,Site,Structure2,Micro,Date_courte,Day_delta,saison)) %>%
  na.omit()%>%
  droplevels() %>% 
  spread(spp,Mcov2) %>% 
  mutate(across(everything(.), ~replace_na(., 0))) %>% 
  mutate(Name=paste(Site,Structure2,Date_courte,saison,Day_delta,sep=","))


#Calcul de la nestedness, diversité et turnover
databetadiv2<-beta.div.comp(dataR3[,-c(1:6,67)],coef="S")


# Extraction des matrices
mat.D=as.matrix(databetadiv2$D)
mat.D[upper.tri(mat.D)]<-NA
diag(mat.D)<-NA
rownames(mat.D)<-dataR3$Name #change le nom des lignes avec les metadonnées
colnames(mat.D)<-dataR3$Name #change le nom des colonnes avec les metadonnées
 
mat.repl=as.matrix(databetadiv2$repl)
mat.repl[upper.tri(mat.repl)]<-NA
diag(mat.repl)<-NA
rownames(mat.repl)<-dataR3$Name #change le nom des lignes avec les metadonnées
colnames(mat.repl)<-dataR3$Name #change le nom des colonnes avec les metadonnées
 
mat.rich=as.matrix(databetadiv2$rich)
mat.rich[upper.tri(mat.rich)]<-NA
diag(mat.rich)<-NA
rownames(mat.rich)<-dataR3$Name #change le nom des lignes avec les metadonnées
colnames(mat.rich)<-dataR3$Name #change le nom des colonnes avec les metadonnées
 

# Transformation des matrices en df
test.mat.D=na.omit(reshape2::melt(mat.D)) %>% mutate(Type='D') 
test.mat.D2 <- test.mat.D %>%
  mutate(row_id = row_number()) %>%  # Créer une colonne pour identifier chaque ligne
  separate(Var1, into = paste0("Var1", 1:5), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 1 
  separate(Var2, into = paste0("Var2", 1:5), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 2
  select(-row_id)  # Supprimer la colonne d'identification
colnames(test.mat.D2)<-c("Site1","Structure1","Date1","Saison1","Day1","Site2","Structure2","Date2","Saison2","Day2","Dissimilarité","type")

test.mat.repl=na.omit(reshape2::melt(mat.repl)) %>% mutate(Type='repl')
test.mat.repl2 <- test.mat.repl %>%
  mutate(row_id = row_number()) %>%  # Créer une colonne pour identifier chaque ligne
  separate(Var1, into = paste0("Var1", 1:5), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 1 
  separate(Var2, into = paste0("Var2", 1:5), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 2
  select(-row_id)  # Supprimer la colonne d'identification
colnames(test.mat.repl2)<-c("Site1","Structure1","Date1","Saison1","Day1","Site2","Structure2","Date2","Saison2","Day2","Dissimilarité","type")

test.mat.rich=na.omit(reshape2::melt(mat.rich)) %>% mutate(Type='rich')
test.mat.rich2 <- test.mat.rich %>%
  mutate(row_id = row_number()) %>%  # Créer une colonne pour identifier chaque ligne
  separate(Var1, into = paste0("Var1", 1:5), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 1 
  separate(Var2, into = paste0("Var2", 1:5), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 2
  select(-row_id)  # Supprimer la colonne d'identification
colnames(test.mat.rich2)<-c("Site1","Structure1","Date1","Saison1","Day1","Site2","Structure2","Date2","Saison2","Day2","Dissimilarité","type")


#Création jeu de données rassemblant les différentes données
datadissi<-test.mat.D2 %>% select(Site1,Structure1,Date1,Saison1,Day1,Site2,Structure2,Date2,Saison2,Day2,Dissimilarité) 
datarepl<-test.mat.repl2 %>% select(Site1,Structure1,Date1,Saison1,Day1,Site2,Structure2,Date2,Saison2,Day2,Dissimilarité) 
datarich<-test.mat.rich2 %>% select(Site1,Structure1,Date1,Saison1,Day1,Site2,Structure2,Date2,Saison2,Day2,Dissimilarité)

datatern<-cbind(datadissi[,-c(6,8)],Similarité=(1-datadissi[,11])*100,Remplacement=100*datarepl[,11],Richesse=100*datarich[,11])
datatern<-cbind(datadissi[,-c(11)],Similarité=(1-datadissi[,11]),Remplacement=datarepl[,11],Richesse=datarich[,11])

```



### Ternary plot
```{r}

########## Test package gg plot ########## #http://www.ggtern.com/d/2.2.0/
datatern2=datatern %>%
  # filter(Structure1 == 'Inner_slots') %>%
    # filter(Structure1 %in% c('Disc','Inner_slots')) %>%
    # filter(Structure2 %in% c('Disc','Inner_slots')) %>%
  # filter(Structure2%in% c('Disc')) %>%
    # filter(Structure1 %in% c('Inner_slots')) %>%
  # filter(Site1 == 'Bu') %>%
    # filter(Site2 == 'Fe') %>%
    # filter(Site1!=Site2) %>%
  filter(Site1 == Site2) %>%
  # filter(Saison1 == Saison2) %>%
  # filter(Structure1!=Structure2) %>%
  filter(Structure1 == Structure2) %>%
  # filter(Date1!=Date2) %>%
  filter(Date1==Date2) %>%
  # filter(Date1 == '2022-11') %>%
  # filter(Date2 == '2022-01') %>%
  # filter(!Date1 %in% c("2021-04","2021-07",'2021-10','2021-11')) %>%
  # filter(!Date2 %in% c("2021-04","2021-07",'2021-10','2021-11')) %>%
  mutate(Comp_site=Site1,
         Comp_struct=Structure1) 
# %>% 
  # filter(Comp_struct =="Inner_slots")

datatern2=datatern2 %>% 
 mutate(Compasite<-paste(Site1,Site2,sep="/")) %>% 
  mutate(Compastruct<-paste(Structure1,Structure2,sep="/")) %>% 
  mutate(Compadate<-paste(Date1,Date2,sep="/")) %>% 
  mutate(Compasaison<-paste(Saison1,Saison2,sep="/")) %>% 
  mutate(Compasite_date<-paste(Site1,Date1,sep="/")) 
colnames(datatern2)[14]<-"Compasite"
colnames(datatern2)[15]<-"Compastruct"
colnames(datatern2)[16]<-"Comp_site"
colnames(datatern2)[17]<-"Comp_struct"
colnames(datatern2)[18]<-"Compadate"
colnames(datatern2)[19]<-"Compasaison"
colnames(datatern2)[20]<-"Compasitedate"

#pour pouvoir mettre mettre les données de structure et date ensemble
# datatern2=datatern2 %>% mutate(Compasitedate=paste(Comp_struct,Compadate))
datatern2=datatern2 %>% mutate(Compasite_struct=paste(Compasite,Structure1))
datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
datatern2=datatern2 %>% mutate(Site_Years=paste(Compasite,Years))
datatern2=datatern2 %>% mutate(Compastruct_date=paste(Compadate,Compastruct))
datatern2=datatern2 %>% mutate(Compastruct_site_date=paste(Compasitedate,Compastruct))
datatern2=datatern2 %>% mutate(Compasite_date=paste(Compasite,Date1))

datamean<-datatern2 %>%  group_by(Compasite,Compasaison) %>%  #permet de faire la moyenne de chaque colonne par site/struct
  #  Compastruct,,Comp_site,Compadate,Compadate,Compadate,Compastruct,Compastruct,Site_Years <-à utiliser dans la ligne d'avant afin de faire les comparaisons voulues
  dplyr::summarize(Similarité=mean(Similarité),
            Remplacement=mean(Remplacement),
            Richesse=mean(Richesse))

ggtern(data=datatern2, aes(x=Richesse,y=Similarité,z=Remplacement,group=Compasaison)) +
  # geom_point(aes(colour=Compasite), position=position_jitter_tern(x=0.1, y=0.1, z=0.1),alpha=.3) +
    # geom_point(aes(colour=Compastruct), position=position_jitter_tern(x=0.1, y=0.1, z=0.1),alpha=.3) +
      # geom_point(aes(colour=Compasitedate), position=position_jitter_tern(x=0.1, y=0.1, z=0.1),alpha=.2) +
  geom_point(colour="grey",position=position_jitter_tern(x=0.1, y=0.1, z=0.1),alpha=.3)+
        geom_point(data=datamean,aes(color=Compasaison)) +
  # stat_density_tern( #ajout de la densité
            # geom="polygon",aes(fill=after_stat(level)),bins=10,color='grey')+
            # geom="polygon",aes(fill=Structure1),bins=10,color='grey')+
            # geom="polygon",aes(fill=Compasite),bins=10,color='grey')+
  theme_hidetitles()+ #enlève le nom des axes
  theme_showarrows()+ #montre les fléches
  # geom_crosshair_tern(data=datamean,aes(color=Compastruct_date))+
  # geom_crosshair_tern(data=datamean,aes(color=Compadate))+
  # geom_crosshair_tern(data=datamean,aes(color=Compastruct_date))+
  # geom_crosshair_tern(data=datamean,aes(color=Compasitedate))+
    geom_crosshair_tern(data=datamean,aes(color=Compasaison))+
    theme(strip.text.x = element_text(size = 12))+
  # facet_wrap(.~Comp_site)+
    facet_wrap(.~Compasite)+
  ggtern_labels()
  labs(title="")
  # scale_color_paletteer_d("dichromat::SteppedSequential_5")
  # labs(color = "Structures comparées")+
  
#### trajectoire avec flèches pour comparer les structures semblables

  # geom_path(data=datamean[which(datamean$Comp_site == "Bi" & datamean$Comp_struct=="Disc"),],group=1,aes(color=Compasitedate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Bu" & datamean$Comp_struct=="Disc"),],group=1,aes(color=Compasitedate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Fe" & datamean$Comp_struct=="Disc"),],group=1,aes(color=Compasitedate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "VB" & datamean$Comp_struct=="Disc"),],group=1,aes(color=Compasitedate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))
  # geom_path(data=datamean[which(datamean$Comp_site == "Bi" & datamean$Comp_struct=="Columns"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Bu" & datamean$Comp_struct=="Columns"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Fe" & datamean$Comp_struct=="Columns"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "VB" & datamean$Comp_struct=="Columns"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  # geom_path(data=datamean[which(datamean$Comp_site == "Bi" & datamean$Comp_struct=="Pillars"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Bu" & datamean$Comp_struct=="Pillars"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Fe" & datamean$Comp_struct=="Pillars"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "VB" & datamean$Comp_struct=="Pillars"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  # geom_path(data=datamean[which(datamean$Comp_site == "Bi" & datamean$Comp_struct=="Inner_slots"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Bu" & datamean$Comp_struct=="Inner_slots"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "Fe" & datamean$Comp_struct=="Inner_slots"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
  #   geom_path(data=datamean[which(datamean$Comp_site == "VB" & datamean$Comp_struct=="Inner_slots"),],group=1,aes(color=Compasite_struct),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))



#### Trajectoire pour comparer les structures différentes
 # geom_path(data=datamean[which(datamean$Compastruct=="Columns/Disc"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Columns/Inner_slots"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Columns/Pillars"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Inner_slots/Disc"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Inner_slots/Columns"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Inner_slots/Pillars"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Pillars/Columns"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Pillars/Disc"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Pillars/Inner_slots"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Disc/Columns"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Disc/Inner_slots"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
 #  geom_path(data=datamean[which(datamean$Compastruct=="Disc/Pillars"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))


#### Trajectoire pour comparer les récifs différents selon les structures
# geom_path(data=datamean[which(datamean$Compasite=="Bu/Bi"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
# geom_path(data=datamean[which(datamean$Compasite=="Fe/Bi"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
# geom_path(data=datamean[which(datamean$Compasite=="Fe/Bu"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
# geom_path(data=datamean[which(datamean$Compasite=="VB/Bi"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
# geom_path(data=datamean[which(datamean$Compasite=="VB/Bu"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))+
# geom_path(data=datamean[which(datamean$Compasite=="VB/Fe"),],group=1,aes(color=Compadate),arrow=arrow(type="closed",length=unit(0.07,"inches"),ends="last"))


#### personnalisation du plot
# theme_custom( #https://rdrr.io/cran/ggtern/man/ggtern_themes.html
#   base_size = 10,
#   base_family = "",
#   tern.plot.background = NULL,
#   tern.panel.background = NULL,
#   col.T = "deepskyblue",
#   col.L = "green3",
#   col.R = "firebrick1",
#   col.grid.minor = "white"
# )
  
``` 




## Comparaison beta div entre les sites/structures
<!-- ########## A utiliser avec la partie "calcul nestedness/remplacement..... ########## -->
### Comparaison interstructures
```{r}
datatern2=datatern %>%
  # filter(Structure1 == 'Disc') %>%
    # filter(Structure1 %in% c('Disc','Inner_slots')) %>%
    # filter(Structure2 %in% c('Disc','Inner_slots')) %>%
  # filter(Structure2%in% c('Disc')) %>%
    # filter(Structure1 %in% c('Inner_slots')) %>%
  # filter(Site1 == 'Fe') %>%
    # filter(Site2 == 'Fe') %>%
    # filter(Site1!=Site2) %>%
  filter(Site1 == Site2) %>% 
  # filter(Saison1 == Saison2) %>%
  filter(Structure1!=Structure2) %>%
  # filter(Structure1 == Structure2) %>%
  # filter(Date1!=Date2) %>%
  filter(Date1==Date2) %>%
  # filter(Date1 == '2022-01') %>%
  # filter(Date2 == '2022-01') %>%
  # filter(!Date1 %in% c("2021-04","2021-07",'2021-10','2021-11')) %>%
  # filter(!Date2 %in% c("2021-04","2021-07",'2021-10','2021-11')) %>%
  mutate(Comp_site=Site1,
         Comp_struct=Structure1,
         Comp_date=Date1) 
# %>% 
  # filter(Comp_struct =="Inner_slots")

datatern2=datatern2 %>% 
 mutate(Compasite<-paste(Site1,Site2,sep="/")) %>% 
  mutate(Compastruct<-paste(Structure1,Structure2,sep="/")) %>% 
  mutate(Compadate<-paste(Date1,Date2,sep="/")) %>% 
  mutate(Compasaison<-paste(Saison1,Saison2,sep="/")) %>% 
  mutate(Compasite_date<-paste(Site1,Date1,sep="/")) 
colnames(datatern2)[17]<-"Compasite"
colnames(datatern2)[18]<-"Compastruct"
colnames(datatern2)[19]<-"Compadate"
colnames(datatern2)[20]<-"Compasaison"
colnames(datatern2)[21]<-"Compasitedate"

#pour pouvoir mettre mettre les données de structure et date ensemble
# datatern2=datatern2 %>% mutate(Compasitedate=paste(Comp_struct,Compadate))
datatern2=datatern2 %>% mutate(Compasite_struct=paste(Compasite,Structure1))
datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
datatern2=datatern2 %>% mutate(Site_Years=paste(Compasite,Years))
datatern2=datatern2 %>% mutate(Compastruct_date=paste(Compadate,Compastruct))
datatern2=datatern2 %>% mutate(Compastruct_site_date=paste(Compasitedate,Compastruct))
datatern2=datatern2 %>% mutate(Compasite_date=paste(Compasite,Date1))

datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Comp_date) %>%  #permet de faire la moyenne de chaque colonne par site/struct
  #  Compastruct,,Comp_site,Compadate,Compadate,Compadate,Compastruct,Compastruct,Site_Years <-à utiliser dans la ligne d'avant afin de faire les comparaisons voulues
  dplyr::summarize(Similarité=mean(Similarité),
            Remplacement=mean(Remplacement),
            Richesse=mean(Richesse))


datameansimi=datamean %>% select(Comp_site,Compastruct,Comp_date,Similarité) %>% 
  mutate(Betaindex= "Similarité") %>% select(Betaindex,Comp_site,Compastruct,Comp_date,Similarité)
colnames(datameansimi)[5]<-"BIvalue"

datameanremp=datamean %>% select(Comp_site,Compastruct,Comp_date,Remplacement) %>% 
  mutate(Betaindex= "Remplacement") %>% select(Betaindex,Comp_site,Compastruct,Comp_date,Remplacement)
colnames(datameanremp)[5]<-"BIvalue"

datameanrich=datamean %>% select(Comp_site,Compastruct,Comp_date,Richesse)  %>% 
  mutate(Betaindex= "Richesse") %>% select(Betaindex,Comp_site,Compastruct,Comp_date,Richesse)
colnames(datameanrich)[5]<-"BIvalue"

databetaindexinterstructures <- rbind(datameansimi,datameanremp,datameanrich)

```






### Comparaison intersites 
```{r}
datatern2=datatern %>%
  # filter(Structure1 == 'Disc') %>%
    # filter(Structure1 %in% c('Disc','Inner_slots')) %>%
    # filter(Structure2 %in% c('Disc','Inner_slots')) %>%
  # filter(Structure2%in% c('Disc')) %>%
    # filter(Structure1 %in% c('Inner_slots')) %>%
  # filter(Site1 == 'Fe') %>%
    # filter(Site2 == 'Fe') %>%
    filter(Site1!=Site2) %>%
  # filter(Site1 == Site2) %>% 
  # filter(Saison1 == Saison2) %>%
  # filter(Structure1!=Structure2) %>%
  filter(Structure1 == Structure2) %>%
  # filter(Date1!=Date2) %>%
  filter(Date1==Date2) %>%
  # filter(Date1 == '2022-01') %>%
  # filter(Date2 == '2022-01') %>%
  # filter(!Date1 %in% c("2021-04","2021-07",'2021-10','2021-11')) %>%
  # filter(!Date2 %in% c("2021-04","2021-07",'2021-10','2021-11')) %>%
  mutate(Comp_site=Site1,
         Comp_struct=Structure1,
         Comp_date=Date1) 
# %>% 
  # filter(Comp_struct =="Inner_slots")

datatern2=datatern2 %>% 
 mutate(Compasite<-paste(Site1,Site2,sep="/")) %>% 
  mutate(Compastruct<-paste(Structure1,Structure2,sep="/")) %>% 
  mutate(Compadate<-paste(Date1,Date2,sep="/")) %>% 
  mutate(Compasaison<-paste(Saison1,Saison2,sep="/")) %>% 
  mutate(Compasite_date<-paste(Site1,Date1,sep="/")) 
colnames(datatern2)[15]<-"Compasite"
colnames(datatern2)[16]<-"Compastruct"
colnames(datatern2)[17]<-"Compadate"
colnames(datatern2)[18]<-"Compasaison"
colnames(datatern2)[19]<-"Compasitedate"

#pour pouvoir mettre mettre les données de structure et date ensemble
# datatern2=datatern2 %>% mutate(Compasitedate=paste(Comp_struct,Compadate))
datatern2=datatern2 %>% mutate(Compasite_struct=paste(Compasite,Structure1))
datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
datatern2=datatern2 %>% mutate(Site_Years=paste(Compasite,Years))
datatern2=datatern2 %>% mutate(Compastruct_date=paste(Compadate,Compastruct))
datatern2=datatern2 %>% mutate(Compastruct_site_date=paste(Compasitedate,Compastruct))
datatern2=datatern2 %>% mutate(Compasite_date=paste(Compasite,Date1))

datamean<-datatern2 %>%  group_by(Compasite,Comp_struct,Comp_date) %>%  #permet de faire la moyenne de chaque colonne par site/struct
  #  Compastruct,,Comp_site,Compadate,Compadate,Compadate,Compastruct,Compastruct,Site_Years <-à utiliser dans la ligne d'avant afin de faire les comparaisons voulues
  dplyr::summarize(Similarité=mean(Similarité),
            Remplacement=mean(Remplacement),
            Richesse=mean(Richesse))


datameansimi=datamean %>% select(Compasite,Comp_struct,Comp_date,Similarité) %>% 
  mutate(Betaindex= "Similarité") %>% select(Betaindex,Compasite,Comp_struct,Comp_date,Similarité)
colnames(datameansimi)[5]<-"BIvalue"

datameanremp=datamean %>% select(Compasite,Comp_struct,Comp_date,Remplacement) %>% 
  mutate(Betaindex= "Remplacement") %>% select(Betaindex,Compasite,Comp_struct,Comp_date,Remplacement)
colnames(datameanremp)[5]<-"BIvalue"

datameanrich=datamean %>% select(Compasite,Comp_struct,Comp_date,Richesse)  %>% 
  mutate(Betaindex= "Richesse") %>% select(Betaindex,Compasite,Comp_struct,Comp_date,Richesse)
colnames(datameanrich)[5]<-"BIvalue"

databetaindexintersite <- rbind(datameansimi,datameanremp,datameanrich)
databetaindexintersite$BIvalue<-as.numeric(databetaindexintersite$BIvalue)
databetaindexintersite$Betaindex<-as.factor(databetaindexintersite$Betaindex)
databetaindexintersite$Comp_struct<-as.factor(databetaindexintersite$Comp_struct)
databetaindexintersite$Compasite<-as.factor(databetaindexintersite$Compasite)
databetaindexintersite$Comp_date<-as.factor(databetaindexintersite$Comp_date)

model1<-gam(BIvalue~s(Comp_date,bs='re')+s(Comp_struct,bs="re")+s(Compasite,bs="re")+s(Betaindex,bs="re"),data=databetaindexintersite) 

plot_smooths(model=model1, series=BIvalue,comparison=Betaindex)+theme_bw() #permet de mettre les gam selon les sites

``` 
  
  
  
### Toutes les comparaisons possible
```{r}
datatern2=datatern %>%
  # filter(Structure1 == 'Disc') %>%
    # filter(Structure1 %in% c('Disc','Inner_slots')) %>%
    # filter(Structure2 %in% c('Disc','Inner_slots')) %>%
  # filter(Structure2%in% c('Disc')) %>%
    # filter(Structure1 %in% c('Inner_slots')) %>%
  # filter(Site1 != 'Fe') %>%
    # filter(Site2 != 'Fe') %>%
  #   filter(Site1!=Site2) %>%
  # filter(Site1 == Site2) %>%
  # # filter(Saison1 == Saison2) %>%
  # filter(Structure1!=Structure2) %>%
  # filter(Structure1 == Structure2) %>%
  # filter(Date1!=Date2) %>%
  filter(Date1==Date2) %>%
  # filter(Date1 == '2022-01') %>%
  # filter(Date2 == '2022-01') %>%
  # filter(!Date2 %in% c("2021-04","2021-07",'2021-10','2021-11')) %>%
  mutate(Comp_site=Site1,Comp_struct=Structure1,Comp_date=Date1)


datatern2=datatern2 %>% 
 mutate(Compasite<-paste(Site1,Site2,sep="/")) %>% 
  mutate(Compastruct<-paste(Structure1,Structure2,sep="/")) %>% 
  mutate(Compadate<-paste(Date1,Date2,sep="/")) %>% 
  mutate(Compasaison<-paste(Saison1,Saison2,sep="/")) %>% 
  mutate(Compasite_date<-paste(Site1,Date1,sep="/")) %>% 
  mutate(Compaday<-paste(Day1,sep="/"))
# colnames(datatern2)[14]<-"Comp_site"
# colnames(datatern2)[15]<-"Comp_struct"
# colnames(datatern2)[16]<-"Comp_date"
colnames(datatern2)[17]<-"Compasite"
colnames(datatern2)[18]<-"Compastruct"
colnames(datatern2)[19]<-"Compadate"
colnames(datatern2)[20]<-"Compasaison"
colnames(datatern2)[21]<-"Compasitedate"
colnames(datatern2)[22]<-"Comp_day"



#pour pouvoir mettre mettre les données de structure et date ensemble
# datatern2=datatern2 %>% mutate(Compasitedate=paste(Comp_struct,Compadate))
datatern2=datatern2 %>% mutate(Compasite_struct=paste(Compasite,Structure1))
datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
datatern2=datatern2 %>% mutate(Site_Years=paste(Compasite,Years))
datatern2=datatern2 %>% mutate(Compastruct_date=paste(Compadate,Compastruct))
datatern2=datatern2 %>% mutate(Compastruct_site_date=paste(Compasitedate,Compastruct))
datatern2=datatern2 %>% mutate(Compasite_date=paste(Compasite,Date1))

datamean<-datatern2 %>%  group_by(Compasite,Compastruct,Comp_date,Compasaison) %>% 
  dplyr::summarize(Similarité=mean(Similarité),
            Remplacement=mean(Remplacement),
            Richesse=mean(Richesse))


datameansimi=datamean %>% select(Compasite,Compastruct,Comp_date,Compasaison,Similarité) %>% 
  mutate(Betaindex= "Similarité") %>% select(Betaindex,Compasite,Compastruct,Comp_date,Compasaison,Similarité)
colnames(datameansimi)[6]<-"BIvalue"

datameanremp=datamean %>% select(Compasite,Compastruct,Comp_date,Compasaison,Remplacement) %>% 
  mutate(Betaindex= "Remplacement") %>% select(Betaindex,Compasite,Compastruct,Comp_date,Compasaison,Remplacement)
colnames(datameanremp)[6]<-"BIvalue"

datameanrich=datamean %>% select(Compasite,Compastruct,Comp_date,Compasaison,Richesse)  %>% 
  mutate(Betaindex= "Richesse") %>% select(Betaindex,Compasite,Compastruct,Comp_date,Compasaison,Richesse)
colnames(datameanrich)[6]<-"BIvalue"

databetaindex <- rbind(datameansimi,datameanremp,datameanrich)

databetaindex$BIvalue<-as.numeric(databetaindex$BIvalue)
databetaindex$Betaindex<-as.factor(databetaindex$Betaindex)
databetaindex$Compastruct<-as.factor(databetaindex$Compastruct)
databetaindex$Compasite<-as.factor(databetaindex$Compasite)
databetaindex$Comp_date<-as.factor(databetaindex$Comp_date)
# databetaindex$Comp_day<-as.numeric(databetaindex$Comp_day)


##### Test comparaison interstructures et intersite avec binaire #####
betaindexbinaire<-databetaindex
databib<-betaindexbinaire


##### Data similarité #####
# datameansimi$Compasite[datameansimi$Compasite == "Bi/Bi"| datameansimi$Compasite == "Bu/Bu"| datameansimi$Compasite == "Fe/Fe"| datameansimi$Compasite == "VB/VB"] <- "Intra"
# datameansimi$Compasite[datameansimi$Compasite == "Bu/Bi"| datameansimi$Compasite == "Fe/Bi"| datameansimi$Compasite == "Fe/Bu"| datameansimi$Compasite == "VB/Bi" | datameansimi$Compasite == "VB/Bu" | datameansimi$Compasite == "VB/Fe"] <- "Inter"
# 
# 
# datameansimi$Compastruct[datameansimi$Compastruct == "Columns/Columns"| datameansimi$Compastruct == "Disc/Disc"| datameansimi$Compastruct == "Pillars/Pillars"| datameansimi$Compastruct == "Inner_slots/Inner_slots"] <- "Intra"
# 
# datameansimi$Compastruct[datameansimi$Compastruct == "Columns/Disc"| datameansimi$Compastruct == "Columns/Inner_slots"| datameansimi$Compastruct == "Disc/Columns"| datameansimi$Compastruct == "Disc/Inner_slots"| datameansimi$Compastruct == "Disc/Pillars"| datameansimi$Compastruct == "Inner_slots/Columns" | datameansimi$Compastruct == "Inner_slots/Disc"| datameansimi$Compastruct == "Inner_slots/Pillars" | datameansimi$Compastruct == "Pillars/Columns"| datameansimi$Compastruct == "Pillars/Disc"| datameansimi$Compastruct == "Pillars/Inner_slots" | datameansimi$Compastruct == "Columns/Pillars"] <- "Inter"


datameansimi$Compa<-rep(0)
datameansimi$Compa[datameansimi$Compasite == "Bu/Bi"| datameansimi$Compasite == "Fe/Bi"| datameansimi$Compasite == "Fe/Bu"| datameansimi$Compasite == "VB/Bi" | datameansimi$Compasite == "VB/Bu" | datameansimi$Compasite == "VB/Fe"]<-"Inter"

datameansimi$Compa[datameansimi$Compasite == "Bi/Bi"| datameansimi$Compasite == "Bu/Bu"| datameansimi$Compasite == "Fe/Fe"| datameansimi$Compasite == "VB/VB"] <- "Intra"

datameansimi$Compa[datameansimi$Compastruct == "Columns/Disc" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Columns/Inner_slots" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Disc/Columns" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Disc/Inner_slots" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Disc/Pillars" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Inner_slots/Columns" & datameansimi$Compa =="Intra" | datameansimi$Compastruct == "Inner_slots/Disc" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Inner_slots/Pillars"  & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Pillars/Columns" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Pillars/Disc" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Pillars/Inner_slots"  & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Columns/Pillars" & datameansimi$Compa =="Intra"] <- "Interstruct"


datameansimi$Compa[datameansimi$Compastruct == "Disc/Disc" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Inner_slots/Inner_slots" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Columns/Columns" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Pillars/Pillars" & datameansimi$Compa =="Intra"] <- "Intrastruct"



##### Data remplacement #####
# datameanremp$Compasite[datameanremp$Compasite == "Bi/Bi"| datameanremp$Compasite == "Bu/Bu"| datameanremp$Compasite == "Fe/Fe"| datameanremp$Compasite == "VB/VB"] <- "Intra"
# datameanremp$Compasite[datameanremp$Compasite == "Bu/Bi"| datameanremp$Compasite == "Fe/Bi"| datameanremp$Compasite == "Fe/Bu"| datameanremp$Compasite == "VB/Bi" | datameanremp$Compasite == "VB/Bu" | datameanremp$Compasite == "VB/Fe"] <- "Inter"
# 
# 
# datameanremp$Compastruct[datameanremp$Compastruct == "Columns/Columns"| datameanremp$Compastruct == "Disc/Disc"| datameanremp$Compastruct == "Pillars/Pillars"| datameanremp$Compastruct == "Inner_slots/Inner_slots"] <- "Intra"
# 
# datameanremp$Compastruct[datameanremp$Compastruct == "Columns/Disc"| datameanremp$Compastruct == "Columns/Inner_slots"| datameanremp$Compastruct == "Disc/Columns"| datameanremp$Compastruct == "Disc/Inner_slots"| datameanremp$Compastruct == "Disc/Pillars"| datameanremp$Compastruct == "Inner_slots/Columns" | datameanremp$Compastruct == "Inner_slots/Disc"| datameanremp$Compastruct == "Inner_slots/Pillars" | datameanremp$Compastruct == "Pillars/Columns"| datameanremp$Compastruct == "Pillars/Disc"| datameanremp$Compastruct == "Pillars/Inner_slots"| datameansimi$Compastruct == "Columns/Pillars"] <- "Inter"

datameanremp$Compa<-rep(0)
datameanremp$Compa[datameanremp$Compasite == "Bu/Bi"| datameanremp$Compasite == "Fe/Bi"| datameanremp$Compasite == "Fe/Bu"| datameanremp$Compasite == "VB/Bi" | datameanremp$Compasite == "VB/Bu" | datameanremp$Compasite == "VB/Fe"]<-"Inter"

datameanremp$Compa[datameanremp$Compasite == "Bi/Bi"| datameanremp$Compasite == "Bu/Bu"| datameanremp$Compasite == "Fe/Fe"| datameanremp$Compasite == "VB/VB"] <- "Intra"

datameanremp$Compa[datameanremp$Compastruct == "Columns/Disc" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Columns/Inner_slots" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Disc/Columns" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Disc/Inner_slots" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Disc/Pillars" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Inner_slots/Columns" & datameanremp$Compa =="Intra" | datameanremp$Compastruct == "Inner_slots/Disc" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Inner_slots/Pillars"  & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Pillars/Columns" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Pillars/Disc" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Pillars/Inner_slots"  & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Columns/Pillars" & datameanremp$Compa =="Intra"] <- "Interstruct"


datameanremp$Compa[datameanremp$Compastruct == "Disc/Disc" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Inner_slots/Inner_slots" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Columns/Columns" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Pillars/Pillars" & datameanremp$Compa =="Intra"] <- "Intrastruct"


##### Date Richesse #####
# datameanrich$Compasite[datameanrich$Compasite == "Bi/Bi"| datameanrich$Compasite == "Bu/Bu"| datameanrich$Compasite == "Fe/Fe"| datameanrich$Compasite == "VB/VB"] <- "Intra"
# datameanrich$Compasite[datameanrich$Compasite == "Bu/Bi"| datameanrich$Compasite == "Fe/Bi"| datameanrich$Compasite == "Fe/Bu"| datameanrich$Compasite == "VB/Bi" | datameanrich$Compasite == "VB/Bu" | datameanrich$Compasite == "VB/Fe"] <- "Inter"
# 
# 
# datameanrich$Compastruct[datameanrich$Compastruct == "Columns/Columns"| datameanrich$Compastruct == "Disc/Disc"| datameanrich$Compastruct == "Pillars/Pillars"| datameanrich$Compastruct == "Inner_slots/Inner_slots"] <- "Intra"
# 
# datameanrich$Compastruct[datameanrich$Compastruct == "Columns/Disc"| datameanrich$Compastruct == "Columns/Inner_slots"| datameanrich$Compastruct == "Disc/Columns"| datameanrich$Compastruct == "Disc/Inner_slots"| datameanrich$Compastruct == "Disc/Pillars"| datameanrich$Compastruct == "Inner_slots/Columns" | datameanrich$Compastruct == "Inner_slots/Disc"| datameanrich$Compastruct == "Inner_slots/Pillars" | datameanrich$Compastruct == "Pillars/Columns"| datameanrich$Compastruct == "Pillars/Disc"| datameanrich$Compastruct == "Pillars/Inner_slots"| datameansimi$Compastruct == "Columns/Pillars"] <- "Inter"

datameanrich$Compa<-rep(0)
datameanrich$Compa[datameanrich$Compasite == "Bu/Bi"| datameanrich$Compasite == "Fe/Bi"| datameanrich$Compasite == "Fe/Bu"| datameanrich$Compasite == "VB/Bi" | datameanrich$Compasite == "VB/Bu" | datameanrich$Compasite == "VB/Fe"]<-"Inter"

datameanrich$Compa[datameanrich$Compasite == "Bi/Bi"| datameanrich$Compasite == "Bu/Bu"| datameanrich$Compasite == "Fe/Fe"| datameanrich$Compasite == "VB/VB"] <- "Intra"

datameanrich$Compa[datameanrich$Compastruct == "Columns/Disc" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Columns/Inner_slots" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Disc/Columns" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Disc/Inner_slots" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Disc/Pillars" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Inner_slots/Columns" & datameanrich$Compa =="Intra" | datameanrich$Compastruct == "Inner_slots/Disc" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Inner_slots/Pillars"  & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Pillars/Columns" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Pillars/Disc" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Pillars/Inner_slots"  & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Columns/Pillars" & datameanrich$Compa =="Intra"] <- "Interstruct"


datameanrich$Compa[datameanrich$Compastruct == "Disc/Disc" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Inner_slots/Inner_slots" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Columns/Columns" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Pillars/Pillars" & datameanrich$Compa =="Intra"] <- "Intrastruct"




databetaindex2 <- cbind(datameansimi[,-1],datameanremp[,-c(1:5,7)],datameanrich[,-c(1:5,7)])
databetaindex2 <- databetaindex2[,c(1:4,6,5,7:8)]
colnames(databetaindex2)[6:8]<-c("Similarité","Remplacement","Richesse")

databetaindex2$Compasite<-as.factor(databetaindex2$Compasite)
databetaindex2$Compastruct<-as.factor(databetaindex2$Compastruct)
databetaindex2$Comp_date<-as.factor(databetaindex2$Comp_date)
databetaindex2$Compasaison<-as.factor(databetaindex2$Compasaison)
# databetaindex2$Comp_day<-as.factor(databetaindex2$Comp_day)
databetaindex2$Compa<-as.factor(databetaindex2$Compa)

databetaindex2$Similarité<-as.numeric(databetaindex2$Similarité)
databetaindex2$Remplacement<-as.numeric(databetaindex2$Remplacement)
databetaindex2$Richesse<-as.numeric(databetaindex2$Richesse)



### Similarité ###
databetaindex3=databetaindex2[,-c(1:2)]

databetaindex3<-databetaindex3[,-c(5:6)]


rf <- randomForest(Similarité ~ ., data = databetaindex3, ntree = 10)

X<-databetaindex3[which(names(databetaindex3)!="Similarité")]
predictor <- Predictor$new(rf, data = X, y = databetaindex3$Similarité)


# imp <- FeatureImp$new(predictor, loss = "mae") ########## fonction qui compile les packages dplyr et MASS donc fonctionne plus
# plot(imp)

# ale <- FeatureEffect$new(predictor, feature = "lstat", grid.size = 10)
# ale$plot()

interact <- Interaction$new(predictor, grid.size = 15)
plot(interact)

effs <- FeatureEffects$new(predictor, grid.size = 10) ######### fonction qui compile les packages dplyr et MASS donc fonctionne plus
plot(effs)

tree <- TreeSurrogate$new(predictor, maxdepth = 2)
plot(tree)

lime.explain <- LocalModel$new(predictor, x.interest = X[1, ])
plot(lime.explain)

# shapley <- Shapley$new(predictor, x.interest = X[1, ], sample.size = 50)
# shapley$plot()




### Remplacement ###
databetaindex3=databetaindex2[,-c(1:2)]

databetaindex3<-databetaindex3[,-c(4,6)]

rf <- randomForest(Remplacement ~ ., data = databetaindex3, ntree = 10)

X<-databetaindex3[which(names(databetaindex3)!="Remplacement")]
predictor <- Predictor$new(rf, data = X, y = databetaindex3$Remplacement)


# imp <- FeatureImp$new(predictor, loss = "mae") ######### fonction qui compile les packages dplyr et MASS donc fonctionne plus
# plot(imp)

interact <- Interaction$new(predictor, grid.size = 15)
plot(interact)


effs <- FeatureEffects$new(predictor, grid.size = 10) ######### fonction qui compile les packages dplyr et MASS donc fonctionne plus
# library(forcats)
# fct_relevel(effs$results$Comp_date$.borders, c("2021-01", "2021-04", "2021-07","2021-11","2022-01","2022-04", "2022-07","2022-11" ))
# levels_order <- c("2021-01", "2021-04", "2021-07","2021-11","2022-01","2022-04","2022-07","2022-11")
# effs$results$Comp_date <- factor(effs$results$Comp_date, levels = levels_order)
# effs$plot$environment$self$results$Cmp_date <- factor(effs$plot$environment$self$results$Comp_date, levels = levels_order)
plot(effs)



### Richesse ###
databetaindex3=databetaindex2[,-c(1:2)]

databetaindex3<-databetaindex3[,-c(4,5)]

rf <- randomForest(Richesse ~ ., data = databetaindex3, ntree = 10)

X<-databetaindex3[which(names(databetaindex3)!="Richesse")]
predictor <- Predictor$new(rf, data = X, y = databetaindex3$Richesse)


# imp <- FeatureImp$new(predictor, loss = "mae")
# plot(imp)

interact <- Interaction$new(predictor, grid.size = 15)
plot(interact)

effs <- FeatureEffects$new(predictor, grid.size = 10)
plot(effs)


```




<!-- ## Analyse des trajectoires -->
<!-- ### Longueur  -->
```{r}
########## Comparaison intrasite interstructures ##########
## Bi ##
# 
# datatern
# 
# datatern2=datatern %>%
#   filter(Site1 == 'Bi') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# trajBi<-trajectoryLengths(distdataR,datamean$Compastruct,surveys=NULL) 
# 
# 
# 
# ## Bu ##
# 
# datatern2=datatern %>%
#   filter(Site1 == 'Bu') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# trajBu<-trajectoryLengths(distdataR,datamean$Compastruct,surveys=NULL) 
# 
# 
# 
# ## Fe ##
# 
# datatern2=datatern %>%
#   filter(Site1 == 'Fe') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# trajFe<-trajectoryLengths(distdataR,datamean$Compastruct,surveys=NULL) 
# 
# 
# 
# ## VB ##
# 
# datatern2=datatern %>%
#   filter(Site1 == 'VB') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# trajVB<-trajectoryLengths(distdataR,datamean$Compastruct,surveys=NULL) 
# 
# 
# trajBi2=trajBi %>%  select(Trajectory)
# trajBu2=trajBu %>%  select(Trajectory)
# trajFe2=trajFe %>%  select(Trajectory)
# trajVB2=trajVB %>%  select(Trajectory)
# trajinterstru<-rbind(trajBi2,trajBu2,trajFe2,trajVB2)
# trajinterstru$Structure<-rep(c("Colonne_Disque","Faille_Colonne","Faille_Disque","Faille_Pilier","Pilier_Colonne","Pilier_Disque"))
# trajinterstru$Site<-rep(c("Bi","Bu","Fe","VB"),each=6)
# trajinterstru$sd<-sqrt(trajinterstru$Trajectory)
# 
# 
# ggplot(trajinterstru, aes(Structure,Trajectory,fill=Structure))+ 
#   geom_bar(stat="identity",alpha=.7)+
#   # geom_boxplot()+
#   geom_errorbar(aes(ymin=Trajectory-sd, ymax=Trajectory+sd), width=.2, position=position_dodge(.9))+ #ajout des barres d'erreur
#   theme_bw()+ labs(title="Comparaisons intrasites interstructures")+
#   xlab("")+ ylab("Distance total de la trajectoire")+
#   facet_wrap(~Site)+
#   theme(axis.text.x = element_blank(), axis.ticks = element_blank()) # enlever les labels + enlever les graduations
# 
# 
# 
# 
# ########## Comparaison intersite intrastructures ##########
# ## Colonnes ##
# 
# datatern
# 
# datatern2=datatern %>%
#   filter(Site1 != Site2) %>%
#   filter(Structure1 == Structure2) %>%
#   filter(Structure1 == "Columns") %>%
#   filter(Date1 == Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# datatern2=datatern2 %>% mutate(Compasite=paste(Site1,Site2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Compasite,Comp_struct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Compasite<-as.factor(datamean$Compasite)
# datamean$Comp_struct<-as.factor(datamean$Comp_struct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# trajCol<-trajectoryLengths(distdataR,datamean$Compasite,surveys=NULL) 
# 
# 
# ## Disques ##
# 
# datatern2=datatern %>%
#   filter(Site1 != Site2) %>%
#   filter(Structure1 == Structure2) %>%
#   filter(Structure1 == "Disc") %>%
#   filter(Date1 == Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# datatern2=datatern2 %>% mutate(Compasite=paste(Site1,Site2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Compasite,Comp_struct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Compasite<-as.factor(datamean$Compasite)
# datamean$Comp_struct<-as.factor(datamean$Comp_struct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# trajDis<-trajectoryLengths(distdataR,datamean$Compasite,surveys=NULL)
# 
# 
# ## Piliers ##
# 
# datatern2=datatern %>%
#   filter(Site1 != Site2) %>%
#   filter(Structure1 == Structure2) %>%
#   filter(Structure1 == "Pillars") %>%
#   filter(Date1 == Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# datatern2=datatern2 %>% mutate(Compasite=paste(Site1,Site2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Compasite,Comp_struct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Compasite<-as.factor(datamean$Compasite)
# datamean$Comp_struct<-as.factor(datamean$Comp_struct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# trajPil<-trajectoryLengths(distdataR,datamean$Compasite,surveys=NULL) 
# 
# 
# ## Failles ##
# 
# datatern2=datatern %>%
#   filter(Site1 != Site2) %>%
#   filter(Structure1 == Structure2) %>%
#   filter(Structure1 == "Inner_slots") %>%
#   filter(Date1 == Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# datatern2=datatern2 %>% mutate(Compasite=paste(Site1,Site2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Compasite,Comp_struct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Compasite<-as.factor(datamean$Compasite)
# datamean$Comp_struct<-as.factor(datamean$Comp_struct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# trajFai<-trajectoryLengths(distdataR,datamean$Compasite,surveys=NULL)
# trajFai$sd<-
# 
# trajCol2=trajCol %>%  select(Trajectory)
# trajDis2=trajDis %>%  select(Trajectory)
# trajPil2=trajPil %>%  select(Trajectory)
# trajFai2=trajFai %>%  select(Trajectory)
# trajintersite<-rbind(trajCol2,trajDis2,trajPil2,trajFai2)
# trajintersite$Structure<-rep(c("Bu_Bi","Fe_Bi","Fe_Bu","VB_Bi","VB_Bu","VB_Fe"))
# trajintersite$Site<-rep(c("Colonne","Disque","Piliers","Faille"),each=6)
# trajintersite$sd<-sqrt(trajintersite$Trajectory)
# 
# 
# ggplot(trajinterstru, aes(Structure,Trajectory,fill=Structure))+ 
#   geom_bar(stat="identity",alpha=.7)+
#   # geom_boxplot()+
#   geom_errorbar(aes(ymin=Trajectory-sd, ymax=Trajectory+sd), width=.2, position=position_dodge(.9))+ #ajout des barres d'erreur
#   theme_bw()+ labs(title="Comparaisons intrasites interstructures")+
#   xlab("")+ ylab("Distance total de la trajectoire")+
#   facet_wrap(~Site)+
#   theme(axis.text.x = element_blank(), axis.ticks = element_blank()) # enlever les labels + enlever les graduations

```


<!-- ### Angles -->
```{r}
########## Comparaison intrasite interstructures ##########
## Bi ##
# 
# datatern2=datatern %>%
#   filter(Site1 == 'Bi') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# angleBi<-trajectoryAngles(distdataR,datamean$Compastruct,surveys=NULL) 
# 
# 
# ## Bu ##
# 
# datatern2=datatern %>%
#   filter(Site1 == 'Bu') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# angleBu<-trajectoryAngles(distdataR,datamean$Compastruct,surveys=NULL) 
# 
# 
# 
# ## Fe ##
# 
# datatern2=datatern %>%
#   filter(Site1 == 'Fe') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# angleFe<-trajectoryAngles(distdataR,datamean$Compastruct,surveys=NULL)
# 
# 
# ## VB ##
# 
# datatern2=datatern %>%
#   filter(Site1 == 'VB') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# angleVB<-trajectoryAngles(distdataR,datamean$Compastruct,surveys=NULL) 
# 
# 
# 
# 
# ########## Comparaison intersite intrastructures ##########
# ## Colonnes ##
# 
# datatern2=datatern %>%
#   filter(Site1 != Site2) %>%
#   filter(Structure1 == Structure2) %>%
#   filter(Structure1 == "Columns") %>%
#   filter(Date1 == Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# datatern2=datatern2 %>% mutate(Compasite=paste(Site1,Site2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Compasite,Comp_struct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Compasite<-as.factor(datamean$Compasite)
# datamean$Comp_struct<-as.factor(datamean$Comp_struct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# anglCol<-trajectoryAngles(distdataR,datamean$Compasite,surveys=NULL) 
# 
# 
# ## Disques ##
# 
# datatern2=datatern %>%
#   filter(Site1 != Site2) %>%
#   filter(Structure1 == Structure2) %>%
#   filter(Structure1 == "Disc") %>%
#   filter(Date1 == Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# datatern2=datatern2 %>% mutate(Compasite=paste(Site1,Site2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Compasite,Comp_struct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Compasite<-as.factor(datamean$Compasite)
# datamean$Comp_struct<-as.factor(datamean$Comp_struct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# anglDis<-trajectoryAngles(distdataR,datamean$Compasite,surveys=NULL) 
# 
# 
# ## Piliers ##
# 
# datatern2=datatern %>%
#   filter(Site1 != Site2) %>%
#   filter(Structure1 == Structure2) %>%
#   filter(Structure1 == "Pillars") %>%
#   filter(Date1 == Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# datatern2=datatern2 %>% mutate(Compasite=paste(Site1,Site2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Compasite,Comp_struct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Compasite<-as.factor(datamean$Compasite)
# datamean$Comp_struct<-as.factor(datamean$Comp_struct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# anglPil<-trajectoryAngles(distdataR,datamean$Compasite,surveys=NULL) 
# 
# 
# ## Failles ##
# 
# datatern2=datatern %>%
#   filter(Site1 != Site2) %>%
#   filter(Structure1 == Structure2) %>%
#   filter(Structure1 == "Inner_slots") %>%
#   filter(Date1 == Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# datatern2=datatern2 %>% mutate(Compasite=paste(Site1,Site2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Compasite,Comp_struct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Compasite<-as.factor(datamean$Compasite)
# datamean$Comp_struct<-as.factor(datamean$Comp_struct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# anglFai<-trajectoryAngles(distdataR,datamean$Compasite,surveys=NULL) 

```


<!-- ### Direction -->
```{r}
########## Comparaison intrasite interstructures ##########
## Bi ##
# 
# datatern2=datatern %>%
#   filter(Site1 == 'Bi') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# directionBi<-trajectoryDirectionality(distdataR,datamean$Compastruct,surveys=NULL)
# 
# 
# ## Bu ##
# 
# datatern2=datatern %>%
#   filter(Site1 == 'Bu') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# directionBu<-trajectoryDirectionality(distdataR,datamean$Compastruct,surveys=NULL)
# 
# 
# 
# ## Fe ##
# 
# datatern2=datatern %>%
#   filter(Site1 == 'Fe') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# directionFe<-trajectoryDirectionality(distdataR,datamean$Compastruct,surveys=NULL)
# 
# 
# ## VB ##
# 
# datatern2=datatern %>%
#   filter(Site1 == 'VB') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# directionVB<-trajectoryDirectionality(distdataR,datamean$Compastruct,surveys=NULL)
# 
# 
# 
# ########## Comparaison intersite intrastructures ##########
# ## Colonnes ##
# 
# datatern2=datatern %>%
#   filter(Site1 != Site2) %>%
#   filter(Structure1 == Structure2) %>%
#   filter(Structure1 == "Columns") %>%
#   filter(Date1 == Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# datatern2=datatern2 %>% mutate(Compasite=paste(Site1,Site2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Compasite,Comp_struct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Compasite<-as.factor(datamean$Compasite)
# datamean$Comp_struct<-as.factor(datamean$Comp_struct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# directionCol<-trajectoryDirectionality(distdataR,datamean$Compasite,surveys=NULL) 
# 
# 
# ## Disques ##
# 
# datatern2=datatern %>%
#   filter(Site1 != Site2) %>%
#   filter(Structure1 == Structure2) %>%
#   filter(Structure1 == "Disc") %>%
#   filter(Date1 == Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# datatern2=datatern2 %>% mutate(Compasite=paste(Site1,Site2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Compasite,Comp_struct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Compasite<-as.factor(datamean$Compasite)
# datamean$Comp_struct<-as.factor(datamean$Comp_struct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# directionDis<-trajectoryDirectionality(distdataR,datamean$Compasite,surveys=NULL) 
# 
# 
# ## Piliers ##
# 
# datatern2=datatern %>%
#   filter(Site1 != Site2) %>%
#   filter(Structure1 == Structure2) %>%
#   filter(Structure1 == "Pillars") %>%
#   filter(Date1 == Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# datatern2=datatern2 %>% mutate(Compasite=paste(Site1,Site2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Compasite,Comp_struct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Compasite<-as.factor(datamean$Compasite)
# datamean$Comp_struct<-as.factor(datamean$Comp_struct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# directionPil<-trajectoryDirectionality(distdataR,datamean$Compasite,surveys=NULL) 
# 
# 
# ## Failles ##
# 
# datatern2=datatern %>%
#   filter(Site1 != Site2) %>%
#   filter(Structure1 == Structure2) %>%
#   filter(Structure1 == "Inner_slots") %>%
#   filter(Date1 == Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# datatern2=datatern2 %>% mutate(Compasite=paste(Site1,Site2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Compasite,Comp_struct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Compasite<-as.factor(datamean$Compasite)
# datamean$Comp_struct<-as.factor(datamean$Comp_struct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# directionFai<-trajectoryDirectionality(distdataR,datamean$Compasite,surveys=NULL) 
# 
# 

```

<!-- ### Convergence  -->
```{r}
########## Comparaison intrasite interstructures ##########
## Bi ##

# datatern2=datatern %>%
#   filter(Site1 == 'Bi') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# convergenceBi<-trajectoryConvergence(distdataR,datamean$Compastruct,surveys=NULL) 
# 
# 
# ## Bu ##
# 
# datatern2=datatern %>%
#   filter(Site1 == 'Bu') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# convergenceBu<-trajectoryConvergence(distdataR,datamean$Compastruct,surveys=NULL) 
# 
# 
# 
# ## Fe ##
# 
# datatern2=datatern %>%
#   filter(Site1 == 'Fe') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# convergenceFe<-trajectoryConvergence(distdataR,datamean$Compastruct,surveys=NULL) 
# 
# 
# ## VB ##
# 
# datatern2=datatern %>%
#   filter(Site1 == 'VB') %>%
#   filter(Site1 == Site2) %>%
#   filter(Structure1!=Structure2) %>%
#   filter(Date1==Date2) %>%
#   mutate(Comp_site=Site1,
#          Comp_struct=Structure1) 
# 
# 
# datatern2=datatern2 %>% mutate(Compasite_struct=paste(Comp_site,Structure1))
# datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
# datatern2=datatern2 %>% mutate(Compastruct=paste(Structure1,Structure2,sep="_"))
# 
# 
# datamean<-datatern2 %>%  group_by(Comp_site,Compastruct,Date1) %>% 
#   dplyr::summarize(Similarité=mean(Similarité),
#             Remplacement=mean(Remplacement),
#             Richesse=mean(Richesse))
# 
# datamean$Comp_site<-as.factor(datamean$Comp_site)
# datamean$Compastruct<-as.factor(datamean$Compastruct)
# datamean$Date1<-as.factor(datamean$Date1)
# 
# datamean2<-datamean[,c(4:6)]
# distdataR<-vegdist(datamean2, method='bray')
# 
# convergenceVB<-trajectoryConvergence(distdataR,datamean$Compastruct,surveys=NULL) 
# 
# 
# 
# 

```






# # Significativité des taxons indicateurs du site (fonction multipatt)
```{r}

#test sans moyenne par structure et donc avec micro
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"

### Mcov moyen
dataR3=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Date_courte,Mcov,Quad2,saison) %>%
  distinct()%>%
  group_by(Site,Structure2,Mcov,Micro,Quad2,Date_courte,saison) %>%
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by=c(spp,Site,Structure2,Micro,Date_courte,saison)) %>%
  na.omit()%>%
  droplevels() %>% 
  spread(spp,Mcov2) %>% 
  mutate(across(everything(.), ~replace_na(., 0))) %>% 
  mutate(Name=paste(Site,Structure2,Date_courte,saison,sep=","))
 
dataR3
test1<-multipatt(dataR3[-c(1:5,66)],dataR3$Site,max.order=2)
summary(test1)

# test avec moyenne par structure
dataR4=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Date_courte,Mcov,Quad2,saison) %>%
  distinct()%>%
  group_by(Site,Structure2,Mcov,Micro,Quad2,Date_courte,saison) %>%
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by=c(spp,Site,Structure2,Micro,Date_courte,saison)) %>%
  na.omit()%>%
  droplevels() 
  
dataR5=dataR4 %>% ungroup %>% 
    group_by(Site,saison,Date_courte,Structure2) %>% 
  as.data.frame() %>% summarize(Mcov3=mean(Mcov2),.by=c(spp,Site,Structure2,Date_courte,saison)) %>%
  spread(spp,Mcov3) %>% 
  mutate(across(everything(.), ~replace_na(., 0)))  
  # mutate(Name=paste(Site,Structure2,Date_courte,saison,sep=","))

test1<-multipatt(dataR5[-c(1:4)],dataR5$Site,max.order=2)
summary(test1)


```

# # Recouvrement par la roche nue

```{r}
# Quelle est l'évolution de la colonisation de la roche nue au fil du temps?
# Est ce que la diminution de la richesse taxonomique en hiver est démontrée par un nombre d'espèces plus faibles? Par une diminution de la colonisation du récif (augmentation du taux de roche nue(mortalité de la flore/faune sessile))?

dataR2=data_PQ_light %>% ungroup %>%
  filter(spp == "None") %>%
  filter(!Micro %in% c('C2P3.rndpts.csv','C2P4.rndpts.csv','C2P6.rndpts.csv')) %>% 
  filter(!Site == ("DSC"))%>%
  filter(!Structure2 %in% c('Holes','Upper_slots','Dome')) %>% 
  # filter(!Date_courte == '2021-01') %>%
  select(Site,Day_delta,Structure2,Micro,Quad2,Mcov) %>% 
  group_by(Site,Day_delta,Structure2,Micro,Quad2,Mcov) %>% 
  na.omit() %>% 
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by = c(Day_delta,Site,Structure2,Micro)) 

dataR3=dataR2 %>% as.data.frame() %>% 
  summarize(Mcov3=mean(Mcov2),.by = c(Day_delta,Site,Structure2)) 

dataR3=dataR2 %>% as.data.frame() %>% 
  summarize(Mcov3=mean(Mcov2),.by = c(Day_delta,Site)) 


ggplot(dataR3, aes(Structure2,Mcov3, fill=Site))+
  xlab("Structure")+
  ylab("Taux de roche nue")+
  geom_jitter(alpha=.3)+  
  geom_boxplot()+
  theme_bw()  

#Evolution temporelle
ggplot(dataR3, aes(Day_delta,Mcov3, col=Site))+
  xlab("Nombre de jours d'immersion")+
  ylab("Pourcentage de roche nue du récif (%)")+
  geom_point()+
  geom_line(aes(group=Site))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  annotate("rect",xmin=18,xmax=111,ymin=-1,ymax = 100,alpha=.1,fill="blue")+
annotate("rect",xmin=112,xmax=205,ymin=-1,ymax = 100,alpha=.1,fill="green")+
  annotate("rect",xmin=206,xmax=298,ymin=-1,ymax = 100,alpha=.1,fill="orange")+
  annotate("rect",xmin=299,xmax=388,ymin=-1,ymax = 100,alpha=.1,fill="brown")+
  annotate("rect",xmin=388.1,xmax=477,ymin=-1,ymax = 100,alpha=.1,fill="blue")+
annotate("rect",xmin=478,xmax=570,ymin=-1,ymax = 100,alpha=.1,fill="green")+
  annotate("rect",xmin=571,xmax=663,ymin=-1,ymax = 100,alpha=.1,fill="orange")+
  annotate("rect",xmin=664,xmax=752,ymin=-1,ymax = 100,alpha=.1,fill="brown")+
annotate("text",x = c(65,158,252,343,433,524,617,708),y=0,
           label=c("Hiver","Printemps","Eté","Automne","Hiver","Printemps","Eté","Automne"),
           colour=c("blue","green","orange","brown","blue","green","orange","brown"))



#### Test Gam recouvrement roche nue
dataR<-data_PQ_light
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2021-01" |dataR$saison == "2022-01"] <- "hiver"

dataR2=dataR %>% ungroup %>%
  filter(spp == "None") %>%
  filter(!Micro %in% c('C2P3.rndpts.csv','C2P4.rndpts.csv','C2P6.rndpts.csv')) %>% 
  filter(!Site == ("DSC"))%>%
  filter(!Structure2 %in% c('Holes','Upper_slots','Dome')) %>% 
  # filter(!Date_courte == '2021-01') %>% 
  select(Site,Day_delta,Structure2,Micro,Quad2,Mcov,saison) %>% 
  group_by(Site,Day_delta,Structure2,Micro,Quad2,Mcov,saison) %>% 
  na.omit() %>% 
  as.data.frame() %>% summarize(Mcov2=mean(Mcov),.by = c(Day_delta,Site,Structure2,Micro,saison)) 

dataR3=dataR2 %>% as.data.frame() %>% 
  summarize(Mcov3=mean(Mcov2),.by = c(Day_delta,Site,Structure2,saison)) 

# dataR3=dataR2 %>% as.data.frame() %>% 
#   summarize(Mcov3=mean(Mcov2),.by = c(Day_delta,Site)) 
dataR3$Site<-as.factor(dataR3$Site)
dataR3$saison<-as.factor(dataR3$saison)

model111111<-gam(Mcov3~s(Day_delta)+s(Structure2,bs="re")+s(Site,bs="re")+s(saison,bs="re")+s(Structure2,by=Site,bs='re'),data=dataR3)
# model111111<-gam(Mcov3~s(Day_delta)+s(Structure2,bs="re")+s(Site,bs="re")+s(saison,bs="re")+s(Structure2,by=Site,bs='re')+Site*Day_delta,data=dataR3) 
summary(model111111)

plot_smooths(model=model111111, series=Day_delta)+theme_bw()+ #permet de mettre les gam selon les sites
  # (scale_y_continuous(limits=c(0,60)))+
      # (scale_x_continuous(limits=c(0,750)))+
      # (scale_y_continuous(limits=c(0,50)))+
   # (scale_x_continuous(minor_breaks=seq(0,27,by=2)))+
     # (scale_x_continuous(breaks=seq(0,25,by=2)))+
  geom_vline(xintercept = 111,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 206,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 299,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 389,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 478,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 571,colour='#666666',alpha=.5)+
  geom_vline(xintercept = 664,colour='#666666',alpha=.5)+
#   annotate("rect",xmin=112,xmax=205.9,ymin=0,ymax=10,alpha=.1,fill="green")+
#   annotate("rect",xmin=206,xmax=298.9,ymin=0,ymax=10,alpha=.1,fill="orange")+
#   annotate("rect",xmin=299,xmax=388.9,ymin=0,ymax=10,alpha=.1,fill="brown")+
#   annotate("rect",xmin=389,xmax=477.9,ymin=0,ymax=10,alpha=.1,fill="blue")+
# annotate("rect",xmin=478,xmax=570.9,ymin=0,ymax=10,alpha=.1,fill="green")+
#   annotate("rect",xmin=571,xmax=663.9,ymin=0,ymax=10,alpha=.1,fill="orange")+
#   annotate("rect",xmin=664,xmax=750,ymin=0,ymax=10,alpha=.1,fill="brown")+
annotate("text",x = c(65,159,252,344,433,524,617,715),y=105,
           label=c("Hiver","Printemps","Eté","Automne","Hiver","Printemps","Eté","Automne"),
           colour=c("#666666","#666666","#666666","#666666","#666666","#666666","#666666","#666666"),size=6,angle=45)+
   xlab("Nombre de jours d'immersion")+
  ylab("Pourcentage de roche nue sur le récif (%)")+
   theme(axis.text.x = element_text(size=16,color="black"))+
  theme(axis.text.y = element_text(size=16,color="black"))+
  theme(legend.position="none")+
  theme(axis.title.x = element_text(size=16,colour="black",vjust=0))+
  theme(axis.title.y = element_text(size=16,colour="black",vjust=2))
ggsave("GAm recouvrement roche nue.png",width=8,height=8,dpi=350)

```

# # Recouvrement par les espèces
```{r}

data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2,saison,Quad2,Day_delta) %>% 
  mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
  group_by(spp,Site,Micro,Date_courte,Structure2,saison,Years,Day_delta) %>% 
  filter(Site == "VB") %>% 
  # filter(Structure2 == "Disc") %>% 
  # filter(Date_courte == "2021-11") %>%
  distinct() %>% drop_na() %>% 
  summarize(Mcov2 = mean(Mcov,.by=c(spp,Micro,Day_delta,Quad2)))



  # spread(spp,Mcov2) %>% ungroup() %>%
  # mutate(across(everything(.), ~replace_na(., 0)))

  
data_comp3=data_comp2 %>% ungroup %>% 
  select(spp,Site,Structure2,Day_delta,Mcov2) %>% 
      group_by(spp,Site,Structure2,Day_delta) %>%  
  summarize(Mcov3 = mean(Mcov2,.by=c(spp,Structure2))) 

# ggplot(data_comp2,aes(x=Structure2,y=Mcov2,col=spp))+
#   geom_col()
# 
# ggplot(data_comp3,aes(x=Structure2,y=Mcov3,col=spp))+
#   geom_col()

data_comp4=data_comp3 %>% ungroup %>% 
  select(spp,Site,Structure2,Day_delta,Mcov3) %>% 
      group_by(spp,Site,Structure2) %>%  
  summarize(Mcov4 = mean(Mcov3,.by=c(spp,Day_delta)))

 data_comp4=data_comp4 %>% 
   mutate(sd=sqrt(Mcov4))

data_comp5 <- data_comp4[order(data_comp4$Mcov4, decreasing = TRUE), ]#mettre dans l'ordre décroissant

# ggplot(data_comp4,aes(x=spp,y=Mcov3,fill=Structure2))+
#   geom_bar(stat="identity")+
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

# ggplot(data_comp5,aes(x=spp,y=Mcov4,fill=Structure2))+
#   geom_bar(stat="identity")+
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

ggplot(data_comp5,aes(x=reorder(spp,-Mcov4, function(x){sum(x)}),y=Mcov4,fill=Structure2))+
  geom_bar(stat="identity",position=position_dodge())+
  geom_errorbar(aes(ymin=Mcov4-sd, ymax=Mcov4+sd), width=.2, #ajout des barres d'erreur
                 position=position_dodge(.9))+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

# # Test calcul SIMPER
```{r}

#ajoute une colonne de saison 
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"
dataR$saison[dataR$saison == "2021-01" |dataR$saison == "2022-01"] <- "hiver"

dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"336"
dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"339"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"2021-11"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"2021-11"


data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2,saison,Quad2,Day_delta) %>% 
  mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
  group_by(spp,Site,Micro,Date_courte,Structure2,saison,Years,Day_delta) %>% 
  filter(Date_courte %in% c("2021-04","2021-07","2021-11","2022-01","2022-04","2022-11")) %>% #selection des dates ou il y a 4 dates (ou 3 sans fetlar)
  # filter(!Site == "Fe") %>%
  distinct() %>% drop_na() %>% 
  summarize(Mcov2 = mean(Mcov,.by=c(spp,Micro,Day_delta,Quad2))) %>%
  spread(spp,Mcov2) %>% ungroup() %>% 
  mutate(across(everything(.), ~replace_na(., 0))) %>% 
  mutate(Compsite_date=paste(Site,Date_courte,sep=","))

data_comp2$Site<-as.factor(data_comp2$Site)
data_comp2$Micro<-as.factor(data_comp2$Micro)
data_comp2$Date_courte<-as.factor(data_comp2$Date_courte)
data_comp2$Day_delta<-as.factor(data_comp2$Day_delta)
data_comp2$Years<-as.factor(data_comp2$Years)
data_comp2$Compsite_date<-as.factor(data_comp2$Compsite_date)


#test simper
simp<-simper(data_comp2[,-c(1:7,64)],data_comp2$Site,permutations = 999)

``` 

# # Recouvrement par les algues
```{r}
dataR
dataRa=dataR %>% ungroup %>% 
    select(spp,Mcov,Site,Micro,Date_courte,Structure2,saison,Quad2,Day_delta) %>% 
  filter(spp %in% c("Algues brunes autres","Algures brunes Filamenteuse", "Algues calcaires rose","Algues rouge arborescentes","Algues rouges autres","Algues rouges en lames","Algues rouges filamenteuse","Algues vertes")) %>% 
mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
  group_by(spp,Site,Micro,Date_courte,Structure2,saison,Years,Day_delta) %>% 
  distinct() %>% drop_na() %>% 
  summarize(Mcov2 = mean(Mcov,.by=c(spp,Micro,Day_delta,Quad2)))
  
dataRa2=dataRa %>%
  group_by(Site,Structure2,Day_delta,saison) %>%
  summarize(Mcov3 = sum(Mcov2,.by=Structure2))

# dataRa2=dataRa %>%
#   group_by(spp,Site,Structure2,Day_delta,saison) %>%
#   summarize(Mcov3 = sum(Mcov2,.by=Structure2))
 
dataRa$spp<-as.factor(dataRa$spp)
dataRa$Site<-as.factor(dataRa$Site)
dataRa$Structure2<-as.factor(dataRa$Structure2)
dataRa$Day_delta<-as.factor(dataRa$Day_delta)
dataRa$saison<-as.factor(dataRa$saison)

  
dataRa2$spp<-as.factor(dataRa2$spp)
dataRa2$Site<-as.factor(dataRa2$Site)
dataRa2$Structure2<-as.factor(dataRa2$Structure2)
dataRa2$Day_delta<-as.factor(dataRa2$Day_delta)
dataRa2$saison<-as.factor(dataRa2$saison)



model111111<-gam(Mcov2~s(Day_delta)+s(Structure2,bs="re")+s(Site,bs="re")+s(saison,bs="re"),data=dataRa)

model111111<-gam(Mcov3~s(Day_delta)+s(Structure2,bs="re")+s(Site,bs="re")+s(saison,bs="re"),data=dataRa2)

plot_smooths(model=model111111, series=Day_delta,comparison=Site)+theme_bw() #permet de mettre les gam selon les sites

```



# # Test calcul divers

##### Indice de Simpson
```{r}
# Montre la diversité taxonomique, 0 étant la présence d'une espèce et 1 une diversité importante
dataR2=dataR %>% ungroup %>%
  filter(saison == 'été') %>% 
  select(spp,Site) %>% 
  distinct()%>% 
  group_by(spp,Site) %>% 
  summarize(S=n()) %>%
  na.omit()

dataR4<-spread((dataR3=dataR2 %>% 
  group_by(spp,Site) %>%
  summarize(S2 = mean(S))),key=spp,value=S2) 
dataR4[is.na(dataR4)]<-0

simpsonind<-diversity(dataR4[,-1],index="simpson")

```

##### Test différence échantillonage
```{r}

dataR2=dataR %>% ungroup %>%
  select(Site,Day_delta,Structure2) %>% 
  distinct()%>% 
  group_by(Site,Day_delta,Structure2) %>% 
  summarize(S3=sum(n(Site)),.by=Structure2) %>%
  na.omit()


seqdate<-c('153','244','367','428','518','609','732')
Bid<-as.numeric(rep(8,times=7))
Bic<-c(8,7,8,8,8,7,8)
Bip<-rep(3,times=7)
Bis<-c(8,8,8,7,8,8,8)
Birep<-rep("Bi",times=7)
Bidata<-as.data.frame(cbind(Birep,seqdate,Bid,Bic,Bip,Bis))
colnames(Bidata)<-c("Site","Nbjourimmer","Disques","Colonnes","Pilliers","Slots")
Bidata$Nbjourimmer<-as.factor(Bidata$Nbjourimmer)
Bidata$Disques<-as.numeric(Bidata$Disques)
Bidata$Colonnes<-as.numeric(Bidata$Colonnes)
Bidata$Pilliers<-as.numeric(Bidata$Pilliers)
Bidata$Slots<-as.numeric(Bidata$Slots)
Bidata2<-spread(Bidata,key=Birep,value=Bid)
ggplot(Bidata,aes(fill=))

Bud<-c(7,8,8,5,8,"",8)
Buc<-c(8,7,8,8,4,"",8)
Bup<-c(3,3,3,3,3,"",3)
Bus<-c(7,8,8,7,8,"",7)
Burep<-rep("Bu",times=7)
Budata<-cbind(Burep,seqdate,Bud,Buc,Bup,Bus)

Fed<-c(8,"",8,8,8,8,"")
Fec<-c(8,"",5,8,6,8,"")
Fep<-c(3,"",3,3,0,8,"")
Fes<-c(8,"",8,8,8,8,"")
Ferep<-rep("Bu",times=7)
Fedata<-cbind(Ferep,seqdate,Fed,Fec,Fep,Fes)

VBd<-c(8,8,8,8,7,8,8)
VBc<-c(8,8,"",8,7,8,8)
VBp<-c(3,3,"",3,3,3,3)
VBs<-c(6,7,7,8,7,8,8)
VBrep<-rep("VB",times=7)
VBdata<-cbind(VBrep,seqdate,VBd,VBc,VBp,VBs)

datanumber<-as.data.frame(rbind(Bidata,Budata,Fedata,VBdata))
datanumber2<-as.data.frame(cbind(Bidata,Budata,Fedata,VBdata))

colnames(datanumber)<-c("Site","Date","Disques","Colonnes","Pilliers","Slots")
datanumber$Date<-as.factor(datanumber$Date)
datanumber$Site<-as.factor(datanumber$Site)
datanumber$Disques<-as.numeric(datanumber$Disques)
datanumber$Colonnes<-as.numeric(datanumber$Colonnes)
datanumber$Pilliers<-as.numeric(datanumber$Pilliers)
datanumber$Slots<-as.numeric(datanumber$Slots)

plot(datanumber$Date,datanumber$Disques)

ggplot(datanumber, aes(Date,Colonnes, fill=Site))+ # Avec "fill" ou "col" du peut ajout une séparation de tes données par facteur (ici le site)
  xlab("Structure")+
  ylab("Richesse taxonomique")+
  # geom_jitter(alpha=.3)+  # On ajoute les points (pas nécessaire mais utile pour savoir sur quoi se base les boxplots)
  geom_boxplot()+
  theme_bw() 

```


#### Clusterisation

```{r}
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"
dataR$saison[dataR$saison == "2021-01" |dataR$saison == "2022-01"] <- "hiver"

dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"336"
dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"339"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"2021-11"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"2021-11"


data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2,saison,Quad2,Day_delta) %>% 
  mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
  group_by(spp,Site,Micro,Date_courte,Structure2,saison,Years,Day_delta) %>% 
  distinct() %>% drop_na() %>% 
  summarize(Mcov2 = mean(Mcov,.by=c(spp,Micro,Day_delta,Quad2))) %>% 
  ungroup %>% 
  group_by(Site)

data_comp2=data_comp2 %>% 
  select(spp,Date_courte,Structure2,saison,Years,Day_delta,Mcov2) %>% 
  summarize(Mcov3 = mean(Mcov2,.by=c(Site))) %>%
  spread(spp,Mcov3) %>% ungroup() %>% 
  mutate(across(everything(.), ~replace_na(., 0))) %>% 
  mutate(Compsite_date=paste(Site,Date_courte,sep=","))

data_comp2$Site<-as.factor(data_comp2$Site)
data_comp2$Micro<-as.factor(data_comp2$Micro)
data_comp2$Date_courte<-as.factor(data_comp2$Date_courte)
data_comp2$Day_delta<-as.factor(data_comp2$Day_delta)
data_comp2$Years<-as.factor(data_comp2$Years)
data_comp2$Compsite_date<-as.factor(data_comp2$Compsite_date)



Comp_mat=data_comp2 %>% select(-c(Site,Micro,Structure2,Date_courte,saison,Years,Day_delta,Compsite_date)) %>% as.matrix() #sans meta données
Meta_data=data_comp2 %>% select(Site,Micro,Structure2,Date_courte,saison,Years,Day_delta,Compsite_date) #meta données

distdataR<-vegdist(Comp_mat, method='bray') #library vegan - distance de Bray-Curtis, considéré face aux distances euclidiennes comme plus efficace pour les données écologiques


hc<-hclust(dist(Comp_mat),method="ward.D2")
hc<-hclust(dist(data_comp2),method="ward.D2")

plot(hc)
```




dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"
dataR$saison[dataR$saison == "2021-01" |dataR$saison == "2022-01"] <- "hiver"

dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"336"
dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"339"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"2021-11"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"2021-11"


# # Proportion des taxons lors de la période avec la richesse taxo minimale
```{r}
data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2,saison,Quad2,Day_delta) %>% 
  mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
  group_by(spp,Site,Micro,Date_courte,Structure2,saison,Years,Day_delta) %>% 
  # filter(Date_courte %in% c("2021-04","2021-07","2021-11","2022-01","2022-04","2022-11")) %>% #selection des dates ou il y a 4 dates (ou 3 sans fetlar)
  filter(Date_courte %in% c("2022-01")) %>% 
  # filter(!Site == "Fe") %>%
  distinct() %>% drop_na() %>% 
  summarize(Mcov2 = mean(Mcov,.by=c(spp,Micro,Day_delta,Quad2))) 
  
data_comp3=data_comp2 %>% ungroup %>% 
  select(spp,Site,Structure2,Date_courte,Mcov2) %>% 
    group_by(spp,Site,Structure2) %>% 
  summarize(Mcov3=mean(Mcov2,.by=c(spp,Site,Structure2,Date_courte)))
  

# choix des taxons dont le recouvrement est supérieur à 20%
data_comp31 <-(data_comp3[which(data_comp3$Mcov3>20.0),])
data_comp31Bi=data_comp31 %>%  filter(Site == "Bi") %>% summarize(Mcov3=mean(Mcov3,.by=c(spp,Site))) 
  data_comp31Bi$Mcov3<-(data_comp31Bi$Mcov3*100)/sum(data_comp31Bi$Mcov3)
  
data_comp31Bu=data_comp31 %>%  filter(Site == "Bu") %>% summarize(Mcov3=mean(Mcov3,.by=c(spp,Site))) 
  data_comp31Bu$Mcov3<-(data_comp31Bu$Mcov3*100)/sum(data_comp31Bu$Mcov3)
  
data_comp31Fe=data_comp31 %>%  filter(Site == "Fe") %>% summarize(Mcov3=mean(Mcov3,.by=c(spp,Site))) 
  data_comp31Fe$Mcov3<-(data_comp31Fe$Mcov3*100)/sum(data_comp31Fe$Mcov3)
  
data_comp31VB=data_comp31 %>%  filter(Site == "VB") %>% summarize(Mcov3=mean(Mcov3,.by=c(spp,Site))) 
  data_comp31VB$Mcov3<-(data_comp31VB$Mcov3*100)/sum(data_comp31VB$Mcov3)



ggplot(data_comp31Bi,aes(x = 0,y=Mcov3,fill=forcats::fct_inorder(spp)))+
  geom_bar(aes(y=Mcov3),stat="identity",width=1,col="white")+
  scale_alpha(range=c(1,.2))+
  coord_polar("y",start=0)+
  geom_label_repel(aes(label =paste(spp,":",format(Mcov3,digits=1),"%")), position=position_stacknudge(x = .9, y=.2,vjust=.5),size=8,force=25)+
  theme_void()+
  theme(legend.position="none") 
  ggsave("piechartBi.png",width=9,height=8,dpi=350)

  ggplot(data_comp31Bu,aes(x = 0,y=Mcov3,fill=forcats::fct_inorder(spp)))+
  geom_bar(aes(y=Mcov3),stat="identity",width=1,col="white")+
  scale_alpha(range=c(1,.2))+
  coord_polar("y",start=0)+
  geom_label_repel(aes(label =paste(spp,":",format(Mcov3,digits=1),"%")), position=position_stacknudge(x = .9, y=.2,vjust=.5),size=8,force=25)+
  theme_void()+
  theme(legend.position="none") 
  ggsave("piechartBu.png",width=9,height=8,dpi=350)
  
  ggplot(data_comp31Fe,aes(x = 0,y=Mcov3,fill=forcats::fct_inorder(spp)))+
  geom_bar(aes(y=Mcov3),stat="identity",width=1,col="white")+
  scale_alpha(range=c(1,.2))+
  coord_polar("y",start=0)+
  geom_label_repel(aes(label =paste(spp,":",format(Mcov3,digits=1),"%")), position=position_stacknudge(x = .9, y=.2,vjust=.5),size=8,force=25)+
  theme_void()+
  theme(legend.position="none") 
  ggsave("piechartFe.png",width=9,height=8,dpi=350)
  
  ggplot(data_comp31VB,aes(x = 0,y=Mcov3,fill=forcats::fct_inorder(spp)))+
  geom_bar(aes(y=Mcov3),stat="identity",width=1,col="white")+
  scale_alpha(range=c(1,.2))+
  coord_polar("y",start=0)+
  geom_label_repel(aes(label =paste(spp,":",format(Mcov3,digits=1),"%")), position=position_stacknudge(x = .9, y=.2,vjust=.5),size=8,force=25)+
  theme_void()+
  theme(legend.position="none") 
  ggsave("piechartVB.png",width=9,height=8,dpi=350)
  
```
  
  
  

### model null
#### test changement
```{r}
dataR

#moyenne selon les quadrats
dataR2=dataR %>% ungroup %>%
  select(spp,Site,Structure2,Micro,Day_delta,Date_courte,Mcov,Quad2) %>%
  distinct()%>%
  mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
  group_by(Site,Structure2,Day_delta,Years,Mcov,Micro,Quad2) %>%
  # summarize(S=n()) %>%
  na.omit()%>%
  droplevels()

dataR3=dataR2 %>%
  group_by(spp,Site,Structure2,Date_courte,Micro) %>%
  summarize(Mcov2 = mean(Mcov,.by=c(Micro,Date_courte,Quad2)))

#choix de la date
dataR4=dataR3 %>% ungroup() %>% select(spp,Date_courte,Mcov2) %>% filter(Date_courte=="2022-01")

#calcul du minimum et maximum par taxon
dataR5=dataR4 %>% group_by(spp) %>% summarize(min=min(Mcov2,.by=spp)) 
dataR6=dataR4 %>% group_by(spp) %>% summarize(max=max(Mcov2)) 
dataR7<-cbind(dataR5,dataR6[,-1])

dataR7$min<-as.numeric(dataR7$min)
dataR7$max<-as.numeric(dataR7$max)

#permet de créer une valeur random par ligne en fonction du min et max #nb dans runif à changer
dataR7$random_value<-mapply(function(min, max) runif(nrow(dataR7), min=dataR7$min, max=dataR7$max),dataR7$min,dataR7$max)

#prendre que les données de random
rv<-as.data.frame(dataR7$random_value)

#joindre les données des spp et des random
dataR8<-cbind(dataR7[,c(1:3)],rv)
# colnames(dataR8)[4:ncol(dataR8)]<-c(1:(ncol(dataR8)-3))
colnames(dataR8)[4:ncol(dataR8)]<-paste("inv", 1:(ncol(dataR8)-3))

#boucle pour ajouter n nombre de 0 par inventaire
n<-10
for (i in 4:ncol(dataR8)){
  dataR8[,i][sample(nrow(dataR8),n)]<-0
}


#colonnes à la place des lignes et inversement
dataR9<-as.data.frame(t(dataR8))
colnames(dataR9)<-dataR8$spp
dataR9$inv<-rownames(dataR9)
dataR9<-dataR9[-1,]


#proportion par rapport à 100%
dataR10<-dataR9
dataR10bis<-dataR9$inv
dataR10<-as.data.frame(lapply(dataR10[,-(ncol(dataR10))],as.numeric))

dataR21=matrix()
for (col in 1:ncol(dataR10)) {
  dataR10[[col]] <- (dataR10[[col]]  * 100)/sum(dataR10[[col]]) 
  }


#Calcul de la nestedness, diversité et turnover
dataR11<-cbind(as.factor(dataR10bis),dataR10)
colnames(dataR11)[1]<-"inventaire"
databetadiv2<-beta.div.comp(dataR11[-c(1:2),-1],coef="S")


# Extraction des matrices
mat.D=as.matrix(databetadiv2$D)
mat.D[upper.tri(mat.D)]<-NA
diag(mat.D)<-NA
rownames(mat.D)<-dataR11$inventaire[-c(1:2)] #change le nom des lignes avec les metadonnées
colnames(mat.D)<-dataR11$inventaire[-c(1:2)] #change le nom des colonnes avec les metadonnées
 
mat.repl=as.matrix(databetadiv2$repl)
mat.repl[upper.tri(mat.repl)]<-NA
diag(mat.repl)<-NA
rownames(mat.repl)<-dataR11$inventaire[-c(1:2)] #change le nom des lignes avec les metadonnées
colnames(mat.repl)<-dataR11$inventaire[-c(1:2)] #change le nom des colonnes avec les metadonnées
 
mat.rich=as.matrix(databetadiv2$rich)
mat.rich[upper.tri(mat.rich)]<-NA
diag(mat.rich)<-NA
rownames(mat.rich)<-dataR11$inventaire[-c(1:2)] #change le nom des lignes avec les metadonnées
colnames(mat.rich)<-dataR11$inventaire[-c(1:2)]#change le nom des colonnes avec les metadonnées
 

# Transformation des matrices en df
test.mat.D=na.omit(reshape2::melt(mat.D)) 
test.mat.D2 <- test.mat.D %>%
  mutate(compainv= paste(Var1,Var2,sep="_"))


test.mat.repl=na.omit(reshape2::melt(mat.repl)) %>% mutate(Type='repl')
test.mat.repl2 <- test.mat.repl %>%
   mutate(compainv= paste(Var1,Var2,sep="_"))


test.mat.rich=na.omit(reshape2::melt(mat.rich)) %>% mutate(Type='rich')
test.mat.rich2 <- test.mat.rich %>%
    mutate(compainv= paste(Var1,Var2,sep="_"))


#Création jeu de données rassemblant les différentes données
datadissi<-test.mat.D2 
datarepl<-test.mat.repl2 
datarich<-test.mat.rich2

datatern<-cbind(datadissi[,c(1:2,3)],Similarité=(1-datadissi[,3])*100,Remplacement=100*datarepl[,3],Richesse=100*datarich[,3])

```


#### réattribution des valeurs
```{r}
##### changement des valeurs du jeu de données de base
dataR$saison<-dataR$Date_courte
dataR$saison[dataR$saison == "2021-04" | dataR$saison == "2022-04"] <- "printemps"
dataR$saison[dataR$saison == "2021-07" | dataR$saison == "2022-07"] <- "été"
dataR$saison[dataR$saison == "2021-10" | dataR$saison == "2021-11"| dataR$saison == "2022-11"] <- "automne"
dataR$saison[dataR$saison == "2022-01"] <- "hiver"
dataR$saison[dataR$saison == "2021-01" |dataR$saison == "2022-01"] <- "hiver"

dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"336"
dataR$Day_delta[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"339"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "Fe"]<-"2021-11"
dataR$Date_courte[dataR$Date_courte == "2021-10" & dataR$Site == "VB"]<-"2021-11"


data_comp2=dataR %>% ungroup %>% 
  select(spp,Mcov,Site,Micro,Date_courte,Structure2,saison,Quad2,Day_delta) %>% 
  mutate(Years=substr(Date_courte, start = 1, stop = 4)) %>%
  group_by(spp,Site,Micro,Date_courte,Structure2,saison,Years,Day_delta) %>% 
  filter(Date_courte %in% c("2022-01")) %>% 
  distinct() %>% drop_na() %>% 
  summarize(Mcov2 = mean(Mcov,.by=c(spp,Micro,Day_delta,Quad2))) %>%
  spread(spp,Mcov2) %>% ungroup() %>% 
  mutate(across(everything(.), ~replace_na(., 0))) %>% 
  mutate(Compsite_date=paste(Site,Date_courte,sep=",")) %>% 
  mutate(Name=paste(Site,Structure2,Date_courte,saison,sep=","))


data_comp2$Site<-as.factor(data_comp2$Site)
data_comp2$Micro<-as.factor(data_comp2$Micro)
data_comp2$Date_courte<-as.factor(data_comp2$Date_courte)
data_comp2$Day_delta<-as.factor(data_comp2$Day_delta)


# réattribution aléatoire des valeurs du dataframe
data_comp3<-data_comp2[,c(8:37)]
data_comp3bis<-data_comp2[,c(1:7,38:39)]
for (i in 1:nrow(data_comp3)) {
  data1<- as.data.frame(sample(data_comp3[i,]))
  colnames(data1)[1:ncol(data1)]<-seq(1:ncol(data1))
  data_comp3[i, ]<-data1
}

data_comp4<-cbind(data_comp3bis,data_comp3)

databetadiv2<-beta.div.comp(data_comp4[,-c(1:9)],coef="S")


# Extraction des matrices
mat.D=as.matrix(databetadiv2$D)
mat.D[upper.tri(mat.D)]<-NA
diag(mat.D)<-NA
rownames(mat.D)<-data_comp2$Name #change le nom des lignes avec les metadonnées
colnames(mat.D)<-data_comp2$Name #change le nom des colonnes avec les metadonnées
 
mat.repl=as.matrix(databetadiv2$repl)
mat.repl[upper.tri(mat.repl)]<-NA
diag(mat.repl)<-NA
rownames(mat.repl)<-data_comp2$Name #change le nom des lignes avec les metadonnées
colnames(mat.repl)<-data_comp2$Name #change le nom des colonnes avec les metadonnées
 
mat.rich=as.matrix(databetadiv2$rich)
mat.rich[upper.tri(mat.rich)]<-NA
diag(mat.rich)<-NA
rownames(mat.rich)<-data_comp2$Name #change le nom des lignes avec les metadonnées
colnames(mat.rich)<-data_comp2$Name #change le nom des colonnes avec les metadonnées
 

# Transformation des matrices en df
test.mat.D=na.omit(reshape2::melt(mat.D)) %>% mutate(Type='D') 
test.mat.D2 <- test.mat.D %>%
  mutate(row_id = row_number()) %>%  # Créer une colonne pour identifier chaque ligne
  separate(Var1, into = paste0("Var1", 1:4), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 1 
  separate(Var2, into = paste0("Var2", 1:4), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 2
  select(-row_id)  # Supprimer la colonne d'identification
colnames(test.mat.D2)<-c("Site1","Structure1","Date1","Saison1","Site2","Structure2","Date2","Saison2","Dissimilarité","type")


test.mat.repl=na.omit(reshape2::melt(mat.repl)) %>% mutate(Type='repl')
test.mat.repl2 <- test.mat.repl %>%
  mutate(row_id = row_number()) %>%  # Créer une colonne pour identifier chaque ligne
  separate(Var1, into = paste0("Var1", 1:4), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 1 
  separate(Var2, into = paste0("Var2", 1:4), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 2
  select(-row_id)  # Supprimer la colonne d'identification
colnames(test.mat.repl2)<-c("Site1","Structure1","Date1","Saison1","Site2","Structure2","Date2","Saison2","Dissimilarité","type")


test.mat.rich=na.omit(reshape2::melt(mat.rich)) %>% mutate(Type='rich')
test.mat.rich2 <- test.mat.rich %>%
  mutate(row_id = row_number()) %>%  # Créer une colonne pour identifier chaque ligne
  separate(Var1, into = paste0("Var1", 1:4), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 1 
  separate(Var2, into = paste0("Var2", 1:4), sep = ",", extra = "drop") %>% #utilise les meta données de la colonne var 2
  select(-row_id)  # Supprimer la colonne d'identification
colnames(test.mat.rich2)<-c("Site1","Structure1","Date1","Saison1","Site2","Structure2","Date2","Saison2","Dissimilarité","type")



#Création jeu de données rassemblant les différentes données
datadissi<-test.mat.D2 %>% select(Site1,Structure1,Date1,Saison1,Site2,Structure2,Date2,Saison2,Dissimilarité) 
datarepl<-test.mat.repl2 %>% select(Site1,Structure1,Date1,Saison1,Site2,Structure2,Date2,Saison2,Dissimilarité) 
datarich<-test.mat.rich2 %>% select(Site1,Structure1,Date1,Saison1,Site2,Structure2,Date2,Saison2,Dissimilarité)

datatern<-cbind(datadissi[,-c(9)],Similarité=(1-datadissi[,9])*100,Remplacement=100*datarepl[,9],Richesse=100*datarich[,9])



####
datatern2=datatern %>%
  # filter(Structure1 == 'Disc') %>%
  # filter(Structure1 %in% c('Disc','Inner_slots')) %>%
  # filter(Structure2 %in% c('Disc','Inner_slots')) %>%
  # filter(Structure2%in% c('Disc')) %>%
  # filter(Structure1 %in% c('Inner_slots')) %>%
  # filter(Site1 == 'Fe') %>%
  # filter(Site2 == 'Fe') %>%
  # filter(Site1 != Site2) %>%
  # filter(Site1 == Site2) %>%
  filter(Saison1 == Saison2) %>%
  # filter(Structure1!=Structure2) %>%
  # filter(Structure1 == Structure2) %>%
  # filter(Date1!=Date2) %>%
  # filter(Date1==Date2) %>%
  # filter(Date1 == '2022-01') %>%
  # filter(Date2 == '2022-01') %>%
  mutate(Comp_site=Site1,Comp_struct=Structure1,Comp_date=Date1)


datatern2=datatern2 %>% 
 mutate(Compasite<-paste(Site1,Site2,sep="/")) %>% 
  mutate(Compastruct<-paste(Structure1,Structure2,sep="/")) %>% 
  mutate(Compadate<-paste(Date1,Date2,sep="/")) %>% 
  mutate(Compasaison<-paste(Saison1,Saison2,sep="/")) %>% 
  mutate(Compasite_date<-paste(Site1,Date1,sep="/"))
colnames(datatern2)[15]<-"Compasite"
colnames(datatern2)[16]<-"Compastruct"
colnames(datatern2)[17]<-"Compadate"
colnames(datatern2)[18]<-"Compasaison"
colnames(datatern2)[19]<-"Compasitedate"



#pour pouvoir mettre mettre les données de structure et date ensemble
# datatern2=datatern2 %>% mutate(Compasitedate=paste(Comp_struct,Compadate))
datatern2=datatern2 %>% mutate(Compasite_struct=paste(Compasite,Structure1))
datatern2=datatern2 %>% mutate(Years=substr(Date1, start = 1, stop = 4))
datatern2=datatern2 %>% mutate(Site_Years=paste(Compasite,Years))
datatern2=datatern2 %>% mutate(Compastruct_date=paste(Compadate,Compastruct))
datatern2=datatern2 %>% mutate(Compastruct_site_date=paste(Compasitedate,Compastruct))
datatern2=datatern2 %>% mutate(Compasite_date=paste(Compasite,Date1))

datamean<-datatern2 %>%  group_by(Compasite,Compastruct,Comp_date,Compasaison) %>% 
  dplyr::summarize(Similarité=mean(Similarité),
            Remplacement=mean(Remplacement),
            Richesse=mean(Richesse))


datameansimi=datamean %>% select(Compasite,Compastruct,Comp_date,Compasaison,Similarité) %>% 
  mutate(Betaindex= "Similarité") %>% select(Betaindex,Compasite,Compastruct,Comp_date,Compasaison,Similarité)
colnames(datameansimi)[6]<-"BIvalue"

datameanremp=datamean %>% select(Compasite,Compastruct,Comp_date,Compasaison,Remplacement) %>% 
  mutate(Betaindex= "Remplacement") %>% select(Betaindex,Compasite,Compastruct,Comp_date,Compasaison,Remplacement)
colnames(datameanremp)[6]<-"BIvalue"

datameanrich=datamean %>% select(Compasite,Compastruct,Comp_date,Compasaison,Richesse)  %>% 
  mutate(Betaindex= "Richesse") %>% select(Betaindex,Compasite,Compastruct,Comp_date,Compasaison,Richesse)
colnames(datameanrich)[6]<-"BIvalue"

databetaindex <- rbind(datameansimi,datameanremp,datameanrich)

databetaindex$BIvalue<-as.numeric(databetaindex$BIvalue)
databetaindex$Betaindex<-as.factor(databetaindex$Betaindex)
databetaindex$Compastruct<-as.factor(databetaindex$Compastruct)
databetaindex$Compasite<-as.factor(databetaindex$Compasite)
databetaindex$Comp_date<-as.factor(databetaindex$Comp_date)
databetaindex$Compasaison<-as.factor(databetaindex$Compasaison)
# databetaindex$Comp_day<-as.numeric(databetaindex$Comp_day)

  
##### Test comparaison interstructures et intersite avec binaire #####

# Data similarité
datameansimi$Compa<-rep(0)

# site
datameansimi$Compa[datameansimi$Compasite == "Bu/Bi"| datameansimi$Compasite == "Fe/Bi"| datameansimi$Compasite == "Fe/Bu"| datameansimi$Compasite == "VB/Bi" | datameansimi$Compasite == "VB/Bu" | datameansimi$Compasite == "VB/Fe" | datameansimi$Compasite == "recif1/Bi"| datameansimi$Compasite == "recif1/Bu" | datameansimi$Compasite == "recif1/Fe" | datameansimi$Compasite == "recif1/Bi" | datameansimi$Compasite == "recif2/Bu" | datameansimi$Compasite == "recif2/Bi" | datameansimi$Compasite == "recif2/Fe" | datameansimi$Compasite == "recif3/Bi" | datameansimi$Compasite == "recif3/Bu" | datameansimi$Compasite == "recif3/Fe" | datameansimi$Compasite == "Bi/recif1" | datameansimi$Compasite == "Bi/recif2" | datameansimi$Compasite == "Bi/recif3" | datameansimi$Compasite == "Bu/recif1" | datameansimi$Compasite == "Bu/recif2" | datameansimi$Compasite == "Bu/recif3" | datameansimi$Compasite == "Fe/recif1" | datameansimi$Compasite == "Fe/recif2" | datameansimi$Compasite == "Fe/recif3" | datameansimi$Compasite == "VB/recif1" | datameansimi$Compasite == "VB/recif2" | datameansimi$Compasite == "VB/recif3"   | datameansimi$Compasite == "VB/recif3" | datameansimi$Compasite == "VB/recif3" | datameansimi$Compasite == "recif2/recif1"| datameansimi$Compasite == "recif3/recif2"| datameansimi$Compasite == "recif3/recif1"]<-"Intersite"

datameansimi$Compa[datameansimi$Compasite == "Bi/Bi"| datameansimi$Compasite == "Bu/Bu"| datameansimi$Compasite == "Fe/Fe"| datameansimi$Compasite == "VB/VB"|datameansimi$Compasite == "recif1/recif1"|datameansimi$Compasite == "recif2/recif2"|datameansimi$Compasite == "recif3/recif3"] <- "Intra"


datameansimi$Compa[datameansimi$Compa == "Intersite" & datameansimi$Compastruct == "Columns/Columns" |datameansimi$Compa == "Intersite" & datameansimi$Compastruct == "Disc/Disc" |datameansimi$Compa == "Intersite" & datameansimi$Compastruct == "Pillars/Pillars" |datameansimi$Compa == "Intersite" & datameansimi$Compastruct == "Inner_slots/Inner_slots"]<-"Intersite 2"


# structure
datameansimi$Compa[datameansimi$Compastruct == "Columns/Disc" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Columns/Inner_slots" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Disc/Columns" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Disc/Inner_slots" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Disc/Pillars" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Inner_slots/Columns" & datameansimi$Compa =="Intra" | datameansimi$Compastruct == "Inner_slots/Disc" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Inner_slots/Pillars"  & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Pillars/Columns" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Pillars/Disc" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Pillars/Inner_slots"  & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Columns/Pillars" & datameansimi$Compa =="Intra"] <- "Interstruct"


datameansimi$Compa[datameansimi$Compastruct == "Disc/Disc" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Inner_slots/Inner_slots" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Columns/Columns" & datameansimi$Compa =="Intra"| datameansimi$Compastruct == "Pillars/Pillars" & datameansimi$Compa =="Intra"] <- "Intrastruct"

# baie
datameansimi$Compa[datameansimi$Compasite == "Bi/recif1" | datameansimi$Compasite == "Bi/recif2" | datameansimi$Compasite == "Bi/recif3" | datameansimi$Compasite == "Bu/recif1" | datameansimi$Compasite == "Bu/recif2" | datameansimi$Compasite == "Bu/recif3" | datameansimi$Compasite == "Fe/recif1" | datameansimi$Compasite == "Fe/recif2" | datameansimi$Compasite == "Fe/recif3" | datameansimi$Compasite == "VB/recif1" | datameansimi$Compasite == "VB/recif2" | datameansimi$Compasite == "VB/recif3"   | datameansimi$Compasite == "VB/recif3" | datameansimi$Compasite == "VB/recif3"| datameansimi$Compasite == "recif1/Bu" | datameansimi$Compasite == "recif1/Fe" | datameansimi$Compasite == "recif1/Bi" | datameansimi$Compasite == "recif2/Bu" | datameansimi$Compasite == "recif2/Bi" | datameansimi$Compasite == "recif2/Fe" | datameansimi$Compasite == "recif3/Bi" | datameansimi$Compasite == "recif3/Bu" | datameansimi$Compasite == "recif3/Fe"]<-"Interbaie"

datameansimi$Compa[datameansimi$Compa=="Interbaie" & datameansimi$Compastruct == "Columns/Columns" | datameansimi$Compa=="Interbaie" & datameansimi$Compastruct == "Disc/Disc" | datameansimi$Compa=="Interbaie" & datameansimi$Compastruct == "Pillars/Pillars"| datameansimi$Compa=="Interbaie" & datameansimi$Compastruct == "Inner_slots/Inner_slots"]<-"Interbaie 2"

datameansimi = datameansimi %>% filter(!Compa == "Intersite") %>% filter(!Compa == "Interbaie")

# datameansimi$a<-rep(0)
# datameansimi$a[datameansimi$Compasite=="recif1/recif2"| datameansimi$Compasite=="recif1/recif3"  | datameansimi$Compasite=="recif2/recif3" | datameansimi$Compasite=="recif3/recif2"| datameansimi$Compasite=="recif3/recif1"| datameansimi$Compasite=="recif2/recif1"]<-"ab"

# datameansimi$Compasite2<-datameansimi$Compasite
# datameansimi$Compasite2[datameansimi$Compasite=="recif1/recif2"| datameansimi$Compasite=="recif1/recif3"  | datameansimi$Compasite=="recif2/recif3" | datameansimi$Compasite=="recif3/recif2"| datameansimi$Compasite=="recif3/recif1"| datameansimi$Compasite=="recif2/recif1"]<-"goelo"


# datameansimi2<-aggregate(BIvalue~Betaindex+Compastruct+Comp_date+Compasaison+Compa+Compasite2,data=datameansimi[datameansimi$Compasite2=="goelo",],FUN=mean)
# datameansimi3<-aggregate(BIvalue~Betaindex+Compastruct+Comp_date+Compasaison+Compa+Compasite2,data=datameansimi[datameansimi$Compasite2!="goelo",],FUN=mean)
# 
# datameansimi4<-rbind(datameansimi2,datameansimi3)



# Data remplacement
datameanremp$Compa<-rep(0)
# site
datameanremp$Compa[datameanremp$Compasite == "Bu/Bi"| datameanremp$Compasite == "Fe/Bi"| datameanremp$Compasite == "Fe/Bu"| datameanremp$Compasite == "VB/Bi" | datameanremp$Compasite == "VB/Bu" | datameanremp$Compasite == "VB/Fe" | datameanremp$Compasite == "recif1/Bi"| datameanremp$Compasite == "recif1/Bu" | datameanremp$Compasite == "recif1/Fe" | datameanremp$Compasite == "recif1/Bi" | datameanremp$Compasite == "recif2/Bu" | datameanremp$Compasite == "recif2/Bi" | datameanremp$Compasite == "recif2/Fe" | datameanremp$Compasite == "recif3/Bi" | datameanremp$Compasite == "recif3/Bu" | datameanremp$Compasite == "recif3/Fe" | datameanremp$Compasite == "Bi/recif1" | datameanremp$Compasite == "Bi/recif2" | datameanremp$Compasite == "Bi/recif3" | datameanremp$Compasite == "Bu/recif1" | datameanremp$Compasite == "Bu/recif2" | datameanremp$Compasite == "Bu/recif3" | datameanremp$Compasite == "Fe/recif1" | datameanremp$Compasite == "Fe/recif2" | datameanremp$Compasite == "Fe/recif3" | datameanremp$Compasite == "VB/recif1" | datameanremp$Compasite == "VB/recif2" | datameanremp$Compasite == "VB/recif3"   | datameanremp$Compasite == "VB/recif3" | datameanremp$Compasite == "VB/recif3" | datameanremp$Compasite == "recif2/recif1"| datameanremp$Compasite == "recif3/recif2"| datameanremp$Compasite == "recif3/recif1"]<-"Intersite"

datameanremp$Compa[datameanremp$Compasite == "Bi/Bi"| datameanremp$Compasite == "Bu/Bu"| datameanremp$Compasite == "Fe/Fe"| datameanremp$Compasite == "VB/VB"|datameanremp$Compasite == "recif1/recif1"|datameanremp$Compasite == "recif2/recif2"|datameanremp$Compasite == "recif3/recif3"] <- "Intra"


datameanremp$Compa[datameanremp$Compa == "Intersite" & datameanremp$Compastruct == "Columns/Columns" |datameanremp$Compa == "Intersite" & datameanremp$Compastruct == "Disc/Disc" |datameanremp$Compa == "Intersite" & datameanremp$Compastruct == "Pillars/Pillars" |datameanremp$Compa == "Intersite" & datameanremp$Compastruct == "Inner_slots/Inner_slots"]<-"Intersite 2"


# structure
datameanremp$Compa[datameanremp$Compastruct == "Columns/Disc" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Columns/Inner_slots" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Disc/Columns" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Disc/Inner_slots" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Disc/Pillars" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Inner_slots/Columns" & datameanremp$Compa =="Intra" | datameanremp$Compastruct == "Inner_slots/Disc" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Inner_slots/Pillars"  & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Pillars/Columns" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Pillars/Disc" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Pillars/Inner_slots"  & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Columns/Pillars" & datameanremp$Compa =="Intra"] <- "Interstruct"


datameanremp$Compa[datameanremp$Compastruct == "Disc/Disc" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Inner_slots/Inner_slots" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Columns/Columns" & datameanremp$Compa =="Intra"| datameanremp$Compastruct == "Pillars/Pillars" & datameanremp$Compa =="Intra"] <- "Intrastruct"

# baie
datameanremp$Compa[datameanremp$Compasite == "Bi/recif1" | datameanremp$Compasite == "Bi/recif2" | datameanremp$Compasite == "Bi/recif3" | datameanremp$Compasite == "Bu/recif1" | datameanremp$Compasite == "Bu/recif2" | datameanremp$Compasite == "Bu/recif3" | datameanremp$Compasite == "Fe/recif1" | datameanremp$Compasite == "Fe/recif2" | datameanremp$Compasite == "Fe/recif3" | datameanremp$Compasite == "VB/recif1" | datameanremp$Compasite == "VB/recif2" | datameanremp$Compasite == "VB/recif3"   | datameanremp$Compasite == "VB/recif3" | datameanremp$Compasite == "VB/recif3"| datameanremp$Compasite == "recif1/Bu" | datameanremp$Compasite == "recif1/Fe" | datameanremp$Compasite == "recif1/Bi" | datameanremp$Compasite == "recif2/Bu" | datameanremp$Compasite == "recif2/Bi" | datameanremp$Compasite == "recif2/Fe" | datameanremp$Compasite == "recif3/Bi" | datameanremp$Compasite == "recif3/Bu" | datameanremp$Compasite == "recif3/Fe"]<-"Interbaie"

datameanremp$Compa[datameanremp$Compa=="Interbaie" & datameanremp$Compastruct == "Columns/Columns" | datameanremp$Compa=="Interbaie" & datameanremp$Compastruct == "Disc/Disc" | datameanremp$Compa=="Interbaie" & datameanremp$Compastruct == "Pillars/Pillars"| datameanremp$Compa=="Interbaie" & datameanremp$Compastruct == "Inner_slots/Inner_slots"]<-"Interbaie 2"


datameanremp = datameanremp %>% filter(!Compa == "Intersite") %>% filter(!Compa == "Interbaie")


# datameanremp$Compasite2<-datameanremp$Compasite
# datameanremp$Compasite2[datameanremp$Compasite=="recif1/recif2"| datameanremp$Compasite=="recif1/recif3"  | datameanremp$Compasite=="recif2/recif3" | datameanremp$Compasite=="recif3/recif2"| datameanremp$Compasite=="recif3/recif1"| datameanremp$Compasite=="recif2/recif1"]<-"goelo"

# datameanremp2<-aggregate(BIvalue~Betaindex+Compastruct+Comp_date+Compasaison+Compa+Compasite2,data=datameanremp[datameanremp$Compasite2=="goelo",],FUN=mean)
# datameanremp3<-aggregate(BIvalue~Betaindex+Compastruct+Comp_date+Compasaison+Compa+Compasite2,data=datameanremp[datameanremp$Compasite2!="goelo",],FUN=mean)
# 
# datameanremp4<-rbind(datameanremp2,datameanremp3)




# Date Richesse
datameanrich$Compa<-rep(0)

#Site
datameanrich$Compa[datameanrich$Compasite == "Bu/Bi"| datameanrich$Compasite == "Fe/Bi"| datameanrich$Compasite == "Fe/Bu"| datameanrich$Compasite == "VB/Bi" | datameanrich$Compasite == "VB/Bu" | datameanrich$Compasite == "VB/Fe" | datameanrich$Compasite == "recif1/Bi"| datameanrich$Compasite == "recif1/Bu" | datameanrich$Compasite == "recif1/Fe" | datameanrich$Compasite == "recif1/Bi" | datameanrich$Compasite == "recif2/Bu" | datameanrich$Compasite == "recif2/Bi" | datameanrich$Compasite == "recif2/Fe" | datameanrich$Compasite == "recif3/Bi" | datameanrich$Compasite == "recif3/Bu" | datameanrich$Compasite == "recif3/Fe" | datameanrich$Compasite == "Bi/recif1" | datameanrich$Compasite == "Bi/recif2" | datameanrich$Compasite == "Bi/recif3" | datameanrich$Compasite == "Bu/recif1" | datameanrich$Compasite == "Bu/recif2" | datameanrich$Compasite == "Bu/recif3" | datameanrich$Compasite == "Fe/recif1" | datameanrich$Compasite == "Fe/recif2" | datameanrich$Compasite == "Fe/recif3" | datameanrich$Compasite == "VB/recif1" | datameanrich$Compasite == "VB/recif2" | datameanrich$Compasite == "VB/recif3"   | datameanrich$Compasite == "VB/recif3" | datameanrich$Compasite == "VB/recif3" | datameanrich$Compasite == "recif2/recif1"| datameanrich$Compasite == "recif3/recif2"| datameanrich$Compasite == "recif3/recif1"]<-"Intersite"

datameanrich$Compa[datameanrich$Compasite == "Bi/Bi"| datameanrich$Compasite == "Bu/Bu"| datameanrich$Compasite == "Fe/Fe"| datameanrich$Compasite == "VB/VB"|datameanrich$Compasite == "recif1/recif1"|datameanrich$Compasite == "recif2/recif2"|datameanrich$Compasite == "recif3/recif3"] <- "Intra"


datameanrich$Compa[datameanrich$Compa == "Intersite" & datameanrich$Compastruct == "Columns/Columns" |datameanrich$Compa == "Intersite" & datameanrich$Compastruct == "Disc/Disc" |datameanrich$Compa == "Intersite" & datameanrich$Compastruct == "Pillars/Pillars" |datameanrich$Compa == "Intersite" & datameanrich$Compastruct == "Inner_slots/Inner_slots"]<-"Intersite 2"


# structure
datameanrich$Compa[datameanrich$Compastruct == "Columns/Disc" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Columns/Inner_slots" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Disc/Columns" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Disc/Inner_slots" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Disc/Pillars" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Inner_slots/Columns" & datameanrich$Compa =="Intra" | datameanrich$Compastruct == "Inner_slots/Disc" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Inner_slots/Pillars"  & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Pillars/Columns" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Pillars/Disc" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Pillars/Inner_slots"  & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Columns/Pillars" & datameanrich$Compa =="Intra"] <- "Interstruct"


datameanrich$Compa[datameanrich$Compastruct == "Disc/Disc" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Inner_slots/Inner_slots" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Columns/Columns" & datameanrich$Compa =="Intra"| datameanrich$Compastruct == "Pillars/Pillars" & datameanrich$Compa =="Intra"] <- "Intrastruct"

# baie
datameanrich$Compa[datameanrich$Compasite == "Bi/recif1" | datameanrich$Compasite == "Bi/recif2" | datameanrich$Compasite == "Bi/recif3" | datameanrich$Compasite == "Bu/recif1" | datameanrich$Compasite == "Bu/recif2" | datameanrich$Compasite == "Bu/recif3" | datameanrich$Compasite == "Fe/recif1" | datameanrich$Compasite == "Fe/recif2" | datameanrich$Compasite == "Fe/recif3" | datameanrich$Compasite == "VB/recif1" | datameanrich$Compasite == "VB/recif2" | datameanrich$Compasite == "VB/recif3"   | datameanrich$Compasite == "VB/recif3" | datameanrich$Compasite == "VB/recif3"| datameanrich$Compasite == "recif1/Bu" | datameanrich$Compasite == "recif1/Fe" | datameanrich$Compasite == "recif1/Bi" | datameanrich$Compasite == "recif2/Bu" | datameanrich$Compasite == "recif2/Bi" | datameanrich$Compasite == "recif2/Fe" | datameanrich$Compasite == "recif3/Bi" | datameanrich$Compasite == "recif3/Bu" | datameanrich$Compasite == "recif3/Fe"]<-"Interbaie"

datameanrich$Compa[datameanrich$Compa=="Interbaie" & datameanrich$Compastruct == "Columns/Columns" | datameanrich$Compa=="Interbaie" & datameanrich$Compastruct == "Disc/Disc" | datameanrich$Compa=="Interbaie" & datameanrich$Compastruct == "Pillars/Pillars"| datameanrich$Compa=="Interbaie" & datameanrich$Compastruct == "Inner_slots/Inner_slots"]<-"Interbaie 2"


datameanrich = datameanrich %>% filter(!Compa == "Intersite") %>% filter(!Compa == "Interbaie")


# datameanrich$Compasite2<-datameanrich$Compasite
# datameanrich$Compasite2[datameanrich$Compasite=="recif1/recif2"| datameanrich$Compasite=="recif1/recif3"  | datameanrich$Compasite=="recif2/recif3" | datameanrich$Compasite=="recif3/recif2"| datameanrich$Compasite=="recif3/recif1"| datameanrich$Compasite=="recif2/recif1"]<-"goelo"
# 
# 
# datameanrich2<-aggregate(BIvalue~Betaindex+Compastruct+Comp_date+Compasaison+Compa+Compasite2,data=datameanrich[datameanrich$Compasite2=="goelo",],FUN=mean)
# datameanrich3<-aggregate(BIvalue~Betaindex+Compastruct+Comp_date+Compasaison+Compa+Compasite2,data=datameanrich[datameanrich$Compasite2!="goelo",],FUN=mean)
# 
# datameanrich4<-rbind(datameanrich2,datameanrich3)




### regroupement des jeux de données
# databetaindex2 <- cbind(datameansimi[,-1],datameanremp[,-c(1:5,7)],datameanrich[,-c(1:5,7)])
databetaindex2 <- cbind(datameansimi[,-1],datameanremp[,-c(1:5,7)],datameanrich[,-c(1:5,7)])
databetaindex2<-databetaindex2[,c(1:3,4,6,7,5,8)]
colnames(databetaindex2)[6:8]<-c("Similarité","Remplacement","Richesse")


# databetaindex2$Compasite<-as.factor(databetaindex2$Compasite)
databetaindex2$Compasite2<-as.factor(databetaindex2$Compasite2)
databetaindex2$Compastruct<-as.factor(databetaindex2$Compastruct)
databetaindex2$Comp_date<-as.factor(databetaindex2$Comp_date)
databetaindex2$Compa<-as.factor(databetaindex2$Compa)
databetaindex2$Compasaison<-as.factor(databetaindex2$Compasaison)


compar<-list(c("Interstruct","Intrastruct"),c("Interstruct","Intersite 2"),c("Intrastruct","Intersite 2"))

ggplot(datameansimi, aes(x=Compa, y=BIvalue))+
  geom_violin(aes(fct_reorder(Compa,-BIvalue),fill=Compa),trim=FALSE)+
  geom_boxplot(width=0.2,aes(fill=Compa))+
  # scale_color_manual(values = c("gray77", "gray63", "gray40","gray8"))+
  theme_bw()+
  xlab("Echelle")+ ylab("Similarité")+
  theme(legend.position="none")+
  geom_signif(comparisons=compar,map_signif_level = TRUE,step_increase = 0.05,color="black",text_size=5)+
  theme(axis.text.x = element_text(size=16,colour="black"))+
  theme(axis.text.y = element_text(size=16,colour="black"))

ggplot(datameanremp, aes(x=Compa, y=BIvalue))+
  geom_violin(aes(fct_reorder(Compa,-BIvalue),fill=Compa),trim=FALSE)+
  geom_boxplot(width=0.2,aes(fill=Compa))+
  # scale_color_manual(values = c("gray77", "gray63", "gray40","gray8"))+
  theme_bw()+
  xlab("Echelle")+ ylab("Similarité")+
  theme(legend.position="none")+
  geom_signif(comparisons=compar,map_signif_level = TRUE,step_increase = 0.05,color="black",text_size=5)+
  theme(axis.text.x = element_text(size=16,colour="black"))+
  theme(axis.text.y = element_text(size=16,colour="black"))

ggplot(datameanrich, aes(x=Compa, y=BIvalue))+
  geom_violin(aes(fct_reorder(Compa,-BIvalue),fill=Compa),trim=FALSE)+
  geom_boxplot(width=0.2,aes(fill=Compa))+
  # scale_color_manual(values = c("gray77", "gray63", "gray40","gray8"))+
  theme_bw()+
  xlab("Echelle")+ ylab("Similarité")+
  theme(legend.position="none")+
  geom_signif(comparisons=compar,map_signif_level = TRUE,step_increase = 0.05,color="black",text_size=5)+
  theme(axis.text.x = element_text(size=16,colour="black"))+
  theme(axis.text.y = element_text(size=16,colour="black"))

```




# #nombre taxon totaux
```{r}
Site<-c("Bi","Bu","Fe","VB","Total Marineff","recif1","recif2","recif3","Total Goëlo")
D2021<-c(37,25,26,29,44,0,0,0,0)
ann1<-c(2021,2021,2021,2021,2021,2021,2021,2021,2021)
dataann2021<-cbind(D2021,ann1,Site)
colnames(dataann2021)<-c("value","année","Site")

D2022<-c(36,28,28,34,54,17,15,17,22)
ann2<-c(2022,2022,2022,2022,2022,2022,2022,2022,2022)
dataann2022<-cbind(D2022,ann2,Site)
colnames(dataann2022)<-c("value","année","Site")

D2023<-c(0,0,0,0,0,17,15,17,22)
ann3<-c(2023,2023,2023,2023,2023,2023,2023,2023,2023)
dataann2023<-cbind(D2023,ann3,Site)
colnames(dataann2023)<-c("value","année","Site")

Dtot<-c(46,36,34,42,60,26,22,26,34)
ann4<-c("total","total","total","total","total","total","total","total","total")
dataanntot<-cbind(Dtot,ann4,Site)
colnames(dataanntot)<-c("value","année","Site")


dataann3<-as.data.frame(rbind(dataann2021,dataann2022,dataann2023,dataanntot))


dataann3$value<-as.numeric(dataann3$value)
dataann3$Site<-as.factor(dataann3$Site)
dataann3$année<-as.factor(dataann3$année)

dataann3$Site<-fct_relevel(dataann3$Site, c("Bi","Bu","Fe","VB","recif1","recif2","recif3","Total Marineff","Total Goëlo" ))

# ggplot(dataann3, aes(année,value))+ #Site
#   geom_bar(stat="identity",alpha=.7,aes(fill=Site))+
#     scale_fill_manual(values = c("#f8766d", "#c49a00", "#53b400","#00c094","#00b6eb","#a58aff","#fb61d7","grey","black"))+
#   theme_bw()+
#   theme(axis.text.x = element_text(size=16,colour="black"))+
#   theme(axis.text.y = element_text(size=16,colour="black"))+
#   theme(axis.title.x = element_text(size=16,colour="black"))+
#   theme(axis.title.y = element_text(size=16,colour="black"))


ggplot(dataann3, aes(Site,value,fill=année))+ #Site
  geom_bar(stat="identity",alpha=.7)+
    # scale_fill_manual(values = c("#f8766d", "#c49a00", "#53b400","#00c094","#00b6eb","#a58aff","#fb61d7","grey","black"))+
  theme_bw()+
  theme(axis.text.x = element_text(size=16,colour="black",angle=35,hjust=1))+
  theme(axis.text.y = element_text(size=16,colour="black"))+
  theme(axis.title.x = element_text(size=16,colour="black"))+
  theme(axis.title.y = element_text(size=16,colour="black"))
ggsave("Richesse.png",width=9,height=8,dpi=350)

```






